resource "snowflake_procedure" "DW_REPORT_GET_REPORT_ADMIN_EXIT_SURVEY" {
	name ="GET_REPORT_ADMIN_EXIT_SURVEY"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN 
--***************************************************************************************************************************** 
-- NAME:  ADMIN_EXIT_SURVEY
-- 
-- PURPOSE: Populating Exit Survey for ADMIN along with other fields coming through Qualtrics Exit Survey.
-- 
-- DEVELOPMENT LOG: 
-- DATE        AUTHOR                NOTES: 
-- --------    -------------------   ----------------------------------------------------------------------------------------------- 
-- 16-06-2023  Ankit Shah         	Initial development. 
-- 20-07-2023  Pooja Deokate	        Added COMPLETED_FLAG to Admin Exit Survey
--*****************************************************************************************************************************

INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.REPORT.ADMIN_EXIT_SURVEY
WITH ADMIN_exit_survey_details AS(
	SELECT survey_id,survey_key
	FROM DW_${var.SF_ENVIRONMENT}.hah.DIM_SURVEY
	WHERE client_employee_indicator = ''ADEMP EXIT''
)
,exit_survey_ADMIN AS (
	SELECT DISTINCT SRH.survey_response_header_key,SRH.RECORDED_DATE,SRH.START_DATE,SRH.END_DATE,DD.SENT_AT AS SENT_DATE,
    SRH.COMPLETED_FLAG
	FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_SURVEY_RESPONSE_HEADER SRH
	LEFT JOIN ADMIN_exit_survey_details cs ON cs.survey_key = srh.SURVEY_KEY
	LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.FACT_DISTRIBUTION DD ON SRH.survey_response_header_key = DD.survey_response_header_key
	WHERE srh.survey_key = cs.survey_key 
)--SELECT * FROM exit_survey_ADMIN;
,SELF_IDENTITY AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS SELF_IDENTITY,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Self Identity'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM SELF_IDENTITY;
,RE_EMPLOYMENT AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS RE_EMPLOYMENT,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Re-Employment'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM RE_EMPLOYMENT;
,RE_EMPLOYMENT_REASON AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS RE_EMPLOYMENT_REASON,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Re-Employment Reason'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM RE_EMPLOYMENT_REASON;
,FULL_NAME AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS FULL_NAME,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Full Name'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM FULL_NAME;
,WORK_STATE AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS WORK_STATE,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Work State'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM WORK_STATE;
,CITY_BRANCH AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS CITY_BRANCH,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''City/Branch'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM CITY_BRANCH;
,RACE_ETHNICITY AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS RACE_ETHNICITY,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Race/Ethnicity'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM RACE_ETHNICITY;
,GENDER AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS GENDER,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Gender'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM GENDER;
,TIME_EMPLOYED AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS TIME_EMPLOYED,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Time Employed'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM TIME_EMPLOYED;
,EMPLOYEE_EXPERIENCE AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS EMPLOYEE_EXPERIENCE,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Employee Experience'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM EMPLOYEE_EXPERIENCE;
,LET_GO_BY_MANAGEMENT AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS LET_GO_BY_MANAGEMENT,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Let Go By Management'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM LET_GO_BY_MANAGEMENT;
,REASON_FOR_LEAVING_CHOICE AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS REASON_FOR_LEAVING_CHOICE,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Reason For Leaving Choice'' AND A.SURVEY_KEY = CS.SURVEY_KEY
	
) --SELECT * FROM REASON_FOR_LEAVING_CHOICE;
,REASON_FOR_LEAVING_RANK AS (
	SELECT b.employee_key,NVL(c.CHOICE_TEXT::VARCHAR,TRIM(SPLIT_PART(b.COMMENTS, ''='', 2))::VARCHAR) AS REASON_FOR_LEAVING_RANK,SURVEY_RESPONSE_HEADER_KEY
	FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_MAPPING a
	INNER JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_SURVEY_QUESTION_RESPONSE_MAPPING b ON a.SURVEY_QUESTION_KEY = b.SURVEY_QUESTION_KEY
	left JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_QUESTION_CHOICE_MAPPING c ON c.CHOICE_LABLE::VARCHAR = TRIM(SPLIT_PART(b.COMMENTS, ''='', 2)) AND b.SURVEY_QUESTION_KEY = c.SURVEY_QUESTION_KEY
	LEFT JOIN ADMIN_exit_survey_details CS ON CS.SURVEY_KEY = B.SURVEY_KEY
	WHERE QUESTION_CONTEXT = ''Reason For Leaving Rank'' AND A.SURVEY_KEY = CS.SURVEY_KEY
) --SELECT * FROM REASON_FOR_LEAVING_RANK;
,FINAL AS (
SELECT
	ces.survey_response_header_key,
	ces.RECORDED_DATE,    
	ces.SENT_DATE,
	ces.START_DATE,
	ces.END_DATE,
    si.SELF_IDENTITY,
	rem.RE_EMPLOYMENT,
	remr.RE_EMPLOYMENT_REASON,
	fln.FULL_NAME,
	ws.WORK_STATE,
	cb.CITY_BRANCH,
	re.RACE_ETHNICITY,
	gn.GENDER,
	te.TIME_EMPLOYED,
	ee.EMPLOYEE_EXPERIENCE,
	lgbm.LET_GO_BY_MANAGEMENT,
	rflc.REASON_FOR_LEAVING_CHOICE,
	rflr.REASON_FOR_LEAVING_RANK,
    ces.COMPLETED_FLAG
FROM exit_survey_ADMIN ces
LEFT JOIN SELF_IDENTITY si ON si.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN RE_EMPLOYMENT rem ON rem.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN RE_EMPLOYMENT_REASON remr ON remr.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN FULL_NAME fln ON fln.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN WORK_STATE ws ON ws.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN CITY_BRANCH cb ON cb.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN RACE_ETHNICITY re ON re.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN GENDER gn ON gn.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN TIME_EMPLOYED te ON te.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN EMPLOYEE_EXPERIENCE ee ON ee.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN LET_GO_BY_MANAGEMENT lgbm ON lgbm.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN REASON_FOR_LEAVING_CHOICE rflc ON rflc.survey_response_header_key = ces.survey_response_header_key
LEFT JOIN REASON_FOR_LEAVING_RANK rflr ON rflr.survey_response_header_key = ces.survey_response_header_key
)SELECT * FROM FINAL;

RETURN(''SUCCESS'');

END
 EOT
}

