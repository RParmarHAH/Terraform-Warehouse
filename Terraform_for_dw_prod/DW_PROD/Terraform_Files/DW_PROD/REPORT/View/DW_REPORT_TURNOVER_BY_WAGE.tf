resource "snowflake_view" "DW_REPORT_TURNOVER_BY_WAGE" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "TURNOVER_BY_WAGE"
	statement = <<-SQL
	 

-- development log


--   date        NAME				Description
-- 08/31/23  Deepen Gajjar   Pushing this view in PROD as per requirement in IDDPS-20


--

WITH derived_rate AS 
(SELECT DISTINCT 
	CASE WHEN e.primary_branch_name LIKE 'PRIMEHOMECARE -%' THEN 'OH' 	
	WHEN e.primary_branch_name LIKE 'EXCEL -%' THEN 'PA' 
	WHEN e.primary_branch_name LIKE 'HHA -%' THEN 'OH'
	WHEN e.primary_branch_name LIKE 'MIDWAY -%' THEN 'OH' 
	WHEN e.primary_branch_name LIKE 'COASTAL -%' THEN 'GA'
	WHEN e.system_code IN ('EMPEONEDISON-3795','EMPEONEDISON-3795D','EMPEONEDISON-3795O','EMPEONPREFERRED-3806','EMPEONPREFERRED-3806A','EMPEONPREFERRED-3806F',
	'EMPEONPREFERRED-7051E') THEN 'NY' ELSE e.PRIMARY_BRANCH_STATE END AS OFFICE_STATE,
e.employee_key, 
e.employee_category,
p.payroll_date, 
ROUND(DIV0NULL(SUM(P.AMOUNT),SUM(P.NUMBER_OF_UNITS)),2) AS DERIVED_RATE



FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_PAYROLL_DETAILS_MERGED p
JOIN dw_prod.INTEGRATION.DIM_EMPLOYEE_PAYROLL_MERGE_DEDUPE  E 
ON e.ORIGINAL_EMPLOYEE_KEY = p.EMPLOYEE_KEY 

WHERE 
payroll_date BETWEEN '1/1/2022' AND getdate() 
AND E.EMPLOYEE_CATEGORY NOT IN ('CORP','Corp')
AND pay_code NOT IN ('500','6','AIN','BON','COR','DEN','GRO','HAB','HS1','K','MHI','MIL','NOP','OT1','OVO','QUA','REF','SCP','SI1','SIP','TOH','VAC','VLI','VSP',
'B','BSO','H','HLO','ML','PH','PH2','PR2','PTR','PTT','PWO','STD','TNO','TR','TRN','TRO','TSP','TT','401','4LN','67','C','CC','HSA','L','OAC','OAD','OAS','OLC',
'OLI','OLS','RB','SEV','VIS','61','62','63','64','66','ACCDNT','B - BONUS','CHILIF','DENT','EL','HOSPTL','M - PAYRATE CORRECTION','MED','O - HOLIDAY OT WORK',
'O - OVERTIME','O - OVERTIME PREMIUM','PEL','PN2','PTN','PWS','S','TTO','V - PTO','VOLADD','VOLLIF','401K','401KLN','BANKRUPTCY','HCFSA','LIFADD','LIFE-ADD','LIFEADD','LTD','M - CELL REIMB','M - MILEAGE',
'M - TRAVEL REIMB','R - HOLIDAY NOT WORK','R - MILEAGE','R - SALARY','SEVERANCE PAY','SPSLIF','V - BEREAVEMENT','VOLADD 2 DNU','B - SIGN','CHILD SUPPORT OH','CHILD SUPPORT OH 2',
'M - HOLIDAY MISC. PAY','M - JURY DUTY','M - TOLL REIMB','M - TRAVEL TIME','OVERPAYMENT RECOVERY','SETTLE','SETTLENT','V - GIVE BACK DAY','WAGE GARN','WAGE GARN 2','401K.','ADJ',
'ALLEN','BARTHO','BONUS','CARESB','CASS','COPE','CRITCL','DAVIES','DELAWA','DUESM','FEDERAL WITHHOLDING','GREENE','HAMILT','HANCOC','HOL','HOLC','HOLCIL','HOLJ','HOLL','HOLM','HOLN',
'HOLT','IBO','JACKSO','KNOX','LAKE','LAWREN','MARION','MEDICARE','MONROE','NEWTON','OTM','OTM1','PTOEVB','PTOFLT','PTOGB','PTOPR','PTOPR2','PTOTRS','RANDOL','RETRO','RFINS','RTRNT',
'SIGN','SOCIAL SECURITY','TREIMB','TTI','VAC1','VACPO','VANDER','VIGO','WAGE','CHETWP','CLAY','DUESO','HSAF','MCATWP','MCCLST','PAHARL','PAHART','PALALL','PALALT','PALEHL','PALEHT',
'PANANT','PHIL-R','401K LOAN','401KLN2','B - CIPBON','B - COVVAC BONUS','CHILD SUPPORT CALIFORNIA','CHILD SUPPORT GA','CHILD SUPPORT GA 2','CHILD SUPPORT GA 3 (COPY)','CHILD SUPPORT GA COASTAL',
'CHILD SUPPORT NEW YORK','COMFSA','DCFSA','DENII','DENIIPO','M - BENEFIT REIMBURS COASTAL','M - BENEFIT REIMBURSE','M - HOTEL REIMB','M - PARKING REIMB','O - OT DEDS',
'OTBL','R - ADMIN BACK PAY','R - SHOW UP VISITS','TRAV75','TRIP FEE','V - PARENTAL LEAVE 1','VSPII','GP','H-Vol-Ben','ITT','MEDTOT','MedADJ','MedV','OT','PT','PTO','SP','SoH',
'WP','401KMatch','401kPT','AddTrans','BON DA','BON HC','BON WH','Benefits','BonusHHA','GTL','HOL-LI','HWB','HolNW','HolOT','HolPRM','J','O','OT-H','OT-IS','OT-LI','OT-TR','OTPR',
'PARKRF','PTO-Acc','PTO-Bal','PTO-Use','RDD','Settlement','Sick','Sick-Acc','Sick-Bal','Sick-Use','SoH-ADJ','TAAE','TRA','TRANRF','TaxPayLoan','Trans','Transit','Union','V',
'WPERTrans','WPNegative','WPS','WPV','XSP','HOL-OT','LoanG','OT-CA','Transp','VaccinePTO','401k-Loan','401kLn-ADJ','401kRoth','BON LH','BRV','BonusPDRN','CS','Guard1S','Guard2S',
'Guard3HW','Guard3S','JD','JNSWP','OT-HOL-LI','OT-PayNBil','Pay-NoBill','RE','TAAEF','TAAES','TACIE','TACIES','TAHE','TAHEF','TAHES','TAULE','TL','VISCH','VISS','BV','DCAP','Guard3F',
'Guard3PC','OT-BL','OT-CV','OXFLEC','Ref $150','TAAEC','TACIEC','TACIEF','TAULEC','TAULES','VISC','VISEC','VISF','VISSH','TAULEF','BoFICAOnly','CH SUPP VA','CH SUPP VA 2','CH SUPP WA',
'CH SUPP WA 2','CHILD SUPPORT DELAWARE 2','CHILD SUPPORT FLORIDA','CHILD SUPPORT FLORIDA 2','CHILD SUPPORT FLORIDA 3','CHILD SUPPORT MI','CHILD SUPPORT NC','CHILD SUPPORT NJ','CHILD SUPPORT NJ (2)',
'CHILD SUPPORT OH 3','CHILD SUPPORT OHIO 2','CHILD SUPPORT OHIO 3','CHILD SUPPORT OHIO 4','CHILD SUPPORT PA','CHILD SUPPORT PA 2','CHILD SUPPORT SC - NEWBERRY','CHILD SUPPORT SOUTH CAROLINA','CHILD SUPPORT TEXAS',
'CHILD SUPPORT WV','DE CHILD SUPPORT','GEN','GOT','M - 401K REIMBURS',
'M - BENEFIT REIMBURS','MD CHILD SUPPORT','O - HOLIDAY OT DED','PT2','R - HOLIDAY DEDUCTION','RI CHILD SUPPORT','SOCIAL SECURITY ADMINISTRATION','TAX GARNISHMENT','TAX GARNISHMENT 2',
'TAX GARNISHMENT 3','TAX GARNISHMENT 4','TAX GARNISHMENT 5','TAX GARNISHMENT 6','V - GIVE BACK DAY DNU','CHILD SUPPORT MI 3','CHILD SUPPORT NY','401KPA','ADJ1','ADV','ALBESM','ALBIRM',
'BER','CLARK','COAOPE','COFMLE','COLUM','DEKALB','DETCTY','EBRLST','EBRTWP','ELKHAR','EMBLS','EMMBOR','EPENN','FLOYD','FORP','HARRIS','HENDRI','HMPLST','HMPTWP','HOLJIL',
'JOHN','JOHNSO','KSCTY','KYCRHI','KYJEFC','KYLAUR','KYLEXF','KYTAYM','LVIL R','MARSHA','MDAACO','MDBMCO','MDHOCO','NYCR','OHBRUN','OHCLEV','OHDEL','OHDUB',
'OHGROV','OHHAMR','OHIRON','OHSTRO','OHVERM','OHWEST','PAABIL','PAABIT','PABREL','PABRET','PAFAIT','PAHANL','PAHANT','PAHATL','PAHATT','PAHEML','PAHEMT','PAHILL','PAHILT',
'PAHOR2','PAHORL','PAHORT','PAJENL','PAJENT','PALMKL','PALSHL','PALSHT','PANBRL','PANBRT','PANHAL','PANHAT','PAROCL','PAROCT','PAUDAL','PAUMOL','PAUMOT','PAUPDL','PAUPDT','PAUPGL',
'PAUPGT','PAUSHL','PAUSHT','PAWARL','PAWART','PAWCKL','PAWCKT','PAWILL','PAWILT','PAWRNL','PAWRNT','PITCTY','PITLST','PORTER','PRCHSD','PTOEIB','RCHLST',
'RCHTWP','RIDLST','SICOOK','SOLTWP','ST JOS','TAX REIMB.','TAXREF','TEXP','TTIME','TXLEVY','UPMLST','V - PARENTAL LEAVE','WCALNL','WCALNT','WHITMA','BACKCK',
'BM1121','CH SUPP IN','CHILD SUPPORT MI .10','CHILD SUPPORT MI .2','CHILD SUPPORT MI .3','CHILD SUPPORT MI .4','CHILD SUPPORT MI .5','CHILD SUPPORT MI .6',
'CHILD SUPPORT MI .7','CHILD SUPPORT MI .8','CHILD SUPPORT MI .9','DET NR','GRB','INS','LAPORT','OCP','OVP','WAGE2','ADAMS','BENTON','BLACKF','BOONE',
'BROWN','CARROL','CIPBON','CLINTO','CRAWFO','DAVIE','DEARBO','DECATU','DUBOIS','DUEADJ','FAYETT','FOUNTA','FRANKL','FULTON','GIBSON',
'GRANT','HEND','HENRY','HOLCCH','HOLCCO','HOLJCH','HOLJCO','HOLKCH','HOLKCO','HOLKIL','HOLLCH','HOLLCO','HOLLIL','HOLMCH','HOLMCO',
'HOLMIL','HOLNCH','HOLNCO','HOLNIL','HOLTCH','HOLTCO','HOLTIL','HOWARD','HUNTIN','JASPER','JAY','JEFFER','JENING','KOSCIU','LAGRAN',
'MADISO','MARTIN','MCCKEN','MFRN','MIAMI','MONTGO','MORGAN','NOB','NOBLE','ORANGE','OTMCH','OTMCO','OTMIL','OWEN','OWENSB','PARKE',
'PERRY','PIKE','POSEY','PSUEDO','PTOPO','PUL-KY','PULASK','PUTNAM','RET','RIPLEY','RUSH','SCOTT','SETNT','SETT','SHELBY','SOB','SPENCE',
'STARKE','SULLIV','TIPPIC','VERMIL','WABASH','WARREN','WARRIC','WASHIN','WAYNE','WELLS','WHITE','WHITEL','CELL REIMB','CHILD SUPPORT OH 4',
'FRNK','TRAV1','ADMF','BONUS1','CIC1','HOL2','MILES','MIN','ONCE','ONCW','OPCTY','RETADJ','SHOW','SUP','SUPER','TRAVN','TVLBIL','401L1',
'ACCDN','AUTO','CHILI','COMFS','CRITC','FITW','FUTA','HOSPT','MED-R','MEDCL','MILE','MISCD','PTOB','PTOM','REIMB','VOLAD','VOLLI', 'VHO',
'VSPIIPO','WC','WORKED IN LOCAL','B - CARES', 'M - FIELD PARKING REIMB''M - FINGERPRINT REIMBURSEMENT','M - GARN REIMB','M - MISC PAY DED','MEDIIPO','MO CH SUPP','SCRUBS','V - FIELD PTO','V - FLOATING HOLIDAY','VSPIIPO','LIVED IN LOCAL','LOCAL 4', 'SDI','ST','SUI','SUI SDI',
'V - FIELD PTO','V - FLOATING HOLIDAY')
AND pay_code_category NOT IN ('Holiday','TAX','TRAINING','Reimbursement', 'BENEFITS & DEDUCTIONS','REIMBURSEMENT','Benefits & Deductions','Tax','No Bill & No Show & No Charge','PTO',
'Travel Time & Mileage','Training','Adjustment','Child Support','Bonus','BONUS')
AND e.primary_branch_name NOT IN ('UNKNOWN')

GROUP BY 1,2,3,4),

WAGE_BUCKET AS (
SELECT DISTINCT 
R.*, 
CASE WHEN R.DERIVED_RATE <=10.00 THEN '<10'
WHEN r.derived_rate BETWEEN 10.01 AND 12.50 THEN '10.01 to 12.50'
WHEN r.derived_rate BETWEEN 12.51 AND 15.00 THEN '12.51 to 15.00'
WHEN r.derived_rate BETWEEN 15.01 AND 17.50 THEN '15.01 to 17.50'
WHEN r.derived_rate BETWEEN 17.51 AND 20.00 THEN '17.51 to 20.00'
WHEN r.derived_rate >= 20.01 THEN  '>20.00' END AS rate_bucket


FROM DERIVED_RATE R),

MIN_MAX_CHECKS AS

(SELECT DISTINCT 
emp.employee_key,
MIN(PAY.PAYROLL_DATE)AS FIRST_CHECK_DATE, 
MAX(PAYROLL_DATE) AS LAST_CHECK_DATE


FROM DW_${var.SF_ENVIRONMENT}.INTEGRATION.DIM_EMPLOYEE_PAYROLL_MERGE_DEDUPE  EMP
LEFT JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_PAYROLL_MERGED PAY
ON PAY.ORIGINAL_EMPLOYEE_KEY = EMP.EMPLOYEE_KEY 

GROUP BY 1)

SELECT DISTINCT 
w.*, 
datediff(month, c.FIRST_CHECK_DATE, w.PAYROLL_DATE) AS TENURE_MONTH, 
datediff(YEAR, c.FIRST_CHECK_DATE,w.PAYROLL_DATE) AS TENURE_YEAR, 
CASE WHEN datediff(days, c.LAST_CHECK_DATE, getdate()) > 30 THEN 'INACTIVE' ELSE 'ACTIVE' END  AS ACTIVE_FLAG

FROM WAGE_BUCKET w
JOIN MIN_MAX_CHECKS C 
ON C.EMPLOYEE_KEY = w.EMPLOYEE_KEY;
SQL
	or_replace = true 
	is_secure = false 
}

