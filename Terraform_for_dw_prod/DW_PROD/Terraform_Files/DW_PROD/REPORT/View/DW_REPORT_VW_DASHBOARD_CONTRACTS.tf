resource "snowflake_view" "DW_REPORT_VW_DASHBOARD_CONTRACTS" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_DASHBOARD_CONTRACTS"
	statement = <<-SQL
	 WITH VISITS AS (
    SELECT CONTRACT_KEY, MAX(SERVICE_DATE) AS LAST_SERVICE_DATE
    FROM HAH.FACT_VISIT
    WHERE NVL(CONFIRMED_FLAG,'YES') ='YES' --NVL(STATUS_CODE, '02') IN ('02','03','04','05') 
	GROUP BY CONTRACT_KEY
),
EXEC_OPS_UTIL_CONTRACTS AS (
SELECT
 C.CONTRACT_KEY
,C.CONTRACT_CODE
,C.CONTRACT_NAME
,C.SYSTEM_CODE
,C.SOURCE_SYSTEM_ID
,C.REVENUE_CATEGORY
,C.REVENUE_SUBCATEGORY_CODE
,C.REVENUE_SUBCATEGORY_NAME 
FROM HAH.DIM_CONTRACT C
JOIN HAH.FACT_Revenue_SubCategory_Usage U ON C.REVENUE_CATEGORY=U.REVENUE_CATEGORY AND C.REVENUE_SUBCATEGORY_CODE=U.REVENUE_SUBCATEGORY_CODE
WHERE U.DASHBOARD_REPORT_NAME = 'Executive_Operations_Dashboard'
AND U.METRIC_NAME = 'Utilization'
AND U.INCLUDE_FLAG = 'TRUE'
AND C.BILLABLE_FLAG = 'TRUE'
AND NVL(C.BILL_UNIT_TYPE, 'Hourly') = 'Hourly' -- To consider only time based billing
--AND C.SOURCE_SYSTEM_ID NOT IN (1, 2) -- Exclude Coastal/Altrus
AND C.REVENUE_CATEGORY NOT IN ('CLS', 'NA')
),
EXEC_OPS_CENSUS_CONTRACTS AS (
SELECT
 C.CONTRACT_KEY
,C.CONTRACT_CODE
,C.CONTRACT_NAME
,C.SYSTEM_CODE
,C.SOURCE_SYSTEM_ID
,COALESCE(C.REVENUE_CATEGORY, 'HC') AS REVENUE_CATEGORY
,COALESCE(C.REVENUE_SUBCATEGORY_CODE, 'HC') AS REVENUE_SUBCATEGORY_CODE
,COALESCE(C.REVENUE_SUBCATEGORY_NAME, 'HOME CARE') AS REVENUE_SUBCATEGORY_NAME 
FROM HAH.DIM_CONTRACT C
LEFT JOIN HAH.FACT_Revenue_SubCategory_Usage U ON C.REVENUE_CATEGORY=U.REVENUE_CATEGORY AND C.REVENUE_SUBCATEGORY_CODE=U.REVENUE_SUBCATEGORY_CODE
WHERE U.DASHBOARD_REPORT_NAME = 'Executive_Operations_Dashboard'
AND U.METRIC_NAME = 'Census'
AND U.INCLUDE_FLAG = 'TRUE'
AND C.BILLABLE_FLAG = 'TRUE'
--AND C.SOURCE_SYSTEM_ID NOT IN (1, 2) -- Exclude Coastal/Altrus
AND C.REVENUE_CATEGORY NOT IN ('CLS', 'NA')
),
OPS_PERF_UTIL_CONTRACTS AS (
SELECT
 C.CONTRACT_KEY
,C.CONTRACT_CODE
,C.CONTRACT_NAME
,C.SYSTEM_CODE
,C.SOURCE_SYSTEM_ID
,C.REVENUE_CATEGORY
,C.REVENUE_SUBCATEGORY_CODE
,C.REVENUE_SUBCATEGORY_NAME 
FROM HAH.DIM_CONTRACT C
JOIN HAH.FACT_Revenue_SubCategory_Usage U ON C.REVENUE_CATEGORY=U.REVENUE_CATEGORY AND C.REVENUE_SUBCATEGORY_CODE=U.REVENUE_SUBCATEGORY_CODE
WHERE U.DASHBOARD_REPORT_NAME = 'Ops_Performance_Dashboard'
AND U.METRIC_NAME = 'Utilization'
AND U.INCLUDE_FLAG = 'TRUE'
AND C.BILLABLE_FLAG = 'TRUE'
--AND C.SOURCE_SYSTEM_ID NOT IN (1, 2) -- Exclude Coastal/Altrus
AND C.REVENUE_CATEGORY NOT IN ('CLS', 'NA')
),
OPS_PERF_CENSUS_CONTRACTS AS (
SELECT
 C.CONTRACT_KEY
,C.CONTRACT_CODE
,C.CONTRACT_NAME
,C.SYSTEM_CODE
,C.SOURCE_SYSTEM_ID
,COALESCE(C.REVENUE_CATEGORY, 'HC') AS REVENUE_CATEGORY
,COALESCE(C.REVENUE_SUBCATEGORY_CODE, 'HC') AS REVENUE_SUBCATEGORY_CODE
,COALESCE(C.REVENUE_SUBCATEGORY_NAME, 'HOME CARE') AS REVENUE_SUBCATEGORY_NAME 
FROM HAH.DIM_CONTRACT C
LEFT JOIN HAH.FACT_Revenue_SubCategory_Usage U ON C.REVENUE_CATEGORY=U.REVENUE_CATEGORY AND C.REVENUE_SUBCATEGORY_CODE=U.REVENUE_SUBCATEGORY_CODE
WHERE U.DASHBOARD_REPORT_NAME = 'Ops_Performance_Dashboard'
AND U.METRIC_NAME = 'Census'
AND U.INCLUDE_FLAG = 'TRUE'
AND C.BILLABLE_FLAG = 'TRUE'
--AND C.SOURCE_SYSTEM_ID NOT IN (1, 2) -- Exclude Coastal/Altrus
AND C.REVENUE_CATEGORY NOT IN ('CLS', 'NA')
)
SELECT
 C.CONTRACT_KEY
,C.CONTRACT_CODE
,C.CONTRACT_NAME
,C.SERVICE_KEY
,C.SERVICE_CODE_ID
,SRV.NAME AS SERVICE_NAME
,C.PARTNER_KEY
,P.PARTNER_CODE
,P.PARTNER_NAME
,C.SYSTEM_CODE
,S.STATE_NAME
,C.SOURCE_SYSTEM_ID
,SS.SYSTEM_DESCRIPTION AS SOURCE_SYSTEM_NAME
,CASE C.SYSTEM_CODE WHEN 'PA' THEN 'PA (old)' WHEN '8485' THEN 'PA' ELSE C.SYSTEM_CODE END AS COMPANY
,CASE WHEN C.BILLABLE_FLAG = 1 THEN 'TRUE' WHEN C.BILLABLE_FLAG = 0 THEN 'FALSE' END AS BILLABLE
,CASE WHEN C.PAYABLE_FLAG = 1 THEN 'TRUE' WHEN C.PAYABLE_FLAG = 0 THEN 'FALSE' END AS PAYABLE
,CASE WHEN C.MILEAGE_FLAG = 1 THEN 'TRUE' WHEN C.MILEAGE_FLAG = 0 THEN 'FALSE' END AS MILEAGE
,COALESCE(C.REVENUE_CATEGORY, CASE WHEN COALESCE(EXECOPS_U.CONTRACT_KEY,EXECOPS_C.CONTRACT_KEY) IS NOT NULL OR 
          COALESCE(OPSPERF_U.CONTRACT_KEY,OPSPERF_C.CONTRACT_KEY) IS NOT NULL THEN 'HC' END) REVENUE_CATEGORY
,COALESCE(C.REVENUE_SUBCATEGORY_CODE, CASE WHEN COALESCE(EXECOPS_U.CONTRACT_KEY,EXECOPS_C.CONTRACT_KEY) IS NOT NULL OR 
          COALESCE(OPSPERF_U.CONTRACT_KEY,OPSPERF_C.CONTRACT_KEY) IS NOT NULL THEN 'HC' END) REVENUE_SUBCATEGORY_CODE 
,COALESCE(C.REVENUE_SUBCATEGORY_NAME, CASE WHEN COALESCE(EXECOPS_U.CONTRACT_KEY,EXECOPS_C.CONTRACT_KEY) IS NOT NULL OR 
          COALESCE(OPSPERF_U.CONTRACT_KEY,OPSPERF_C.CONTRACT_KEY) IS NOT NULL THEN 'HOME CARE' END) REVENUE_SUBCATEGORY_NAME 
,CASE WHEN EXECOPS_U.CONTRACT_KEY IS NOT NULL THEN TRUE ELSE FALSE END AS INCLUDE_FOR_EXEC_OPS_HOURS
,CASE WHEN EXECOPS_C.CONTRACT_KEY IS NOT NULL THEN TRUE ELSE FALSE END AS INCLUDE_FOR_EXEC_OPS_CLIENTS
,CASE WHEN OPSPERF_U.CONTRACT_KEY IS NOT NULL THEN TRUE ELSE FALSE END AS INCLUDE_FOR_OPS_PERF_HOURS
,CASE WHEN OPSPERF_C.CONTRACT_KEY IS NOT NULL THEN TRUE ELSE FALSE END AS INCLUDE_FOR_OPS_PERF_CLIENTS
,V.LAST_SERVICE_DATE
FROM HAH.DIM_CONTRACT C
LEFT JOIN HAH.DIM_PARTNER P ON C.PARTNER_KEY = P.PARTNER_KEY 
LEFT JOIN HAH.DIM_SERVICES_1_0 SRV
	ON SRV.SOURCE_SYSTEM_ID = C.SOURCE_SYSTEM_ID AND SRV.SYSTEM_CODE = C.SYSTEM_CODE AND SRV.SERVICE_CODE_ID = C.SERVICE_CODE_ID
LEFT JOIN HAH.DIM_STATE S ON C.CONTRACT_STATE_CODE=S.STATE_ISO_CODE
LEFT JOIN HAH.DIM_SOURCE_SYSTEM SS ON C.SOURCE_SYSTEM_ID=SS.SOURCE_SYSTEM_ID
LEFT JOIN VISITS V ON V.CONTRACT_KEY = C.CONTRACT_KEY
LEFT JOIN EXEC_OPS_UTIL_CONTRACTS EXECOPS_U ON C.CONTRACT_KEY = EXECOPS_U.CONTRACT_KEY
LEFT JOIN EXEC_OPS_CENSUS_CONTRACTS EXECOPS_C ON C.CONTRACT_KEY = EXECOPS_C.CONTRACT_KEY
LEFT JOIN OPS_PERF_CENSUS_CONTRACTS OPSPERF_C ON C.CONTRACT_KEY = OPSPERF_C.CONTRACT_KEY
LEFT JOIN OPS_PERF_UTIL_CONTRACTS OPSPERF_U ON C.CONTRACT_KEY = OPSPERF_U.CONTRACT_KEY
WHERE C.REVENUE_CATEGORY NOT IN ('CLS', 'NA') -- ADDED BY PJSHAH ON 20092022;
;
SQL
	or_replace = true 
	is_secure = false 
}

