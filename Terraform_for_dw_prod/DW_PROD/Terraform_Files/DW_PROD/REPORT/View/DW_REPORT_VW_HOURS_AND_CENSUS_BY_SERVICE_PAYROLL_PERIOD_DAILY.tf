resource "snowflake_view" "DW_REPORT_VW_HOURS_AND_CENSUS_BY_SERVICE_PAYROLL_PERIOD_DAILY" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_HOURS_AND_CENSUS_BY_SERVICE_PAYROLL_PERIOD_DAILY"
	statement = <<-SQL
	         WITH DATA AS (
      SELECT B.BRANCH_PAYROLL_PERIODS_KEY,A.* FROM REPORT.HOURS_AND_CENSUS_BY_PAYROLL_DATE_DAILY A
      LEFT JOIN HAH.FACT_BRANCH_PAYROLL_PERIODS B ON A.BRANCH_KEY=B.BRANCH_KEY AND A.SERVICE_DATE>=B.PERIOD_START_DATE 
        AND A.SERVICE_DATE<=B.PERIOD_END_DATE
      WHERE A.SERVICE_DATE BETWEEN DATEADD('DAY',-150,CURRENT_DATE) AND CURRENT_DATE)        
       ,DATE_DATA AS (
         SELECT 
         B.BRANCH_PAYROLL_PERIODS_KEY AS BRANCH_PAYROLL_PERIODS_KEY, A.CALENDAR_DATE AS CALENDAR_DATE,B.BRANCH_KEY AS BRANCH_KEY FROM HAH.DIM_DATE A
         LEFT JOIN HAH.FACT_BRANCH_PAYROLL_PERIODS B ON A.CALENDAR_DATE BETWEEN B.PERIOD_START_DATE AND B.PERIOD_END_DATE
         WHERE A.CALENDAR_DATE BETWEEN DATEADD('DAY',-150,CURRENT_DATE) AND CURRENT_DATE)     
         SELECT A.*,B.BRANCH_PAYROLL_PERIODS_KEY AS SEVEN_DAY_PRIOR_BRANCH_PAYROLL_PERIODS_KEY FROM 
         DATA A 
         LEFT JOIN DATE_DATA B ON B.CALENDAR_DATE=DATEADD('DAY',-7,A.SERVICE_DATE) AND A.BRANCH_KEY=B.BRANCH_KEY
         WHERE SEVEN_DAY_PRIOR_BRANCH_PAYROLL_PERIODS_KEY IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

