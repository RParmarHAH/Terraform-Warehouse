resource "snowflake_view" "DW_REPORT_LOST_CLIENTS_2020_21" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "LOST_CLIENTS_2020_21"
	statement = <<-SQL
	 
WITH VISITS AS
(
	SELECT DISTINCT CLIENT_KEY,DATE_TRUNC('MONTH',REPORT_DATE) REPORT_MONTH,CONTRACT_KEY,
	FIRST_VALUE(BRANCH_NAME) OVER(PARTITION BY CLIENT_KEY ORDER BY DATE_TRUNC('MONTH',REPORT_DATE) DESC, NVL(SUM(HOURS_SERVED), 0) DESC) BRANCH_NAME
	FROM INTEGRATION.FACT_VISIT_MERGED 
	WHERE REPORT_DATE >='2020-01-01' AND NVL(BILL_UNIT_TYPE,'Hourly')='Hourly'	
	GROUP BY CLIENT_KEY,BRANCH_NAME,CONTRACT_KEY ,DATE_TRUNC('MONTH',REPORT_DATE)
	HAVING MAX(DATE_TRUNC('MONTH',REPORT_DATE))<='2021-03-01'
)
, FINAL1 AS 
(
SELECT DISTINCT V.CLIENT_KEY, V.BRANCH_NAME, C.CLIENT_FIRST_NAME, C.CLIENT_LAST_NAME,
MAX(V.REPORT_MONTH) OVER (PARTITION BY V.CLIENT_KEY) LATEST_REPORT_MONTH,
C.CLIENT_STATE_CODE,
FIRST_VALUE(I.HOURS_AUTHORIZED) OVER (PARTITION BY I.CLIENT_KEY ORDER BY I.REPORT_DATE DESC) HOURS_AUTHORIZED,
FIRST_VALUE (I.HOURS_AUTHORIZED_NON_ADJUSTED) OVER (PARTITION BY I.CLIENT_KEY ORDER BY I.REPORT_DATE DESC) HOURS_AUTHORIZED_NON_ADJUSTED
FROM visits V
LEFT JOIN INTEGRATION.DIM_CLIENT_MERGED C ON C.CLIENT_KEY=V.CLIENT_KEY
LEFT JOIN INTEGRATION.FACT_INTAKE_MERGED I ON I.CLIENT_KEY = V.CLIENT_KEY AND I.CONTRACT_KEY=V.CONTRACT_KEY AND I.REPORT_DATE=V.REPORT_MONTH
JOIN REPORT.VW_DASHBOARD_CONTRACTS DC ON I.CONTRACT_KEY = DC.CONTRACT_KEY AND DC.INCLUDE_FOR_EXEC_OPS_HOURS = 1 AND DC.REVENUE_CATEGORY = 'HC'
)
SELECT DISTINCT  CLIENT_KEY ,BRANCH_NAME, CLIENT_FIRST_NAME, CLIENT_LAST_NAME,LATEST_REPORT_MONTH,CLIENT_STATE_CODE,SUM (HOURS_AUTHORIZED) AS HOURS_AUTHORIZED, SUM(HOURS_AUTHORIZED_NON_ADJUSTED) AS HOURS_AUTHORIZED_NON_ADJUSTED
FROM FINAL1
GROUP BY CLIENT_KEY ,BRANCH_NAME, CLIENT_FIRST_NAME, CLIENT_LAST_NAME,LATEST_REPORT_MONTH,CLIENT_STATE_CODE;
SQL
	or_replace = true 
	is_secure = false 
}

