resource "snowflake_view" "DW_REPORT_VW_SANDATA_REJECT_CODES" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_SANDATA_REJECT_CODES"
	statement = <<-SQL
	 SELECT S.REJECTIONCODE as REJECT_CODE, 
RC.DESCRIPTION,
CONCAT(S.AgencyId, ' - ', S.ScheduleId) AS Sandata_Visit_ID,
S.SCHEDULEID as SCHEDULE_ID,
BRANCH.BRANCH_KEY,
S.SCHEDULEDATE as SCHEDULE_DATE,
CLIENT.SYSTEM_CODE, 
CLIENT.CLIENT_KEY
FROM DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_SCHEDULES S
JOIN (
    SELECT L.*
    FROM (
        SELECT *,
            ROW_NUMBER() OVER(PARTITION BY AGENCYID, SCHEDULEID ORDER BY CLIENTSCHEDHDRID DESC, CLIENTSCHEDDTLID DESC) AS ROW_NUM
        FROM DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_SCHEDULESCLIENTS
    ) L
    WHERE L.ROW_NUM = 1
) SC
    ON SC.AGENCYID = S.AGENCYID AND SC.SCHEDULEID = S.SCHEDULEID
JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CA
    ON CA.AGENCYID = SC.AGENCYID AND CA.ADMISSIONID = SC.ADMISSIONID
JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTS C
    ON C.AGENCYID = CA.AGENCYID AND C.CLIENTID = CA.CLIENTID
LEFT JOIN --HAH.DIM_BRANCH BRANCH
INTEGRATION.DIM_BRANCH_MERGED BRANCH
    ON BRANCH.SYSTEM_CODE = CASE CA.AGENCYID WHEN '8380' THEN 'IL' WHEN '38004' THEN 'IN' WHEN '8463' THEN 'MO' WHEN '8485' THEN '8485' END
        AND BRANCH.OFFICE_CODE = COALESCE(TRY_CAST(CA.LOCATIONID AS INT)::STRING, CA.LOCATIONID)
LEFT JOIN --HAH.DIM_CLIENT CLIENT
INTEGRATION.DIM_CLIENT_MERGED CLIENT
    ON CLIENT.SYSTEM_CODE = CASE C.AGENCYID WHEN '8380' THEN 'IL' WHEN '38004' THEN 'IN' WHEN '8463' THEN 'MO' WHEN '8485' THEN '8485' END
        AND CLIENT.CLIENT_NUMBER = IFF(C.AGENCYID = '8485', C.CLIENTID, COALESCE(TRY_CAST(C.OTHERID AS INT), TRY_CAST(C.CUSTOMID AS INT)))
JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_REJECTIONCODES RC on S.AGENCYID = RC.AGENCYID and S.REJECTIONCODE = RC.CODE
WHERE S.SCHEDULEDATE >= '2020-01-01' and
S.REJECTIONCODE is not null
and S.REJECTIONCODE <> '';
SQL
	or_replace = true 
	is_secure = false 
}

