resource "snowflake_view" "DW_REPORT_VW_GATOR_CAREGIVER_MAPPING" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_GATOR_CAREGIVER_MAPPING"
	statement = <<-SQL
	 ------------------------------------------------------------------------------------------------------------------------------
/*
Object Type : 	View
Object Name	: 	VW_GATOR_CAREGIVER_MAPPING
Author		:	Pooja Deokate
Description :
	- Interim Solution to Map CC Employee Key From Gator with DW Client Key
*/
--*****************************************************************************************************************************
-- CHANGE LOG :
-- Version	Date(MM/DD/YYYY)	Author				Change Description
-- --------	----------------   	------------------	---------------------------------------------------------------------------
-- 1.0		26/09/2023   		Pooja Deokate		Initial development
-------------------------------------------------------------------------------------------------------------------------------
WITH CAREGIVER_LIST AS
(
	SELECT DISTINCT GATOR_CAREGIVER.ID AS ACCOUNT_ID
					, LEFT(GATOR_CAREGIVER.HEALTHCLOUDGA__SOURCESYSTEMID__C, 32) AS GATOR_EMPLOYEE_KEY
					, NVL(DW_CAREGIVER.EMPLOYEE_KEY, LEFT(GATOR_CAREGIVER.HEALTHCLOUDGA__SOURCESYSTEMID__C, 32)) AS DW_EMPLOYEE_KEY
					, NVL(DW_CAREGIVER.EMPLOYEE_FIRST_NAME,  GATOR_CAREGIVER.FIRSTNAME) AS EMPLOYEE_FIRST_NAME 
					, NVL(DW_CAREGIVER.EMPLOYEE_LAST_NAME, GATOR_CAREGIVER.LASTNAME ) AS EMPLOYEE_LAST_NAME
	FROM DISC_${var.SF_ENVIRONMENT}.HEALTH_NAVIGATOR.ACCOUNT GATOR_CAREGIVER
	INNER JOIN DISC_${var.SF_ENVIRONMENT}.HEALTH_NAVIGATOR.RECORDTYPE RECORD_TYPE
		ON RECORD_TYPE.ID = GATOR_CAREGIVER.RECORDTYPEID
			AND RECORD_TYPE.NAME = 'Caregiver'
	LEFT JOIN APP_DB_${var.SF_ENVIRONMENT}.CARE_COORDINATION.CAREGIVER_MATCH_LIST CAREGIVER_MATCH 
		ON LEFT(GATOR_CAREGIVER.HEALTHCLOUDGA__SOURCESYSTEMID__C, 32) = CAREGIVER_MATCH.GATOR_EMPLOYEE_KEY
			AND CAREGIVER_MATCH.ORIGINAL_SOURCE = 'DW'
	LEFT JOIN DW_${var.SF_ENVIRONMENT}.INTEGRATION.DIM_EMPLOYEE_MERGED  DW_CAREGIVER
		ON DW_CAREGIVER.ORIGINAL_EMPLOYEE_KEY = NVL(CAREGIVER_MATCH.DW_EMPLOYEE_KEY
										 , LEFT(GATOR_CAREGIVER.HEALTHCLOUDGA__SOURCESYSTEMID__C, 32))
)
SELECT DISTINCT ACCOUNT_ID AS ACCOUNT_ID
			, GATOR_EMPLOYEE_KEY AS EMPLOYEE_KEY
			, GATOR_EMPLOYEE_KEY AS ORIGINAL_EMPLOYEE_KEY
			, 'GATOR' AS SOURCE_SYSTEM
			, 'GATOR' AS ORIGINAL_SOURCE_SYSTEM
			, EMPLOYEE_FIRST_NAME
			, EMPLOYEE_LAST_NAME
FROM CAREGIVER_LIST
UNION
SELECT DISTINCT ACCOUNT_ID AS ACCOUNT_ID
				, GATOR_EMPLOYEE_KEY AS EMPLOYEE_KEY
				, DW_EMPLOYEE_KEY AS ORIGINAL_EMPLOYEE_KEY
				, 'GATOR' AS SOURCE_SYSTEM
				, 'DW' AS ORIGINAL_SOURCE_SYSTEM
				, EMPLOYEE_FIRST_NAME
				, EMPLOYEE_LAST_NAME
FROM CAREGIVER_LIST;
SQL
	or_replace = true 
	is_secure = false 
}

