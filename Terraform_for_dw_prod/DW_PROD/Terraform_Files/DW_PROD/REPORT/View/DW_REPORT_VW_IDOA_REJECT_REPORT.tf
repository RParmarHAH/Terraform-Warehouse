resource "snowflake_view" "DW_REPORT_VW_IDOA_REJECT_REPORT" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_IDOA_REJECT_REPORT"
	statement = <<-SQL
	 
WITH CLIENT_INFO
AS
(
SELECT DBNAME,
REFERENCENO,
CLIENTNUMBER,
PERIOD,
HOURSMOVED,
CHANGEDBY, 
CHANGEDDATETIME,
AUDITNUMBER,
BILLHOURSMOVED,
BILLAMOUNTMOVED,
CLIENTNAME,
WRITEOFF,
TOBERECOUPED,
OFFICENUMBER,
PREVWRITEOFF,
RECOUPED,
RECOUPWRITEOFF
FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFMOVEDHOURS
)

,
OLD_CONTRACT
AS
(
SELECT MH.OLDCONTRACT as OLD_CONTRACT_CODE,
CON.CONTRACT_NAME as OLD_CONTRACT_NAME,
MH.DBNAME,
MH.REFERENCENO
FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFMOVEDHOURS MH
JOIN HAH.DIM_CONTRACT CON on MH.DBNAME = CON.SYSTEM_CODE and MH.OLDCONTRACT = CON.CONTRACT_CODE
)

,
NEW_CONTRACT 
AS
(
SELECT MH.NEWCONTRACT as NEW_CONTRACT_CODE,
CON.CONTRACT_NAME as NEW_CONTRACT_NAME,
MH.DBNAME,
MH.REFERENCENO
FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFMOVEDHOURS MH
JOIN HAH.DIM_CONTRACT CON on MH.DBNAME = CON.SYSTEM_CODE and MH.NEWCONTRACT = CON.CONTRACT_CODE
)

SELECT CI.*,
OC.OLD_CONTRACT_CODE,
OC.OLD_CONTRACT_NAME,
NC.NEW_CONTRACT_CODE,
NC.NEW_CONTRACT_NAME
FROM CLIENT_INFO CI
JOIN NEW_CONTRACT NC on CI.REFERENCENO = NC.REFERENCENO and CI.DBNAME = NC.DBNAME
JOIN OLD_CONTRACT OC on CI.REFERENCENO = OC.REFERENCENO and CI.DBNAME = OC.DBNAME;
SQL
	or_replace = true 
	is_secure = false 
}

