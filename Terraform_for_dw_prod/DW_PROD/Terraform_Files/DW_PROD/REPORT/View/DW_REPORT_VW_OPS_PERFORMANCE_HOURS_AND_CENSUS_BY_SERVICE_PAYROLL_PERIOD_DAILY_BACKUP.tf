resource "snowflake_view" "DW_REPORT_VW_OPS_PERFORMANCE_HOURS_AND_CENSUS_BY_SERVICE_PAYROLL_PERIOD_DAILY_BACKUP" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_OPS_PERFORMANCE_HOURS_AND_CENSUS_BY_SERVICE_PAYROLL_PERIOD_DAILY_BACKUP"
	statement = <<-SQL
	 WITH DATA AS 
(
      SELECT B.BRANCH_PAYROLL_PERIODS_KEY,A.* 
      FROM REPORT.HOURS_AND_CENSUS_BY_PAYROLL_DATE_DAILY A
      LEFT JOIN REPORT.VW_DASHBOARD_CONTRACTS CT ON A.CONTRACT_KEY=CT.CONTRACT_KEY 
          AND (CT.INCLUDE_FOR_OPS_PERF_HOURS=1 AND INCLUDE_FOR_OPS_PERF_CLIENTS=1)
      LEFT JOIN INTEGRATION.FACT_BRANCH_PAYROLL_PERIODS_MERGED  B ON A.BRANCH_KEY=B.ORIGINAL_BRANCH_KEY AND A.SERVICE_DATE>=B.PERIOD_START_DATE 
        AND A.SERVICE_DATE<=B.PERIOD_END_DATE
      WHERE A.SERVICE_DATE BETWEEN DATEADD('DAY',-100,CURRENT_DATE) AND CURRENT_DATE
)        
,DATE_DATA AS (
         SELECT DISTINCT
--         FIRST_VALUE(B.BRANCH_PAYROLL_PERIODS_KEY) OVER (PARTITION BY B.BRANCH_KEY, B.PERIOD_START_DATE ORDER BY IFF(B.BRANCH_KEY <> B.ORIGINAL_BRANCH_KEY, 1, 0)) AS BRANCH_PAYROLL_PERIODS_KEY,
         	A.CALENDAR_DATE AS CALENDAR_DATE,B.BRANCH_KEY AS BRANCH_KEY FROM HAH.DIM_DATE A
         LEFT JOIN INTEGRATION.FACT_BRANCH_PAYROLL_PERIODS_MERGED B ON A.CALENDAR_DATE BETWEEN B.PERIOD_START_DATE AND B.PERIOD_END_DATE
         WHERE A.CALENDAR_DATE BETWEEN DATEADD('WEEK',-79,CURRENT_DATE) AND CURRENT_DATE
  )        
SELECT A.BRANCH_PAYROLL_PERIODS_KEY,A.PAYROLL_DATE,
A.PAY_PERIOD_START_DATE,
A.PAY_PERIOD_END_DATE,
A.SERVICE_DATE,
A.SERVICE_END_OF_WEEK,
A.BRANCH_KEY,
A.SUPERVISOR_KEY,
A.CLIENT_KEY_DATA,
A.CONTRACT_KEY,
A.ORIGINAL_SOURCE_SYSTEM_ID,
A.SOURCE_SYSTEM_ID,
A.CLIENT_KEY,
A.HOURS_SERVED_ALL,
A.ETL_TASK_KEY,
A.ETL_INSERTED_TASK_KEY,
A.ETL_INSERTED_DATE,
A.ETL_INSERTED_BY,
A.ETL_LAST_UPDATED_DATE,
A.ETL_LAST_UPDATED_BY,
A.ETL_DELETED_FLAG,
A.ETL_INFERRED_MEMBER_FLAG 
FROM DATA A 
LEFT JOIN DATE_DATA B ON B.CALENDAR_DATE=DATEADD('DAY',-7,A.SERVICE_DATE) AND A.BRANCH_KEY=B.BRANCH_KEY
WHERE B.CALENDAR_DATE IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

