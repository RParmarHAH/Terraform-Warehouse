resource "snowflake_view" "DW_REPORT_VW_CLIENTS_REFERRED_WIP" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "REPORT"
	name = "VW_CLIENTS_REFERRED_WIP"
	statement = <<-SQL
	 SELECT DISTINCT
DATE_TRUNC('MONTH',R.REFERRED_DATE) AS REFERRED_DATE,
R.CLIENT_KEY,
R.CLIENT_NUMBER ,
R.CLIENT_NAME ,
R.DAYS_TO_SERVICE ,
R.BRANCH_KEY, 
R.FIRST_CONTRACT_KEY AS CONTRACT_KEY,
R.FIRST_PARTNER_CONTRACT_SERVICE_KEY ,
R.TYPE,
R.SOURCE_SYSTEM_ID ,
R.ORIGINAL_SOURCE_SYSTEM_ID 
FROM REPORT.CLIENTS_REFERRED_1_0  R
JOIN REPORT.VW_DASHBOARD_CONTRACTS DC ON R.FIRST_CONTRACT_KEY=DC.CONTRACT_KEY 
    AND DC.INCLUDE_FOR_EXEC_OPS_CLIENTS=1
WHERE R.REFERRED_DATE BETWEEN DATE_TRUNC(MONTH ,DATEADD(MONTH ,-13,CURRENT_DATE)) AND CURRENT_DATE
UNION ALL 
SELECT DISTINCT
DATE_TRUNC('MONTH',R.REFERRED_DATE) AS REFERRED_DATE,
R.CLIENT_KEY,
R.CLIENT_NUMBER ,
R.CLIENT_NAME ,
R.DAYS_TO_SERVICE ,
R.BRANCH_KEY, 
R.FIRST_CONTRACT_KEY AS CONTRACT_KEY,
R.FIRST_PARTNER_CONTRACT_SERVICE_KEY ,
R.TYPE,
R.SOURCE_SYSTEM_ID ,
R.ORIGINAL_SOURCE_SYSTEM_ID 
FROM REPORT.CLIENTS_REFERRED_2_0  R
JOIN DW_${var.SF_ENVIRONMENT}.HAH.FACT_PARTNER_CONTRACT_SERVICE PCS ON PCS.PARTNER_CONTRACT_SERVICE_KEY = R.FIRST_PARTNER_CONTRACT_SERVICE_KEY 
JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_SERVICES S ON PCS.SERVICE_KEY =S.SERVICE_KEY 
WHERE R.REFERRED_DATE BETWEEN DATE_TRUNC(MONTH ,DATEADD(MONTH,-13,CURRENT_DATE)) AND CURRENT_DATE
AND S.REVENUE_CATEGORY NOT IN ('CLS','CC','NA');
SQL
	or_replace = true 
	is_secure = false 
}

