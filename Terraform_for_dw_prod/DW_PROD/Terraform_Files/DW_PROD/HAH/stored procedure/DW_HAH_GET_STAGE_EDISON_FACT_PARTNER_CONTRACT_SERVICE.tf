resource "snowflake_procedure" "DW_HAH_GET_STAGE_EDISON_FACT_PARTNER_CONTRACT_SERVICE" {
	name ="GET_STAGE_EDISON_FACT_PARTNER_CONTRACT_SERVICE"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN

--*****************************************************************************************************************************
-- NAME:  EDISON FACT PARTNER CONTRACT SERVICE
--
-- PURPOSE: Populates Stage EDISON FACT FACT PARTNER CONTRACT SERVICE
--
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 03/21/23     Pankti Fadia              Initial version
-- 28/06/23     Sagar Gulghane            Changed service_key logic
-- 12/25/23		Shraddha Sejpal			  Added State
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.EDISON_FACT_PARTNER_CONTRACT_SERVICE

WITH CLIENT AS(
	SELECT * FROM(SELECT PATIENTID,MASTER_ID,AGENCYID,LASTNAME,FIRSTNAME,OFFICEID--,ADMISSIONID --,OFFICEID
					FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.CLIENT_MASTER_LIST)
	UNION
	SELECT * FROM(SELECT DISTINCT PATIENTID,MASTER_ID,AGENCYID,LASTNAME,FIRSTNAME,OFFICEID--,ADMISSIONID --,OFFICEID
					FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.CLIENT_MATCH_LIST WHERE PATIENTID NOT IN (
				  SELECT PATIENTID FROM	DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.CLIENT_MASTER_LIST) ))
	SELECT
		DISTINCT MD5(
		''EDISON'' || ''-'' || 
		ifnull(S.AGENCYID, -1) || ''-'' ||
		ifnull(PR.PAYERID, -1) || ''-'' ||
		IFNULL(S.CONTRACTID, -1) || ''-'' ||
		IFNULL(S.SERVICECODEID, -1) || ''-'' ||
		IFNULL(RS.REVENUE_SUBCATEGORY_CODE, ''1'') || ''-'' ||
		IFNULL(S.VISITTYPE, ''-1'') || ''-'' ||
		IFNULL(S.RATETYPETEXT, ''-1'') || ''-'' || ''EDISON'') AS PARTNER_CONTRACT_SERVICE_KEY,
		''17'' AS SOURCE_SYSTEM_ID,
		''EDISON'' AS SYSTEM_CODE,
		''NY'' AS STATE,
        MD5(''EDISON'' || ''-'' ||  COALESCE(PR.PAYERID,S.CONTRACTID,-1) || ''-'' || COALESCE(PR.CONTRACTID,PR.PAYERID,S.CONTRACTID,-1) || ''-'' || ''HHAEXCHANGE'') AS PARTNER_CONTRACT_KEY,
		COALESCE(PR.PAYERID,PR.CONTRACTID,S.CONTRACTID,-1) AS PARTNER_CODE,
		COALESCE(PR.PAYERNAME,S.CONTRACTNAME,''UNKNOWN'') AS PARTNER_NAME,
		COALESCE(PR.CONTRACTID,S.CONTRACTID,-1) AS CONTRACT_CODE,
		COALESCE(PR.PAYERNAME,S.CONTRACTNAME,''UNKNOWN'') AS CONTRACT_NAME,
		--MD5(''EDISON'' || ''-'' || S.SERVICECODEID || ''-'' || ''EDISON'') AS SERVICE_KEY,
        MD5(''EDISON'' || ''-'' || S.SERVICECODEID || ''-'' ||NVL(RS.REVENUE_SUBCATEGORY_CODE,''UNKNOWN'')|| ''-'' || ''EDISON'') AS SERVICE_KEY,
		S.SERVICECODEID AS SERVICECODE,
		S.SERVICECODE AS SERVICENAME,
		MD5(''EDISON'' || ''-'' || S.SERVICECODEID || ''-'' || NULLIF(RS.REVENUE_SUBCATEGORY_CODE,''-1'') || ''-'' || ''HHAEXCHANGE'') AS BILLING_KEY,
		S.SERVICECODE AS BILLING_CODE,
		S.CONTRACTNAME AS BILL_NAME,
		IFF(UPPER(S.SERVICECODE) LIKE ''%BILLABLE%'',0,1) AS BILLABLE_FLAG,
		COALESCE(S.RATETYPETEXT,''Hourly'') AS BILL_TYPE,
		IFF(BILL_TYPE=''Hourly'',CASE
			WHEN CR.UNITS = 1 THEN ''Hourly''
			WHEN CR.UNITS = 2 THEN ''Half Hours''
			WHEN CR.UNITS = 4 THEN ''Quarter Hours''
			ELSE NULL
		END,NULL) AS BILL_UOM,
		COALESCE(S.RATETYPETEXT,''Hourly'') AS SCHEDULE_TYPE,
		S.RATETYPETEXT AS SCHEDULE_UOM,
		IFF(UPPER(S.SERVICECODE) LIKE ''%BILLABLE%'',0,1) AS AUTHORIZATION_REQUIRED_FLAG,
		TRUE AS PAYABLE_FLAG,                       
		FALSE AS EXPENSE_FLAG,                    
		IFF(UPPER(VI.INCLUDEMILEAGEEXPENSE :: BOOLEAN) IS NULL,UPPER(FALSE :: BOOLEAN),UPPER(VI.INCLUDEMILEAGEEXPENSE :: BOOLEAN)) AS MILEAGE_FLAG,                       --Remaining
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
		:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP) :: timestamp_ntz as ETL_INSERTED_DATE,
		CURRENT_USER as ETL_INSERTED_BY,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP) :: timestamp_ntz as ETL_UPDATED_DATE,
		CURRENT_USER as ETL_LAST_UPDATED_BY,
		0 as ETL_DELETED_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.SERVICECODES S
--LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.PATIENTAUTHORIZATION PA 
--    ON S.CONTRACTID = PA.CONTRACTID
--	AND S.SERVICECODEID = PA.SERVICECODEID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.CONTRACTS C 
	ON S.CONTRACTID = C.CONTRACTID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.PAYER_REPL PR 
	ON IFNULL(PR.CONTRACTID, PR.PAYERID) = S.CONTRACTID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.CONTRACTRATES CR 
	ON s.SERVICECODEID = CR.SERVICECODEID
	AND CR.AGENCYID = S.AGENCYID
	AND CR.SERVICECODEID = S.SERVICECODEID
	AND CR.TODATE :: DATE > GETDATE()
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.VisitInfo_REPL VI 
	ON S.SERVICECODEID = VI.PRIMARYSERVICECODEID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.VISITAUTHORIZATIONS_REPL VA 
	ON VA.VISITID = VI.VISITID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.PATIENTAUTHORIZATION PA
	ON PA.AUTHORIZATIONID = VA.AUTHORIZATIONID 
--FULL JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.VW_EDISON_REVENUE_SEG RS ON
	-- RS.VISITID = VI.VISITID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.VW_EDISON_REVENUE_SEG RS ON
	RS.SERVICECODEID = VI.PRIMARYSERVICECODEID	;

RETURN ''SUCCESS'';
end;

 EOT
}

