resource "snowflake_procedure" "DW_HAH_GET_STAGE_ZENDESK_FACT_TICKET" {
	name ="GET_STAGE_ZENDESK_FACT_TICKET"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
  RETURN_RESULT VARCHAR(1000);
BEGIN
 --*****************************************************************************************************************************
-- NAME:  ZENDESK_FACT_TICKET
--
-- PURPOSE: Creates one row per TICKET according to ZENDESK 
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
--                                    Initial development
-- 12/18/2023  MIRISHA                ADDED TICKET_METRICS FIELDS,TICKET CUSTOM FIELDS AND TICKET FORM
-- 02/05/2024  MIRISHA                CHANGED WH_EMPLOYEE_KEY, BRANCH_KEY AND STATE FROM BL TO IL
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.ZENDESK_FACT_TICKET
WITH TICKET_CUSTOM_FIELDS AS (
SELECT  
      T.id AS TICKET_ID,
      SOURCE ,
      MAX(CASE WHEN f.value:id::string = ''1500012520922'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as Requester_Email,
       MAX(CASE WHEN f.value:id::string = ''1500012519802'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as Requester_Name,
      MAX(CASE WHEN f.value:id::string = ''1500012455641'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as Requester_Phone_Number,
     MAX( CASE WHEN f.value:id::string = ''16817002059415''AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END ) as Requester_Phone_Number_CALLMAX,
     MAX( CASE WHEN f.value:id::string = ''16458811127063'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END ) as caller_type_AH,
      MAX(CASE WHEN f.value:id::string = ''14373648858007'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as caller_type_Can_Care,
      MAX( CASE WHEN f.value:id::string = ''16458440367255'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as CASE_TYPE_AH,
      MAX(CASE WHEN f.value:id::string = ''6898839824791'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as FR_TICKET_TYPE,
        MAX(CASE WHEN f.value:id::string = ''6069102484759'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as RESOLUTION_COMMENT,
     MAX( CASE WHEN f.value:id::string = ''16459918526743'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as CALL_MAX_CALL_NOTES,
         MAX(CASE WHEN f.value:id::string = ''1500015488301'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as MARKET,
        MAX(CASE WHEN f.value:id::string = ''16148415266327'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as Caregiver_Name,
   MAX( CASE WHEN f.value:id::string = ''9278827248535'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as Client_Name,  
      MAX( CASE WHEN f.value:id::string = ''14768742892183'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as EMP_ID,
      MAX( CASE WHEN f.value:id::string = ''16148411092631'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END) as CLI_ID,
     MAX( CASE WHEN f.value:id::string = ''8298114147735'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as Work_Email,
     MAX( CASE WHEN f.value:id::string = ''7921676177943'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as EMAIL,
       MAX( CASE WHEN f.value:id::string = ''1900000589245'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as ASSIGNEE,
         MAX( CASE WHEN f.value:id::string = ''1500010739422'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as EMPLOYEE_TYPE,
        MAX( CASE WHEN f.value:id::string = ''5455195867415'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as ACC_PAY_TICKET_TYPE,
        MAX( CASE WHEN f.value:id::string = ''1500010509462'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as AMS_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''6899287080599'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as COPS_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''1500010492201'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as COUPA_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''1500015710861'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as DF_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''5402686591127'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as HR_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''12249042629783'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as HEALTHSTREAM_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''6196592498327'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as HEYMARKET_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''15502482397847'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as JF_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''5402970269335'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as LT_TICKET_TYPE,
      MAX( CASE WHEN f.value:id::string = ''17289777624599'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as ONB_TICKET_TYPE,
      MAX( CASE WHEN f.value:id::string = ''1900007167005'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as PARADOX_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''8297189640983'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as PROC_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''7923519994263'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as RISKCON_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''7923437585815'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as STR_LC_TICKET_TYPE,
       MAX( CASE WHEN f.value:id::string = ''7923342091031'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as SURV_TICKET_TYPE,
      MAX( CASE WHEN f.value:id::string = ''18023474402711'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as WORKDAY_TICKET_TYPE,
      MAX( CASE WHEN f.value:id::string = ''4656099147031'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as ZENDESK_TICKET_TYPE,
      MAX( CASE WHEN f.value:id::string = ''6830099472279'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as LAST_NAME,
       MAX( CASE WHEN f.value:id::string = ''14767655433623'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as full_legal_name,
 MAX( CASE WHEN f.value:id::string = ''7924876074007'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as FIRST_MIDDLE_LAST_NAME,
      MAX( CASE WHEN f.value:id::string = ''6829910081047'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as first_name,
      MAX( CASE WHEN f.value:id::string = ''13466589846679'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as total_time_spent,
       MAX( CASE WHEN f.value:id::string = ''13466557371031'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as time_spent_last_update,
        MAX( CASE WHEN f.value:id::string = ''1500010230042'' AND TRIM(f.value:value::string)<>'''' THEN  f.value:value::string 
          ELSE NULL
      END )as SYSTEM,
       MAX( CASE WHEN f.value:id::string = ''17893646264087'' AND TRIM(f.value:value::string)<>'''' THEN f.value:value::string 
          ELSE NULL
      END )as PROBLEM_TYPE
    FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.TICKETS T,
    LATERAL FLATTEN(input => T.CUSTOM_FIELDS) f
    GROUP BY 1,2),
  TICKET_TYPE_FORMATTING AS 
    (SELECT TICKET_ID,SOURCE ,
     IFF(TRIM(ZENDESK_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(ZENDESK_TICKET_TYPE,''_'','' ''))) AS ZENDESK_TICKET_TYPE ,
     IFF(TRIM(HEYMARKET_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(HEYMARKET_TICKET_TYPE,''_'','' ''))) AS HEYMARKET_TICKET_TYPE ,
     IFF(TRIM(WORKDAY_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(WORKDAY_TICKET_TYPE,''_'','' ''))) AS WORKDAY_TICKET_TYPE ,
     IFF(TRIM(SURV_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(SURV_TICKET_TYPE,''_'','' ''))) AS SURV_TICKET_TYPE ,
     IFF(TRIM(STR_LC_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(STR_LC_TICKET_TYPE,''_'','' ''))) AS STR_LC_TICKET_TYPE, 
     IFF(TRIM(RISKCON_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(RISKCON_TICKET_TYPE,''_'','' ''))) AS RISKCON_TICKET_TYPE, 
     IFF(TRIM(PROC_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(PROC_TICKET_TYPE,''_'','' ''))) AS PROC_TICKET_TYPE ,
     IFF(TRIM(PARADOX_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(PARADOX_TICKET_TYPE,''_'','' ''))) AS PARADOX_TICKET_TYPE, 
     IFF(TRIM(LT_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(LT_TICKET_TYPE,''_'','' ''))) AS LT_TICKET_TYPE,
     IFF(TRIM(ONB_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(ONB_TICKET_TYPE,''_'','' ''))) AS ONB_TICKET_TYPE,
     IFF(TRIM(JF_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(JF_TICKET_TYPE,''_'','' ''))) AS JF_TICKET_TYPE   ,
     IFF(TRIM(HEALTHSTREAM_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(HEALTHSTREAM_TICKET_TYPE,''_'','' ''))) AS HEALTHSTREAM_TICKET_TYPE ,
     IFF(TRIM(HR_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(HR_TICKET_TYPE,''_'','' ''))) AS HR_TICKET_TYPE ,
     IFF(TRIM(DF_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(DF_TICKET_TYPE,''_'','' ''))) AS DF_TICKET_TYPE ,
     IFF(TRIM(COUPA_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(COUPA_TICKET_TYPE,''_'','' ''))) AS COUPA_TICKET_TYPE, 
     IFF(TRIM(COPS_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(COPS_TICKET_TYPE,''_'','' ''))) AS COPS_TICKET_TYPE ,
     IFF(TRIM(AMS_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(AMS_TICKET_TYPE,''_'','' ''))) AS AMS_TICKET_TYPE ,
     IFF(TRIM(ACC_PAY_TICKET_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(ACC_PAY_TICKET_TYPE,''_'','' ''))) AS ACC_PAY_TICKET_TYPE ,
     CASE
     WHEN LEFT(CASE_TYPE_AH, 4) = ''cga_'' THEN ''Caregiver - '' ||REGEXP_REPLACE(REGEXP_REPLACE(INITCAP(SUBSTRING(CASE_TYPE_AH, 5)),''__'','' ''),''_'','' '')
     WHEN LEFT(CASE_TYPE_AH, 4) IN  (''gral'',''grl_'') THEN ''General - '' || REGEXP_REPLACE(REGEXP_REPLACE(INITCAP(SUBSTRING(CASE_TYPE_AH, 5)),''__'','' ''),''_'','' '')
     WHEN LEFT(CASE_TYPE_AH, 3) = ''hpc'' THEN ''High Priority Client - '' || REGEXP_REPLACE(REGEXP_REPLACE(INITCAP(SUBSTRING(CASE_TYPE_AH, 4)),''__'','' ''),''_'','' '')
     WHEN LEFT(CASE_TYPE_AH, 3) = ''req'' THEN ''Request - '' || REGEXP_REPLACE(REGEXP_REPLACE(INITCAP(SUBSTRING(CASE_TYPE_AH, 4)),''__'','' ''),''_'','' '')
     WHEN UPPER(TRIM(CASE_TYPE_AH)) IN (''X'',''XX'','' '','''') THEN NULL 
     ELSE  INITCAP(REGEXP_REPLACE(CASE_TYPE_AH, ''_'', '' ''))
     END AS CASE_TYPE_AH,
--     CASE
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''application_questions.*'') THEN ''Application Questions''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''branch_questions.*'') THEN ''Branch Questions''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''client_inquiries.*'') THEN ''Client Inquiries''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''client_matching_questions.*'') THEN ''Client Matching Questions''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''hr_issues.*'') THEN ''HR Issues''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''interest_in_becoming_a_caregiver.*'') THEN ''Interest in Becoming a Caregiver''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''interview_scheduling.*'') THEN ''Interview Scheduling''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''interview_no_show.*'') THEN ''Interview No Show''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''onboarding_help.*'') THEN ''Onboarding Help''
--     WHEN REGEXP_LIKE(TRIM(FR_TICKET_TYPE), ''orientation_help.*'') THEN ''Orientation Help''
--     WHEN UPPER(TRIM(FR_TICKET_TYPE)) IN (''X'',''XX'','' '','''') THEN NULL 
--     ELSE INITCAP(REGEXP_REPLACE(FR_TICKET_TYPE,''_'','' ''))
--     END AS FR_TICKET_TYPE
     CASE WHEN UPPER(TRIM(FR_TICKET_TYPE)) IN (''X'',''XX'','' '','''') THEN NULL 
     ELSE  INITCAP(REGEXP_REPLACE(REGEXP_REPLACE(TRIM(FR_TICKET_TYPE),''__'','' - ''),''_'','' ''))
      END AS FR_TICKET_TYPE
     FROM TICKET_CUSTOM_FIELDS
    ),
    CALLER_TYPE AS 
    (SELECT  
      TICKET_ID,
      SOURCE ,
      CASE 
      WHEN TRIM(caller_type_AH)=''case_manager_ahcaller'' THEN ''Case Manager - Payor''
      WHEN TRIM(caller_type_AH)=''doh_ahcaller'' THEN ''Dept of Health''
      WHEN TRIM(caller_type_AH) ='''' THEN NULL
      ELSE INITCAP(REGEXP_REPLACE(REGEXP_REPLACE((caller_type_AH),''_ahcaller'',''''),''_'','' '')) 
      END AS caller_type_AH,
      CASE WHEN UPPER(TRIM(caller_type_Can_Care)) IN (''X'','''') THEN NULL 
      ELSE INITCAP(REGEXP_REPLACE(REGEXP_REPLACE(caller_type_Can_Care,''_caller_type'',''''),''_'','' ''))
      END AS caller_type_Can_Care
      FROM TICKET_CUSTOM_FIELDS
    ),
    TICKET_FORM AS (
    SELECT
    DISTINCT 
    TF.ID  AS ticket_form_id,      
    TF.FORM_NAME  AS form_name
    FROM
   DISC_${var.SF_ENVIRONMENT}.ZENDESK.TICKET_FORMS TF
    )
SELECT DISTINCT 
	CASE T.SOURCE WHEN ''Payroll'' THEN ''ZENDESK_PAYROLL''
				  WHEN ''AMS'' THEN ''ZENDESK_AMS''	
				  END AS SYSTEM_CODE
	,MD5(''ZENDESK'' || ''-'' || T.ID  || ''-'' || T.SOURCE || ''-'' || ''ZENDESK'' ) AS TICKET_KEY 
	,T.ID	
	,25 AS SOURCE_SYSTEM_ID 
	,(VIA:channel::VARCHAR) VIA
	,T.STATUS
	,PRIORITY
	,T.TYPE
	,REQUESTER_ID
	,SUBMITTER_ID
	,DEM.EMPLOYEE_KEY AS WH_EMPLOYEE_KEY
	,MD5(''ZENDESK'' || ''-'' || REQUESTER_ID  || ''-'' || T.SOURCE || ''-'' || ''ZENDESK'' ) AS EMPLOYEE_KEY
	,MD5(''ZENDESK'' || ''-'' || SUBMITTER_ID  || ''-'' || T.SOURCE || ''-'' || ''ZENDESK'' ) AS SUBMITTER_KEY
	,T.ASSIGNEE_ID
	,NULLIF(TRIM(CONCAT(NVL(TRIM(EM_ASSIGNEE.EMPLOYEE_FIRST_NAME),''''),'' '',NVL(CONCAT(NULLIF(TRIM(EM_ASSIGNEE.EMPLOYEE_MIDDLE_NAME),''''),'' ''),''''),NVL(TRIM(EM_ASSIGNEE.EMPLOYEE_LAST_NAME),''''))),'''') AS ASSIGNEE_NAME
	,RECIPIENT
	,SATISFACTION_RATING:score::VARCHAR AS SATISFACTION_RATING 
	,T.IS_PUBLIC
	,SUBJECT
	,T.DESCRIPTION
	--,T.ORGANIZATION_ID
	,NULLIF(T.ORGANIZATION_ID::VARCHAR,''null'') AS ORGANIZATION_ID
	,COALESCE(DBM.BRANCH_KEY ,DEM.PRIMARY_BRANCH_KEY) AS BRANCH_KEY
	,COALESCE(DBM.OFFICE_STATE_CODE , DEM.PRIMARY_BRANCH_STATE) AS OFFICE_STATE_CODE
	,BRAND_ID
	,COLLABORATOR_IDS
	,EMAIL_CC_IDS
	,T.EXTERNAL_ID
	,FOLLOWER_IDS
	,FOLLOWUP_IDS
	,GROUP_ID
	,G."NAME" AS GROUP_TITLE
	,G.DESCRIPTION AS GROUP_DESCRIPTION
	,SHARING_AGREEMENT_IDS
	,T.TICKET_FORM_ID
	,TF.form_name AS TICKET_FORM_NAME
	,T.URL
	,T.CREATED_AT
	,T.UPDATED_AT,
	 TM.ID AS TKT_METRICS_ID,
	 TM.FIRST_RESOLUTION_TIME_IN_MINUTES_CALENDAR ,
	 TM.REPLY_TIME_IN_MINUTES_CALENDAR  ,
	 TM.FULL_RESOLUTION_TIME_IN_MINUTES_CALENDAR  ,
	 TM.REQUESTER_WAIT_TIME_IN_MINUTES_CALENDAR  ,
	 TM.ON_HOLD_TIME_IN_MINUTES_CALENDAR  ,
	 TM.AGENT_WAIT_TIME_IN_MINUTES_CALENDAR ,
	 TM.REOPENS ,
	 TM.REPLIES ,
	 TM.GROUP_STATIONS ,
	 TM.ASSIGNEE_STATIONS ,
	 TM.ASSIGNEE_UPDATED_AT ,
	 TM.REQUESTER_UPDATED_AT ,
	 TM.STATUS_UPDATED_AT ,
	 TM.INITIALLY_ASSIGNED_AT ,
	 TM.ASSIGNED_AT ,
	 TM.SOLVED_AT ,
	 TM.LATEST_COMMENT_ADDED_AT ,
	 TM.CUSTOM_STATUS_UPDATED_AT ,
     TM.URL AS URL_TKT_METRICS,
     IFF(TRIM(TCF.EMPLOYEE_TYPE) IN (''X'',''XX'','' '',''''),NULL,INITCAP(REGEXP_REPLACE(TCF.EMPLOYEE_TYPE,''_'','' ''))) AS EMPLOYEE_TYPE,
     COALESCE(CT.caller_type_AH,CT.caller_type_Can_Care) AS CALLER_TYPE,
     COALESCE(TCF.Requester_Name, CONCAT(TCF.FIRST_NAME,'' '',TCF.LAST_NAME) ,TCF.full_legal_name,TCF.FIRST_MIDDLE_LAST_NAME) AS REQUESTER_NAME,
     TCF.Requester_Phone_Number AS  REQUESTER_PHONE_NUMBER,
     TCF.Requester_Phone_Number_callmax AS REQUESTER_PHONE_NUMBER_CALLMAX,
     COALESCE(TCF.Requester_Email,TCF.EMAIL, TCF.WORK_EMAIL ) AS REQUESTER_EMAIL,
     IFF(LENGTH(TCF.Caregiver_Name)>200,NULL,TRIM(TCF.Caregiver_Name)) AS CAREGIVER_NAME,
     IFF(LENGTH(TCF.Client_Name)>200,NULL,TRIM(TCF.Client_Name)) AS CLIENT_NAME,
     TRIM(TCF.CALL_MAX_CALL_NOTES) AS CALL_MAX_CALL_NOTES,
     TCF.RESOLUTION_COMMENT AS RESOLUTION_COMMENT,
     TCF.total_time_spent AS TOTAL_TIME_SPENT, --SECONDS
     TCF.time_spent_last_update AS TIME_SPENT_LAST_UPDATE ,--SECONDS
     IFF(TRIM(TCF.SYSTEM) IN (''X'',''XX'',''''),NULL,INITCAP(REGEXP_REPLACE(REGEXP_REPLACE(TCF.SYSTEM,''__'','' ''),''_'','' ''))) AS SYSTEM,
     CASE WHEN GROUP_ID=''6518753925399'' THEN COALESCE(TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID IN(''17092458253847'',''1500005453101'') THEN COALESCE(TTF.AMS_TICKET_TYPE,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.ACC_PAY_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID IN(''1500006387982'',''4461823803415'',''5596042656023'',''4461854558615'',''14767992183447'',''14768037560599'') THEN COALESCE(TTF.HR_TICKET_TYPE,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID= ''16343545863191'' THEN COALESCE(TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID = ''17091091998103'' THEN COALESCE(TTF.ONB_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID=''1900000438625'' THEN COALESCE(TTF.COUPA_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID = ''7923701811095'' THEN COALESCE(TTF.RISKCON_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID IN (''16281007095063'',''16602634532631'') THEN COALESCE(TTF.CASE_TYPE_AH,TTF.FR_TICKET_TYPE,TTF.COPS_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID IN (''14372025488663'',''6899121317271'',''4416877110167'',''14372066702743'')  THEN COALESCE(TTF.FR_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        WHEN GROUP_ID = ''4461832458903'' THEN COALESCE(TTF.LT_TICKET_TYPE,TTF.FR_TICKET_TYPE,TTF.CASE_TYPE_AH,TTF.COPS_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        ELSE COALESCE(TTF.CASE_TYPE_AH,TTF.FR_TICKET_TYPE,TTF.COPS_TICKET_TYPE,TTF.ACC_PAY_TICKET_TYPE,TTF.AMS_TICKET_TYPE,TTF.COUPA_TICKET_TYPE,TTF.DF_TICKET_TYPE,TTF.HR_TICKET_TYPE,TTF.HEALTHSTREAM_TICKET_TYPE,TTF.HEYMARKET_TICKET_TYPE,TTF.JF_TICKET_TYPE,TTF.LT_TICKET_TYPE,TTF.ONB_TICKET_TYPE,TTF.PARADOX_TICKET_TYPE,TTF.PROC_TICKET_TYPE,TTF.RISKCON_TICKET_TYPE,TTF.STR_LC_TICKET_TYPE,TTF.SURV_TICKET_TYPE,TTF.WORKDAY_TICKET_TYPE,TTF.ZENDESK_TICKET_TYPE)
        END AS TICKET_CASE_TYPE,
     IFF(TCF.MARKET IN (''X'',''XX'','' '',''''),NULL, (INITCAP(REGEXP_REPLACE(TCF.MARKET,''_'','' '')))) AS MARKET,
     IFF(TCF.PROBLEM_TYPE IN (''X'',''XX'','' '',''''),NULL, (INITCAP(REGEXP_REPLACE(TCF.PROBLEM_TYPE,''_'','' '')))) AS PROBLEM_TYPE, 
    --ETL_FIELDS--
     :STR_ETL_TASK_KEY AS ETL_TASK_KEY,
     :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
     ,CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	 ,CURRENT_USER AS ETL_INSERTED_BY
	 ,CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
	 ,CURRENT_USER AS ETL_LAST_UPDATED_BY
	 ,0 AS ETL_DELETED_FLAG	
--
FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.TICKETS T
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.TICKET_METRICS TM
    ON TRIM(T.ID)= TRIM(TM.TICKET_ID) AND TM."SOURCE" =T.SOURCE
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.USER U
	ON T.REQUESTER_ID = U.ID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.GROUPS G
	ON T.GROUP_ID = G.ID
LEFT JOIN HAH.DIM_EMPLOYEE EM_ASSIGNEE
	ON EM_ASSIGNEE.EMPLOYEE_ID = T.ASSIGNEE_ID 
	AND EM_ASSIGNEE.SOURCE_SYSTEM_ID = 25
LEFT JOIN INTEGRATION.DIM_EMPLOYEE_MERGED DEM 
    ON DEM.EMPLOYEE_KEY = U.USER_FIELDS_EMPLOYEE_KEY 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.VW_ORGANIZATION_BRANCH_MAPPING BM 
	ON T.ORGANIZATION_ID = bm.id
LEFT JOIN INTEGRATION.DIM_BRANCH_MERGED DBM ON BM.BRANCH_KEY = DBM.ORIGINAL_BRANCH_KEY 
LEFT JOIN TICKET_CUSTOM_FIELDS TCF ON TCF.SOURCE = T.SOURCE AND TCF.TICKET_ID = T.ID	
LEFT JOIN TICKET_TYPE_FORMATTING TTF ON TTF.SOURCE = T.SOURCE AND TTF.TICKET_ID = T.ID
LEFT JOIN CALLER_TYPE CT ON CT.SOURCE = T.SOURCE AND CT.TICKET_ID = T.ID
LEFT JOIN TICKET_FORM TF ON TF.ticket_form_id  =T.TICKET_FORM_ID;

SELECT CONCAT (''MESSAGE : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
	RETURN return_result;
    END;
    
 EOT
}

