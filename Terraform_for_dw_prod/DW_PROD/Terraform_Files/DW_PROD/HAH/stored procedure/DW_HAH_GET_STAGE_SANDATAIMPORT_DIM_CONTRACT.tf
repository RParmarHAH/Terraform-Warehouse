resource "snowflake_procedure" "DW_HAH_GET_STAGE_SANDATAIMPORT_DIM_CONTRACT" {
	name ="GET_STAGE_SANDATAIMPORT_DIM_CONTRACT"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result VARCHAR;
BEGIN
    --*****************************************************************************************************************************
-- NAME:  SANDATAIMPORT_DIM_CONTRACT
--
-- PURPOSE: Creates one row per contract according to Sandata
--
-- PRODELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 02/13/20     Rachel Stewart         Initial PRODelopment
-- 03/26/20    Rachel Stewart          Added Billable, Payable and Mileage flags
-- 04/01/20		Mohd Kamaludin		 Added CDC
-- 06/30/20		Mir Ali				Added business defaults (all contracts assumed to be HC and Billable, payable, and non-mileage)
-- 09/14/20		Mir Ali				Added reference to new mapping table, FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING
-- 03/24/23		Darshan Gosai       Seprated SANDATA CARECOORIDNATE recrds on basis of system_code
--*****************************************************************************************************************************
--
INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.STAGE.SANDATAIMPORT_DIM_CONTRACT
WITH MAPPING AS (
    SELECT DISTINCT
		CA.ADMISSIONTYPE AS CONTRACT_CODE,
		CA.AGENCYID AS SYSTEM_CODE,
		COALESCE(M.CONTRACT_NAME, ''Unknown'') AS CONTRACT_NAME,
		CASE WHEN SANDATA_ADMSN.SERVICEID IN (''CARECO'',''VBPCG'')
				THEN ''CC''
			ELSE COALESCE(M.REVENUE_CATEGORY, ''HC'') END AS REVENUE_CATEGORY,
		CASE WHEN SANDATA_ADMSN.SERVICEID IN (''CARECO'',''VBPCG'')
				THEN ''CC''
			ELSE COALESCE(M.REVENUE_SUBCATEGORY_CODE, ''HC'')  END AS REVENUE_SUBCATEGORY_CODE,
		CASE WHEN  SANDATA_ADMSN.SERVICEID IN (''CARECO'',''VBPCG'')
			THEN ''CARE COORDINATE''
			ELSE COALESCE(M.REVENUE_SUBCATEGORY_NAME, ''HOME CARE'') END AS REVENUE_SUBCATEGORY_NAME,
		COALESCE(M.BILLABLE_FLAG, TRUE) AS BILLABLE_FLAG,
		COALESCE(M.PAYABLE_FLAG, TRUE) AS PAYABLE_FLAG,
		COALESCE(M.MILEAGE_FLAG, FALSE) AS MILEAGE_FLAG,
		CASE WHEN SANDATA_ADMSN.SERVICEID IN (''CARECO'',''VBPCG'')
			THEN ''CARECO''
			ELSE NULL END AS SERVICE
    FROM DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CA
    LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING M
    	ON M.SOURCE_SYSTEM_ID = 4 AND M.SYSTEM_CODE = CA.AGENCYID AND M.CONTRACT_CODE = CA.ADMISSIONTYPE
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_ADMISSIONSERVICES SANDATA_ADMSN 
    	ON SANDATA_ADMSN.ADMISSIONID = CA.ADMISSIONID
	WHERE CA.AGENCYID = ''8485''
	AND (CA.ETL_LAST_UPDATED_DATE >= :STR_CDC_START::timestamp_ntz 
	OR M.ETL_LAST_UPDATED_DATE >= :STR_CDC_START::timestamp_ntz)
)
SELECT
CASE WHEN SERVICE IN (''CARECO'')
			THEN md5(''CC_''||C.SYSTEM_CODE || ''-'' || C.CONTRACT_CODE || ''-''  ||  ''SANDATAIMPORT'')
		ELSE 
			md5(C.SYSTEM_CODE || ''-'' || C.CONTRACT_CODE || ''-''  ||  ''SANDATAIMPORT'') END AS CONTRACT_KEY
    , C.CONTRACT_CODE
    ,CASE WHEN SERVICE IN(''CARECO'') THEN  ''CC_''||C.SYSTEM_CODE ELSE C.SYSTEM_CODE END AS SYSTEM_CODE 
    ,4 AS SOURCE_SYSTEM_ID
    ,C.CONTRACT_NAME
    ,NULL AS SERVICE_CODE_ID
	,NULL AS SERVICE_KEY
    ,null AS DEFAULT_BILL_CODE -- Can get bill code from openSam but some are nulls
    ,null AS PAYROLL_CODE
    ,C.REVENUE_CATEGORY
	,C.REVENUE_SUBCATEGORY_CODE
	,C.REVENUE_SUBCATEGORY_NAME
    ,C.REVENUE_CATEGORY AS PAYOR_CODE
    ,C.REVENUE_CATEGORY || '' - '' || C.REVENUE_SUBCATEGORY_NAME AS PAYOR_DESCRIPTION
    ,C.REVENUE_CATEGORY AS SERVICE_LINE_CODE
    ,C.REVENUE_CATEGORY || '' - '' || C.REVENUE_SUBCATEGORY_NAME AS SERVICE_LINE_DESCRIPTION
    ,CASE WHEN C.SYSTEM_CODE = 8485 THEN ''PA'' WHEN C.SYSTEM_CODE = ''CC_8485'' THEN ''PA'' ELSE NULL END AS CONTRACT_STATE_CODE -- Get need to extrnal id table
    ,''1HR'' AS TIME_TRANSLATION_CODE
    ,1 AS TIME_TRANSLATION_DIVIDER
	,NULL AS PAY_TRAVELS_CODE         
    ,C.MILEAGE_FLAG AS MILEAGE_FLAG
    ,C.PAYABLE_FLAG AS PAYABLE_FLAG
    ,C.BILLABLE_FLAG AS BILLABLE_FLAG
	,NULL AS BILLED_BY_QUARTER_HOURS
	,NULL AS BILLED_BY_HALF_HOURS
    ,TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE
    ,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE
    ---- ETL FIELDS ----
    ,:STR_ETL_TASK_KEY AS ETL_TASK_KEY
	,:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
    ,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
    CURRENT_USER as ETL_INSERTED_BY ,
    convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE,
    CURRENT_USER as ETL_LAST_UPDATED_BY,
    0 as ETL_DELETED_FLAG,
    0 AS ETL_INFERRED_MEMBER_FLAG
 FROM MAPPING AS C
;
    SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

    return return_result;
END;
    
 EOT
}

