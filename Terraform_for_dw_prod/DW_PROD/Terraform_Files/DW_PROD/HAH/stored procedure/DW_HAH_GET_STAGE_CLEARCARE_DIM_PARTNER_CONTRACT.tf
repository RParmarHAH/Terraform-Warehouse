resource "snowflake_procedure" "DW_HAH_GET_STAGE_CLEARCARE_DIM_PARTNER_CONTRACT" {
	name ="GET_STAGE_CLEARCARE_DIM_PARTNER_CONTRACT"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
    --*****************************************************************************************************************************
-- NAME:  CLEARCARE_DIM_PARTNER_CONTRACT
--
-- PURPOSE: Creates one row per PARTNER_CONTRACT according to CLEARCARE
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 20/10/23     SAGAR GULGHANE          Initial development
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.CLEARCARE_DIM_PARTNER_CONTRACT
SELECT DISTINCT MD5(''CLEARCARE'' || ''-''|| NVL(PCM.PAYOR_ID,-1) || ''-''|| CA.BILL_RATE_NAME || ''-''|| CA.BILL_RATE_TYPE || ''-''|| ''CLEARCARE'' ) AS PARTNER_CONTRACT_KEY,
      16 AS SOURCE_SYSTEM_ID,
      ''CLEARCARE'' AS SYSTEM_CODE,
	16 AS ORIGINAL_SOURCE_SYSTEM_ID,
      ''CLEARCARE'' AS ORIGINAL_SYSTEM_CODE,
      ''OH'' AS STATE,
       MD5(PCM.SYSTEM_CODE||''-''||NVL(PCM.PAYOR_ID,-1)||''-''||''CLEARCARE'') AS PARTNER_KEY,
      NVL(PCM.PAYOR_ID,-1),
      COALESCE(DPP.PAYOR_NAME,''UNKNOWN''),      
    CASE WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 4 THEN ''Non-Billable''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 3 THEN ''Live-In''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 2 THEN ''Per-Visit''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 1 THEN ''Hourly''
         ELSE CA.BILL_RATE_NAME 
    END AS CONTRACT_CODE,
    CASE WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 4 THEN ''Non-Billable''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 3 THEN ''Live-In''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 2 THEN ''Per-Visit''
         WHEN CA.BILL_RATE_NAME = '''' AND CA.BILL_RATE_TYPE = 1 THEN ''Hourly''
         ELSE CA.BILL_RATE_NAME END  AS CONTRACT_NAME,
    TRUE AS ACTIVE_FLAG,
   TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS START_DATE,
	    TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS END_DATE
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	 	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	    , Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY
	 	, 0 AS ETL_DELETED_FLAG
   FROM
    DISC_${var.SF_ENVIRONMENT}.CLEARCARE.CARELOGS_CARELOG CA
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.BILLING_CLIENTAUTHORIZATION AU  
      ON AU.CLIENT_ID=CA.PATIENT_ID AND AU.AGENCY_ID =CA.AGENCY_ID 
 AND AU.ID =CA.AUTHORIZATION_ID::VARCHAR --AND AU.BILL_RATE_ID =CA.BILL_RATE_OBJ_ID AND AU.START_DATE BETWEEN CA.CLOCK_IN AND CA.CLOCK_OUT
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = CA.PATIENT_ID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.AGENCY_AGENCYLOCATION AG ON AG.ID = PA.LOCATION_ID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.PROFILE_PARENTPAYERSERVICE PP ON
    PP.id = AU.service_id
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.BILLING_BILLRATE BR ON
    AU.BILL_RATE_ID = BR.ID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.PAYOR_contract_UI.PAYOR_contract_MAPPING PCM ON
    CASE
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 4 THEN ''Non-Billable''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 3 THEN ''Live-In''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 2 THEN ''Visit''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 1 THEN ''Hourly''
        ELSE CA.BILL_RATE_NAME
    END = PCM.CONTRACT_CODE AND PCM.ORIGINAL_SOURCE_SYSTEM_ID=16
LEFT JOIN  DISC_${var.SF_ENVIRONMENT}.PAYOR_CONTRACT_UI.PAYOR AS DPP  ON PCM.PAYOR_ID = DPP.PAYOR_ID   
WHERE CA.AGENCY_ID =2459
        UNION 
        SELECT 
            DISTINCT MD5(''CLEARCARE'' || ''-''|| NVL(PCM.PAYOR_ID,-1) || ''-''|| BR.NAME || ''-''|| COALESCE(AU.BILL_RATE_METHOD  ,''-1'')  || ''-''||''CLEARCARE'' ) AS PARTNER_CONTRACT_KEY,
          16 AS SOURCE_SYSTEM_ID,
      ''CLEARCARE'' AS SYSTEM_CODE,
		16 AS ORIGINAL_SOURCE_SYSTEM_ID,
      ''CLEARCARE'' AS ORIGINAL_SYSTEM_CODE,
     ''OH'' AS STATE,
    MD5(PCM.SYSTEM_CODE||''-''||NVL(PCM.PAYOR_ID,-1)||''-''||''CLEARCARE'') AS PARTNER_KEY,
      NVL(PCM.PAYOR_ID,-1),
      COALESCE(DPP.PAYOR_NAME,''UNKNOWN''),  
      BR.NAME AS CONTRACT_CODE,
      BR.NAME AS CONTRACT_NAME,
      TRUE AS ACTIVE_FLAG, 
	 TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS START_DATE,
	    TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS END_DATE
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	 	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	    , Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY
	 	, 0 AS ETL_DELETED_FLAG
 FROM  DISC_${var.SF_ENVIRONMENT}.CLEARCARE.BILLING_BILLRATE BR 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.BILLING_CLIENTAUTHORIZATION AU 
ON AU.BILL_RATE_ID = BR.ID 
  LEFT JOIN   DISC_${var.SF_ENVIRONMENT}.CLEARCARE.CARELOGS_CARELOG CA ON AU.ID = CA.AUTHORIZATION_ID
-- ON AU.CLIENT_ID=CA.PATIENT_ID AND AU.AGENCY_ID =CA.AGENCY_ID 
-- AND AU.AUTHORIZATION_ID =CA.AUTHORIZATION_ID::VARCHAR AND AU.BILL_RATE_ID =CA.BILL_RATE_OBJ_ID AND AU.START_DATE BETWEEN CA.CLOCK_IN AND CA.CLOCK_OUT 
--LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.BILLING_CLIENTAUTHORIZATION AU 
--    --AU.ID = CA.AUTHORIZATION_ID AND AU.AGENCY_ID=CA.AGENCY_ID   
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = CA.PATIENT_ID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.AGENCY_AGENCYLOCATION AG ON AG.ID = PA.LOCATION_ID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.CLEARCARE.PROFILE_PARENTPAYERSERVICE PP ON
    PP.id = AU.service_id
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.PAYOR_contract_UI.PAYOR_contract_MAPPING PCM ON
      CASE
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 4 THEN ''Non-Billable''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 3 THEN ''Live-In''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 2 THEN ''Visit''
        WHEN CA.BILL_RATE_NAME = ''''
        AND CA.BILL_RATE_TYPE = 1 THEN ''Hourly''
        ELSE CA.BILL_RATE_NAME
    END = PCM.CONTRACT_CODE AND PCM.ORIGINAL_SOURCE_SYSTEM_ID=16
LEFT JOIN  DISC_${var.SF_ENVIRONMENT}.PAYOR_CONTRACT_UI.PAYOR AS DPP  ON PCM.PAYOR_ID = DPP.PAYOR_ID WHERE AG.AGENCY_ID =2459;
	
return ''SUCCESS'';
END;

 EOT
}

