resource "snowflake_procedure" "DW_HAH_GET_STAGE_SANDATAIMPORT_DIM_PARTNER_CONTRACT" {
	name ="GET_STAGE_SANDATAIMPORT_DIM_PARTNER_CONTRACT"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
    --*****************************************************************************************************************************
-- NAME:  SANDATAIMPORT_DIM_PARTNER_CONTRACT
--
-- PURPOSE: Creates one row per PARTNER CONTRACT according to SANDATA
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 04/03/23    VIJAY SHARMA          Initial development
-- 04/07/23	VIJAY SHARMA		  Modified logic to include contracts from Sandata visits, BI_REPOSITORY Visits and Client admissions
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.SANDATAIMPORT_DIM_PARTNER_CONTRACT
--Taken partner contracts from Client admissions
SELECT DISTINCT  
CASE WHEN AUTH.SERVICEID IN (''CARECO'' , ''VBPCG'')
THEN MD5(''CC_''||IFNULL(CA.AGENCYID,''-1'') || ''-'' || IFNULL(AUTH.PAYORID,''-1'') || ''-'' || 
IFNULL(CA.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' || ''SANDATAIMPORT'') 
ELSE MD5(IFNULL(CA.AGENCYID,''-1'') || ''-'' || IFNULL(AUTH.PAYORID,''-1'') || ''-'' || 
IFNULL(CA.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' || ''SANDATAIMPORT'')
END AS PARTNER_CONTRACT_KEY,
4 AS SOURCE_SYSTEM_ID,
CASE WHEN AUTH.SERVICEID IN (''CARECO'' , ''VBPCG'')	
		THEN ''CC_''||CA.AGENCYID
		ELSE IFNULL(CA.AGENCYID,''-1'') END AS SYSTEM_CODE,
''PA'' AS STATE,
MD5(IFNULL(P.PAYORID,-1) || ''-'' || ''SANDATAIMPORT'') AS PARTNER_KEY,
COALESCE(P.PAYORID , ''-1'') AS PARTNER_CODE, --?
COALESCE(P."NAME" , ''UNKNOWN'') AS PARTNER_NAME,
COALESCE(CA.ADMISSIONTYPE, ''UNKNOWN'') AS CONTRACT_CODE,
COALESCE(M.CONTRACT_NAME, ''Unknown'') AS CONTRACT_NAME,
TRUE AS ACTIVE_FLAG, --? 
TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS START_DATE, --? 
TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS END_DATE --? 
	---- ETL FIELDS ----
	, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	, CURRENT_USER AS ETL_INSERTED_BY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
	, CURRENT_USER AS ETL_LAST_UPDATED_BY
	, 0 AS ETL_DELETED_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CA
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_AUTHORIZATIONS AUTH
	    	ON AUTH.ADMISSIONID =CA.ADMISSIONID AND AUTH.AGENCYID=CA.AGENCYID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_PAYORS P ON P.PAYORID = AUTH.PAYORID AND P.AGENCYID =8485
LEFT JOIN HAH.FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING M
    	ON M.SOURCE_SYSTEM_ID = 4 AND M.SYSTEM_CODE = CA.AGENCYID AND M.CONTRACT_CODE = CA.ADMISSIONTYPE
WHERE CA.AGENCYID = ''8485''
UNION
--Taken partner contracts from Sandata visits
SELECT DISTINCT 
CASE WHEN F.SERVICEID IN (''CARECO'' , ''VBPCG'')
THEN MD5(''CC_''||IFNULL(CA.AGENCYID,''-1'') || ''-'' || IFNULL(INV_H.PAYORID,''-1'') || ''-'' || 
IFNULL(CA.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' || ''SANDATAIMPORT'') 
ELSE MD5(IFNULL(CA.AGENCYID,''-1'') || ''-'' || IFNULL(INV_H.PAYORID,''-1'') || ''-'' || 
IFNULL(CA.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' || ''SANDATAIMPORT'') 
END AS PARTNER_CONTRACT_KEY,
4 AS SOURCE_SYSTEM_ID,
CASE WHEN F.SERVICEID IN (''CARECO'' , ''VBPCG'') AND CA.AGENCYID IS NOT NULL
		THEN ''CC_''||CA.AGENCYID
		ELSE IFNULL(CA.AGENCYID,''-1'') END AS SYSTEM_CODE,
''PA'' AS STATE,
MD5(IFNULL(P.PAYORID,-1) || ''-'' || ''SANDATAIMPORT'') AS PARTNER_KEY,
COALESCE(P.PAYORID , ''-1'') AS PARTNER_CODE, --?
COALESCE(P."NAME" , ''UNKNOWN'') AS PARTNER_NAME,
COALESCE(CA.ADMISSIONTYPE, ''UNKNOWN'') AS CONTRACT_CODE,
COALESCE(M.CONTRACT_NAME, ''Unknown'') AS CONTRACT_NAME,
TRUE AS ACTIVE_FLAG, --? 
TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS START_DATE, --? 
TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS END_DATE --? 
	---- ETL FIELDS ----
	, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	, CURRENT_USER AS ETL_INSERTED_BY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
	, CURRENT_USER AS ETL_LAST_UPDATED_BY
	, 0 AS ETL_DELETED_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_VISITS F
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CA
	ON CA.AGENCYID = F.AGENCYID AND CA.ADMISSIONID = F.ADMISSIONID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_INVOICEHEADER INV_H ON INV_H.INVOICENUMBER =F.INVOICENUMBER AND INV_H.AGENCYID =8485 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_AUTHORIZATIONS AUTH
	    	ON AUTH.ADMISSIONID =CA.ADMISSIONID AND AUTH.AGENCYID=CA.AGENCYID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_PAYORS P ON P.PAYORID = INV_H.PAYORID AND P.AGENCYID =8485
LEFT JOIN HAH.FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING M
    	ON M.SOURCE_SYSTEM_ID = 4 AND M.SYSTEM_CODE = CA.AGENCYID AND M.CONTRACT_CODE = CA.ADMISSIONTYPE
WHERE F.AGENCYID = ''8485''
UNION 
--Taken partner contracts from BI_REPOSITORY Visits
SELECT DISTINCT  
CASE WHEN SV.SERVICEID IN (''CARECO'' , ''VBPCG'')
THEN MD5(''CC_''||IFNULL(CAD.AGENCYID,''-1'') || ''-'' || IFNULL(P.PAYORID,''-1'') || ''-'' || 
IFNULL(CAD.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' || ''SANDATAIMPORT'') 
ELSE MD5(IFNULL(CAD.AGENCYID,''-1'') || ''-'' || IFNULL(P.PAYORID,''-1'') || ''-'' || 
IFNULL(CAD.ADMISSIONTYPE , ''UNKNOWN'') || ''-'' ||''SANDATAIMPORT'') 
END AS PARTNER_CONTRACT_KEY,
4 AS SOURCE_SYSTEM_ID,
CASE WHEN SV.SERVICEID IN (''CARECO'' , ''VBPCG'') AND CAD.AGENCYID IS NOT NULL
		THEN ''CC_''||CAD.AGENCYID
		ELSE IFNULL(CAD.AGENCYID,''-1'') END AS SYSTEM_CODE,
''PA'' AS STATE,
MD5(IFNULL(P.PAYORID,-1) || ''-'' || ''SANDATAIMPORT'') AS PARTNER_KEY,
COALESCE(P.PAYORID , ''-1'') AS PARTNER_CODE, --?
COALESCE(P."NAME" , ''UNKNOWN'') AS PARTNER_NAME,
COALESCE(CAD.ADMISSIONTYPE, ''UNKNOWN'') AS CONTRACT_CODE,
COALESCE(M.CONTRACT_NAME, ''Unknown'') AS CONTRACT_NAME,
TRUE AS ACTIVE_FLAG, --? 
TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS START_DATE, --? 
TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS END_DATE --? 
	---- ETL FIELDS ----
	, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	, CURRENT_USER AS ETL_INSERTED_BY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
	, CURRENT_USER AS ETL_LAST_UPDATED_BY
	, 0 AS ETL_DELETED_FLAG	
FROM DISC_${var.SF_ENVIRONMENT}.BI_REPOSITORY.SANDATAVISITS SV
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CAD
	ON SV.AGENCYID = CAD.AGENCYID AND SV.ADMISSIONID = CAD.ADMISSIONID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_PAYORS P ON P."NAME" = SV.PAYORNAME AND P.AGENCYID =8485
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.SANDATAIMPORT.SANDATA_AUTHORIZATIONS AUTH
	    	ON AUTH.ADMISSIONID =CAD.ADMISSIONID AND AUTH.AGENCYID=CAD.AGENCYID 
LEFT JOIN HAH.FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING M
    	ON M.SOURCE_SYSTEM_ID = 4 AND M.SYSTEM_CODE = CAD.AGENCYID AND M.CONTRACT_CODE = CAD.ADMISSIONTYPE
WHERE SV.AGENCYID = ''8485'';

return ''SUCCESS'';
END;

 EOT
}

