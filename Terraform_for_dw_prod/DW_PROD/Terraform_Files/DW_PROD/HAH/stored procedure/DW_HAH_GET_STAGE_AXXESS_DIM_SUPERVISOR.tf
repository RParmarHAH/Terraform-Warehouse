resource "snowflake_procedure" "DW_HAH_GET_STAGE_AXXESS_DIM_SUPERVISOR" {
	name ="GET_STAGE_AXXESS_DIM_SUPERVISOR"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   ------------------------------------------------------------------------------------------
-- 01/06/22    Abhishek Sunil        Initial Development
-- 04/25/22    Parag Gajjar          Logic Change
-- 05/04/22    Parag Gajjar          Dedup Leverage
-- 02/05/24	   Shraddha Sejpal		 Removed NVL function from Supervisor_Key
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.AXXESS_DIM_SUPERVISOR
WITH EMP_DEDUPE --- ADDED BY PJSHAH ON 07/01
AS
(
  SELECT * FROM 
	(
		SELECT MASTER_ID, EMPLOYEE_ID, (FIRST_NAME || ''  '' || LAST_NAME) AS EMP_NAME, ADDRESS_STATECODE
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.AXXESS.EMPLOYEE_MASTER_LIST  --DISC_DEDUPE_${var.SF_ENVIRONMENT}.ASR.CLIENT_MASTER_LIST 
	)
	UNION
	SELECT * FROM 
	(
		SELECT  MASTER_ID, EMPLOYEE_ID, (FIRST_NAME || ''  '' || LAST_NAME) AS EMP_NAME, ADDRESS_STATECODE
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.AXXESS.EMPLOYEE_MATCH_LIST  --DISC_DEDUPE_${var.SF_ENVIRONMENT}.ASR.CLIENT_MATCH_LIST 
		WHERE EMPLOYEE_ID NOT IN (SELECT EMPLOYEE_ID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.AXXESS.EMPLOYEE_MASTER_LIST)	
	)
)
SELECT DISTINCT
		
        MD5(''PRIME'' || ''-'' || UPPER(TRIM(PV.CASE_MANAGER_ID)) || ''-'' || ''AXXESS'') AS SUPERVISOR_KEY, 
 	 	PV.CASE_MANAGER_ID AS SUPERVISOR_CODE, 
		''PRIME'' AS SYSTEM_CODE, 
		14 AS SOURCE_SYSTEM_ID, 
		UPPER(TRIM(EMP.EMP_NAME)) AS SUPERVISOR_NAME,  -- ADDED BY PJSHAH ON 07/1 
        EMP.ADDRESS_STATECODE AS SUPERVISOR_STATE_CODE, 
		NULL SUPERVISOR_JOB_CODE,
		NULL SUPERVISOR_JOB_TITLE,
		TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE,
	    TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
   		:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
	    convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
	    CURRENT_USER as ETL_INSERTED_BY ,
	    convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE,
	    CURRENT_USER as ETL_LAST_UPDATED_BY,
	    0 as ETL_DELETED_FLAG,
	    0 AS ETL_INFERRED_MEMBER_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.AXXESS.VW_AXXESS_HH_VISITS_UPPER PV 
LEFT JOIN EMP_DEDUPE EMP ON EMP.EMPLOYEE_ID=PV.CASE_MANAGER_ID
WHERE PV.CASE_MANAGER_ID IS NOT NULL

UNION ALL

--HOMECARE DATA 

SELECT DISTINCT		
        MD5(''PRIME'' || ''-'' || UPPER(TRIM(TD.CAREPERIOD_CASEMANAGER_ID)) || ''-'' || ''AXXESS'') AS SUPERVISOR_KEY,  --Pankti M.
 	 	TD.CAREPERIOD_CASEMANAGER_ID AS SUPERVISOR_CODE,
		''PRIME'' AS SYSTEM_CODE,
		14 AS SOURCE_SYSTEM_ID,
--		UPPER(TRIM(CP.CAREPERIOD_CASEMANAGER_NAME)) AS SUPERVISOR_NAME,
--		CP.PHYSICIAN_STATE_CODE AS SUPERVISOR_STATE_CODE,
		UPPER(TRIM(EMP.EMP_NAME)) AS SUPERVISOR_NAME, -- ADDED BY Pinkal ON 08/02 
		EMP.ADDRESS_STATECODE AS SUPERVISOR_STATE_CODE, --Added By Pinkal ON 08/02
		NULL SUPERVISOR_JOB_CODE,
		NULL SUPERVISOR_JOB_TITLE,
		TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE,
	    TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
   		:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
        CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE,
        CURRENT_USER AS ETL_INSERTED_BY,
        CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE,
        CURRENT_USER AS ETL_LAST_UPDATED_BY,
        0 AS ETL_DELETED_FLAG,
	    0 AS ETL_INFERRED_MEMBER_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.AXXESS.VW_AXXESS_HC_TASKDETAILS TD
LEFT JOIN EMP_DEDUPE EMP ON EMP.EMPLOYEE_ID = TD.CAREPERIOD_CASEMANAGER_ID
WHERE TD.CAREPERIOD_CASEMANAGER_ID IS NOT NULL;
RETURN ''SUCCESS'';
end;                        

 EOT
}

