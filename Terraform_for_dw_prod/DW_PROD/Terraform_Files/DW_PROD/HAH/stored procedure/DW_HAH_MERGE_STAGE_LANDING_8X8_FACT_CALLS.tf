resource "snowflake_procedure" "DW_HAH_MERGE_STAGE_LANDING_8X8_FACT_CALLS" {
	name ="MERGE_STAGE_LANDING_8X8_FACT_CALLS"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
  RETURN_RESULT VARCHAR(1000);
BEGIN
    MERGE INTO HAH.FACT_CALLS TGT 
	USING STAGE.LANDING_8X8_FACT_CALLS STG 
	ON TGT.CALL_KEY = STG.CALL_KEY
	WHEN MATCHED THEN 
	UPDATE SET 
		TGT.SYSTEM_CODE = STG.SYSTEM_CODE,
TGT.CALL_KEY = STG.CALL_KEY,
TGT.CALL_ID = STG.CALL_ID,
TGT.SOURCE_SYSTEM_ID = STG.SOURCE_SYSTEM_ID,
TGT.AGENT_KEY = STG.AGENT_KEY,
TGT.CALLER_KEY = STG.CALLER_KEY,
TGT.TICKET_KEY = STG.TICKET_KEY,
TGT.TICKET_ID = STG.TICKET_ID,
TGT.AGENT_ID = STG.AGENT_ID,
TGT.CALLER_ID = STG.CALLER_ID,
TGT.CALL_GROUP_ID = STG.CALL_GROUP_ID,
TGT.GROUP_TITLE = STG.GROUP_TITLE,
TGT.GROUP_DESCRIPTION = STG.GROUP_DESCRIPTION,
TGT.ORGANIZATION_ID = STG.ORGANIZATION_ID,
TGT.BRANCH_KEY = STG.BRANCH_KEY,
TGT.OFFICE_STATE_CODE = STG.OFFICE_STATE_CODE,
TGT.CALL_CHARGE = STG.CALL_CHARGE,
TGT.COMPLETION_STATUS = STG.COMPLETION_STATUS,
TGT.DIRECTION = STG.DIRECTION,
TGT.DURATION = STG.DURATION,
TGT.EXCEEDED_QUEUE_WAIT_TIME = STG.EXCEEDED_QUEUE_WAIT_TIME,
TGT.HOLD_TIME = STG.HOLD_TIME,
TGT.MINUTES_BILLED = STG.MINUTES_BILLED,
TGT.PHONE_NUMBER_ID = STG.PHONE_NUMBER_ID,
TGT.PHONE_NUMBER = STG.PHONE_NUMBER,
TGT.TIME_TO_ANSWER = STG.TIME_TO_ANSWER,
TGT.VOICEMAIL = STG.VOICEMAIL,
TGT.WAIT_TIME = STG.WAIT_TIME,
TGT.WRAP_UP_TIME = STG.WRAP_UP_TIME,
TGT.TALK_TIME = STG.TALK_TIME,
TGT.CONSULTATION_TIME = STG.CONSULTATION_TIME,
TGT.OUTSIDE_BUSINESS_HOURS = STG.OUTSIDE_BUSINESS_HOURS,
TGT.CALLBACK = STG.CALLBACK,
TGT.DEFAULT_GROUP = STG.DEFAULT_GROUP,
TGT.LINE_ID = STG.LINE_ID,
TGT.LINE_TYPE = STG.LINE_TYPE,
TGT.CALL_CHANNEL = STG.CALL_CHANNEL,
TGT.QUALITY_ISSUES = STG.QUALITY_ISSUES,
TGT.CREATED_AT = STG.CREATED_AT,
TGT.TIME_BRACKET = STG.TIME_BRACKET,
TGT.UPDATED_AT = STG.UPDATED_AT,
TGT.DNIS = STG.DNIS,
TGT.AA_DESTINATION = STG.AA_DESTINATION,
TGT.CALL_START_DATE = STG.CALL_START_DATE,
TGT.CALL_START_TIME = STG.CALL_START_TIME,
TGT.CALL_DISCONNECTED_DATE = STG.CALL_DISCONNECTED_DATE,
TGT.CALL_DISCONNECTED_TIME = STG.CALL_DISCONNECTED_TIME,
TGT.CALLEE_DISCONNECT_ON_HOLD = STG.CALLEE_DISCONNECT_ON_HOLD,
TGT.CALLER_DISCONNECT_ON_HOLD = STG.CALLER_DISCONNECT_ON_HOLD,
TGT.CALL_ANSWERED_DATE = STG.CALL_ANSWERED_DATE,
TGT.CALL_ANSWERED_TIME = STG.CALL_ANSWERED_TIME,
TGT.CALL_LEG_COUNT = STG.CALL_LEG_COUNT,
TGT.RING_DURATION = STG.RING_DURATION,
TGT.ABANDONED_TIME = STG.ABANDONED_TIME,
TGT.DEPARTMENTS = STG.DEPARTMENTS,
TGT.BRANCHES = STG.BRANCHES,
TGT.CALLER_NAME = STG.CALLER_NAME,
TGT.CALLEE_NAME = STG.CALLEE_NAME,
TGT.WH_EMPLOYEE_KEY = STG.WH_EMPLOYEE_KEY,
TGT.ETL_TASK_KEY = STG.ETL_TASK_KEY,
TGT.ETL_INSERTED_TASK_KEY = STG.ETL_INSERTED_TASK_KEY,
TGT.ETL_INSERTED_DATE = STG.ETL_INSERTED_DATE,
TGT.ETL_INSERTED_BY = STG.ETL_INSERTED_BY,
TGT.ETL_LAST_UPDATED_DATE = STG.ETL_LAST_UPDATED_DATE,
TGT.ETL_LAST_UPDATED_BY = STG.ETL_LAST_UPDATED_BY,
TGT.ETL_DELETED_FLAG = STG.ETL_DELETED_FLAG  
	WHEN NOT MATCHED THEN 
	INSERT (
		SYSTEM_CODE,
CALL_KEY,
CALL_ID,
SOURCE_SYSTEM_ID,
AGENT_KEY,
CALLER_KEY,
TICKET_KEY,
TICKET_ID,
AGENT_ID,
CALLER_ID,
CALL_GROUP_ID,
GROUP_TITLE,
GROUP_DESCRIPTION,
ORGANIZATION_ID,
BRANCH_KEY,
OFFICE_STATE_CODE,
CALL_CHARGE,
COMPLETION_STATUS,
DIRECTION,
DURATION,
EXCEEDED_QUEUE_WAIT_TIME,
HOLD_TIME,
MINUTES_BILLED,
PHONE_NUMBER_ID,
PHONE_NUMBER,
TIME_TO_ANSWER,
VOICEMAIL,
WAIT_TIME,
WRAP_UP_TIME,
TALK_TIME,
CONSULTATION_TIME,
OUTSIDE_BUSINESS_HOURS,
CALLBACK,
DEFAULT_GROUP,
LINE_ID,
LINE_TYPE,
CALL_CHANNEL,
QUALITY_ISSUES,
CREATED_AT,
TIME_BRACKET,
UPDATED_AT,
DNIS,
AA_DESTINATION,
CALL_START_DATE,
CALL_START_TIME,
CALL_DISCONNECTED_DATE,
CALL_DISCONNECTED_TIME,
CALLEE_DISCONNECT_ON_HOLD,
CALLER_DISCONNECT_ON_HOLD,
CALL_ANSWERED_DATE,
CALL_ANSWERED_TIME,
CALL_LEG_COUNT,
RING_DURATION,
ABANDONED_TIME,
DEPARTMENTS,
BRANCHES,
CALLER_NAME,
CALLEE_NAME,
WH_EMPLOYEE_KEY,
ETL_TASK_KEY,
ETL_INSERTED_TASK_KEY,
ETL_INSERTED_DATE,
ETL_INSERTED_BY,
ETL_LAST_UPDATED_DATE,
ETL_LAST_UPDATED_BY,
ETL_DELETED_FLAG
		) 
	VALUES (
		STG.SYSTEM_CODE,
STG.CALL_KEY,
STG.CALL_ID,
STG.SOURCE_SYSTEM_ID,
STG.AGENT_KEY,
STG.CALLER_KEY,
STG.TICKET_KEY,
STG.TICKET_ID,
STG.AGENT_ID,
STG.CALLER_ID,
STG.CALL_GROUP_ID,
STG.GROUP_TITLE,
STG.GROUP_DESCRIPTION,
STG.ORGANIZATION_ID,
STG.BRANCH_KEY,
STG.OFFICE_STATE_CODE,
STG.CALL_CHARGE,
STG.COMPLETION_STATUS,
STG.DIRECTION,
STG.DURATION,
STG.EXCEEDED_QUEUE_WAIT_TIME,
STG.HOLD_TIME,
STG.MINUTES_BILLED,
STG.PHONE_NUMBER_ID,
STG.PHONE_NUMBER,
STG.TIME_TO_ANSWER,
STG.VOICEMAIL,
STG.WAIT_TIME,
STG.WRAP_UP_TIME,
STG.TALK_TIME,
STG.CONSULTATION_TIME,
STG.OUTSIDE_BUSINESS_HOURS,
STG.CALLBACK,
STG.DEFAULT_GROUP,
STG.LINE_ID,
STG.LINE_TYPE,
STG.CALL_CHANNEL,
STG.QUALITY_ISSUES,
STG.CREATED_AT,
STG.TIME_BRACKET,
STG.UPDATED_AT,
STG.DNIS,
STG.AA_DESTINATION,
STG.CALL_START_DATE,
STG.CALL_START_TIME,
STG.CALL_DISCONNECTED_DATE,
STG.CALL_DISCONNECTED_TIME,
STG.CALLEE_DISCONNECT_ON_HOLD,
STG.CALLER_DISCONNECT_ON_HOLD,
STG.CALL_ANSWERED_DATE,
STG.CALL_ANSWERED_TIME,
STG.CALL_LEG_COUNT,
STG.RING_DURATION,
STG.ABANDONED_TIME,
STG.DEPARTMENTS,
STG.BRANCHES,
STG.CALLER_NAME,
STG.CALLEE_NAME,
STG.WH_EMPLOYEE_KEY,
STG.ETL_TASK_KEY,
STG.ETL_INSERTED_TASK_KEY,
STG.ETL_INSERTED_DATE,
STG.ETL_INSERTED_BY,
STG.ETL_LAST_UPDATED_DATE,
STG.ETL_LAST_UPDATED_BY,
STG.ETL_DELETED_FLAG
		);
SELECT CONCAT (''MESSAGE : '',"number of rows inserted",'' Rows Inserted & '',"number of rows updated",'' Rows Updated. '') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
	RETURN return_result;
END;
    
 EOT
}

