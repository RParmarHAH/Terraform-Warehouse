resource "snowflake_procedure" "DW_HAH_GET_STAGE_OSHAH_FACT_REVENUE" {
	name ="GET_STAGE_OSHAH_FACT_REVENUE"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- NAME:  OSHAH_FACT_REVENUE
--
-- PURPOSE: Creates FACT REVENUE -- OSHAH
--
-- DEVELOPMENT LOG:
-- DATE			AUTHOR					NOTES:
-- --------		-------------------		---------------------------------------------------------------------------------------
-- 12/28/2022	  Pankti Fadia			 Initial Development
-- 28/04/2023     Pinkal Panchal		 PAYMENT TABLE JOIN CHANGES IN BILLING CTE FOR RCM MARKET REPORT
-- 07/12/2023     Sandesh Gosavi         update code to use config flag
-- 08/25/2023     Mirisha                updated state logic for contracts
-- 24/11/2023	Preeti Sharma		     Added Bill_Unit_Type Column for RCM(Requested By Natalie)
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.OSHAH_FACT_REVENUE
WITH CLIENT AS 
(
	SELECT * FROM
	(
		SELECT PATIENTID, MASTER_ID, OFFICEID
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.CLIENT_MASTER_LIST 
	)
	UNION
	SELECT * FROM
	(
		SELECT DISTINCT PATIENTID, MASTER_ID, OFFICEID
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.CLIENT_MATCH_LIST
		WHERE PATIENTID NOT IN (SELECT PATIENTID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.CLIENT_MASTER_LIST )
    )
)
, EMPLOYEE AS
(
	SELECT * FROM
	(
		SELECT CAREGIVERID, MASTER_ID
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.EMPLOYEE_MASTER_LIST
	)
	UNION
	SELECT * FROM
	(
		SELECT DISTINCT CAREGIVERID, MASTER_ID
		FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.EMPLOYEE_MATCH_LIST
		WHERE CAREGIVERID NOT IN (SELECT CAREGIVERID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.EMPLOYEE_MASTER_LIST )
	)
)
, BILLING AS (
SELECT
DET.INVOICEDETAILID
	 , MIN(PT.INVOICEDATE) AS FIRST_INVOICE_DATE
	 , MAX(BV.DEPOSITDATE) AS FINAL_PAID_DATE
	 , SUM(BV.PAIDAMOUNT) AS PAID_AMOUNT
	 , SUM(BV.WRITEOFF) AS WRITEOFFAMOUNT
	 , SUM(BV.ADJUSTMENT+BV.TTADJUSTMENT+BV.OTHERADJUSTMENT) AS ADJUSTMENTS
	 , SUM(BV.CREDITS) AS CREDITS
FROM DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.TBLINVOICEDETAILS_REPL DET
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.BILLING_PAIDVISITS_REPL BV ON BV.VISITID = DET.VISITID
AND BV.PATIENTID = DET.PATIENTID
-- PAYMENTS Join change on 28/04/23 for RCM by Pinkal
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.PAYMENTS PT 
-- ON PT.INVOICEDETAILID = DET.INVOICEDETAILID
ON BV.VISITID = PT.VISITID AND BV.PATIENTID = PT.PATIENTID AND BV.PAYMENTDETAILID = PT.PAYMENTID
GROUP BY DET.INVOICEDETAILID
)
, CONTRACTS AS (
	SELECT DISTINCT 
		 SC.SERVICECODEID
		, SC.SERVICECODE
		, SC.CONTRACTID
		, CR.CONTRACTRATEID
		, IFNULL(OFF.STATE,PR.STATE) AS STATE --ADDED
	FROM DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.SERVICECODES SC
		LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.PAYER_REPL PR ON IFNULL(PR.CONTRACTID,PR.PAYERID) = SC.ContractID
		LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.PAYEROFFICES PO ON PR.PAYERID= PO.PAYERID --OR P.PAYERID = C.LINKEDCONTRACTPAYERID --ADDED
		LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.OFFICE_OFFICES_REPL OFF ON OFF.OFFICEID = PO.OFFICEID --ADDED
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.CONTRACTRATES CR ON SC.SERVICECODEID = CR.SERVICECODEID
AND CR.TODATE :: DATE > GETDATE()
AND CR.FROMDATE :: DATE <= GETDATE()
)
SELECT DISTINCT 
	 MD5(''OSHAH'' || ''-'' || INV_HED.INVOICEHEADERID || ''-'' ||INV_DET.INVOICEDETAILID || ''-'' || ''HHAEXCHANGE'') AS REVENUE_KEY
	, DATE_TRUNC(DAY, INV_DET.VISITDATE::DATE) AS REPORT_DATE
	, MD5(''OSHAH'' || ''-'' || OFFICE.OFFICEID || ''-'' || ''HHAEXCHANGE'') AS BRANCH_KEY
	, MD5(''OSHAH'' || ''-'' || EMP.MASTER_ID || ''-'' || ''HHAEXCHANGE'') AS EMPLOYEE_KEY
	, MD5(''OSHAH'' || ''-'' || CLI.MASTER_ID || ''-'' || ''HHAEXCHANGE'') AS CLIENT_KEY
	, MD5(''OSHAH'' || ''-'' || NVL(C.CONTRACTID,''-1'') || ''-'' || NVL(C.CONTRACTRATEID,-1) || ''-'' || NVL(C.SERVICECODEID,-1)|| ''-'' || ''HHAEXCHANGE'') AS CONTRACT_KEY
	, MD5(''OSHAH'' || ''-'' || INV_HED.INVOICEHEADERID || ''-'' || ''HHAEXCHANGE'') AS INVOICE_KEY 
	, 17 AS SOURCE_SYSTEM_ID
	, MD5(''OSHAH'' || ''-'' || NVL(SUP.COORDINATORID,-1) || ''-'' || ''HHAEXCHANGE'') AS SUPERVISOR_KEY
	, DATE_TRUNC(DAY,COALESCE(BNG.FIRST_INVOICE_DATE,INV_DET.CREATEDDATE)::DATE) AS REVENUE_DATE
	, DATE_TRUNC(DAY,BNG.FINAL_PAID_DATE::DATE) AS PAYMENT_DATE
	, UPPER(TRIM(OFFICE.OFFICENAME)) AS BRANCH_NAME
	, NVL(EMP.CAREGIVERID, EMP.MASTER_ID) AS EMPLOYEE_ID
	, NVL(CLI.PATIENTID, CLI.MASTER_ID) AS CLIENT_NUMBER
	, C.CONTRACTID AS CONTRACT_CODE
	, INV_HED.VENDORINVOICENUMBER AS INVOICE_NUMBER
	, ''REGULAR'' AS INVOICE_TYPE
	, CASE WHEN INV_DET.INVRATETYPE =''Hourly'' THEN ''HOURLY''
           WHEN INV_DET.INVRATETYPE =''Daily'' THEN ''DAILY''
           WHEN INV_DET.INVRATETYPE =''Visit'' THEN ''VISIT''
      ELSE NULL END AS BILL_UNIT_TYPE
	, 1 AS NUMBER_OF_CLIENTS
	, CONCAT(''OSHAH - '',TRIM(OFFICE.STATE)) AS SYSTEM_CODE
	, NVL(SUP.COORDINATORID,''-1'') AS SUPERVISOR_CODE
	, TRIM(C.SERVICECODE) AS BILL_CODE
	, NVL(ROUND(INV_DET.BILLEDHOURS/60,2) ,0) AS INVOICE_HOURS
	, INV_DET.BILLEDRATE AS INVOICE_RATE
	, NVL(INV_DET.BILLEDAMOUNT,0) AS AMOUNT_BILLED
	, NVL(BNG.PAID_AMOUNT,0) AS AMOUNT_COLLECTED
	, AMOUNT_BILLED - AMOUNT_COLLECTED AS AMOUNT_OUTSTANDING
	, :STR_ETL_TASK_KEY AS ETL_TASK_KEY 
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	, CURRENT_USER as ETL_INSERTED_BY
	, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_UPDATED_DATE
	, CURRENT_USER AS ETL_LAST_UPDATED_BY
	, 0 AS ETL_DELETED_FLAG
FROM DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.TBLINVOICEDETAILS_REPL INV_DET
INNER JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.TBLINVOICEHEADER_REPL INV_HED ON INV_DET.INVOICEHEADERID = INV_HED.INVOICEHEADERID
INNER JOIN CLIENT CLI ON INV_HED.PATIENTID = CLI.PATIENTID
INNER JOIN EMPLOYEE EMP ON INV_DET.CAREGIVERID = EMP.CAREGIVERID
INNER JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.OFFICE_OFFICES_REPL OFFICE ON INV_HED.OFFICEID = OFFICE.OFFICEID
LEFT JOIN BILLING BNG ON INV_DET.INVOICEDETAILID = BNG.INVOICEDETAILID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.TBLVISITS_REPL VISIT ON INV_DET.VISITID = VISIT.VISITID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.TBLCOORDINATOR_REPL SUP ON VISIT.COORDINATORID = SUP.COORDINATORID
INNER JOIN CONTRACTS C ON INV_DET.INVSERVICECODEID = C.SERVICECODEID 
WHERE OFFICE.STATE IN (SELECT STATE FROM DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEOSHAH.CONFIGURATION WHERE CONFIG = TRUE);
	RETURN ''SUCCESS'';
END;

 EOT
}

