resource "snowflake_procedure" "DW_HAH_MERGE_STAGE_QUALTRICS_FACT_DISTRIBUTION" {
	name ="MERGE_STAGE_QUALTRICS_FACT_DISTRIBUTION"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN

MERGE INTO DW_${var.SF_ENVIRONMENT}.HAH.FACT_DISTRIBUTION TGT 
USING DW_${var.SF_ENVIRONMENT}.STAGE.QUALTRICS_FACT_DISTRIBUTION STAGE 
ON TGT.FACT_DISTRIBUTION_KEY = STAGE.QUALTRICS_FACT_DISTRIBUTION_KEY
WHEN MATCHED THEN 
UPDATE SET 
    TGT.QUALTRICS_DIM_DISTRIBUTION_KEY= STAGE.QUALTRICS_DIM_DISTRIBUTION_KEY
   ,TGT.EMPLOYEE_KEY= STAGE.EMPLOYEE_KEY
   ,TGT.WH_EMPLOYEE_KEY= STAGE.WH_EMPLOYEE_KEY
   ,TGT.CLIENT_KEY= STAGE.CLIENT_KEY
   ,TGT.WH_CLIENT_KEY= STAGE.WH_CLIENT_KEY
   ,TGT.STATUS= STAGE.STATUS
   ,TGT.SURVEY_LINK= STAGE.SURVEY_LINK
   ,TGT.SURVEY_RESPONSE_HEADER_KEY= STAGE.SURVEY_RESPONSE_HEADER_KEY
   ,TGT.RECORD_ID= STAGE.RECORD_ID
   ,TGT.RESPONSE_COMPLETED_AT= STAGE.RESPONSE_COMPLETED_AT
   ,TGT.SENT_AT= STAGE.SENT_AT
   ,TGT.OPENED_AT= STAGE.OPENED_AT
   ,TGT.RESPONSE_STARTED_AT= STAGE.RESPONSE_STARTED_AT
   ,TGT.SOURCE_SYSTEM_ID= STAGE.SOURCE_SYSTEM_ID
   ,TGT.SOURCE_SYSTEM_CODE =  STAGE.SOURCE_SYSTEM_CODE
   ,TGT.ETL_TASK_KEY= STAGE.ETL_TASK_KEY
   ,TGT.ETL_INSERTED_TASK_KEY= STAGE.ETL_INSERTED_TASK_KEY
   ,TGT.ETL_INSERTED_DATE= STAGE.ETL_INSERTED_DATE
   ,TGT.ETL_INSERTED_BY= STAGE.ETL_INSERTED_BY
   ,TGT.ETL_UPDATED_DATE= STAGE.ETL_UPDATED_DATE
   ,TGT.ETL_LAST_UPDATED_BY= STAGE.ETL_LAST_UPDATED_BY
   ,TGT.ETL_DELETED_FLAG= STAGE.ETL_DELETED_FLAG
   ,TGT.ETL_INFERRED_MEMBER_FLAG= STAGE.ETL_INFERRED_MEMBER_FLAG
   
WHEN NOT MATCHED THEN 
INSERT ( 
    FACT_DISTRIBUTION_KEY,
    QUALTRICS_DIM_DISTRIBUTION_KEY,
	EMPLOYEE_KEY,
    WH_EMPLOYEE_KEY,
	CLIENT_KEY,
    WH_CLIENT_KEY,
	STATUS,
	SURVEY_LINK,
	SURVEY_RESPONSE_HEADER_KEY,
	RECORD_ID,
	RESPONSE_COMPLETED_AT,
	SENT_AT,
	OPENED_AT,
	RESPONSE_STARTED_AT,
    SOURCE_SYSTEM_ID,
    SOURCE_SYSTEM_CODE,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG,
	ETL_INFERRED_MEMBER_FLAG 
) 
VALUES ( 
        STAGE.QUALTRICS_FACT_DISTRIBUTION_KEY,
        STAGE.QUALTRICS_DIM_DISTRIBUTION_KEY,
	STAGE.EMPLOYEE_KEY,
    STAGE.WH_EMPLOYEE_KEY,
	STAGE.CLIENT_KEY,
    STAGE.WH_CLIENT_KEY,
	STAGE.STATUS,
	STAGE.SURVEY_LINK,
	STAGE.SURVEY_RESPONSE_HEADER_KEY,
	STAGE.RECORD_ID,
	STAGE.RESPONSE_COMPLETED_AT,
	STAGE.SENT_AT,
	STAGE.OPENED_AT,
	STAGE.RESPONSE_STARTED_AT,
    STAGE.SOURCE_SYSTEM_ID,
    STAGE.SOURCE_SYSTEM_CODE,
	STAGE.ETL_TASK_KEY,
	STAGE.ETL_INSERTED_TASK_KEY,
	STAGE.ETL_INSERTED_DATE,
	STAGE.ETL_INSERTED_BY,
	STAGE.ETL_UPDATED_DATE,
	STAGE.ETL_LAST_UPDATED_BY,
	STAGE.ETL_DELETED_FLAG,
	STAGE.ETL_INFERRED_MEMBER_FLAG
);

END;

 EOT
}

