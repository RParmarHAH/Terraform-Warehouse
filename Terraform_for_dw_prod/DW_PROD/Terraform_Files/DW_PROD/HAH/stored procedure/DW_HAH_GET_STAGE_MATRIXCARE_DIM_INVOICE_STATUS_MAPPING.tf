resource "snowflake_procedure" "DW_HAH_GET_STAGE_MATRIXCARE_DIM_INVOICE_STATUS_MAPPING" {
	name ="GET_STAGE_MATRIXCARE_DIM_INVOICE_STATUS_MAPPING"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 21/03/23    MITUL PANCHAL        Initial Development
-- 27/09/23    Pradeep Thippani     Invoice_status logic change for PAID and PARTIAL PAY
-- 03/10/23    Pradeep Thippani     changed amount_billed logic
--*****************************************************************************************************************************

INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.STAGE.MATRIXCARE_DIM_INVOICE_STATUS_MAPPING
WITH INVOICE_DETAILS AS 
(
	SELECT INVOICE_DETAILS.INVD_INVHID AS INVH_ID, 
        SUM(NVL(INVOICE_DETAILS.INVD_ADJUSTEDCHARGETOTAL,0)) AS AMOUNT_BILLED,
--		SUM(NVL(INVOICE_DETAILS.INVD_TOTALCHARGES, 0) + NVL(INVOICE_DETAILS.INVD_TOTALREVADJUSTMENTS, 0)) AS AMOUNT_BILLED,
-- changes made on 03/10/2023 for RCM
		SUM(INVOICE_DETAILS.INVD_TOTALPAYMENTS * -1) AS AMOUNT_COLLECTED, -- Payments are in negative amounts 
        SUM(INVOICE_DETAILS.INVD_BALANCE) AS AMOUNT_OUTSTANDING -- ADDED ON 27/09/23 FOR RCM	 
	FROM DISC_${var.SF_ENVIRONMENT}.MATRIXCARE.STVHC_T_INVOICEDETAILS AS INVOICE_DETAILS 
	GROUP BY INVOICE_DETAILS.INVD_INVHID
) 
SELECT DISTINCT
	7 AS SOURCE_SYSTEM_ID,	
	''MATRIXCARE'' AS SYSTEM_CODE, 
	CASE WHEN INVOICE_HEADER.INVH_CANCELDATE IS NOT NULL THEN ''CANCELLED''
--       WHEN INVOICE_DETAILS.AMOUNT_COLLECTED >= INVOICE_DETAILS.AMOUNT_BILLED THEN ''PAID''
--	     WHEN INVOICE_DETAILS.AMOUNT_COLLECTED > 0 THEN ''PARTIAL PAY''
--   changes made on 27/09/2023 for RCM
	     WHEN INVOICE_DETAILS.AMOUNT_COLLECTED > 0 AND INVOICE_DETAILS.AMOUNT_OUTSTANDING <= 0  THEN ''PAID''
		 WHEN INVOICE_DETAILS.AMOUNT_COLLECTED > 0 AND INVOICE_DETAILS.AMOUNT_OUTSTANDING > 0   THEN ''PARTIAL PAY''
		 WHEN INVOICE_DETAILS.AMOUNT_BILLED > 0 THEN ''BILLED''
		 WHEN NVL(INVOICE_DETAILS.AMOUNT_BILLED, 0) = 0 THEN ''UNBILLED''
	ELSE ''UNKNOWN'' END AS DERIVED_INVOICE_STATUS,
	MD5(SOURCE_SYSTEM_ID || ''-'' || DERIVED_INVOICE_STATUS || ''-'' || SYSTEM_CODE) AS INVOICE_STATUS_KEY
--	     ETL Fields
    ,:STR_ETL_TASK_KEY AS ETL_TASK_KEY
    ,:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY                    
	,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE
	,CURRENT_USER as ETL_INSERTED_BY
	,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE
	,CURRENT_USER as ETL_LAST_UPDATED_BY
FROM DISC_${var.SF_ENVIRONMENT}.MATRIXCARE.STVHC_T_INVOICEHEADER AS INVOICE_HEADER
LEFT JOIN INVOICE_DETAILS AS INVOICE_DETAILS
ON INVOICE_DETAILS.INVH_ID = INVOICE_HEADER.INVH_ID
;
RETURN ''SUCCESS'';
END;

 EOT
}

