resource "snowflake_procedure" "DW_HAH_GET_STAGE_EDISON_DIM_BRANCH" {
	name ="GET_STAGE_EDISON_DIM_BRANCH"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

                BEGIN
--*****************************************************************************************************************************
-- NAME:  EDISON_DIM_BRANCH
--
-- DEVELOPMENT LOG:
-- DATE        NAME                		CHANGES
-- --------    -------------------   	-----------------------------------------------------------------------------------------------
-- 03/15/23 	Shikhar Saxena 			Changed the Branch key logic for Corporate branch
-- 05/29/23		Shikhar Saxena			Changed the logic to add SOURCE_SYSTEM_TYPE field
--*****************************************************************************************************************************
INSERT OVERWRITE INTO STAGE.EDISON_DIM_BRANCH
WITH HHAEXCHANGEEDISON_DATA AS (
	SELECT MD5(''EDISON'' || ''-'' || ''EDISON CORPORATE OFFICE'' || ''-'' || ''EDISON'') AS BRANCH_KEY,
		''EDISON CORPORATE OFFICE'' AS BRANCH_NAME,
		''EDISON CORPORATE OFFICE'' AS OFFICE_NAME,
		''NY'' AS STATE,
		''EDISON'' AS SYSTEM_CODE,
		17 AS SOURCE_SYSTEM_ID,
		-1 AS OFFICE_CODE,
		NULL AS OFFICE_ZIP,
		NULL AS OFFICE_ADDRESS1,
		NULL AS OFFICE_ADDRESS2,
		NULL AS OFFICE_CITY,
		NULL AS OFFICE_PHONE,
        -1 AS HAH_OFFICE_CODE, -- will need to be updated after manual data entry into hr_office_mapping and KMRegions
        -1 AS HAH_OFFICE_NUMBER -- will need to be updated after manual data entry into hr_office_mapping and KMRegions
), RISKCONNECT_HIERARCHY AS (
	SELECT * FROM "DISC_${var.SF_ENVIRONMENT}"."STAGE"."RISKCONNECT_HIERARCHY"
), HR_OFFICE_MAPPING AS (
	SELECT * FROM "DISC_${var.SF_ENVIRONMENT}"."STAGE"."HR_OFFICE_MAPPING"
), HAH_OFFICES AS (
	SELECT UPPER(TRIM(OFFICES.STATE)) AS STATE,
		TRY_CAST(OFFICES.OFFICENUMBER AS INT) AS OFFICE_NUMBER,
		OFFICES.OFFICENAME AS OFFICE_NAME,
		CASE WHEN OFFICES.OFFICENAME LIKE ''%DD%'' THEN ''DD''
			WHEN OFFICES.OFFICENAME LIKE ''%ADS%'' THEN ''ADS''
		END AS BRANCH_SERVICE_LINE,
		OFFICES.TOLLFREE AS OFFICE_TOLL_FREE_PHONE,
		OFFICES.FAX AS OFFICE_FAX,
		TRIM( OFFICES.Email) AS Primary_Branch_Email,
		CAST(NULL AS VARCHAR(10)) AS Secondary_Branch_Email,
		OFFICES.OFFICEMANAGER AS OFFICEMANAGER1,
		CAST(NULL AS VARCHAR(10)) AS OFFICEMANAGER2,
		OFFICES.DATECREATED AS DATE_CREATED,
		OFFICES.ETL_LAST_UPDATED_DATE
	FROM "DISC_${var.SF_ENVIRONMENT}"."HAHUSERS"."LOGIN_OFFICE" AS OFFICES
    WHERE TRY_CAST(OFFICES.OFFICENUMBER AS INT) IS NOT NULL
) 
SELECT HHAEXCHANGEEDISON_OFFICES.BRANCH_KEY, HHAEXCHANGEEDISON_OFFICES.BRANCH_NAME, HHAEXCHANGEEDISON_OFFICES.SYSTEM_CODE, HHAEXCHANGEEDISON_OFFICES.SOURCE_SYSTEM_ID, SOURCE_SYSTEM.SOURCE_SYSTEM_TYPE,
		HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_NUMBER AS OFFICE_NUMBER, HHAEXCHANGEEDISON_OFFICES.OFFICE_CODE, 
		HHAEXCHANGEEDISON_OFFICES.OFFICE_NAME, HHAEXCHANGEEDISON_OFFICES.OFFICE_NAME AS OFFICE_NAME_ALT,
		DESC.DESCRIPTION AS DEPARTMENT_NAME, NULL AS BRANCH_SERVICE_LINE,
		TRUE AS PARENT_FLAG,
		HHAEXCHANGEEDISON_OFFICES.BRANCH_KEY AS PARENT_BRANCH_KEY,
		HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_NUMBER AS PARENT_OFFICE_NUMBER,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_CODE AS PARENT_OFFICE_CODE,
		HHAEXCHANGEEDISON_OFFICES.STATE || '' - '' || HHAEXCHANGEEDISON_OFFICES.BRANCH_NAME || '' (EDISON)'' AS PARENT_BRANCH_NAME,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_ADDRESS1,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_ADDRESS2,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_CITY,
		COALESCE(HAH_OFFICES.STATE, HHAEXCHANGEEDISON_OFFICES.STATE) AS OFFICE_STATE_CODE,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_ZIP,
		HHAEXCHANGEEDISON_OFFICES.OFFICE_PHONE,
		HAH_OFFICES.OFFICE_TOLL_FREE_PHONE,
		HAH_OFFICES.OFFICE_FAX,
		HHAEXCHANGEEDISON_OFFICES.STATE || '' - '' || HHAEXCHANGEEDISON_OFFICES.BRANCH_NAME || '' (EDISON)'' AS DETAILED_OFFICE_NAME,	
		--//--	No NY Data in KMRegions
		REGIONS.REGIONNUMBER AS REGION_NUMBER,
		UPPER(TRIM(REGIONS.NAME)) AS REGION_NAME,
		UPPER(TRIM(REGIONS.MANAGER)) AS REGION_MANAGER,
		NULL AS REGION_MANAGER_EMPLOYEE_KEY,
		NULL AS SUBREGION_NAME,
		--//--	No NY Data in KMRegions
		--/-- No NY data in HAHUSERS.LoginOffices
		UPPER(TRIM(HAH_OFFICES.OfficeManager1)) AS Primary_Branch_Manager_Name,
		TRIM(HAH_OFFICES.PRIMARY_BRANCH_EMAIL) AS PRIMARY_BRANCH_EMAIL,
		NULL AS PRIMARY_BRANCH_MANAGER_EMPLOYEE_KEY,
		UPPER(TRIM(HAH_OFFICES.OfficeManager2)) AS Secondary_Branch_Manager_Name,
		TRIM(HAH_OFFICES.SECONDARY_BRANCH_EMAIL) AS SECONDARY_BRANCH_EMAIL,
		NULL AS SECONDARY_BRANCH_MANAGER_EMPLOYEE_KEY,
		--/-- No NY data in HAHUSERS.LoginOffices
		--/--  No NY data in Riskconnect
		RISKCONNECT.NODE_KEY AS RISKCONNECT_NODE_KEY,
		RISKCONNECT.NODE_NAME AS RISKCONNECT_NAME,
		--/--  No NY data in Riskconnect
		--/--  No NY data in Mercer
		HR.HR_OFFICE_NUMBER,
		HR.HR_OFFICE_NAME,
		--/--  No NY data in Mercer
		TRUE AS ACTIVE_FLAG,
		TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE,
		TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
		--- ETL FIELDS ---
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
		:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
		CURRENT_USER as ETL_INSERTED_BY ,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE,
		CURRENT_USER as ETL_LAST_UPDATED_BY,
		0 as ETL_DELETED_FLAG,
		0 AS ETL_INFERRED_MEMBER_FLAG
	FROM HHAEXCHANGEEDISON_DATA AS HHAEXCHANGEEDISON_OFFICES
    LEFT JOIN HAH_OFFICES AS HAH_OFFICES
		ON HAH_OFFICES.STATE = HHAEXCHANGEEDISON_OFFICES.STATE AND HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_NUMBER = HAH_OFFICES.OFFICE_NUMBER
    LEFT JOIN "DW_${var.SF_ENVIRONMENT}"."HAH"."DIM_STATE" AS STATES 
		ON STATES.STATE_ISO_CODE = HHAEXCHANGEEDISON_OFFICES.STATE
	--//--  Need RiskConnect Data Refresh  
    LEFT OUTER JOIN RISKCONNECT_HIERARCHY AS RISKCONNECT
		ON RISKCONNECT.STATE = HHAEXCHANGEEDISON_OFFICES.STATE
			--AND RISKCONNECT.PARENT_LEVEL = 2
			--AND TRIM(RISKCONNECT.OFFICE_CODE) = IFF(TRIM(HHAEXCHANGEEDISON_OFFICES.STATE) <> ''SC'', TRIM(HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_CODE), HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_NUMBER::STRING)
	--//--  Need Mercer Data Refresh
    LEFT OUTER JOIN HR_OFFICE_MAPPING AS HR
		ON TRIM(HR.OFFICE_CODE) = TRIM(HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_CODE) AND TRIM(HR.STATE) = HHAEXCHANGEEDISON_OFFICES.STATE 
    LEFT JOIN "DISC_${var.SF_ENVIRONMENT}"."HAH_REPORTING"."KEYMETOFFICES" AS REGION_OFFICES
		ON TRIM(REGION_OFFICES.OFFICESTATE) = HHAEXCHANGEEDISON_OFFICES.STATE AND TRY_CAST(REGION_OFFICES.OFFICENUMBER AS INT) = HHAEXCHANGEEDISON_OFFICES.HAH_OFFICE_NUMBER 
	--//--  Needs KMRegions Data Refresh 
    LEFT JOIN "DISC_${var.SF_ENVIRONMENT}"."BI_REPOSITORY"."KMREGIONS" AS REGIONS
		ON (REGION_OFFICES.REGIONNUMBER IS NULL AND 
			CASE WHEN UPPER(STATES.STATE_NAME) = ''GEORGIA'' THEN ''GEORGIA/SOUTH CAROLINA''
				WHEN UPPER(STATES.STATE_NAME) = ''SOUTH CAROLINA'' THEN ''GEORGIA/SOUTH CAROLINA''
				WHEN UPPER(STATES.STATE_NAME) = ''MICHIGAN'' THEN ''DD/MICHIGAN''
				WHEN UPPER(STATES.STATE_NAME) = ''KANSAS'' THEN ''MISSOURI'' 
				WHEN UPPER(STATES.STATE_NAME) = ''IOWA'' THEN ''ILLINOIS - NORTH'' 
				WHEN UPPER(STATES.STATE_NAME) = ''MISSISSIPPI'' THEN ''MISSISSIPPI/TENNESSEE''
				WHEN UPPER(STATES.STATE_NAME) = ''TENNESSEE'' THEN ''MISSISSIPPI/TENNESSEE''
				ELSE UPPER(STATES.STATE_NAME) END = REGIONS.NAME) 
			OR (REGION_OFFICES.REGIONNUMBER = REGIONS.REGIONNUMBER)
    LEFT JOIN DW_${var.SF_ENVIRONMENT}.STAGE.EDISON_OFFICE_DESCRIPTIONS DESC ON DESC.OFFICEID = HHAEXCHANGEEDISON_OFFICES.OFFICE_CODE
	LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_SOURCE_SYSTEM AS SOURCE_SYSTEM ON SOURCE_SYSTEM.SOURCE_SYSTEM_ID = HHAEXCHANGEEDISON_OFFICES.SOURCE_SYSTEM_ID
 
;
    RETURN ''SUCCESS'';
    END;
    
 EOT
}

