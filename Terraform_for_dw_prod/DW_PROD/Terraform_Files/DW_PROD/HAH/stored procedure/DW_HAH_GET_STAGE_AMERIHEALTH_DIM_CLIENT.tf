resource "snowflake_procedure" "DW_HAH_GET_STAGE_AMERIHEALTH_DIM_CLIENT" {
	name ="GET_STAGE_AMERIHEALTH_DIM_CLIENT"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
       --*****************************************************************************************************************************
-- NAME:  AmeriHealth_DIM_CLIENT
--
-- PURPOSE: Creates one row per client according to AmeriHealth
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 24/07/2023     AKASH THAKKER         Initial Development
-- 08/23/2023     AKASH THAKKER         Added distinct due to duplicate clients from source file
-- 11/08/2023     Trushali Ramoliya    Added the column for HISPANIC_OR_LATINO and also updated the logic for ethnicity as per IDDOX - 388
--*****************************************************************************************************************************
INSERT OVERWRITE INTO STAGE.AmeriHealth_DIM_CLIENT
	SELECT DISTINCT 
		MD5(''AMERIHEALTH'' || ''-'' || TRIM(EXTERNAL_ID) || ''-'' || ''AMERIHEALTH'') AS CLIENT_KEY,		
		TRIM(EXTERNAL_ID) AS CLIENT_NUMBER ,
		''AMERIHEALTH'' AS SYSTEM_CODE ,
		35 AS SOURCE_SYSTEM_ID ,
		NULL AS Client_PID ,
		MEDICARE_ID AS CLIENT_MEDICARE_ID ,
		MEDICAID_ID ,
		TO_DATE(DATE_OF_BIRTH) AS CLIENT_DOB ,
		NULL CLIENT_DATE_OF_DEATH ,
		NULL Client_GENDER ,
		NULL CLIENT_ETHNICITY ,
		FALSE AS HISPANIC_OR_LATINO,					  
		NULL CLIENT_GENDER_IDENTITY ,
		NULL CLIENT_SEXUAL_ORIENTATION ,
		NULL CLIENT_RACE ,
		NULL CLIENT_MARITAL_STATUS ,
		NULL CLIENT_SALUTATION ,
		TRIM(FIRST_NAME) AS CLIENT_FIRST_NAME
    	,TRIM(MIDDLE_NAME) AS  Client_MIDDLE_NAME
    	,TRIM(LAST_NAME) AS CLIENT_LAST_NAME
    	,CONCAT(UPPER(TRIM(LAST_NAME)), '', '' , UPPER(TRIM(FIRST_NAME)) , '' '',nvl(UPPER(TRIM(MIDDLE_NAME)),'''')) AS CLIENT_NAME,
		STREET_ADDRESS AS Client_Address1 ,
		NULL Client_Address2 ,
		UPPER(CITY) AS Client_City ,
		STATE CLIENT_STATE_CODE ,
		ZIP_CODE AS Client_Zip ,
		NULL CLIENT_CLN_ADDRESS1 ,
		NULL CLIENT_CLN_ADDRESS2 ,
		NULL CLIENT_CLN_CITY ,
		NULL CLIENT_CLN_STATE_CODE ,
		NULL CLIENT_CLN_ZIP ,
		NULL CLIENT_STD_ADDRESS1 ,
		NULL CLIENT_STD_ADDRESS2 ,
		NULL CLIENT_STD_CITY ,
		NULL CLIENT_STD_STATE_CODE ,
		NULL CLIENT_STD_ZIP ,
		NULL Client_Home_Phone ,
		NULL Client_Cell_Phone ,
		NULL Client_Work_Phone ,
		NULL CLIENT_FAX_NUMBER ,
		EMAIL_ADDRESS AS CLIENT_PERSONAL_EMAIL ,
		NULL REFERRAL_DATE ,
		NULL DAYS_TO_SERVICE ,
		NULL CONTRACT_BEGIN_DATE ,
		NULL CONTRACT_END_DATE ,
		NULL FIRST_SERVICE_DATE ,
		NULL LAST_SERVICE_DATE ,
		NULL BEGIN_DATE ,
		NULL END_DATE ,
		TRUE ACTIVE_CLIENT_FLAG ,
		NULL On_Hold_Flag ,
		CAST( NULL AS DATE) AS On_Hold_Start_Date ,
		CAST( NULL AS DATE) AS On_Hold_End_Date ,
		NULL LINKED_ID ,
		NULL ACQUIRED_FROM_COMPANY_KEY ,
		NULL ACQUIRED_FROM_COMPANY_ID ,
		NULL ACQUIRED_FROM_COMPANY_FULL_NAME ,
		NULL ACQUISITION_DATE ,
		NULL ACQUISITION_FLAG ,
		NULL ADMISSION_DATE ,
		NULL ADMISSION_FLAG ,
		NULL CLIENT_CONVERTED_FLAG ,
		NULL PRIMARY_SUPERVISOR_KEY ,
		NULL PRIMARY_SUPERVISOR_CODE ,
		NULL PRIMARY_SUPERVISOR_NAME ,
		NULL SECONDARY_SUPERVISOR_KEY ,
		NULL SECONDARY_SUPERVISOR_CODE ,
		NULL SECONDARY_SUPERVISOR_NAME ,
		NULL PRIMARY_BRANCH_KEY ,
		NULL PRIMARY_BRANCH_NAME ,
		NULL PRIMARY_BRANCH_STATE ,
		NULL GUARANTOR_NAME ,
		NULL NOTES ,
		NULL AGENCY ,
		 TO_DATE(''1900-01-01'',''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE
	    ,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE
	    ,:STR_ETL_TASK_KEY AS ETL_TASK_KEY
		,:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	    ,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE
	    ,CURRENT_USER as ETL_INSERTED_BY 
	    ,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE
	    ,CURRENT_USER as ETL_LAST_UPDATED_BY
	    ,0 as ETL_DELETED_FLAG
	    ,0 AS ETL_INFERRED_MEMBER_FLAG
from DISC_${var.SF_ENVIRONMENT}.AmeriHealth.AmeriHealth_SOURCE_DATA ;

return '' SUCCESS '';
END;

 EOT
}

