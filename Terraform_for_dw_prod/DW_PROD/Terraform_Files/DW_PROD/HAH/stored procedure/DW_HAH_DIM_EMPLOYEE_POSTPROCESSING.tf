resource "snowflake_procedure" "DW_HAH_DIM_EMPLOYEE_POSTPROCESSING" {
	name ="DIM_EMPLOYEE_POSTPROCESSING"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result VARCHAR;
BEGIN
UPDATE DW_${var.SF_ENVIRONMENT}.HAH.DIM_EMPLOYEE  E
SET E.DERIVED_FIRST_SERVICE_DATE = V.FIRST_SERVICE_DATE, E.DERIVED_LAST_SERVICE_DATE = V.LAST_SERVICE_DATE 
FROM (
    SELECT DISTINCT E.EMPLOYEE_KEY, MIN(V.REPORT_DATE) FIRST_SERVICE_DATE, MAX(V.REPORT_DATE) LAST_SERVICE_DATE 
    FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_EMPLOYEE E 
    LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.FACT_VISIT V
        ON E.EMPLOYEE_KEY  = V.EMPLOYEE_KEY
  LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_CONTRACT DC ON V.CONTRACT_KEY = DC.CONTRACT_KEY
    WHERE DC.BILLABLE_FLAG = TRUE AND V.CONFIRMED_FLAG = ''YES''
    GROUP BY 1
) V
    WHERE E.EMPLOYEE_KEY = V.EMPLOYEE_KEY;

UPDATE DW_${var.SF_ENVIRONMENT}.HAH.DIM_EMPLOYEE  E
SET E.DERIVED_PAYROLL_FIRST_CHECK_DATE = P.FIRST_PAYROLL_DATE, E.DERIVED_PAYROLL_LAST_CHECK_DATE = P.LAST_PAYROLL_DATE 
FROM (
    SELECT EMPLOYEE_KEY, MIN(PAYROLL_DATE) AS FIRST_PAYROLL_DATE,MAX(PAYROLL_DATE) AS LAST_PAYROLL_DATE
    FROM DW_${var.SF_ENVIRONMENT}.HAH.FACT_PAYROLL
    GROUP BY 1
) P
    WHERE E.EMPLOYEE_KEY = P.EMPLOYEE_KEY;

END;

 EOT
}

