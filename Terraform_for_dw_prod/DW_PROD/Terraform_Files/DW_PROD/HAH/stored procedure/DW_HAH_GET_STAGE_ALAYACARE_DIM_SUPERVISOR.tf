resource "snowflake_procedure" "DW_HAH_GET_STAGE_ALAYACARE_DIM_SUPERVISOR" {
	name ="GET_STAGE_ALAYACARE_DIM_SUPERVISOR"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- NAME:  ALAYACARE_DIM_SUPERVISOR
--
-- PURPOSE: Creates one dummy supervisor row per group according to AlayaCare 
--			Currently uses hard coding, but can build out with Discovery layer once more tables available
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 12/16/2021  VAIDEHI SHAH 		SUPERVISOR ROW FOR EACH GROUP FOR EACH BRANCH
-- 06/12/2023  JASHVANT PATEL		UPDATED SUPERVISOR TITLES AND LOGIC CHANGE
--*****************************************************************************************************************************
INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.STAGE.ALAYACARE_DIM_SUPERVISOR
WITH EMP AS 
(
SELECT EMPLOYEE_ID , ROW_NUMBER() OVER (PARTITION BY PROFILE_SUPERVISOR_TAG ORDER BY CREATED_AT DESC) AS RN , *
FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.EMPLOYEE
)
SELECT 
DATA.SUPERVISOR_KEY,	DATA.SUPERVISOR_CODE,	DATA.SYSTEM_CODE,	DATA.SOURCE_SYSTEM_ID,	DATA.SUPERVISOR_NAME,	DATA.SUPERVISOR_STATE_CODE,	DATA.SUPERVISOR_JOB_CODE,	DATA.SUPERVISOR_JOB_TITLE,	DATA.EFFECTIVE_FROM_DATE,	DATA.EFFECTIVE_TO_DATE,	DATA.ETL_TASK_KEY,	DATA.ETL_INSERTED_TASK_KEY,	DATA.ETL_INSERTED_DATE,	DATA.ETL_INSERTED_BY,	DATA.ETL_LAST_UPDATED_DATE,	DATA.ETL_LAST_UPDATED_BY,	DATA.ETL_DELETED_FLAG,	DATA.ETL_INFERRED_MEMBER_FLAG
FROM(
SELECT MD5(UPPER(NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(B.BRANCH_ID,-1) || '')'') || ''-'' ||E.PROFILE_SUPERVISOR_TAG || ''-'' || ''ALAYACARE'') AS SUPERVISOR_KEY,
E.PROFILE_SUPERVISOR_TAG AS SUPERVISOR_CODE,
UPPER(NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(B.BRANCH_ID,-1) || '')'') AS SYSTEM_CODE,
9 AS SOURCE_SYSTEM_ID,
UPPER(COALESCE(TRIM(E.PROFILE_FIRST_NAME),'''') || '' '' || COALESCE(TRIM(E.PROFILE_MIDDLE_NAME),'''') || '' '' ||COALESCE (TRIM(E.PROFILE_LAST_NAME),'''')) AS SUPERVISOR_NAME,
E.PROFILE_STATE AS SUPERVISOR_STATE_CODE,
NULL SUPERVISOR_JOB_CODE,
E.PROFILE_JOB_TITLE SUPERVISOR_JOB_TITLE,
TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE,
TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
		CURRENT_USER as ETL_INSERTED_BY ,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE,
		CURRENT_USER as ETL_LAST_UPDATED_BY,
		0 as ETL_DELETED_FLAG,
		0 AS ETL_INFERRED_MEMBER_FLAG
FROM EMP E
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH B ON E.BRANCH_ID = B.BRANCH_ID
WHERE E.PROFILE_SUPERVISOR_TAG IS NOT NULL AND E.PROFILE_SUPERVISOR_TAG<>'''' AND E.RN=1)
DATA
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.CONFIGURATION CONFIG 
	ON UPPER(CONFIG.SYSTEM_CODE) = UPPER(DATA.SYSTEM_CODE)
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL
;
RETURN ''SUCCESS'';
end;                        

 EOT
}

