resource "snowflake_procedure" "DW_HAH_GET_STAGE_PAYLOCITY_DIM_BRANCH" {
	name ="GET_STAGE_PAYLOCITY_DIM_BRANCH"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result varchar(1000);
BEGIN

INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.STAGE.PAYLOCITY_DIM_BRANCH

WITH BRANCH_MAPPING AS
(

	SELECT ''1'' AS CODE,''Evansville'' AS OFFICE_NAME,''33978'' AS SYSTEM_CODE, ''be8953b546f3bce6b629fe0a6be44545''  AS BRANCH_KEY
	UNION
	SELECT ''2'' AS CODE,''Columbus'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''0515334692b2264eb0afb8ba71d1ddd6''  AS BRANCH_KEY
	UNION
	SELECT ''3'' AS CODE,''Jeffersonville'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''df498a31659b291a102cfbc6c49dfca3''  AS BRANCH_KEY
	UNION
	SELECT ''3'' AS CODE,''Jeffersonville'' AS OFFICE_NAME,''33978'' AS SYSTEM_CODE, ''df498a31659b291a102cfbc6c49dfca3''  AS BRANCH_KEY
	UNION
	SELECT ''4'' AS CODE,''Jasper'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''7be3639d7fb1afebc1d6d2ec98654893''  AS BRANCH_KEY
	UNION
	SELECT ''5'' AS CODE,''Bedford'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''8c81845ba614546f0de7d8b7452293ca''  AS BRANCH_KEY
	UNION
	SELECT ''6'' AS CODE,''DO NOT USE'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''''  AS BRANCH_KEY
	UNION
	SELECT ''7'' AS CODE,''Bloomington'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''e67b7fd436b099ca0eb51f1b8e1d2483''  AS BRANCH_KEY
	UNION
	SELECT ''8'' AS CODE,''Greenwood'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''e4a6c90c75bf5ed07194e1daa36e0ef7''  AS BRANCH_KEY
	UNION
	SELECT ''9'' AS CODE,''Newburgh'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''''  AS BRANCH_KEY
	UNION
	SELECT ''10'' AS CODE,''New Albany'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''ffde2c7f58348a272da95fbc468d51a9''  AS BRANCH_KEY
	UNION
	SELECT ''11'' AS CODE,''Indianapolis'' AS OFFICE_NAME,''33978'' AS SYSTEM_CODE, ''''  AS BRANCH_KEY
	UNION
	SELECT ''11'' AS CODE,''Indy North'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''83761b48ab592bd461da25217b17de29''  AS BRANCH_KEY
	UNION
	SELECT ''12'' AS CODE,''Muncie'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''a34629be5375a45dae2c08685bb2898a''  AS BRANCH_KEY
	UNION
	SELECT ''13'' AS CODE,''Kokomo'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''9fdb8a924b4bbf2f46ccb57ae39c1b4e''  AS BRANCH_KEY
	UNION
	SELECT ''14'' AS CODE,''Lafayette'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''de23a84aea8c53c5768ab55000e64647''  AS BRANCH_KEY
	UNION
	SELECT ''15'' AS CODE,''Fort Wayne'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''35447d8d9323a106745968cbdeb16cba''  AS BRANCH_KEY
	UNION
	SELECT ''16'' AS CODE,''Evansville'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''be8953b546f3bce6b629fe0a6be44545''  AS BRANCH_KEY
	UNION
	SELECT ''18'' AS CODE,''Jeffersonville - Skilled'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''''  AS BRANCH_KEY
	UNION
	SELECT ''20'' AS CODE,''Seymour'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''729ebff0548e90448d65a49a3e49ae41''  AS BRANCH_KEY
	UNION
	SELECT ''21'' AS CODE,''Richmond'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''f5b32e797aca754feaf1cedd9b7f67f8''  AS BRANCH_KEY
	UNION
	SELECT ''22'' AS CODE,''Terre Haute'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''aa6cfa98b87d7ad4b47f814c8fb27666''  AS BRANCH_KEY
	UNION
	SELECT ''23'' AS CODE,''South Bend'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''3e9552c753e54fed57d6d86b9603276f''  AS BRANCH_KEY
	UNION
	SELECT ''24'' AS CODE,''West Indy'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''c909d8effc221e2702759e5cfd72d857''  AS BRANCH_KEY
	UNION
	SELECT ''25'' AS CODE,''Crown Point'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''0de7034bd8a952a2050e16fc2c995dd5''  AS BRANCH_KEY
	UNION
	SELECT ''26'' AS CODE,''Help at Home'' AS OFFICE_NAME,''B6150'' AS SYSTEM_CODE, ''''  AS BRANCH_KEY
	UNION 
	SELECT ''27'' AS CODE, ''HAH - La Porte'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''5441ced501e00adf6dc9cd68b340ab89'' AS BRANCH_KEY
	UNION 
	SELECT ''28'' AS CODE, ''HAH - Schererville'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''24b0c7444ffbfe7951add05fe697626f'' AS BRANCH_KEY
	UNION 
	SELECT ''29'' AS CODE, ''HAH - Valparaiso'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''536b1e4935305bf7865b01e273a3e5b2'' AS BRANCH_KEY
	UNION 
	SELECT ''30'' AS CODE, ''HAH - Bloomington'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''b9f024215a9cf305054f489e63de7838'' AS BRANCH_KEY
	UNION 
	SELECT ''31'' AS CODE, ''HAH - Terre Haute'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''a872744b844b90104b636dd4c3b19ad1'' AS BRANCH_KEY
	UNION 
	SELECT ''32'' AS CODE, ''HAH - Evansville'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''ac36bf2692ff903a6b5060452803dbef'' AS BRANCH_KEY
	UNION 
	SELECT ''33'' AS CODE, ''HAH - Washington'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''bee66b07d31c801c9e1fde14d8e9d01d'' AS BRANCH_KEY
	UNION 
	SELECT ''34'' AS CODE, ''HAH - Richmond'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''966a10c41caaf79fd977836ef2e9af8e'' AS BRANCH_KEY
	UNION 
	SELECT ''35'' AS CODE, ''HAH - Seymour'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''26ae943904d2dcc6a57f5d7d7067ff0e'' AS BRANCH_KEY
	UNION 
	SELECT ''36'' AS CODE, ''HAH - Greenwood'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''3b97d90e34288cdb4ce34c1f654f247c'' AS BRANCH_KEY
	UNION 
	SELECT ''37'' AS CODE, ''HAH - Muncie'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''13d362dd861f979e6743b12ca68d927c'' AS BRANCH_KEY
	UNION 
	SELECT ''38'' AS CODE, ''HAH - Indy Avon'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''ff4c0932c622859cbe18c6db95838369'' AS BRANCH_KEY
	UNION 
	SELECT ''58'' AS CODE, ''HAH - Lafayette'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''1ee9227b18e67ff894f8397928bf495e'' AS BRANCH_KEY
	UNION 
	SELECT ''67'' AS CODE, ''HAH - Logansport'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''15a3426a7f22721d670c97d79808458f'' AS BRANCH_KEY
	UNION
	SELECT ''60'' AS CODE, ''HAH - Indy East'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, '''' AS BRANCH_KEY
	UNION
	SELECT ''68'' AS CODE, ''HAH - Winchester'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''40f0f6fa2e7166f67ea4fe53530d9f2a'' AS BRANCH_KEY
	UNION
	SELECT ''69'' AS CODE, ''HAH - New Albany'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''ffde2c7f58348a272da95fbc468d51a9'' AS BRANCH_KEY
	UNION
	SELECT ''90'' AS CODE, ''HAH - South Bend'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''849e9d1df1dee4bf413c6d7405b77866'' AS BRANCH_KEY
	UNION
	SELECT ''202'' AS CODE, ''HAH - Fort Wayne'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''4d2217bd145bafef2bb4c4fe6bfdb73c'' AS BRANCH_KEY
	UNION
	SELECT ''617'' AS CODE, ''HAH - Anderson'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, ''bf5952b753944cb90d5b600f04de3ccc'' AS BRANCH_KEY
	UNION
	SELECT ''LOC'' AS CODE, ''Location'' AS OFFICE_NAME, ''B6150'' AS SYSTEM_CODE, '''' AS BRANCH_KEY

)
SELECT
MD5(BRANCH_MAPPING.SYSTEM_CODE || ''-'' || BRANCH_MAPPING.CODE || ''-'' ||''PAYLOCITY'') AS BRANCH_KEY,
BRANCH_MAPPING.OFFICE_NAME AS BRANCH_NAME,
BRANCH_MAPPING.SYSTEM_CODE,
10 AS SOURCE_SYSTEM_ID,
SOURCE_SYSTEM.SOURCE_SYSTEM_TYPE,
NVL(BRANCH.OFFICE_NUMBER,-1) AS OFFICE_NUMBER,
BRANCH_MAPPING.CODE AS OFFICE_CODE,
NVL(BRANCH.OFFICE_NAME,BRANCH_MAPPING.OFFICE_NAME)  AS OFFICE_NAME,
NVL(BRANCH.OFFICE_NAME_ALT,BRANCH_MAPPING.OFFICE_NAME),
NVL(BRANCH.DEPARTMENT_NAME,BRANCH_MAPPING.OFFICE_NAME),
BRANCH.BRANCH_SERVICE_LINE,
NVL(BRANCH.PARENT_FLAG,TRUE),
MD5(BRANCH_MAPPING.SYSTEM_CODE || ''-'' || BRANCH_MAPPING.CODE || ''-'' ||''PAYLOCITY'') PARENT_BRANCH_KEY,
BRANCH.PARENT_OFFICE_NUMBER,
BRANCH.PARENT_OFFICE_CODE,
NVL(BRANCH.PARENT_BRANCH_NAME,BRANCH_MAPPING.OFFICE_NAME),
BRANCH.OFFICE_ADDRESS1,
BRANCH.OFFICE_ADDRESS2,
BRANCH.OFFICE_CITY,
COALESCE(BRANCH.OFFICE_STATE_CODE, ''IN''),
BRANCH.OFFICE_ZIP,
BRANCH.OFFICE_PHONE,
BRANCH.OFFICE_TOLL_FREE_PHONE,
BRANCH.OFFICE_FAX,
BRANCH.DETAILED_OFFICE_NAME,
BRANCH.REGION_NUMBER,
BRANCH.REGION_NAME,
BRANCH.REGION_MANAGER,
BRANCH.REGION_MANAGER_EMPLOYEE_KEY,
BRANCH.SUBREGION_NAME,
BRANCH.PRIMARY_BRANCH_MANAGER_NAME,
BRANCH.PRIMARY_BRANCH_EMAIL,
BRANCH.PRIMARY_BRANCH_MANAGER_EMPLOYEE_KEY,
BRANCH.SECONDARY_BRANCH_MANAGER_NAME,
BRANCH.SECONDARY_BRANCH_EMAIL,
BRANCH.SECONDARY_BRANCH_MANAGER_EMPLOYEE_KEY,
BRANCH.RISKCONNECT_NODE_KEY,
BRANCH.RISKCONNECT_NAME,
BRANCH.HR_OFFICE_NUMBER,
BRANCH.HR_OFFICE_NAME,
NVL(BRANCH.ACTIVE_FLAG,TRUE),
NVL(BRANCH.EFFECTIVE_FROM_DATE,TO_DATE(''1900-01-01'', ''YYYY-MM-DD'')),
NVL(BRANCH.EFFECTIVE_TO_DATE,TO_DATE(''1900-01-01'', ''YYYY-MM-DD'')),

 :STR_ETL_TASK_KEY AS ETL_TASK_KEY,
 :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
    
CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE,
CURRENT_USER AS ETL_INSERTED_BY ,
CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE,
CURRENT_USER AS ETL_LAST_UPDATED_BY,
0 AS ETL_DELETED_FLAG,
0 AS ETL_INFERRED_MEMBER_FLAG
FROM BRANCH_MAPPING
LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH AS BRANCH ON BRANCH_MAPPING.BRANCH_KEY=BRANCH.BRANCH_KEY
LEFT JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_SOURCE_SYSTEM AS SOURCE_SYSTEM WHERE SOURCE_SYSTEM.SOURCE_SYSTEM_ID = 10
AND BRANCH_MAPPING.SYSTEM_CODE NOT IN (''33978'');


SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;

 EOT
}

