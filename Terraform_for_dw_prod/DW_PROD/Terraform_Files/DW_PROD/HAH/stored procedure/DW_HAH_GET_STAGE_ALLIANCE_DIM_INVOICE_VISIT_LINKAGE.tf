resource "snowflake_procedure" "DW_HAH_GET_STAGE_ALLIANCE_DIM_INVOICE_VISIT_LINKAGE" {
	name ="GET_STAGE_ALLIANCE_DIM_INVOICE_VISIT_LINKAGE"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- NAME:  ALLIANCE_DIM_INVOICE_VISIT_LINKAGE
--
-- DEVELOPMENT LOG:A
-- DATE         AUTHOR               NOTES:
-- --------     ------------------   ----------------------------------------------------------------------------------------------
-- 06/12/23	   Preeti Sharma		 Initial Development

--*****************************************************************************************************************************
--
INSERT OVERWRITE INTO STAGE.ALLIANCE_DIM_INVOICE_VISIT_LINKAGE
WITH CLIENT AS
(
    SELECT * FROM
    (
        SELECT MASTER_ID,CLIENTID
        FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.CLIENT_MASTER_LIST
    )
    UNION
    SELECT * FROM
    (
        SELECT DISTINCT MASTER_ID ,CLIENTID
        FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.CLIENT_MATCH_LIST
        WHERE CLIENTID NOT IN (SELECT CLIENTID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.CLIENT_MASTER_LIST)
    )
),
REVENUE_DATA_REPORT AS
(
    SELECT *     
    FROM DISC_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.CLEANBILLINGDETAIL -- The File received FROM Aggie
    QUALIFY DENSE_RANK() 
            OVER(PARTITION BY CLIENT, TIME_IN, TIME_OUT, CAREGIVER, RATE_CODE, HOURS, LOCATION 
            ORDER BY EXTRACTED_DATE DESC) = 1
)
SELECT
DISTINCT MD5(''ALLIANCE'' || ''-'' || SCH.SCHEDULEID || ''-'' || ''-1'' || ''-'' || C.MASTER_ID || ''-'' || ''GENERATIONS'') AS REVENUE_KEY
,MD5(''ALLIANCE'' || ''-'' || SCH.SCHEDULEID || ''-'' || ''GENERATIONS'') AS VISIT_KEY
, SCH.SCHEDULEID AS VISIT_ID
, DATE_TRUNC (DAY, SCH."DATE") AS SERVICE_DATE
, ''ALLIANCE'' AS SYSTEM_CODE 
,19 AS SOURCE_SYSTEM_ID
,:STR_ETL_TASK_KEY AS ETL_TASK_KEY
,:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY                     
,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE
,CURRENT_USER as ETL_INSERTED_BY
,convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_UPDATED_DATE
,CURRENT_USER as ETL_LAST_UPDATED_BY
,0 as ETL_DELETED_FLAG
FROM REVENUE_DATA_REPORT RD
INNER JOIN DISC_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.CLIENT CL
        ON CL.LASTNAME || '', '' || CL.FIRSTNAME = RD.CLIENT
INNER JOIN DISC_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.EMPLOYEE EM
        ON EM.LASTNAME || '', '' || EM.FIRSTNAME =  RD.CAREGIVER
INNER JOIN DISC_${var.SF_ENVIRONMENT}.GENERATIONSALLIANCE.SCHEDULES SCH
        ON CL.CLIENTID = SCH.CLIENTID
            AND SCH.SOCIALSECNUM = EM.SOCIALSECURITYNUM 
            AND SCH.ISCONFIRMED = TRUE
INNER JOIN CLIENT C 
        ON C.CLIENTID = SCH.CLIENTID  
INNER JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_CLIENT DC
        ON DC.CLIENT_NUMBER = C.MASTER_ID
            AND DC.SOURCE_SYSTEM_ID = 19
WHERE 1 = 1
            AND TO_TIME(RD.TIME_IN::DATETIME) = TO_TIME(SCH.STARTTIME) 
            AND TO_TIME(RD.TIME_OUT::DATETIME) = TO_TIME(SCH.ENDTIME)
            AND SCH."DATE"::DATE <= ''2022-09-30''
            AND DC.CLIENT_NUMBER  NOT IN (SELECT CLIENT_NUMBER FROM DATA_MANAGEMENT.DATA_QUALITY.INVALID_CLIENT_NUMBER WHERE SOURCE_SYSTEM_ID = 19 AND SYSTEM_CODE = ''GENERATIONS'')
; 

RETURN ''SUCCESS'';
END;

 EOT
}

