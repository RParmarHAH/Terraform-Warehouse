resource "snowflake_procedure" "DW_HAH_GET_STAGE_ROSTER_FACT_CLIENT_STATUS_HISTORY" {
	name ="GET_STAGE_ROSTER_FACT_CLIENT_STATUS_HISTORY"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN
--*****************************************************************************************************************************
-- NAME:  ROSTER_FACT_CLIENT_STATUS_HISTORY
--
-- PURPOSE: Populates Stage Molina, Centene and AmeriHealth FACT_CLIENT_STATUS_HISTORY
--
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 7/7/2023    Pooja Deokate		 Initial version
-- 01/09/2023  Pooja Deokate         Modified into Start_date logic
-- 18/10/2023  Pooja Deokate         Modified into FACT_CLIENT_STATUS_HISTORY_KEY logic
--*****************************************************************************************************************************
INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.STAGE.ROSTER_FACT_CLIENT_STATUS_HISTORY
SELECT MD5(''MOLINA'' || ''-'' || TRIM(MDC.EXTERNAL_ID) || ''-'' || TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') || ''-'' || ''MOLINA'') AS FACT_CLIENT_STATUS_HISTORY_KEY
		, MD5(''MOLINA'' || ''-'' || TRIM(MDC.EXTERNAL_ID) || ''-'' || ''MOLINA'') AS CLIENT_KEY
		, ''MOLINA'' AS SYSTEM_CODE
		, ''32'' AS SOURCE_SYSTEM_ID
		, ''ROSTER'' as STATUS_SOURCE
		, TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') AS START_DATE
		, NULL AS END_DATE
		, TRUE AS CURRENT_RECORD_FLAG_ACTIVE
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
		, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY
FROM DISC_${var.SF_ENVIRONMENT}.MOLINA.MOLINA_SOURCE_DATA MDC
UNION ALL
SELECT MD5(''CENTENE''  || ''-'' || TRIM(MDC.EXTERNAL_ID)|| ''-'' || TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') ||''-'' || ''CENTENE'') AS FACT_CLIENT_STATUS_HISTORY_KEY
		, MD5(''CENTENE'' || ''-'' || TRIM(MDC.EXTERNAL_ID) || ''-'' || ''CENTENE'') AS CLIENT_KEY
		, ''CENTENE'' AS SYSTEM_CODE
		, ''27'' AS SOURCE_SYSTEM_ID
		, ''ROSTER'' AS STATUS_SOURCE
		, TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') AS START_DATE
		, NULL AS END_DATE
		, TRUE AS CURRENT_RECORD_FLAG_ACTIVE
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
		, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY
FROM DISC_${var.SF_ENVIRONMENT}.CENTENE.CENTENE_SOURCE_DATA MDC
UNION ALL
SELECT MD5(''AMERIHEALTH''  || ''-'' || TRIM(MDC.EXTERNAL_ID)|| ''-'' || TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') ||''-'' || ''AMERIHEALTH'') AS FACT_CLIENT_STATUS_HISTORY_KEY
		, MD5(''AMERIHEALTH'' || ''-'' || TRIM(MDC.EXTERNAL_ID) || ''-'' || ''AMERIHEALTH'') AS CLIENT_KEY
		, ''AMERIHEALTH'' AS SYSTEM_CODE
		, ''35'' AS SOURCE_SYSTEM_ID
		, ''ROSTER'' AS STATUS_SOURCE
		, TO_DATE(REGEXP_SUBSTR(MDC.FILENAME , ''[0-9]{8}''), ''YYYYMMDD'') AS START_DATE
		, NULL AS END_DATE
		, TRUE AS CURRENT_RECORD_FLAG_ACTIVE
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
		, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY 
FROM DISC_${var.SF_ENVIRONMENT}.AMERIHEALTH.AMERIHEALTH_SOURCE_DATA MDC;
RETURN ''SUCCESS'';
END;

 EOT
}

