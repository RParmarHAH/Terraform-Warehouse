resource "snowflake_view" "DW_HAH_VW_DIM_CLIENT_MERGED" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	name = "VW_DIM_CLIENT_MERGED"
	statement = <<-SQL
	 WITH DATAFLEX_CLIENTS AS (
	SELECT CLIENT.CLIENT_KEY, LIST.SYSTEM_CODE, CLIENT.CLIENT_PID 
	FROM (
		SELECT SOURCE_SYSTEM_ID, IFF(SYSTEM_CODE IN ('GA', 'SC'), 'GA', SYSTEM_CODE) AS SYSTEM_CODE, CLIENT_PID 
		FROM HAH.DIM_CLIENT
		WHERE SOURCE_SYSTEM_ID = 3
		GROUP BY SOURCE_SYSTEM_ID, IFF(SYSTEM_CODE IN ('GA', 'SC'), 'GA', SYSTEM_CODE), CLIENT_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_CLIENT AS CLIENT
		ON CLIENT.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND IFF(CLIENT.SYSTEM_CODE IN ('GA', 'SC'), 'GA', CLIENT.SYSTEM_CODE) = LIST.SYSTEM_CODE AND CLIENT.CLIENT_PID = LIST.CLIENT_PID
), COASTAL_CLIENTS AS (
	SELECT CLIENT.CLIENT_KEY, CLIENT.CLIENT_PID
	FROM (
		SELECT CLIENT_PID
		FROM HAH.DIM_CLIENT
		WHERE SOURCE_SYSTEM_ID IN (1, 2)
		GROUP BY CLIENT_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_CLIENT AS CLIENT
		ON CLIENT.SOURCE_SYSTEM_ID IN (1, 2) AND CLIENT.CLIENT_PID = LIST.CLIENT_PID
), EXCEL_CLIENTS AS (
	SELECT CLIENT.CLIENT_KEY, CLIENT.CLIENT_PID
	FROM (
		SELECT SOURCE_SYSTEM_ID, CLIENT_PID
		FROM HAH.DIM_CLIENT
		WHERE SOURCE_SYSTEM_ID = 4
		GROUP BY SOURCE_SYSTEM_ID, CLIENT_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_CLIENT AS CLIENT
		ON CLIENT.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND CLIENT.CLIENT_PID = LIST.CLIENT_PID
), MERGED_CLIENTS AS (
	-- Coastal
	SELECT DATAFLEX.CLIENT_PID,
		DATAFLEX.CLIENT_KEY AS OLD_SYSTEM_CLIENT_KEY, 
		COASTAL.CLIENT_KEY AS NEW_SYSTEM_CLIENT_KEY
	FROM DATAFLEX_CLIENTS AS DATAFLEX
	JOIN COASTAL_CLIENTS AS COASTAL
		ON COASTAL.CLIENT_PID = DATAFLEX.CLIENT_PID
	WHERE DATAFLEX.SYSTEM_CODE = 'GA'
	-- Excel
	UNION ALL
	SELECT DATAFLEX.CLIENT_PID,
		DATAFLEX.CLIENT_KEY AS OLD_SYSTEM_CLIENT_KEY, 
		EXCEL.CLIENT_KEY AS NEW_SYSTEM_CLIENT_KEY
	FROM DATAFLEX_CLIENTS AS DATAFLEX
	JOIN EXCEL_CLIENTS AS EXCEL
		ON EXCEL.CLIENT_PID = DATAFLEX.CLIENT_PID
	WHERE DATAFLEX.SYSTEM_CODE = 'PA'
)
	SELECT CLIENT.CLIENT_KEY AS ORIGINAL_CLIENT_KEY,
		CLIENT.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		CLIENT.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		CLIENT.CLIENT_NUMBER AS ORIGINAL_CLIENT_NUMBER,
		NEW_CLIENT.*
	FROM HAH.DIM_CLIENT AS CLIENT
	LEFT JOIN MERGED_CLIENTS AS MERGED_CLIENTS
		ON MERGED_CLIENTS.OLD_SYSTEM_CLIENT_KEY = CLIENT.CLIENT_KEY
	JOIN HAH.DIM_CLIENT AS NEW_CLIENT
		ON NEW_CLIENT.CLIENT_KEY = COALESCE(MERGED_CLIENTS.NEW_SYSTEM_CLIENT_KEY, CLIENT.CLIENT_KEY);
SQL
	or_replace = true 
	is_secure = false 
}

