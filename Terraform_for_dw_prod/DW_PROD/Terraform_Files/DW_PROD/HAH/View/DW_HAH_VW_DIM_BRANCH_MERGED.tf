resource "snowflake_view" "DW_HAH_VW_DIM_BRANCH_MERGED" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "HAH"
	name = "VW_DIM_BRANCH_MERGED"
	statement = <<-SQL
	 WITH DATAFLEX_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID = 3
), COASTAL_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER 
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID IN (1, 2)
), EXCEL_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER 
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID = 4
), MERGED_OFFICES AS (
	-- Coastal offices
	SELECT DATAFLEX.BRANCH_KEY AS OLD_SYSTEM_BRANCH_KEY, COASTAL.BRANCH_KEY AS NEW_SYSTEM_BRANCH_KEY
	FROM DATAFLEX_OFFICES AS DATAFLEX
	JOIN COASTAL_OFFICES AS COASTAL
		ON COASTAL.OFFICE_STATE_CODE = DATAFLEX.OFFICE_STATE_CODE AND COASTAL.OFFICE_NUMBER = DATAFLEX.OFFICE_NUMBER
	-- Excel offices
	UNION
	SELECT DATAFLEX.BRANCH_KEY AS OLD_SYSTEM_BRANCH_KEY, EXCEL.BRANCH_KEY AS NEW_SYSTEM_BRANCH_KEY
	FROM DATAFLEX_OFFICES AS DATAFLEX
	JOIN EXCEL_OFFICES AS EXCEL
		ON EXCEL.OFFICE_STATE_CODE = DATAFLEX.OFFICE_STATE_CODE AND EXCEL.OFFICE_NUMBER = DATAFLEX.OFFICE_NUMBER
)
	SELECT BRANCH.BRANCH_KEY as ORIGINAL_BRANCH_KEY,
		BRANCH.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		BRANCH.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		BRANCH.OFFICE_CODE AS ORIGINAL_OFFICE_CODE,
		NEW_BRANCH.*,
		TRIM(
		-- Remove Prepended State from Parent_Branch_Name
		REGEXP_REPLACE(
			SUBSTRING(
				NEW_BRANCH.PARENT_BRANCH_NAME,
				1, LEN(NEW_BRANCH.PARENT_BRANCH_NAME) - CHARINDEX('(', REVERSE(NEW_BRANCH.PARENT_BRANCH_NAME)) - 1 -- Remove appended office_code/office_number from Parent_Branch_Name
			)
		, '[A-Z]{2,} -', '', 1, 1)) AS PARENT_BRANCH_NAME_SHORTENED
	FROM HAH.DIM_BRANCH AS BRANCH
	LEFT JOIN MERGED_OFFICES AS MERGED_OFFICES
		ON MERGED_OFFICES.OLD_SYSTEM_BRANCH_KEY = BRANCH.BRANCH_KEY
	LEFT JOIN HAH.DIM_BRANCH AS NEW_BRANCH
		ON NEW_BRANCH.BRANCH_KEY = COALESCE(MERGED_OFFICES.NEW_SYSTEM_BRANCH_KEY, BRANCH.BRANCH_KEY);
SQL
	or_replace = true 
	is_secure = false 
}

