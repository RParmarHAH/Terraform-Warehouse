resource "snowflake_procedure" "DW_INTEGRATION_FACT_INTAKE_MERGED_POSTPROCESSING" {
	name ="FACT_INTAKE_MERGED_POSTPROCESSING"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "INTEGRATION"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result VARCHAR;
BEGIN

    INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_INTAKE_MERGED
	SELECT INTAKE.INTAKE_KEY,
		INTAKE.REPORT_DATE,
		COALESCE(BRANCH_MERGED.BRANCH_KEY, INTAKE.BRANCH_KEY) AS BRANCH_KEY,
		INTAKE.BRANCH_KEY AS ORIGINAL_BRANCH_KEY,
		COALESCE(CLIENT_MERGED.CLIENT_KEY, INTAKE.CLIENT_KEY) AS CLIENT_KEY,
		INTAKE.CLIENT_KEY AS ORIGINAL_CLIENT_KEY,
		INTAKE.CONTRACT_KEY,
		COALESCE(CLIENT_MERGED.SOURCE_SYSTEM_ID, INTAKE.SOURCE_SYSTEM_ID) AS SOURCE_SYSTEM_ID,
		INTAKE.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		INTAKE.REAUTHORIZED_DATE,
		INTAKE.PRE_AUTH_NUMBER				-- Added by PJShah on 02052022
   		,INTAKE.BEGIN_SERVICE_DATE      	-- Added by PJShah on 02052022                 
   		,INTAKE.END_SERVICE_DATE			-- Added by PJShah on 02052022
   		,INTAKE.LATEST_AUTH_BEGIN_DATE		-- Added by PJShah on 02052022            
   		,INTAKE.LATEST_AUTH_END_DATE		-- Added by PJShah on 02052022
		,COALESCE(BRANCH_MERGED.BRANCH_NAME, INTAKE.BRANCH_NAME) AS BRANCH_NAME,
		INTAKE.BRANCH_NAME AS ORIGINAL_BRANCH_NAME,
		COALESCE(CLIENT_MERGED.CLIENT_NUMBER, INTAKE.CLIENT_NUMBER) AS CLIENT_NUMBER,
		INTAKE.CLIENT_NUMBER AS ORIGINAL_CLIENT_NUMBER,
		INTAKE.CONTRACT_CODE,
		INTAKE.BILL_RATE,
		COALESCE(CLIENT_MERGED.SYSTEM_CODE, INTAKE.SYSTEM_CODE) AS SYSTEM_CODE,
		INTAKE.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		INTAKE.CASE_MANAGER,
		INTAKE.HOURS_AUTHORIZED,
		INTAKE.HOURS_AUTHORIZED_NON_ADJUSTED,
		INTAKE.ETL_TASK_KEY,
		INTAKE.ETL_INSERTED_TASK_KEY,
		INTAKE.ETL_INSERTED_DATE,
		INTAKE.ETL_INSERTED_BY,
		INTAKE.ETL_LAST_UPDATED_DATE,
		INTAKE.ETL_LAST_UPDATED_BY,
		INTAKE.ETL_DELETED_FLAG
	FROM HAH.FACT_INTAKE AS INTAKE
	LEFT JOIN INTEGRATION.DIM_BRANCH_MERGED AS BRANCH_MERGED
		ON BRANCH_MERGED.ORIGINAL_BRANCH_KEY = INTAKE.BRANCH_KEY
	LEFT JOIN INTEGRATION.DIM_CLIENT_MERGED AS CLIENT_MERGED
		ON CLIENT_MERGED.ORIGINAL_CLIENT_KEY = INTAKE.CLIENT_KEY;

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

return return_result;
END;


 EOT
}

