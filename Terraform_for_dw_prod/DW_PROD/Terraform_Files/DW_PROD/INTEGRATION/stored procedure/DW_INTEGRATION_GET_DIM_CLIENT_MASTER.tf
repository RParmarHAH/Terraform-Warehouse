resource "snowflake_procedure" "DW_INTEGRATION_GET_DIM_CLIENT_MASTER" {
	name ="GET_DIM_CLIENT_MASTER"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "INTEGRATION"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result varchar(1000);
BEGIN

INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.INTEGRATION.DIM_CLIENT_MASTER 
WITH
  CTE_MATCHES AS (
      SELECT
          FILENAME
          , CLUSTER_ID
          , COUNT(0) CNT
      FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.CCSI.DF_CCSI_CLIENT_DEDUPE_SOURCE
      GROUP BY
          FILENAME
          , CLUSTER_ID
      HAVING CNT > 1
  ),
  CTE_CLUSTERS AS (
      SELECT
          DEDUPE.RECORD_ID
          , DEDUPE.CLUSTER_ID
          , ROW_NUMBER() OVER(PARTITION BY DEDUPE.CLUSTER_ID ORDER BY  CCSI.CLIENT_NUMBER DESC) RECORD_ORDER
          ,CCSI.BEGIN_DATE
          ,CCSI.CLIENT_NUMBER 
      FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.CCSI.DF_CCSI_CLIENT_DEDUPE_SOURCE DEDUPE
      INNER JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_CLIENT CCSI ON
            DEDUPE.RECORD_ID = CCSI.CLIENT_KEY
      INNER JOIN CTE_MATCHES MATCHES ON
            MATCHES.FILENAME = DEDUPE.FILENAME
            AND MATCHES.CLUSTER_ID = DEDUPE.CLUSTER_ID
      ORDER BY DEDUPE.CLUSTER_ID
  ) --SELECT * FROM CTE_CLUSTERS;
SELECT  CLIENT_KEY AS MASTER_ID,
		CCSI.*
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_CLIENT CCSI
INNER JOIN CTE_CLUSTERS CLUSTS
    ON CLUSTS.RECORD_ID = CCSI.CLIENT_KEY
    AND CLUSTS.RECORD_ORDER = 1 
UNION 
SELECT CLIENT_KEY AS MASTER_ID,
		CCSI.*
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_CLIENT CCSI
LEFT JOIN CTE_CLUSTERS DUPS
    ON DUPS.RECORD_ID = CCSI.CLIENT_KEY
WHERE DUPS.RECORD_ID IS NULL;

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;

 EOT
}

