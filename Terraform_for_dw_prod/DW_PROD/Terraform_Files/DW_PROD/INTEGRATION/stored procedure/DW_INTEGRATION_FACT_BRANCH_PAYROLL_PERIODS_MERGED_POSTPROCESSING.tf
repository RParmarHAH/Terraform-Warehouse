resource "snowflake_procedure" "DW_INTEGRATION_FACT_BRANCH_PAYROLL_PERIODS_MERGED_POSTPROCESSING" {
	name ="FACT_BRANCH_PAYROLL_PERIODS_MERGED_POSTPROCESSING"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "INTEGRATION"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result VARCHAR;
BEGIN

    INSERT  OVERWRITE  INTO DW_${var.SF_ENVIRONMENT}.INTEGRATION.FACT_BRANCH_PAYROLL_PERIODS_MERGED 
    SELECT PAYROLL_PERIODS.BRANCH_PAYROLL_PERIODS_KEY,
		COALESCE(BRANCH_MERGED.BRANCH_KEY, PAYROLL_PERIODS.BRANCH_KEY) AS BRANCH_KEY,
		COALESCE(BRANCH_MERGED.OFFICE_STATE_CODE, PAYROLL_PERIODS.OFFICE_STATE_CODE) AS OFFICE_STATE_CODE,
		COALESCE(BRANCH_MERGED.DETAILED_OFFICE_NAME, PAYROLL_PERIODS.DETAILED_OFFICE_NAME) AS DETAILED_OFFICE_NAME,
		PAYROLL_PERIODS.BRANCH_KEY AS ORIGINAL_BRANCH_KEY,
		PAYROLL_PERIODS.PERIOD_START_DATE,
		PAYROLL_PERIODS.PERIOD_END_DATE,
		PAYROLL_PERIODS.CHECK_DATE,
		PAYROLL_PERIODS.ETL_TASK_KEY,
		PAYROLL_PERIODS.ETL_INSERTED_TASK_KEY,
		PAYROLL_PERIODS.ETL_INSERTED_DATE,
		PAYROLL_PERIODS.ETL_INSERTED_BY,
		PAYROLL_PERIODS.ETL_LAST_UPDATED_DATE,
		PAYROLL_PERIODS.ETL_LAST_UPDATED_BY,
		PAYROLL_PERIODS.ETL_DELETED_FLAG,
		PAYROLL_PERIODS.ETL_INFERRED_MEMBER_FLAG
	FROM HAH.FACT_BRANCH_PAYROLL_PERIODS AS PAYROLL_PERIODS
	JOIN INTEGRATION.DIM_BRANCH_MERGED AS BRANCH_MERGED
		ON BRANCH_MERGED.ORIGINAL_BRANCH_KEY = PAYROLL_PERIODS.BRANCH_KEY;
   
SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

return return_result;
END;


 EOT
}

