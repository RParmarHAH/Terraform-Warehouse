resource "snowflake_procedure" "DW_INTEGRATION_DATAFLEX_MATRIXCARE_CLIENT_MAPPING_IN_MI_POSTPROCESSING" {
	name ="DATAFLEX_MATRIXCARE_CLIENT_MAPPING_IN_MI_POSTPROCESSING"
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "INTEGRATION"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

DECLARE
    return_result VARCHAR;
BEGIN

INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.INTEGRATION.DATAFLEX_MATRIXCARE_CLIENT_MAPPING_IN_MI
WITH DC AS 
(
SELECT ROW_NUMBER() OVER (ORDER BY C.CLIENT_NUMBER,C.source_system_id) AS ID,*
from HAH.DIM_CLIENT C
where C.source_system_id IN (3,7)
AND C.SYSTEM_CODE IN (''IN'',''MI'',''MATRIXCARE'')
AND (C.CLIENT_NUMBER) NOT IN (SELECT client_number FROM DATA_MANAGEMENT.DATA_QUALITY.INVALID_CLIENT_NUMBER WHERE SYSTEM_CODE IN (''IN'',''MI'',''MATRIXCARE''))
) 
SELECT DISTINCT MASTER_CLIENT_KEY,client_number,client_key,system_code,source_system_id
FROM 
(
SELECT min(MASTER_CLIENT_KEY) MASTER_CLIENT_KEY,client_number,FIRST_NAME,CLIENT_LAST_NAME,CLIENT_DOB,client_key,CLIENT_ADDRESS1,CLIENT_ZIP,SYSTEM_CODE,source_system_id,CLIENT_HOME_PHONE,CLIENT_ETHNICITY,
CLIENT_PERSONAL_EMAIL
FROM 
(
SELECT DISTINCT 
CASE WHEN (UPPER(TRIM(MC.CLIENT_FIRST_NAME)) = UPPER(TRIM(DC.CLIENT_FIRST_NAME)) 
			AND MC.CLIENT_DOB = DC.CLIENT_DOB
			AND SUBSTRING(MC.CLIENT_ZIP,1,5)=SUBSTRING(DC.CLIENT_ZIP,1,5)
			AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
			)
	 THEN CONCAT(MIN(DC.CLIENT_NUMBER) OVER (PARTITION BY UPPER(TRIM(DC.CLIENT_FIRST_NAME)),DC.CLIENT_DOB,SUBSTRING(DC.CLIENT_ZIP,1,5)),'' - '',
	             MIN(DC.CLIENT_DOB) OVER (PARTITION BY UPPER(TRIM(DC.CLIENT_FIRST_NAME)),DC.CLIENT_DOB,SUBSTRING(DC.CLIENT_ZIP,1,5)),''-RULE-1'')
		WHEN (SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5)
	 			AND SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
	 			AND MC.CLIENT_DOB = DC.CLIENT_DOB
	 			AND MC.CLIENT_GENDER=DC.CLIENT_GENDER)
		THEN CONCAT(MIN(DC.CLIENT_NUMBER) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),DC.CLIENT_DOB),'' - '',
		            MIN(DC.CLIENT_DOB) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),DC.CLIENT_DOB),''-RULE-2'')
			WHEN 
				(SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5)
					AND SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
					AND SUBSTRING(MC.CLIENT_ZIP,1,5)=SUBSTRING(DC.CLIENT_ZIP,1,5)
					AND SUBSTRING(UPPER(TRIM(MC.CLIENT_ADDRESS1)),1,5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_ADDRESS1)),1,5)
					AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
					AND (editdistance(MC.CLIENT_DOB,DC.CLIENT_DOB)<2 OR (editdistance(D.SSN,M.SSN))<3))
			THEN CONCAT(MIN(DC.CLIENT_NUMBER) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),SUBSTRING(DC.CLIENT_ZIP,1,5),SUBSTRING(UPPER(TRIM(DC.CLIENT_ADDRESS1)),1,5)),'' - '',
			            MIN(SUBSTRING(DC.CLIENT_ZIP,1,5)) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),SUBSTRING(DC.CLIENT_ZIP,1,5),SUBSTRING(UPPER(TRIM(DC.CLIENT_ADDRESS1)),1,5)),''-RULE-3'')
 				WHEN (UPPER(TRIM(MC.CLIENT_FIRST_NAME)) = UPPER(TRIM(DC.CLIENT_FIRST_NAME)) 
						AND MC.CLIENT_DOB = DC.CLIENT_DOB
						AND (MC.CLIENT_HOME_PHONE = DC.CLIENT_HOME_PHONE)
						AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
						AND editdistance(MC.CLIENT_LAST_NAME,DC.CLIENT_LAST_NAME)<3
					 )
	 				THEN CONCAT(MIN(DC.CLIENT_NUMBER) OVER (PARTITION BY UPPER(TRIM(DC.CLIENT_FIRST_NAME)),DC.CLIENT_DOB,DC.CLIENT_HOME_PHONE),'' - '',
	 				            MIN(DC.CLIENT_DOB) OVER (PARTITION BY UPPER(TRIM(DC.CLIENT_FIRST_NAME)),DC.CLIENT_DOB,DC.CLIENT_HOME_PHONE),''-RULE-4'')
						WHEN (SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
							AND SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5)
							AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
							AND MC.CLIENT_PERSONAL_EMAIL = DC.CLIENT_PERSONAL_EMAIL)
						THEN CONCAT(MIN(DC.CLIENT_NUMBER) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),DC.CLIENT_PERSONAL_EMAIL),'' - '',
						            MIN(DC.CLIENT_PERSONAL_EMAIL) OVER (PARTITION BY SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5),SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5),DC.CLIENT_PERSONAL_EMAIL),''-RULE-5'')
							END MASTER_CLIENT_KEY,
DC.client_number,UPPER(TRIM(DC.CLIENT_FIRST_NAME)) FIRST_NAME,DC.CLIENT_LAST_NAME,DC.CLIENT_DOB,DC.client_key,DC.CLIENT_ADDRESS1,DC.CLIENT_ZIP,DC.SYSTEM_CODE,DC.source_system_id,DC.CLIENT_HOME_PHONE,DC.CLIENT_ETHNICITY,
DC.CLIENT_PERSONAL_EMAIL
FROM DC
LEFT JOIN (SELECT SSN FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFCLIENTS WHERE DBNAME IN (''IN'')) D ON MD5(D.SSN)=DC.client_pid
JOIN DC as MC
LEFT JOIN (SELECT SSN FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFCLIENTS WHERE DBNAME IN (''IN'')) M ON MD5(M.SSN)=MC.client_pid
WHERE DC.id<>MC.id AND
(
	(
	UPPER(TRIM(MC.CLIENT_FIRST_NAME)) = UPPER(TRIM(DC.CLIENT_FIRST_NAME))
	AND MC.CLIENT_DOB = DC.CLIENT_DOB
	AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
	AND (
		 MC.CLIENT_HOME_PHONE = DC.CLIENT_HOME_PHONE OR 
		 SUBSTRING(MC.CLIENT_ZIP,1,5)=SUBSTRING(DC.CLIENT_ZIP,1,5))
		 AND editdistance(MC.CLIENT_LAST_NAME,DC.CLIENT_LAST_NAME)<3
		 )
OR
	(SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5)
	 AND SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
	 AND MC.CLIENT_DOB = DC.CLIENT_DOB
	 AND MC.CLIENT_GENDER=DC.CLIENT_GENDER)
OR
	(SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5)
		AND SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
		AND SUBSTRING(MC.CLIENT_ZIP,1,5)=SUBSTRING(DC.CLIENT_ZIP,1,5)
		AND SUBSTRING(UPPER(TRIM(MC.CLIENT_ADDRESS1)),1,5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_ADDRESS1)),1,5)
		AND MC.CLIENT_GENDER=DC.CLIENT_GENDER
		AND (editdistance(MC.CLIENT_DOB,DC.CLIENT_DOB)<2 OR (editdistance(D.SSN,M.SSN))<3))
OR 
	(SUBSTRING(UPPER(TRIM(MC.CLIENT_LAST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_LAST_NAME)), 1, 5) 
		AND SUBSTRING(UPPER(TRIM(MC.CLIENT_FIRST_NAME)), 1, 5) = SUBSTRING(UPPER(TRIM(DC.CLIENT_FIRST_NAME)), 1, 5) 
		AND MC.CLIENT_PERSONAL_EMAIL = DC.CLIENT_PERSONAL_EMAIL )
)		
) x
GROUP BY client_number,FIRST_NAME,CLIENT_LAST_NAME,CLIENT_DOB,client_key,CLIENT_ADDRESS1,CLIENT_ZIP,SYSTEM_CODE,source_system_id,CLIENT_HOME_PHONE,CLIENT_ETHNICITY,CLIENT_PERSONAL_EMAIL
) z;

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

return return_result;
END;


 EOT
}

