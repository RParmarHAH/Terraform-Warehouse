resource "snowflake_view" "DW_STAGE_VW_CURRENT_DELETED_MATRIXCARE_DIM_SUPERVISOR" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_DELETED_MATRIXCARE_DIM_SUPERVISOR"
	statement = <<-SQL
	 WITH SUPERVISORS AS
(
	SELECT DISTINCT NVL( mccg.CAR_SUPERVISOR, mccg.CAR_MANAGER) AS SUPERVISOR_CODE,
		MAX( mccg.ETL_LAST_UPDATED_DATE) AS ETL_LAST_UPDATED_DATE
	FROM DISC_${var.SF_ENVIRONMENT}.MATRIXCARE.STVHC_T_CAREGIVER mccg
	WHERE NVL( mccg.CAR_SUPERVISOR, mccg.CAR_MANAGER) IS NOT NULL
	GROUP BY 1
)
(SELECT DISTINCT 
	md5( 'MATRIXCARE' || '-' || s.SUPERVISOR_CODE || '-' || 'MATRIXCARE') AS SUPERVISOR_KEY
 FROM SUPERVISORS AS s
 LEFT OUTER JOIN DISC_${var.SF_ENVIRONMENT}.MATRIXCARE.HIST_STVHC_T_CAREGIVER mccg
	ON s.SUPERVISOR_CODE = mccg.CAR_ID
 WHERE (mccg.ETL_LAST_UPDATED_DATE >= '1900-01-01' OR s.ETL_LAST_UPDATED_DATE >= '1900-01-01')
 	AND mccg.ETL_DELETED_FLAG = TRUE
 	AND CAST( mccg.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT MAX( ETL_LAST_UPDATED_DATE::DATE) FROM DISC_${var.SF_ENVIRONMENT}.MATRIXCARE.HIST_STVHC_T_CAREGIVER)
);
SQL
	or_replace = true 
	is_secure = false 
}

