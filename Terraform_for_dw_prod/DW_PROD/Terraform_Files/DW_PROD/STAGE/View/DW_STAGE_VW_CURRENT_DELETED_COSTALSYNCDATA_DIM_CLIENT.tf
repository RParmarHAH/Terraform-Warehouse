resource "snowflake_view" "DW_STAGE_VW_CURRENT_DELETED_COSTALSYNCDATA_DIM_CLIENT" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_DELETED_COSTALSYNCDATA_DIM_CLIENT"
	statement = <<-SQL
	 WITH 
    main as
    (
        SELECT DISTINCT
			P.DB AS DB, 
            P.PATIENT_NUMBER AS ClientNumber,
            TRIM(P.LOCATION_CODE) AS LOCATION_CODE,
            ST.STATE_ISO_CODE AS OfficeState,
            UPPER(L.LOCATION_NAME) as OfficeName, 
            MIN(A.ADMIT_DATE) OVER (PARTITION BY P.DB, P.PATIENT_NUMBER) AS ReferralDate, 
            IFF(P.FIRST_VISIT_DATE = '1900-01-01 00:00:00.000',NULL,P.FIRST_VISIT_DATE) AS FirstDateOfService, 
            P.LAST_VISIT_DATE AS LatestDateOfService,
            CASE WHEN LatestDateOfService BETWEEN DATEADD(DAYS,-30,CURRENT_DATE) AND CURRENT_DATE THEN 1 ELSE 0 END AS Active,
            P.DEPARTMENT__CODE AS SUPERVISORCODE, 
            D.DEPARTMENT_NAME AS SUPERVISORNAME,
            GREATEST(
            	NVL(MAX(P.ETL_LAST_UPDATED_DATE) OVER (PARTITION BY P.DB, P.PATIENT_NUMBER), '1/1/1900'),
            	NVL(MAX(L.ETL_LAST_UPDATED_DATE) OVER (PARTITION BY P.DB, P.PATIENT_NUMBER), '1/1/1900'),
            	NVL(MAX(D.ETL_LAST_UPDATED_DATE) OVER (PARTITION BY P.DB, P.PATIENT_NUMBER), '1/1/1900'),
            	NVL(MAX(A.ETL_LAST_UPDATED_DATE) OVER (PARTITION BY P.DB, P.PATIENT_NUMBER), '1/1/1900')) AS ETL_LAST_UPDATED_DATE
        FROM "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."CV_PATIENTS" P 
        LEFT JOIN "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."CV_LOCATIONS" L ON TRIM(P.DB) = TRIM(L.DB) AND TRIM(P.LOCATION_CODE) = TRIM(L.LOCATION_CODE)
        LEFT JOIN HAH.DIM_STATE ST ON ST.STATE_ISO_CODE = NULLIF(TRIM(L.STATE_CODE), '')
        LEFT JOIN "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."CV_DEPARTMENTS" D ON TRIM(P.DB) = TRIM(D.DB) AND TRIM(P.DEPARTMENT__CODE) = TRIM(D.DEPARTMENT__CODE)
        LEFT JOIN "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."CV_ADMISSIONS" A ON TRIM(P.PATIENT_NUMBER) = TRIM(A.PATIENT_NUMBER) AND TRIM(P.DB)=TRIM(A.DB)
        LEFT JOIN "DATA_MANAGEMENT"."DATA_QUALITY"."INVALID_CLIENT_NUMBER" DQCN 
            ON TRIM(P.PATIENT_NUMBER,' ') = TRIM(DQCN.CLIENT_NUMBER,' ')
		WHERE DQCN.CLIENT_NUMBER IS NULL
    )
  SELECT DISTINCT 
      md5(f.DB || '-' || f.ClientNumber || '-'  ||  'COSTALSYNCDATA') AS CLIENT_KEY --PK
  FROM main f
  JOIN "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."HIST_CV_PATIENTS" P ON f.ClientNumber = P.PATIENT_NUMBER AND f.DB=P.DB
  LEFT JOIN "DATA_MANAGEMENT"."DATA_QUALITY"."INVALID_PHONE_NUMBER" DQP ON P.PHONE=DQP.PHONE_NUMBER
  LEFT JOIN "DATA_MANAGEMENT"."DATA_QUALITY"."INVALID_SSN" DQSSN ON P.SOCIAL_SECURITY_NUMBER=DQSSN.SSN
  LEFT JOIN "DATA_MANAGEMENT"."DATA_QUALITY"."INVALID_DATE" DQDOB ON P.BIRTH_DATE = DQDOB.DOB
  LEFT JOIN "DATA_MANAGEMENT"."DATA_QUALITY"."INVALID_DATE" DQRD ON f.Referraldate = DQRD.REFERRAL_DATE
  LEFT JOIN HAH.DIM_ZIP_CODE Z ON Z.ZIP_CODE=TRIM(P.ZIPCODE)
  LEFT JOIN HAH.DIM_STATE S ON S.STATE_ISO_CODE=UPPER(TRIM(P.STATE_CODE))
  WHERE f.ETL_LAST_UPDATED_DATE >= '1900-01-01' 
  	AND P.ETL_DELETED_FLAG = TRUE
  	AND CAST(P.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT CAST(MAX(ETL_LAST_UPDATED_DATE) AS DATE) FROM "DISC_${var.SF_ENVIRONMENT}"."COSTALSYNCDATA"."HIST_CV_PATIENTS");
SQL
	or_replace = true 
	is_secure = false 
}

