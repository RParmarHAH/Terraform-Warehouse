resource "snowflake_view" "DW_STAGE_VW_CURRENT_DELETED_DATAFLEXSYNCDATA_DIM_SUPERVISOR" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_DELETED_DATAFLEXSYNCDATA_DIM_SUPERVISOR"
	statement = <<-SQL
	 WITH BULK_BILLING_SUPERVISORS AS (
    SELECT DISTINCT I.DBNAME,  
    	TRY_CAST(CONCAT(-100, I.OFFICE) AS INTEGER)::STRING AS DUMMY_SUPERVISOR_CODE,
    	MD5(I.DBNAME || '-' || DUMMY_SUPERVISOR_CODE || '-' || 'DATAFLEXSYNCDATA-DUMMY') AS DUMMY_SUPERVISOR_KEY,
    	CONCAT('BULK BILLING SPV for ', COALESCE(B.BRANCH_NAME, CONCAT(I.DBNAME, '-Unknown'))) AS DUMMY_SUPERVISOR_NAME
    FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.DFARINVOICES I
	LEFT JOIN HAH.DIM_BRANCH B ON B.SOURCE_SYSTEM_ID = 3 AND B.SYSTEM_CODE = I.DBNAME AND B.OFFICE_NUMBER = I.OFFICE 
    WHERE I.ETL_LAST_UPDATED_DATE >= '1900-01-01'
        AND 1 = 2 -- Do not include this CTE for the Current_Deleted view
)
	SELECT 
		md5(f.DbName || '-'  || nvl(f.Code,'Unknown-' || f.DbName) || '-'  || 'DATAFLEXSYNCDATA') AS SUPERVISOR_KEY
	FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.HIST_DfSupervisors f
	WHERE f.ETL_DELETED_FLAG = TRUE
        AND CAST(f.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT CAST(MAX(ETL_LAST_UPDATED_DATE) AS DATE) FROM DISC_${var.SF_ENVIRONMENT}.DATAFLEXSYNCDATA.HIST_DfSupervisors)
	UNION ALL
	SELECT DUMMY_SUPERVISOR_KEY AS SUPERVISOR_KEY
	FROM BULK_BILLING_SUPERVISORS;
SQL
	or_replace = true 
	is_secure = false 
}

