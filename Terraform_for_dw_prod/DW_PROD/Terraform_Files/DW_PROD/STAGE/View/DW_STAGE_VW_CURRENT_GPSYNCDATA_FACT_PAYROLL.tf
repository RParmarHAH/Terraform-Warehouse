resource "snowflake_view" "DW_STAGE_VW_CURRENT_GPSYNCDATA_FACT_PAYROLL" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_GPSYNCDATA_FACT_PAYROLL"
	statement = <<-SQL
	 
WITH EMPLOYEE AS 
(
	SELECT DISTINCT 
		MASTER_ID, EMPLOYEE_ID, DB, OFFICE_NO, WORK_STATE,
		MD5(CAST(TRIM(MASTER_ID) AS VARCHAR)||'-'|| DB) AS EMPLOYEE_KEY
	FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GPSYNCDATA.EMPLOYEE_MASTER_LIST
	UNION
	SELECT DISTINCT 
		MASTER_ID, EMPLOYEE_ID, DB, OFFICE_NO, WORK_STATE,
		MD5(CAST(TRIM(MASTER_ID) AS VARCHAR)||'-'|| DB) AS EMPLOYEE_KEY
	FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GPSYNCDATA.EMPLOYEE_MATCH_LIST
	WHERE EMPLOYEE_ID NOT IN (SELECT DISTINCT EMPLOYEE_ID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.GPSYNCDATA.EMPLOYEE_MASTER_LIST)
),
PayCodes_ServiceHours AS 
( SELECT Paycodes.COMPANY_CODE, Paycodes.PAY_CODE 
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.EMPLOYER_EDGE_PAYCODES Paycodes
  JOIN DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.GPALLPAYCODESBASE PaycodeDescription
  	ON TRIM(PaycodeDescription.DB) = TRIM(Paycodes.COMPANY_CODE) AND TRIM(PaycodeDescription.PAY_CODE) = TRIM(Paycodes.PAY_CODE) 
  WHERE Paycodes.IN_USE = 1 AND Paycodes.COUNT_HOURS = 1 AND Paycodes.TYPE_CODE = 'R'
  	AND NOT (
  		UPPER(Paycodes.PAY_CODE) IN ('OCP', 'TTI', 'QTRBON' )
  		OR UPPER(Paycodes.PAY_CODE) LIKE 'HOL%'
  		)
  	-- Exclude possible OTM codes
  	AND NOT (
  		(
  			UPPER(PaycodeDescription.DESCRIPTION) LIKE '%OTM%'
  			OR UPPER(PaycodeDescription.DESCRIPTION) LIKE '%OVERTIME%'
  		)
  		AND UPPER(PaycodeDescription.DESCRIPTION) NOT LIKE '%ADJ%'
  	)
), PayCodes_OvertimeHours AS 
( SELECT Paycodes.COMPANY_CODE, Paycodes.PAY_CODE
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.EMPLOYER_EDGE_PAYCODES Paycodes
  JOIN DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.GPALLPAYCODESBASE PaycodeDescription
  	ON TRIM(PaycodeDescription.DB) = TRIM(Paycodes.COMPANY_CODE) AND TRIM(PaycodeDescription.PAY_CODE) = TRIM(Paycodes.PAY_CODE) 
  WHERE
  	(
  		UPPER(PaycodeDescription.DESCRIPTION) LIKE '%OTM%'
  		OR UPPER(PaycodeDescription.DESCRIPTION) LIKE '%OVERTIME%'
  	)
  	AND UPPER(PaycodeDescription.DESCRIPTION) NOT LIKE '%ADJ%'
), srv AS
( SELECT m1.CheckID, CAST( SUM( dl1.AMOUNT) AS DECIMAL( 12,2)) AS Service_Wages, CAST( SUM( dl1.UNITS) AS DECIMAL( 12,2)) AS Service_Hours
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_Master AS m1
  INNER JOIN DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_DetailLine dl1 ON m1.CheckID = dl1.CheckID
  INNER JOIN PayCodes_ServiceHours AS pc1 ON TRIM(m1.DB) = TRIM(pc1.COMPANY_CODE) AND TRIM( PayCode) = TRIM( pc1.Pay_Code)
  WHERE dl1.IsWage = 'TRUE'
  	AND m1.ETL_LAST_UPDATED_DATE >= '1900-01-01'
  GROUP BY m1.CheckID),
nonsrv AS
( SELECT m1.CheckID, CAST( SUM( dl1.AMOUNT) AS DECIMAL( 12,2)) AS Non_Service_Wages, CAST( SUM( dl1.UNITS) AS DECIMAL( 12,2)) AS Non_Service_Units
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_Master AS m1
  INNER JOIN DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_DetailLine dl1 ON m1.CheckID = dl1.CheckID
  LEFT JOIN PayCodes_ServiceHours AS pc1 ON TRIM(m1.DB) = TRIM(pc1.COMPANY_CODE) AND TRIM( PayCode) = TRIM( pc1.Pay_Code)
  LEFT JOIN PayCodes_OvertimeHours AS pc2 ON TRIM(m1.DB) = TRIM(pc2.COMPANY_CODE) AND TRIM( PayCode) = TRIM( pc2.Pay_Code)
  WHERE dl1.IsWage = 'TRUE' AND pc1.COMPANY_CODE IS NULL AND pc2.COMPANY_CODE IS NULL
  	AND m1.ETL_LAST_UPDATED_DATE >= '1900-01-01'
  GROUP BY m1.CheckID),
ovtm AS
( SELECT m1.CheckID, CAST( SUM( dl1.AMOUNT) AS DECIMAL( 12,2)) AS Overtime_Wages, CAST( SUM( dl1.UNITS) AS DECIMAL( 12,2)) AS Overtime_Hours
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_Master AS m1
  INNER JOIN DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_DetailLine dl1 ON m1.CheckID = dl1.CheckID
  INNER JOIN PayCodes_OvertimeHours AS pc1 ON TRIM(m1.DB) = TRIM(pc1.COMPANY_CODE) AND TRIM( PayCode) = TRIM( pc1.Pay_Code) 
  WHERE dl1.IsWage = 'TRUE'
  	AND m1.ETL_LAST_UPDATED_DATE >= '1900-01-01'
  GROUP BY m1.CheckID),
tax AS
( SELECT CheckID, CAST( SUM( AMOUNT) AS DECIMAL( 12,2)) AS Taxes
  FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_DetailLine 
  WHERE IsTax = 'TRUE'
  GROUP BY CheckID)
SELECT DISTINCT 
MD5( CAST( m1.PayDate AS VARCHAR) || CAST(coalesce(EMP1.MASTER_ID, m1.EMPLOYEEID) AS varchar) || m1.db || m1.CheckNumber) AS Payroll_Key
FROM DISC_${var.SF_ENVIRONMENT}.GPSYNCDATA.Paystub_Master AS m1
LEFT JOIN EMPLOYEE EMP1
	ON TRIM(EMP1.EMPLOYEE_ID) = TRIM(M1.EMPLOYEEID) AND UPPER(TRIM(EMP1.DB)) = UPPER(TRIM(M1.DB))
LEFT OUTER JOIN srv ON srv.CheckID = m1.CheckID
LEFT OUTER JOIN nonsrv ON nonsrv.CheckID = m1.CheckID
LEFT OUTER JOIN ovtm ON ovtm.CheckID = m1.CheckID
LEFT OUTER JOIN tax ON tax.CheckID = m1.CheckID
WHERE m1.AUDITTRAILNUMBER not like '%ABANDONED%'
	AND m1.ETL_LAST_UPDATED_DATE >= '1900-01-01';
SQL
	or_replace = true 
	is_secure = false 
}

