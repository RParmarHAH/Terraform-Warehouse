resource "snowflake_view" "DW_STAGE_VW_CURRENT_ALAYACARE_DIM_SUPERVISOR" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_ALAYACARE_DIM_SUPERVISOR"
	statement = <<-SQL
	 SELECT SUPERVISOR_KEY
FROM (
	SELECT MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || COMPANY.BRANCH_ID || ')'||'-'||UPPER(TRIM(COMPANY.PROFILE_STATE)) || '-' || NVL(GROUPS.GROUP_ID,-1) || '-' || 'ALAYACARE') AS SUPERVISOR_KEY,
		NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || COMPANY.BRANCH_ID || ')' AS SYSTEM_CODE
		FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.GROUPS AS GROUPS
		JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH AS COMPANY
			ON COMPANY.BRANCH_ID = GROUPS.BRANCH_ID 
		LEFT JOIN HAH.DIM_STATE AS STATE
			ON UPPER(TRIM(STATE.STATE_NAME)) = UPPER(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION))
) DATA
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.CONFIGURATION CONFIG 
	ON CONFIG.SYSTEM_CODE=DATA.SYSTEM_CODE
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

