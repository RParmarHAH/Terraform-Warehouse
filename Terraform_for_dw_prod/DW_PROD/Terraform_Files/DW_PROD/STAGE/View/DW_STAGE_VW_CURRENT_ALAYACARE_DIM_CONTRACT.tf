resource "snowflake_view" "DW_STAGE_VW_CURRENT_ALAYACARE_DIM_CONTRACT" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_ALAYACARE_DIM_CONTRACT"
	statement = <<-SQL
	 SELECT CONTRACT_KEY FROM (SELECT MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || NVL(F.BRANCH_ID,-1) || ')' || '-' || F.FUNDER_ID::STRING || '-' || NVL(S.SERVICE_CODE_ID::STRING, '') || '-' || 'ALAYACARE') AS CONTRACT_KEY,
NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || NVL(F.BRANCH_ID,-1) || ')' AS SYSTEM_CODE
FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.FUNDER F 
JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.SERVICE_CODE_BILL_CODE SBC ON F.FUNDER_ID = SBC.FUNDER_ID 
JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.SERVICE_CODE S ON SBC.SERVICE_CODE_ID = S.SERVICE_CODE_ID
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BILL_CODE AS BC ON BC.BILL_CODE_ID = SBC.BILL_CODE_ID 
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH AS COMPANY
	ON COMPANY.BRANCH_ID = F.BRANCH_ID)DATA 
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.CONFIGURATION CONFIG 
	ON CONFIG.SYSTEM_CODE=DATA.SYSTEM_CODE
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

