resource "snowflake_view" "DW_STAGE_VW_CURRENT_ALAYACARE_DIM_INVOICE" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_ALAYACARE_DIM_INVOICE"
	statement = <<-SQL
	 WITH INVOICE_ITEMS AS (
	SELECT INVOICE_ITEM.INVOICE_ID, 
		COALESCE(C.MASTER_ID, INVOICE_ITEM.CLIENT_ID, VISIT.CLIENT_ID) AS CLIENT_ID,
		COALESCE(VISIT.BRANCH_ID, COST_CENTRE.PROPERTIES_BRANCH_ID) AS BRANCH_ID,
		G.GROUP_ID,
		SUM(INVOICE_ITEM.INVOICE_ITEM_AMOUNT) AS AMOUNT_BILLED, 
		SUM(NVL(INVOICE_ITEM.INVOICE_ITEM_AMOUNT, 0) - NVL(INVOICE_ITEM.INVOICE_ITEM_BALANCE, 0)) AS AMOUNT_COLLECTED,
		SUM(INVOICE_ITEM.INVOICE_ITEM_BALANCE) AS AMOUNT_OUTSTANDING,
		NULLIF(MAX(GREATEST(NVL(INVOICE_ITEM.PAYMENT_DATE, '1/1/1900'), NVL(INVOICE_ITEM.INVOICE_LAST_PAYMENT_DATE, '1/1/1900'))), '1/1/1900') AS FINAL_PAYMENT_DATE
	FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.INVOICE_ITEM AS INVOICE_ITEM
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.VISIT AS VISIT
		ON VISIT.VISIT_ID = INVOICE_ITEM.VISIT_ID 
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.SERVICE AS SERVICE
		ON SERVICE.SERVICE_ID = VISIT.SERVICE_ID
	LEFT JOIN DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.CLIENT_MATCH_LIST   CM
		ON CM.ID = SERVICE.SERVICE_CLIENT_ID
	LEFT JOIN DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.CLIENT_MASTER_LIST  C	
		ON C.CLIENT_ID=COALESCE(CM.ID, SERVICE.SERVICE_CLIENT_ID, VISIT.CLIENT_ID, INVOICE_ITEM.CLIENT_ID)
--			AND VISIT.BRANCH_ID=C.BRANCH_ID 
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.TBL_GUID_COST_CENTRE_TIER_4 COST_CENTRE_MAPPING
		ON COST_CENTRE_MAPPING.GUID_TO = C.GUID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.TBL_COST_CENTRES_TIER_4 AS COST_CENTRE
		ON COST_CENTRE.ID = COST_CENTRE_MAPPING.COST_CENTRE_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.GROUPS AS G
		ON G.BRANCH_ID = COALESCE(COST_CENTRE.PROPERTIES_BRANCH_ID, VISIT.BRANCH_ID)
			AND G.PROFILE_COMPANY = COST_CENTRE.PROPERTIES_DESCRIPTION
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH B 
		ON B.BRANCH_ID = COALESCE(VISIT.BRANCH_ID, COST_CENTRE.PROPERTIES_BRANCH_ID)
	GROUP BY 1, 2, 3, 4
) SELECT INVOICE_KEY FROM (
SELECT MD5(NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || NVL(INVOICE_ITEMS.BRANCH_ID,-1) || ')' || '-' || INVOICE_DETAILS.INVOICE_ID || '-' || 'ALAYACARE') AS INVOICE_KEY,
		NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || COALESCE(INVOICE_ITEMS.BRANCH_ID, FUNDERS.BRANCH_ID, -1) || ')'  AS SYSTEM_CODE
	FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.INVOICE_DETAILS AS INVOICE_DETAILS
	LEFT JOIN INVOICE_ITEMS AS INVOICE_ITEMS
		ON INVOICE_ITEMS.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.FUNDER AS FUNDERS
		ON FUNDERS.FUNDER_ID = INVOICE_DETAILS.INVOICE_FUNDER_ID -- Do not use Invoice_Details.Branch_ID as it could be null
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.GROUPS AS G
		ON G.GROUP_ID = INVOICE_ITEMS.GROUP_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH AS B 
		ON B.BRANCH_ID = COALESCE(INVOICE_ITEMS.BRANCH_ID, FUNDERS.BRANCH_ID)
	) DATA
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.CONFIGURATION CONFIG 
	ON CONFIG.SYSTEM_CODE=DATA.SYSTEM_CODE
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

