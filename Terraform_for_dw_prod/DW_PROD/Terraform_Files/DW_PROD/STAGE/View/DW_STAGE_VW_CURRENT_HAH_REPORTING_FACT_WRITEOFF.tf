resource "snowflake_view" "DW_STAGE_VW_CURRENT_HAH_REPORTING_FACT_WRITEOFF" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_HAH_REPORTING_FACT_WRITEOFF"
	statement = <<-SQL
	 SELECT
    md5(NVL(f.PERIOD::string, '') || '-' || NVL(off.OFFICENAME::string, 'Unknown') || '-' || NVL(f.CLIENTNUMBER::string, '') || '-'
		|| NVL(f.CONTRACTCODE, 'Unknown') || '-' || NVL(f.ADDITIONALITEM::string, 'Unknown') || '-'
		|| NVL(f.PAYDATE::string, '')  || '-' || NVL(f.DFDB,'')) AS WRITEOFF_KEY
FROM DISC_${var.SF_ENVIRONMENT}.HAH_REPORTING.AGING_SUMMARY_AMOUNTDATA f
LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HAH_REPORTING.AGING_SUMMARY_OFFICES off
    on f.OFFICENUMBER = off.OFFICENUMBER
    and f.DFDB = off.DFDB
LEFT JOIN (SELECT DISTINCT CODE, REASON FROM DISC_${var.SF_ENVIRONMENT}.HAH_REPORTING.AGING_SUMMARY_WRITEOFFCODES) wo
    on f.WOREASON = wo.CODE
LEFT JOIN (SELECT DISTINCT BRANCH_KEY, OFFICE_NUMBER, SYSTEM_CODE FROM HAH.DIM_BRANCH) b2
ON b2.OFFICE_NUMBER = f.OFFICENUMBER
    AND b2.SYSTEM_CODE = f.DFDB
LEFT JOIN HAH.DIM_CLIENT c2
ON TO_VARCHAR(c2.CLIENT_NUMBER) = TO_VARCHAR(f.CLIENTNUMBER)
    AND c2.SYSTEM_CODE = f.DFDB
LEFT JOIN HAH.DIM_CONTRACT n2
ON n2.CONTRACT_CODE = f.CONTRACTCODE
    AND n2.SYSTEM_CODE = f.DFDB
WHERE  AMOUNTTYPE LIKE '%WriteOff%'-- limit 100
AND (f.ETL_LAST_UPDATED_DATE >= '1900-01-01'
	OR off.ETL_LAST_UPDATED_DATE >= '1900-01-01');
SQL
	or_replace = true 
	is_secure = false 
}

