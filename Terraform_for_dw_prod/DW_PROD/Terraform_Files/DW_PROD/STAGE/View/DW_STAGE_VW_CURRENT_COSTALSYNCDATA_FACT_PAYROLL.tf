resource "snowflake_view" "DW_STAGE_VW_CURRENT_COSTALSYNCDATA_FACT_PAYROLL" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_COSTALSYNCDATA_FACT_PAYROLL"
	statement = <<-SQL
	 WITH ServicePayCode
AS 
(
	SELECT
		DB,PAY_CODE,PAY_CODE_CATEGORY
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.PAYCODE_CATEGORY
	WHERE PAY_CODE_CATEGORY ='SERVICE_CODE'
		
)
,OverTimePayCode
AS 
(
	SELECT
		DB,PAY_CODE,PAY_CODE_CATEGORY
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.PAYCODE_CATEGORY
	WHERE PAY_CODE_CATEGORY ='OVERTIME'

)
,REIMBURSEMENT_PAYCODE
AS 
(
	SELECT
		DB,PAY_CODE,PAY_CODE_CATEGORY
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.PAYCODE_CATEGORY
	WHERE PAY_CODE_CATEGORY = 'REIMBURSEMENT'

)
,CHANGED_DATA
AS
(
	SELECT DISTINCT
		DB
		,AUDITTRAILNUMBER 
		,CHECKNUMBER 
		,CHECKDATE
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKDETAILSBASE T
	WHERE T.ETL_LAST_UPDATED_DATE >= '1900-01-01'
)
,srv 
AS 
(
	SELECT 
		cd.DB 
		,cd.CHECKNUMBER 
		,cd.AUDITTRAILNUMBER 
		,SUM(pcd.AMOUNT) AMOUNT
		,SUM(pcd.UNITS ) AS HOURS
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKDETAILSBASE pcd 
	INNER JOIN CHANGED_DATA CD 
	ON cd.DB = pcd.DB 
	AND cd.CHECKNUMBER = pcd.CHECKNUMBER 
	AND cd.AUDITTRAILNUMBER = pcd.AUDITTRAILNUMBER
	INNER JOIN ServicePayCode sd
	ON pcd.PAYCODE =sd.PAY_CODE
	AND pcd.DB =sd.DB
	GROUP BY cd.DB , cd.CHECKNUMBER ,cd.AUDITTRAILNUMBER 
)
,overtimehours 
AS 
(
	SELECT 
		cd.DB 
		,cd.CHECKNUMBER 
		,cd.AUDITTRAILNUMBER 
		,SUM(pcd.AMOUNT) AMOUNT
		,SUM(pcd.UNITS ) AS HOURS
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKDETAILSBASE pcd 
	INNER JOIN CHANGED_DATA CD 
	ON cd.DB = pcd.DB 
	AND cd.CHECKNUMBER = pcd.CHECKNUMBER 
	AND cd.AUDITTRAILNUMBER = pcd.AUDITTRAILNUMBER
	INNER JOIN OverTimePayCode sd
	ON pcd.PAYCODE =sd.PAY_CODE
	AND pcd.DB =sd.DB
	GROUP BY cd.DB , cd.CHECKNUMBER ,cd.AUDITTRAILNUMBER 
)
,REIMBURSEMENT_PAY
AS
(
	SELECT 
		cd.DB 
		,cd.CHECKNUMBER 
		,cd.AUDITTRAILNUMBER 
		,SUM(pcd.AMOUNT) AMOUNT
		,SUM(pcd.UNITS ) AS HOURS
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKDETAILSBASE pcd 
	INNER JOIN CHANGED_DATA CD 
	ON cd.DB = pcd.DB 
	AND cd.CHECKNUMBER = pcd.CHECKNUMBER 
	AND cd.AUDITTRAILNUMBER = pcd.AUDITTRAILNUMBER
	INNER JOIN REIMBURSEMENT_PAYCODE sd
	ON pcd.PAYCODE =sd.PAY_CODE
	AND pcd.DB =sd.DB
	GROUP BY cd.DB , cd.CHECKNUMBER ,cd.AUDITTRAILNUMBER 
)
,nonsrvhours 
AS 
(
	SELECT 
		cd.DB 
		,cd.CHECKNUMBER 
		,cd.AUDITTRAILNUMBER 
		,SUM(pcd.AMOUNT) AMOUNT
		,SUM(pcd.UNITS ) AS HOURS
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKDETAILSBASE pcd 
	INNER JOIN CHANGED_DATA CD 
	ON cd.DB = pcd.DB 
	AND cd.CHECKNUMBER = pcd.CHECKNUMBER 
	AND cd.AUDITTRAILNUMBER = pcd.AUDITTRAILNUMBER
	
	INNER JOIN DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCODESBASE paycodes
	ON PAYCODES.PAY_CODE = pcd.PAYCODE
	AND PAYCODES.DB = pcd.DB
	
	LEFT JOIN ServicePayCode sd
	ON pcd.PAYCODE =sd.PAY_CODE
	AND pcd.DB =sd.DB
	
	LEFT JOIN OverTimePayCode ot
	ON pcd.PAYCODE =ot.PAY_CODE
	AND pcd.DB =ot.DB
	
	LEFT JOIN REIMBURSEMENT_PayCode rpc
	ON pcd.PAYCODE = rpc.PAY_CODE
	AND pcd.DB = rpc.DB
	
	WHERE sd.PAY_CODE IS NULL AND ot.PAY_CODE IS NULL AND rpc.PAY_CODE IS NULL
	GROUP BY cd.DB , cd.CHECKNUMBER ,cd.AUDITTRAILNUMBER 
)
, final_payroll
AS
(
	SELECT 
		pcb.DB 
		,CASE TRIM(pcb.DB) WHEN 'ALTRU' THEN 'SHC_ALTRUS' WHEN 'SHC' THEN 'SHC_SAVANNAH' END AS SYSTEM_CODE		
		,pcb.AUDITTRAILNUMBER 
		,pcb.CHECKNUMBER 
		,pcb.EMPLOYEEID 
		,pcb.DEPARTMENT 
		,pcb.CHECKDATE AS PayDate
		,pcb.PAYPERIODBEGINDATE AS PeriodStart
		,pcb.PAYPERIODENDDATE 	AS PeriodEnd
		,pcb.GROSSPAY 
	--	,pcb.NETPAY + pcb.TOTALTAX
		,pcb.NETPAY 
		,pcb.TOTALTAX
		,COALESCE (srv.AMOUNT,0) AS Service_Amount
		,COALESCE(ot.AMOUNT,0) AS OverTime_Amount
		,COALESCE (ns.AMOUNT,0) AS NonSrv_Amount
		,COALESCE (rp.AMOUNT,0) AS Reim_Amount
		--	,COALESCE(srv.AMOUNT,0) + COALESCE(ot.AMOUNT,0)
	--	,COALESCE(srv.AMOUNT,0) + COALESCE(ot.AMOUNT,0)+ COALESCE(ns.AMOUNT,0)
		,COALESCE(srv.HOURS,0) AS Service_Hours
		,COALESCE(ot.HOURS,0) AS OverTime_Hours
		,COALESCE(ns.HOURS,0) AS NonSrv_Hours
		,COALESCE(rp.HOURS,0) AS Reim_Hours
		,COALESCE(srv.HOURS,0) + COALESCE(ot.HOURS,0) + COALESCE(ns.HOURS,0) AS TotalUnits
	FROM DISC_${var.SF_ENVIRONMENT}.COSTALSYNCDATA.GPALLPAYCHECKSBASE pcb
	INNER JOIN CHANGED_DATA AS cd 
	ON pcb.DB = cd.DB
	AND pcb.AUDITTRAILNUMBER  = cd.AUDITTRAILNUMBER
	AND pcb.CHECKNUMBER = cd.CHECKNUMBER
	LEFT JOIN srv 
	ON srv.DB = pcb.DB 
	AND srv.AUDITTRAILNUMBER = pcb.AUDITTRAILNUMBER 
	AND srv.CHECKNUMBER = cd.CHECKNUMBER
	LEFT JOIN overtimehours ot 
	ON ot.DB = pcb.DB 
	AND ot.AUDITTRAILNUMBER = pcb.AUDITTRAILNUMBER 
	AND ot.CHECKNUMBER = cd.CHECKNUMBER
	LEFT JOIN nonsrvhours ns 
	ON ns.DB = pcb.DB 
	AND ns.AUDITTRAILNUMBER = pcb.AUDITTRAILNUMBER 
	AND ns.CHECKNUMBER = cd.CHECKNUMBER
	LEFT JOIN REIMBURSEMENT_PAY rp
	ON rp.DB = pcb.DB 
	AND rp.AUDITTRAILNUMBER = pcb.AUDITTRAILNUMBER 
	AND rp.CHECKNUMBER = cd.CHECKNUMBER
	
)

SELECT 
	-- MD5( CAST( fp.PayDate AS VARCHAR) || CAST( fp.EmployeeID AS varchar) || fp.db || fp.CheckNumber) AS Payroll_Key
	MD5( CAST( fp.PayDate AS VARCHAR) || CAST( fp.EmployeeID AS varchar) || fp.SYSTEM_CODE || fp.CheckNumber) AS Payroll_Key
FROM final_payroll fp
LEFT JOIN HAH.DIM_EMPLOYEE emp
ON trim(emp.SYSTEM_CODE) = trim(fp.SYSTEM_CODE)
AND trim(emp.employee_id) = trim(fp.EMPLOYEEID)
LEFT JOIN DISC_${var.SF_ENVIRONMENT}."STAGE".COASTAL_OFFICE_MAPPING_PAYROLL AS BRANCH_MAPPING
	ON BRANCH_MAPPING.DB = TRIM(fp.DB) AND BRANCH_MAPPING.DEPARTMENT = TRIM(fp.DEPARTMENT)
LEFT JOIN HAH.DIM_BRANCH AS BRANCH
	ON BRANCH.SYSTEM_CODE = BRANCH_MAPPING.SYSTEM_CODE AND BRANCH.OFFICE_CODE = BRANCH_MAPPING.OFFICE_CODE
LEFT JOIN HAH.DIM_SOURCE_SYSTEM AS SS 
ON TRIM(CASE ss.SYSTEM_DESCRIPTION 
			WHEN 'Carevoyant (Altrus)' THEN 'SHC_ALTRUS' 
			WHEN 'Carevoyant (Coastal)' THEN 'SHC_SAVANNAH' 
			ELSE NULL END ) = fp.SYSTEM_CODE;
SQL
	or_replace = true 
	is_secure = false 
}

