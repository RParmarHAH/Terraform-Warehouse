resource "snowflake_view" "DW_STAGE_VW_CURRENT_ALAYACARE_FACT_REVENUE" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_ALAYACARE_FACT_REVENUE"
	statement = <<-SQL
	 WITH EMPLOYEE AS 
(
SELECT * FROM 
(
	SELECT EMPLOYEE_ID,MASTER_ID,EMPLOYEE_ID AS ORIGINAL_RECORD_ID,BRANCH_ID
	FROM  DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.EMPLOYEE_MASTER_LIST  
) 
UNION
SELECT * FROM 
(
	SELECT DISTINCT ID,MASTER_ID,ID AS ORIGINAL_RECORD_ID,BRANCH_ID
	FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.EMPLOYEE_MATCH_LIST 
	WHERE ID NOT IN (SELECT EMPLOYEE_ID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.EMPLOYEE_MASTER_LIST ) 
) 
)
, CLIENT AS  --VISIT DATA
(
SELECT * FROM 
(
	SELECT CLIENT_ID,MASTER_ID,CLIENT_ID AS ORIGINAL_RECORD_ID,GUID,BRANCH_ID
	FROM  DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.CLIENT_MASTER_LIST 
) 
UNION
SELECT * FROM 
(
	SELECT DISTINCT ID,MASTER_ID,ID AS ORIGINAL_RECORD_ID,GUID,BRANCH_ID
	FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.CLIENT_MATCH_LIST 
	WHERE ID NOT IN (SELECT CLIENT_ID FROM DISC_DEDUPE_${var.SF_ENVIRONMENT}.ALAYACARE.CLIENT_MASTER_LIST ) 
) 
)
SELECT DATA.REVENUE_KEY FROM ( 
SELECT 	MD5(NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || COALESCE(GROUPS.BRANCH_ID, SERVICES.BRANCH_ID, FUNDERS.BRANCH_ID, -1) || ')' || '-' || INVOICE_ITEM.INVOICE_ITEM_ID || '-' || 'ALAYACARE') AS REVENUE_KEY,
		NVL(TRIM(B.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), 'Unknown') || ' (' || COALESCE(GROUPS.BRANCH_ID, SERVICES.BRANCH_ID, FUNDERS.BRANCH_ID, -1) || ')' AS SYSTEM_CODE
		FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.INVOICE_ITEM AS INVOICE_ITEM
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.SERVICE AS SERVICES ON SERVICES.SERVICE_ID = INVOICE_ITEM.SERVICE_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.FUNDER AS FUNDERS ON FUNDERS.FUNDER_ID = INVOICE_ITEM.FUNDER_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.VISIT AS VISITS ON VISITS.VISIT_ID = INVOICE_ITEM.VISIT_ID 
	LEFT JOIN EMPLOYEE E ON VISITS.EMPLOYEE_ID = E.EMPLOYEE_ID AND COALESCE(VISITS.BRANCH_ID, SERVICES.BRANCH_ID) = E.BRANCH_ID   
	LEFT JOIN  CLIENT C
	ON COALESCE(INVOICE_ITEM.CLIENT_ID, VISITS.CLIENT_ID) = C.CLIENT_ID AND COALESCE(VISITS.BRANCH_ID, SERVICES.BRANCH_ID) = C.BRANCH_ID 	
    LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.TBL_GUID_COST_CENTRE_TIER_4 COST_CENTRE_MAPPING
		ON COST_CENTRE_MAPPING.GUID_TO = C.GUID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.TBL_COST_CENTRES_TIER_4 AS COST_CENTRE
		ON COST_CENTRE.ID = COST_CENTRE_MAPPING.COST_CENTRE_ID
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.GROUPS AS GROUPS
		ON GROUPS.BRANCH_ID = COST_CENTRE.PROPERTIES_BRANCH_ID
		AND GROUPS.PROFILE_COMPANY = COST_CENTRE.PROPERTIES_DESCRIPTION
	LEFT JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.BRANCH B 
		ON B.BRANCH_ID = COALESCE(GROUPS.BRANCH_ID, SERVICES.BRANCH_ID, FUNDERS.BRANCH_ID)
	WHERE INVOICE_ITEM.INVOICE_ID IS NOT NULL
)  DATA
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ALAYACARE.CONFIGURATION CONFIG 
	ON CONFIG.SYSTEM_CODE=DATA.SYSTEM_CODE
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

