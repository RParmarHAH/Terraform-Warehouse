resource "snowflake_view" "DW_STAGE_VW_CURRENT_CCSI_DIM_CONTRACT" {
	database = "DW_${var.SF_ENVIRONMENT}"
	schema = "STAGE"
	name = "VW_CURRENT_CCSI_DIM_CONTRACT"
	statement = <<-SQL
	 
--INSERT OVERWRITE INTO DW_${var.SF_ENVIRONMENT}.HAH.DIM_CONTRACT 
WITH  ALL_DATA AS 
(
	SELECT * FROM DISC_${var.SF_ENVIRONMENT}.CCSI.RAWVRFP           
)
,BILLABLE AS        -------- LOGIC FOR BILLABLE FLAG
(
	SELECT DISTINCT  UPPER (TRIM (CONTRACT_NO)) AS CONTRACT_NO , COUNT (DISTINCT PAY_EMPLOYEE) AS CNT
		FROM ALL_DATA 
	WHERE CONTRACT_NO IS NOT NULL 
	GROUP BY 1
)
SELECT DISTINCT 
  MD5( 'CCSI' || B.CONTRACT_NO || '-' || 'CCSI') AS CONTRACT_KEY 
 FROM  ALL_DATA  R
LEFT JOIN BILLABLE B ON UPPER (TRIM (R.CONTRACT_NO)) = B.CONTRACT_NO 
WHERE R.CONTRACT_NO IS NOT NULL;
SQL
	or_replace = true 
	is_secure = false 
}

