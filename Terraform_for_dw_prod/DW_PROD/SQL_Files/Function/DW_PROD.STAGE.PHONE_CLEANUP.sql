CREATE OR REPLACE FUNCTION DW_PROD.STAGE.PHONE_CLEANUP("PHONE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
STRICT
AS '
	CASE 
		WHEN
			NULLIF(TRIM(UPPER(PHONE)),'''') ILIKE ''___-___-____%'' OR NULLIF(TRIM(UPPER(PHONE)),'''') ILIKE ''___.___.____%'' 
			THEN LEFT(NULLIF(TRIM(REGEXP_REPLACE(UPPER(PHONE),''[^[:digit:]]'')),''''),10)
		WHEN
			LENGTH(NULLIF(TRIM(REGEXP_REPLACE(UPPER(PHONE),''[^[:digit:]]'')),'''')) = 10
			THEN NULLIF(TRIM(REGEXP_REPLACE(UPPER(PHONE),''[^[:digit:]]'')),'''')
		WHEN 
			LENGTH(NULLIF(TRIM(REGEXP_REPLACE(UPPER(PHONE),''[^[:digit:]]'')),'''')) = 11 
			THEN RIGHT(NULLIF(TRIM(REGEXP_REPLACE(UPPER(PHONE),''[^[:digit:]]'')),''''),10)
		ELSE
			NULL
	END
';