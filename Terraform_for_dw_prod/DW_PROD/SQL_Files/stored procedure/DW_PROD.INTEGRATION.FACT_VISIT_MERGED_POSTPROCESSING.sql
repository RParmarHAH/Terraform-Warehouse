CREATE OR REPLACE PROCEDURE DW_PROD.INTEGRATION.FACT_VISIT_MERGED_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN
--***************************************************************************************************************************
-- DEVELOPMENT LOG:
-- DATE        	AUTHOR                	NOTES:
-- --------    	-------------------   	-----------------------------------------------------------------------------------------------
--24/1/2023		Pooja Shah				Removed SOURCE_SYSTEM_ID NOT IN Filter for 14 -Axxess
--12/05/2023	Shraddha Sejpal			Added PARTNER_CONTRACT_SERVICE_KEY, CLIENT_SERVICE_KEY,BILLING_KEY
--***************************************************************************************************************************
 
		INSERT OVERWRITE INTO INTEGRATION.FACT_VISIT_MERGED 
		SELECT VISIT.VISIT_KEY,
		VISIT.REPORT_DATE,
		COALESCE(BRANCH_MERGED.BRANCH_KEY, VISIT.BRANCH_KEY) AS BRANCH_KEY,
		VISIT.BRANCH_KEY AS ORIGINAL_BRANCH_KEY,
		COALESCE(CLIENT_MERGED.CLIENT_KEY, VISIT.CLIENT_KEY) AS CLIENT_KEY,
		VISIT.CLIENT_KEY AS ORIGINAL_CLIENT_KEY,		
		VISIT.CONTRACT_KEY,
		VISIT.SCHEDULED_EMPLOYEE_KEY AS SCHEDULED_EMPLOYEE_KEY, 
		COALESCE(EMPLOYEE_MERGED.EMPLOYEE_KEY, VISIT.EMPLOYEE_KEY) AS EMPLOYEE_KEY,
		VISIT.EMPLOYEE_KEY AS ORIGINAL_EMPLOYEE_KEY,		
		COALESCE(CLIENT_MERGED.SOURCE_SYSTEM_ID, VISIT.SOURCE_SYSTEM_ID) AS SOURCE_SYSTEM_ID,
		VISIT.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		COALESCE(SUPERVISOR_MERGED.SUPERVISOR_KEY,VISIT.SUPERVISOR_KEY) AS SUPERVISOR_KEY,
		VISIT.SUPERVISOR_KEY ORIGINAL_SUPERVISOR_KEY,
		VISIT.INVOICE_KEY,
		VISIT.PAYROLL_KEY,
		VISIT.CLIENT_SERVICE_KEY,
		VISIT.PARTNER_CONTRACT_SERVICE_KEY,
		VISIT.BILLING_KEY,
		VISIT.SERVICE_DATE,
		VISIT.PAYROLL_DATE,
		COALESCE(BRANCH_MERGED.BRANCH_NAME, VISIT.BRANCH_NAME) AS BRANCH_NAME,
		VISIT.BRANCH_NAME AS ORIGINAL_BRANCH_NAME,
		COALESCE(CLIENT_MERGED.CLIENT_NUMBER, VISIT.CLIENT_NUMBER) AS CLIENT_NUMBER,
		VISIT.CLIENT_NUMBER AS ORIGINAL_CLIENT_NUMBER,
		VISIT.CONTRACT_CODE,
		VISIT.SCHEDULED_EMPLOYEE_ID AS SCHEDULE_EMPLOYEE_ID,
		COALESCE(EMPLOYEE_MERGED.EMPLOYEE_ID, VISIT.EMPLOYEE_ID) AS EMPLOYEE_ID,
		VISIT.EMPLOYEE_ID AS ORIGINAL_EMPLOYEE_ID,
		COALESCE(CLIENT_MERGED.SYSTEM_CODE, VISIT.SYSTEM_CODE) AS SYSTEM_CODE,
		VISIT.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		VISIT.SUPERVISOR_CODE,
		VISIT.INVOICE_ID,
		VISIT.CHEQUE_NUMBER,
		VISIT.CLEAN_SHIFT_FLAG,
		VISIT.SCHEDULE_STATUS_CODE,
		VISIT.SCHEDULE_STATUS_NAME,
		VISIT.SCHEDULE_STATUS_DESCRIPTION,
		VISIT.VISIT_STATUS_CODE,
		VISIT.VISIT_STATUS_NAME,
		VISIT.VISIT_STATUS_DESCRIPTION,
		VISIT.INVOICE_STATUS_CODE,
		VISIT.INVOICE_STATUS_NAME,
		VISIT.INVOICE_STATUS_DESCRIPTION,
		VISIT.PAYROLL_STATUS_CODE,
		VISIT.PAYROLL_STATUS_NAME,
		VISIT.PAYROLL_STATUS_DESCRIPTION,
		VISIT.CANCEL_REASON_CODE,
		VISIT.CANCEL_REASON_DESCRIPTION,
		VISIT.CANCEL_REASON_NOTES,
		VISIT.EXCEPTION_REASON_INDICATOR,
		VISIT.RESOLUTION_CODE,
		VISIT.RESOLUTION_DESCRIPTION,
		VISIT.REJECTION_CODE,
		VISIT.REJECTION_DESCRIPTION,
		VISIT.BILL_CODE,
		VISIT.BILL_RATE,
		VISIT.BILL_UNITS_SERVED,
		VISIT.BILL_UNIT_TYPE,		
		VISIT.OVERHEAD_RATE,
		VISIT.SCHEDULE_TIMEIN,
		VISIT.SCHEDULE_TIMEOUT,
		VISIT.SCHEDULE_DURATION,
		VISIT.ACTUAL_TIMEIN,
		VISIT.ACTUAL_TIMEOUT,
		VISIT.ACTUAL_DURATION,
		VISIT.ADJUSTED_TIMEIN,
		VISIT.ADJUSTED_TIMEOUT,
		VISIT.ADJUSTED_DURATION,
		VISIT.HOURS_SERVED,
		VISIT.COMMENTS,
		VISIT.IS_EVV_FLAG,
		VISIT.TIMESHEET_TYPE,
		VISIT.TRACKING_ID,
		VISIT.ETL_TASK_KEY,
		VISIT.ETL_INSERTED_TASK_KEY,
		VISIT.ETL_INSERTED_DATE,
		VISIT.ETL_INSERTED_BY,
		VISIT.ETL_LAST_UPDATED_DATE,
		VISIT.ETL_LAST_UPDATED_BY,
		VISIT.ETL_DELETED_FLAG,
		VISIT.CONFIRMED_FLAG
	FROM HAH.FACT_VISIT AS VISIT
	LEFT JOIN INTEGRATION.DIM_BRANCH_MERGED AS BRANCH_MERGED
		ON BRANCH_MERGED.ORIGINAL_BRANCH_KEY = VISIT.BRANCH_KEY
	LEFT JOIN INTEGRATION.DIM_CLIENT_MERGED AS CLIENT_MERGED
		ON CLIENT_MERGED.ORIGINAL_CLIENT_KEY = VISIT.CLIENT_KEY
	LEFT JOIN INTEGRATION.DIM_EMPLOYEE_MERGED AS EMPLOYEE_MERGED
		ON EMPLOYEE_MERGED.ORIGINAL_EMPLOYEE_KEY = VISIT.EMPLOYEE_KEY
    LEFT JOIN INTEGRATION.DIM_SUPERVISOR_MERGED AS SUPERVISOR_MERGED 
    	ON SUPERVISOR_MERGED.ORIGINAL_SUPERVISOR_KEY = VISIT.SUPERVISOR_KEY
--    WHERE COALESCE(CLIENT_MERGED.SOURCE_SYSTEM_ID, VISIT.SOURCE_SYSTEM_ID) NOT IN (''14'',''15'',''19'')
    WHERE VISIT.SOURCE_SYSTEM_ID NOT IN (''15'');
RETURN ''SUCCESS'';
end;
';