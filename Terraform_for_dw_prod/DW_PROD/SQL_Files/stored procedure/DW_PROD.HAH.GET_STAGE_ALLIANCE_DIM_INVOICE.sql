CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_ALLIANCE_DIM_INVOICE("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'BEGIN
--*****************************************************************************************************************************
-- NAME:  ALLIANCE_DIM_INVOICE
--
-- PURPOSE: Creates one row per Invoice according to ALLIANCE
--
-- DEVELOPMENT LOG:ALLIANCE
-- DATE        	AUTHOR                	NOTES:
-- --------    	-------------------   	-----------------------------------------------------------------------------------------------
-- 07/28/2022	Leo Joy     			Initial development
-- 01/27/2023	Mohit Vaghadiya			Since we dont have billing/revenue info in Generations, updated based on Revenue file received 
--										from Aggie. not accurate but this is what we have 
--										Can not get the Invoice Number from ALGL Details due to payor name does not match
--*****************************************************************************************************************************
--
INSERT OVERWRITE INTO STAGE.ALLIANCE_DIM_INVOICE
WITH CLIENT AS
(
    SELECT * FROM
    (
        SELECT MASTER_ID,CLIENTID
        FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.CLIENT_MASTER_LIST
    )
    UNION
    SELECT * FROM
    (
        SELECT DISTINCT MASTER_ID ,CLIENTID
        FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.CLIENT_MATCH_LIST
        WHERE CLIENTID NOT IN (SELECT CLIENTID FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.CLIENT_MASTER_LIST)
    )
), EMPLOYEE AS
(
    SELECT * FROM
    (
        SELECT MASTER_ID, SOCIALSECURITYNUM
        FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.EMPLOYEE_MASTER_LIST
    )
    UNION
    SELECT * FROM
    (
        SELECT DISTINCT MASTER_ID, SOCIALSECURITYNUM
        FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.EMPLOYEE_MATCH_LIST
        WHERE MASTER_ID  NOT IN (SELECT MASTER_ID  FROM DISC_DEDUPE_PROD.GENERATIONSALLIANCE.EMPLOYEE_MASTER_LIST)
    )
), CONTRACT_MAPPING AS
(
	SELECT DISTINCT CASE WHEN (CONTAINS(UPPER(P.BADDRESS1), C.FIRSTNAME) AND CONTAINS(UPPER(P.BADDRESS1), C.LASTNAME)) 
							OR (
									CONTAINS(UPPER(C.LASTNAME), REGEXP_SUBSTR(UPPER(P.BADDRESS1), ''\\\\\\\\S+$''))
									OR CONTAINS(REGEXP_SUBSTR(UPPER(P.BADDRESS1), ''\\\\\\\\S+$''), UPPER(C.LASTNAME)
									)
							) OR CT.NAME = ''Private Pay''
							THEN TRUE
					 ELSE FALSE 
				END IS_PRIAVATE_PAY
				, MD5(''ALLIANCE'' 
							||  ''-'' || P.PAYORID 
							|| ''-'' || SR.SERVICECODE 
							|| ''-'' || IFF(IS_PRIAVATE_PAY, ''PRIVATEPAY'', '''')
							-- || ''-'' || IFF( C.CLIENTTYPEID=1 , ''PRIVATEPAY'',TRIM(SR.DESCRIPTION))
							|| ''-'' || ''GENERATIONS''
						) AS CONTRACT_KEY
				, P.PAYORID
				, CASE WHEN SR.FLATRATE=''TRUE''  THEN ''Visit''
							 WHEN SR.FLATRATE=''FALSE'' THEN ''Hourly''
							 ELSE NULL 
				  END AS BILL_UNIT_TYPE
				, CONCAT(P.PAYORID,''-'',SR.SERVICECODE) AS CONTRACT_CODE
				, SCH.SCHEDULEID
				, P.BADDRESS1 AS PAYORNAME
	FROM DISC_PROD.GENERATIONSALLIANCE.CLIENTPAYORS CPY
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.SCHEDULES SCH
	    ON SCH.CLIENTID = CPY.CLIENTID
	 			AND SCH."DATE"::DATE <= ''2022-09-30''::DATE
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.PAYOR P
	    ON P.PAYORID = CPY.PAYORID
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.SERVICES SR
	    ON SR.SERVICECODE  = SCH.SERVICECODE
	LEFT JOIN  DISC_PROD.GENERATIONSALLIANCE.CLIENT C 
	    ON C.CLIENTID = CPY.CLIENTID 
	LEFT JOIN DISC_PROD.GENERATIONSALLIANCE.CLIENTTYPE CT 
	    ON CT.CLIENTTYPEID = C.CLIENTTYPEID
	QUALIFY DENSE_RANK() OVER(PARTITION BY SCH.SCHEDULEID, CPY.CLIENTID 
					  	 ORDER BY IFF(NVL(SCH.PAYORID, 0) = CPY.PAYORID, 2, NVL(CPY.ISPRIMARY, 0)::INT) DESC
						  		, IFF(NVL(SCH.PAYORID, 0) = CPY.PAYORID, 2, NVL(CPY.CURRENTPAYOR, 0)::INT) DESC) = 1
), REVENUE_DATA_REPORT AS
(
	SELECT *     
	FROM DISC_PROD.GENERATIONSALLIANCE.CLEANBILLINGDETAIL -- The File received FROM Aggie
	QUALIFY DENSE_RANK() 
			OVER(PARTITION BY CLIENT, TIME_IN, TIME_OUT, CAREGIVER, RATE_CODE, HOURS, LOCATION 
			ORDER BY EXTRACTED_DATE DESC) = 1
), GENERATIONS_INVOICE_DATA AS
(
	SELECT DISTINCT MD5(''ALLIANCE'' || ''-'' || CO.PAYORNAME || ''-'' || SCH.SCHEDULEID || ''-'' || C.MASTER_ID || ''-'' || ''GENERATIONS'') AS INVOICE_KEY
			, DC.CLIENT_KEY AS CLIENT_KEY
			, ''-1'' AS INVOICE_NUMBER
			, NULL AS ALTERNATE_INVOICE_NUMBER
			, REPLACE(LEFT(SCH."DATE"::DATE, 7),''-'', '''') AS PERIOD
			, ''REGULAR'' AS INVOICE_TYPE
			, 1 AS NUMBER_OF_CLIENTS
			, ''ALLIANCE'' AS SYSTEM_CODE
			, 19 AS SOURCE_SYSTEM_ID
			, MD5(''ALLIANCE'' || ''-'' || TRIM(CL.LOCATIONID) || ''-'' || ''GENERATIONS'') AS BRANCH_KEY
			, CO.PAYORID AS PAYOR_CODE
			, CO.PAYORNAME AS PAYOR_NAME
			, FALSE AS INVOICE_OPEN_FLAG
			, SCH."DATE"::DATE AS FIRST_INVOICE_DATE
			, RD.EXTRACTED_DATE::DATE AS FINAL_PAYMENT_DATE
			, ''-1'' AS FIRST_INVOICE_NUMBER
			, 1 AS BILL_ITERATION
			, NULL AS BILL_REPRESENTATIVE
			, NULL AS BILL_SUPERVISOR
			, NULL AS BILL_MANAGER
			, ''PAID'' AS INVOICE_STATUS
			, FALSE AS WRITEOFF_FLAG
			, NULL AS WRITEOFF_REASON
			, RD.ADJUSTED_REVENUE AS AMOUNT_BILLED
			, RD.ADJUSTED_REVENUE AS AMOUNT_COLLECTED
			, (AMOUNT_BILLED-AMOUNT_COLLECTED) AS AMOUNT_OUTSTANDING
			, TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE
			, TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE
			, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
			, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
		 	, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
			, CURRENT_USER as ETL_INSERTED_BY
			, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_UPDATED_DATE
			, CURRENT_USER AS ETL_LAST_UPDATED_BY
			, 0 AS ETL_DELETED_FLAG
			, 0 AS ETL_INFERRED_MEMBER_FLAG
	FROM REVENUE_DATA_REPORT RD
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.CLIENT CL
		ON CL.LASTNAME || '', '' || CL.FIRSTNAME = RD.CLIENT
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.EMPLOYEE EM
		ON EM.LASTNAME || '', '' || EM.FIRSTNAME =  RD.CAREGIVER
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.SCHEDULES SCH
		ON CL.CLIENTID = SCH.CLIENTID
			AND SCH.SOCIALSECNUM = EM.SOCIALSECURITYNUM 
			AND SCH.ISCONFIRMED = TRUE
	INNER JOIN DISC_PROD.GENERATIONSALLIANCE.SERVICES S
		ON S.SERVICECODE = SCH.SERVICECODE
			AND S.DESCRIPTION = RD.RATE_CODE
	INNER JOIN CLIENT C	
		ON C.CLIENTID = SCH.CLIENTID
	INNER JOIN HAH.DIM_CLIENT DC
		ON DC.CLIENT_NUMBER = C.MASTER_ID
			AND DC.SOURCE_SYSTEM_ID = 19
	INNER JOIN EMPLOYEE E 
		ON E.SOCIALSECURITYNUM = SCH.SOCIALSECNUM 
	INNER JOIN CONTRACT_MAPPING CO
	    ON CO.SCHEDULEID = SCH.SCHEDULEID
	LEFT JOIN DISC_PROD.GENERATIONSALLIANCE.CASEMANAGER CM 
		ON CM.CASEMANAGERID = CL.CASEMANAGERID
	LEFT JOIN DISC_PROD.GENERATIONSALLIANCE.VW_BRANCH_MAPPING BM
	    ON BM.LOCATION_ID = CL.LOCATIONID
	WHERE 1 = 1
			AND TO_TIME(RD.TIME_IN::DATETIME) = TO_TIME(SCH.STARTTIME) 
			AND TO_TIME(RD.TIME_OUT::DATETIME) = TO_TIME(SCH.ENDTIME)
			AND SCH."DATE"::DATE <= ''2022-09-30''
			AND DC.CLIENT_NUMBER  NOT IN (SELECT CLIENT_NUMBER FROM DATA_MANAGEMENT.DATA_QUALITY.INVALID_CLIENT_NUMBER WHERE SOURCE_SYSTEM_ID = 19 AND SYSTEM_CODE = ''GENERATIONS'')

)
SELECT *
FROM GENERATIONS_INVOICE_DATA;
RETURN ''SUCCESS'';
END';