CREATE OR REPLACE PROCEDURE DW_PROD.REPORT.GET_REPORT_CALL_TICKET("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN
--***************************************************************************************************************************** 
-- NAME:  CALL_TICKET
-- 
-- PURPOSE: Populating CALL_TICKET DATA
-- 
-- DEVELOPMENT LOG: 
-- DATE        AUTHOR                NOTES: 
-- --------    -------------------   ----------------------------------------------------------------------------------------------- 
--             MIRISHA          	 Initial development. 
-- 02-05-2024  MIRISHA 	             REMOVED CALLS FROM ZENDESK WHICH WERE PRESENT IN 8X8
--*****************************************************************************************************************************
    
INSERT OVERWRITE INTO REPORT.CALL_TICKET
WITH ZENDESK_TICKETS AS (
SELECT T.* FROM  HAH.FACT_TICKET T
LEFT JOIN DISC_PROD.ZENDESK.TICKETS TKT
ON TKT.ID= T.ID AND TKT."SOURCE" =''AMS'' AND T.SYSTEM_CODE=''ZENDESK_AMS''
WHERE TKT.TAGS NOT ILIKE ''%closed_by_merge%''
)
SELECT 
C.SYSTEM_CODE,
T.TICKET_KEY,
T.ID AS TICKET_ID,
C.SOURCE_SYSTEM_ID,
C.CALL_KEY,
C.CALL_ID,
C.AGENT_KEY AS CALL_AGENT_KEY,
C.CALLER_KEY,
C.AGENT_ID AS CALL_AGENT_ID,
C.CALLER_ID ,
C.CALL_GROUP_ID,
T.GROUP_ID AS TICKET_GROUP_ID,
C.GROUP_TITLE  AS CALL_GROUP_TITLE,
T.GROUP_TITLE AS TICKET_GROUP_TITLE,
C.BRANCH_KEY  ,
C.OFFICE_STATE_CODE ,
C.CALL_CHARGE ,
C.COMPLETION_STATUS AS CALL_COMPLETION_STATUS,
C.DIRECTION AS CALL_DIRECTION,
C.DURATION AS CALL_DURATION,
C.EXCEEDED_QUEUE_WAIT_TIME AS CALL_EXCEEDED_QUEUE_WAIT_TIME,
C.HOLD_TIME AS CALL_HOLD_TIME,
C.MINUTES_BILLED AS CALL_MINUTES_BILLED,
C.PHONE_NUMBER_ID ,
C.PHONE_NUMBER ,
C.TIME_TO_ANSWER AS CALL_TIME_TO_ANSWER,
C.VOICEMAIL ,
C.WAIT_TIME AS CALL_WAIT_TIME,
C.WRAP_UP_TIME AS CALL_WRAP_UP_TIME,
C.TALK_TIME AS CALL_TALK_TIME,
C.CONSULTATION_TIME AS CALL_CONSULTATION_TIME,
C.OUTSIDE_BUSINESS_HOURS AS CALL_OUTSIDE_BUSINESS_HOURS,
C.CALLBACK ,
C.DEFAULT_GROUP AS CALL_DEFAULT_GROUP,
C.LINE_ID AS CALL_LINE_ID ,
C.LINE_TYPE AS CALL_LINE_TYPE,
C.CALL_CHANNEL ,
C.QUALITY_ISSUES AS CALL_QUALITY_ISSUES ,
C.CREATED_AT AS CALL_CREATED_AT,
C.TIME_BRACKET AS CALL_TIME_BRACKET,
C.UPDATED_AT AS CALL_UPDATED_AT,
C.ORGANIZATION_ID ,
T.PRIORITY AS TICKET_PRIORITY,
T.STATUS AS TICKET_STATUS,
T.CALLER_TYPE,
T.PROBLEM_TYPE AS TICKET_PROBLEM_TYPE,
T.TICKET_CASE_TYPE,
T.VIA AS TICKET_VIA,
T.TYPE AS TICKET_TYPE,
T.REQUESTER_ID AS TICKET_REQUESTER_ID,
T.SUBMITTER_ID AS TICKET_SUBMITTER_ID,
T.WH_EMPLOYEE_KEY AS TICKET_WH_EMPLOYEE_KEY,
C.WH_EMPLOYEE_KEY AS CALL_WH_EMPLOYEE_KEY,
T.EMPLOYEE_KEY AS TICKET_EMPLOYEE_KEY,
T.SUBMITTER_KEY AS TICKET_SUBMITTER_KEY,
T.ASSIGNEE_ID AS TICKET_ASSIGNEE_ID,
T.ASSIGNEE_NAME AS TICKET_ASSIGNEE_NAME,
T.RECIPIENT AS TICKET_RECIPIENT,
T.SATISFACTION_RATING AS TICKET_SATISFACTION_RATING,
T.IS_PUBLIC AS TICKET_IS_PUBLIC,
T.SUBJECT AS TICKET_SUBJECT,
T.DESCRIPTION AS TICKET_DESCRIPTION,
T.BRAND_ID AS TICKET_BRAND_ID,
T.COLLABORATOR_IDS AS TICKET_COLLABORATOR_IDS,
T.EMAIL_CC_IDS AS TICKET_EMAIL_CC_IDS,
T.EXTERNAL_ID AS TICKET_EXTERNAL_ID,
T.FOLLOWER_IDS AS TICKET_FOLLOWER_IDS,
T.FOLLOWUP_IDS AS TICKET_FOLLOWUP_IDS,
T.SHARING_AGREEMENT_IDS AS TICKET_SHARING_AGREEMENT_IDS,
T.TICKET_FORM_ID ,
T.TICKET_FORM_NAME,
T.URL AS TICKET_URL,
T.CREATED_AT AS TICKET_CREATED_AT,
T.UPDATED_AT AS TICKET_UPDATED_AT,
T.TKT_METRICS_ID,
T.FIRST_RESOLUTION_TIME_IN_MINUTES_CALENDAR AS TICKET_FIRST_RESOLUTION_TIME,
T.REPLY_TIME_IN_MINUTES_CALENDAR AS TICKET_REPLY_TIME,
T.FULL_RESOLUTION_TIME_IN_MINUTES_CALENDAR AS TICKET_FULL_RESOLUTION_TIME,
T.REQUESTER_WAIT_TIME_IN_MINUTES_CALENDAR AS TICKET_REQUESTER_WAIT_TIME,
T.ON_HOLD_TIME_IN_MINUTES_CALENDAR AS TICKET_ON_HOLD_TIME,
T.AGENT_WAIT_TIME_IN_MINUTES_CALENDAR AS TICKET_AGENT_WAIT_TIME,
T.REOPENS AS TICKET_REOPENS,
T.REPLIES AS TICKET_REPLIES,
T.GROUP_STATIONS AS TICKET_GROUP_STATIONS,
T.ASSIGNEE_STATIONS AS TICKET_ASSIGNEE_STATIONS,
T.ASSIGNEE_UPDATED_AT AS TICKET_ASSIGNEE_UPDATED_AT,
T.REQUESTER_UPDATED_AT AS TICKET_REQUESTER_UPDATED_AT,
T.STATUS_UPDATED_AT AS TICKET_STATUS_UPDATED_AT,
T.INITIALLY_ASSIGNED_AT AS TICKET_INITIALLY_ASSIGNED_AT,
T.ASSIGNED_AT AS TICKET_ASSIGNED_AT,
T.SOLVED_AT AS TICKET_SOLVED_AT,
T.LATEST_COMMENT_ADDED_AT AS TICKET_LATEST_COMMENT_ADDED_AT,
T.CUSTOM_STATUS_UPDATED_AT AS TICKET_CUSTOM_STATUS_UPDATED_AT,
T.URL_TKT_METRICS,
T.EMPLOYEE_TYPE AS TICKET_EMPLOYEE_TYPE,
T.REQUESTER_NAME AS TICKET_REQUESTER_NAME,
T.REQUESTER_PHONE_NUMBER AS TICKET_REQUESTER_PHONE_NUMBER,
T.REQUESTER_PHONE_NUMBER_CALLMAX AS TICKET_REQUESTER_PHONE_NUMBER_CALLMAX,
T.REQUESTER_EMAIL AS TICKET_REQUESTER_EMAIL,
T.CAREGIVER_NAME AS TICKET_CAREGIVER_NAME,
T.CLIENT_NAME AS TICKET_CLIENT_NAME,
T.CALL_MAX_CALL_NOTES,
T.RESOLUTION_COMMENT AS TICKET_RESOLUTION_COMMENT,
T.TOTAL_TIME_SPENT AS TICKET_TOTAL_TIME_SPENT,
T.TIME_SPENT_LAST_UPDATE AS TICKET_TIME_SPENT_LAST_UPDATE,
T.SYSTEM ,
T.MARKET  ,
C.DNIS,
C.AA_DESTINATION,
C.CALL_START_DATE,
C.CALL_START_TIME,
C.CALL_DISCONNECTED_DATE,
C.CALL_DISCONNECTED_TIME,
C.CALLEE_DISCONNECT_ON_HOLD,
C.CALLER_DISCONNECT_ON_HOLD,
C.CALL_ANSWERED_DATE,
C.CALL_ANSWERED_TIME,
C.CALL_LEG_COUNT,
C.RING_DURATION,
C.ABANDONED_TIME,
C.DEPARTMENTS,
C.BRANCHES,
C.CALLER_NAME,
C.CALLEE_NAME,
''0'' AS TICKET_ONLY
FROM HAH.FACT_CALLS C
LEFT JOIN ZENDESK_TICKETS T
ON T.ID = C.TICKET_ID AND T.SYSTEM_CODE= C.SYSTEM_CODE
UNION ALL 
SELECT 
T.SYSTEM_CODE,
T.TICKET_KEY,
T.ID AS TICKET_ID,
T.SOURCE_SYSTEM_ID,
NULL AS CALL_KEY,
NULL AS CALL_ID,
NULL AS CALL_AGENT_KEY,
NULL AS CALLER_KEY,
NULL AS CALL_AGENT_ID,
NULL AS CALLER_ID ,
NULL AS CALL_GROUP_ID,
T.GROUP_ID AS TICKET_GROUP_ID,
NULL  AS CALL_GROUP_TITLE,
T.GROUP_TITLE AS TICKET_GROUP_TITLE,
T.BRANCH_KEY  ,
T.OFFICE_STATE_CODE ,
NULL AS CALL_CHARGE ,
NULL AS CALL_COMPLETION_STATUS,
NULL AS CALL_DIRECTION,
NULL AS CALL_DURATION,
NULL AS CALL_EXCEEDED_QUEUE_WAIT_TIME,
NULL AS CALL_HOLD_TIME,
NULL AS CALL_MINUTES_BILLED,
NULL AS PHONE_NUMBER_ID ,
NULL AS PHONE_NUMBER ,
NULL AS CALL_TIME_TO_ANSWER,
NULL AS VOICEMAIL ,
NULL AS CALL_WAIT_TIME,
NULL AS CALL_WRAP_UP_TIME,
NULL AS CALL_TALK_TIME,
NULL AS CALL_CONSULTATION_TIME,
NULL AS CALL_OUTSIDE_BUSINESS_HOURS,
NULL AS CALLBACK ,
NULL AS CALL_DEFAULT_GROUP,
NULL AS CALL_LINE_ID ,
NULL AS CALL_LINE_TYPE,
NULL AS CALL_CHANNEL ,
NULL AS CALL_QUALITY_ISSUES ,
NULL AS CALL_CREATED_AT,
NULL AS CALL_TIME_BRACKET,
NULL AS CALL_UPDATED_AT,
T.ORGANIZATION_ID ,
T.PRIORITY AS TICKET_PRIORITY,
T.STATUS AS TICKET_STATUS,
T.CALLER_TYPE,
T.PROBLEM_TYPE AS TICKET_PROBLEM_TYPE,
T.TICKET_CASE_TYPE,
T.VIA AS TICKET_VIA,
T.TYPE AS TICKET_TYPE,
T.REQUESTER_ID AS TICKET_REQUESTER_ID,
T.SUBMITTER_ID AS TICKET_SUBMITTER_ID,
T.WH_EMPLOYEE_KEY AS TICKET_WH_EMPLOYEE_KEY,
NULL AS CALL_WH_EMPLOYEE_KEY,
T.EMPLOYEE_KEY AS TICKET_EMPLOYEE_KEY,
T.SUBMITTER_KEY AS TICKET_SUBMITTER_KEY,
T.ASSIGNEE_ID AS TICKET_ASSIGNEE_ID,
T.ASSIGNEE_NAME AS TICKET_ASSIGNEE_NAME,
T.RECIPIENT AS TICKET_RECIPIENT,
T.SATISFACTION_RATING AS TICKET_SATISFACTION_RATING,
T.IS_PUBLIC AS TICKET_IS_PUBLIC,
T.SUBJECT AS TICKET_SUBJECT,
T.DESCRIPTION AS TICKET_DESCRIPTION,
T.BRAND_ID AS TICKET_BRAND_ID,
T.COLLABORATOR_IDS AS TICKET_COLLABORATOR_IDS,
T.EMAIL_CC_IDS AS TICKET_EMAIL_CC_IDS,
T.EXTERNAL_ID AS TICKET_EXTERNAL_ID,
T.FOLLOWER_IDS AS TICKET_FOLLOWER_IDS,
T.FOLLOWUP_IDS AS TICKET_FOLLOWUP_IDS,
T.SHARING_AGREEMENT_IDS AS TICKET_SHARING_AGREEMENT_IDS,
T.TICKET_FORM_ID ,
T.TICKET_FORM_NAME,
T.URL AS TICKET_URL,
T.CREATED_AT AS TICKET_CREATED_AT,
T.UPDATED_AT AS TICKET_UPDATED_AT,
T.TKT_METRICS_ID,
T.FIRST_RESOLUTION_TIME_IN_MINUTES_CALENDAR AS TICKET_FIRST_RESOLUTION_TIME,
T.REPLY_TIME_IN_MINUTES_CALENDAR AS TICKET_REPLY_TIME,
T.FULL_RESOLUTION_TIME_IN_MINUTES_CALENDAR AS TICKET_FULL_RESOLUTION_TIME,
T.REQUESTER_WAIT_TIME_IN_MINUTES_CALENDAR AS TICKET_REQUESTER_WAIT_TIME,
T.ON_HOLD_TIME_IN_MINUTES_CALENDAR AS TICKET_ON_HOLD_TIME,
T.AGENT_WAIT_TIME_IN_MINUTES_CALENDAR AS TICKET_AGENT_WAIT_TIME,
T.REOPENS AS TICKET_REOPENS,
T.REPLIES AS TICKET_REPLIES,
T.GROUP_STATIONS AS TICKET_GROUP_STATIONS,
T.ASSIGNEE_STATIONS AS TICKET_ASSIGNEE_STATIONS,
T.ASSIGNEE_UPDATED_AT AS TICKET_ASSIGNEE_UPDATED_AT,
T.REQUESTER_UPDATED_AT AS TICKET_REQUESTER_UPDATED_AT,
T.STATUS_UPDATED_AT AS TICKET_STATUS_UPDATED_AT,
T.INITIALLY_ASSIGNED_AT AS TICKET_INITIALLY_ASSIGNED_AT,
T.ASSIGNED_AT AS TICKET_ASSIGNED_AT,
T.SOLVED_AT AS TICKET_SOLVED_AT,
T.LATEST_COMMENT_ADDED_AT AS TICKET_LATEST_COMMENT_ADDED_AT,
T.CUSTOM_STATUS_UPDATED_AT AS TICKET_CUSTOM_STATUS_UPDATED_AT,
T.URL_TKT_METRICS,
T.EMPLOYEE_TYPE AS TICKET_EMPLOYEE_TYPE,
T.REQUESTER_NAME AS TICKET_REQUESTER_NAME,
T.REQUESTER_PHONE_NUMBER AS TICKET_REQUESTER_PHONE_NUMBER,
T.REQUESTER_PHONE_NUMBER_CALLMAX AS TICKET_REQUESTER_PHONE_NUMBER_CALLMAX,
T.REQUESTER_EMAIL AS TICKET_REQUESTER_EMAIL,
T.CAREGIVER_NAME AS TICKET_CAREGIVER_NAME,
T.CLIENT_NAME AS TICKET_CLIENT_NAME,
T.CALL_MAX_CALL_NOTES,
T.RESOLUTION_COMMENT AS TICKET_RESOLUTION_COMMENT,
T.TOTAL_TIME_SPENT AS TICKET_TOTAL_TIME_SPENT,
T.TIME_SPENT_LAST_UPDATE AS TICKET_TIME_SPENT_LAST_UPDATE,
T.SYSTEM ,
T.MARKET  ,
NULL AS DNIS,
NULL AS AA_DESTINATION,
NULL AS CALL_START_DATE,
NULL AS CALL_START_TIME,
NULL AS CALL_DISCONNECTED_DATE,
NULL AS CALL_DISCONNECTED_TIME,
NULL AS CALLEE_DISCONNECT_ON_HOLD,
NULL AS CALLER_DISCONNECT_ON_HOLD,
NULL AS CALL_ANSWERED_DATE,
NULL AS CALL_ANSWERED_TIME,
NULL AS CALL_LEG_COUNT,
NULL AS RING_DURATION,
NULL AS ABANDONED_TIME,
NULL AS DEPARTMENTS,
NULL AS BRANCHES,
NULL AS CALLER_NAME,
NULL AS CALLEE_NAME,
''1'' AS TICKET_ONLY
FROM ZENDESK_TICKETS T
WHERE NOT EXISTS (SELECT 1 FROM HAH.FACT_CALLS C  WHERE C.TICKET_KEY=T.TICKET_KEY) AND SYSTEM_CODE= ''ZENDESK_AMS'';

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result
FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;
';