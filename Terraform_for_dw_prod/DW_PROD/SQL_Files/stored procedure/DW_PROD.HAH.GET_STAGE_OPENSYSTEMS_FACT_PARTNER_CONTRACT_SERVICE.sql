CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_OPENSYSTEMS_FACT_PARTNER_CONTRACT_SERVICE("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN

--*****************************************************************************************************************************
-- NAME:  OPENSYSTEMS FACT PARTNER CONTRACT SERVICE
--
-- PURPOSE: Populates Stage OPENSYSTEMS  FACT PARTNER CONTRACT SERVICE
--
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 03/22/23     Pankti Fadia              Initial version
-- 12/25/23		Shraddha Sejpal			  Added State
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.OPENSYSTEMS_FACT_PARTNER_CONTRACT_SERVICE

WITH CLIENT AS(
	SELECT * FROM
		(
		SELECT PATIENTID, MASTER_ID, AGENCYID, LASTNAME, FIRSTNAME, OFFICEID--,ADMISSIONID --,OFFICEID
		FROM DISC_DEDUPE_PROD.HHAEXCHANGEOPENSYSTEMS.CLIENT_MASTER_LIST
    )
UNION
	SELECT * FROM
		(
		SELECT DISTINCT PATIENTID, MASTER_ID, AGENCYID, LASTNAME, FIRSTNAME, OFFICEID--,ADMISSIONID --,OFFICEID
		FROM DISC_DEDUPE_PROD.HHAEXCHANGEOPENSYSTEMS.CLIENT_MATCH_LIST
		WHERE PATIENTID NOT IN ( SELECT	PATIENTID FROM
				DISC_DEDUPE_PROD.HHAEXCHANGEOPENSYSTEMS.CLIENT_MASTER_LIST) 
))
	SELECT
		DISTINCT MD5(
		''OPENSYSTEMS'' || ''-'' || 
		ifnull(S.AGENCYID, -1) || ''-'' ||
		ifnull(PR.PAYERID, -1) || ''-'' ||
		IFNULL(S.CONTRACTID, -1) || ''-'' ||
		IFNULL(S.SERVICECODEID, -1) || ''-'' ||
		IFNULL(S.VISITTYPE, ''-1'') || ''-'' ||
		IFNULL(S.RATETYPETEXT, ''-1'') || ''-'' ||
		COALESCE (O.STATE,CASE WHEN PR.STATE=''DE'' OR PAYERNAME ILIKE ANY (''%DE'',''%DC Medicaid%'',''%Highmark Health Options%'',''%AmeriHealth Caritas DE%'') THEN ''DE''  ELSE ''PA'' END) || ''-'' ||
		''HHAEXCHANGE'') AS PARTNER_CONTRACT_SERVICE_KEY,
		''17'' AS SOURCE_SYSTEM_ID,
		CONCAT(''OPENSYSTEMS - '',COALESCE (O.STATE,CASE WHEN PR.STATE=''DE'' OR PAYERNAME ILIKE ANY (''%DE'',''%DC Medicaid%'',''%Highmark Health Options%'',''%AmeriHealth Caritas DE%'') THEN ''DE''  ELSE ''PA'' END)) AS SYSTEM_CODE,
		COALESCE (O.STATE,CASE WHEN PR.STATE=''DE'' OR PAYERNAME ILIKE ANY (''%DE'',''%DC Medicaid%'',''%Highmark Health Options%'',''%AmeriHealth Caritas DE%'') THEN ''DE''  ELSE ''PA'' END) AS STATE,
		MD5(''OPENSYSTEMS'' || ''-'' || COALESCE(O.STATE,''PA'') || ''-'' || IFNULL(PR.PAYERID,-1) || ''-'' || COALESCE(PR.CONTRACTID,PR.PAYERID,-1) || ''-'' || ''HHAEXCHANGE'') AS PARTNER_CONTRACT_KEY,
		NVL(PR.PAYERID, -1) AS PARTNER_CODE,
		IFNULL(PR.PAYERNAME,''UNKNOWN'') AS PARTNER_NAME,
		S.CONTRACTID AS CONTRACT_CODE,
		S.CONTRACTNAME AS CONTRACT_NAME,
		MD5(''OPENSYSTEMS'' || ''-'' || S.SERVICECODEID || ''-'' || ''HHAEXCHANGE'') AS SERVICE_KEY,
		S.SERVICECODEID AS SERVICECODE,
		S.SERVICECODE AS SERVICENAME,
		MD5(''OPENSYSTEMS'' || ''-'' || S.SERVICECODEID || ''-'' || ''HHAEXCHANGE'') AS BILLING_KEY,
		S.SERVICECODE AS BILLING_CODE,
		S.CONTRACTNAME AS BILL_NAME,
		IFF(UPPER(S.SERVICECODE) LIKE ''%BILLABLE%'',0,1) AS BILLABLE_FLAG,
		S.RATETYPETEXT AS BILL_TYPE,
		IFF(BILL_TYPE=''Hourly'',CASE
			WHEN CR.UNITS = 1 THEN ''Hourly''
			WHEN CR.UNITS = 2 THEN ''Half Hours''
			WHEN CR.UNITS = 4 THEN ''Quarter Hours''
			ELSE NULL
		END,NULL) AS BILL_UOM,
		S.RATETYPETEXT AS SCHEDULE_TYPE,
		S.RATETYPETEXT AS SCHEDULE_UOM,
		IFF(UPPER(S.SERVICECODE) LIKE ''%BILLABLE%'',0,1) AS AUTHORIZATION_REQUIRED_FLAG,
		TRUE::BOOLEAN AS PAYABLE_FLAG,                        
		FALSE::BOOLEAN AS EXPENSE_FLAG,                      
		IFF(UPPER(VI.INCLUDEMILEAGEEXPENSE :: BOOLEAN) IS NULL,UPPER(FALSE :: BOOLEAN),UPPER(VI.INCLUDEMILEAGEEXPENSE :: BOOLEAN)) AS MILEAGE_FLAG,                       
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
		:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP) :: timestamp_ntz as ETL_INSERTED_DATE,
		CURRENT_USER as ETL_INSERTED_BY,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP) :: timestamp_ntz as ETL_UPDATED_DATE,
		CURRENT_USER as ETL_LAST_UPDATED_BY,
		0 as ETL_DELETED_FLAG
		FROM DISC_PROD.HHAEXCHANGEOPENSYSTEMS.SERVICECODES S
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.PATIENTAUTHORIZATION PA 
    	ON S.CONTRACTID = PA.CONTRACTID
		AND S.SERVICECODEID = PA.SERVICECODEID
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.CONTRACTS C ON
		S.CONTRACTID = C.CONTRACTID
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.PAYER_REPL PR 
		ON IFNULL(PR.CONTRACTID, PR.PAYERID) = S.CONTRACTID
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.VisitInfo_REPL VI
 		ON S.SERVICECODEID = VI.PRIMARYSERVICECODEID
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.OFFICE_OFFICES_REPL O ON VI.OFFICEID = O.OFFICEID
	LEFT JOIN DISC_PROD.HHAEXCHANGEOPENSYSTEMS.CONTRACTRATES CR ON
		s.SERVICECODEID = CR.SERVICECODEID
		AND CR.AGENCYID = S.AGENCYID
		AND CR.SERVICECODEID = S.SERVICECODEID
		AND CR.TODATE :: DATE > GETDATE();
	
RETURN ''SUCCESS'';
end;
';