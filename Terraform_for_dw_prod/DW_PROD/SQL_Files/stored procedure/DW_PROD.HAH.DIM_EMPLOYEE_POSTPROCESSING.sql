CREATE OR REPLACE PROCEDURE DW_PROD.HAH.DIM_EMPLOYEE_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN
UPDATE DW_PROD.HAH.DIM_EMPLOYEE  E
SET E.DERIVED_FIRST_SERVICE_DATE = V.FIRST_SERVICE_DATE, E.DERIVED_LAST_SERVICE_DATE = V.LAST_SERVICE_DATE 
FROM (
    SELECT DISTINCT E.EMPLOYEE_KEY, MIN(V.REPORT_DATE) FIRST_SERVICE_DATE, MAX(V.REPORT_DATE) LAST_SERVICE_DATE 
    FROM DW_PROD.HAH.DIM_EMPLOYEE E 
    LEFT JOIN DW_PROD.HAH.FACT_VISIT V
        ON E.EMPLOYEE_KEY  = V.EMPLOYEE_KEY
  LEFT JOIN DW_PROD.HAH.DIM_CONTRACT DC ON V.CONTRACT_KEY = DC.CONTRACT_KEY
    WHERE DC.BILLABLE_FLAG = TRUE AND V.CONFIRMED_FLAG = ''YES''
    GROUP BY 1
) V
    WHERE E.EMPLOYEE_KEY = V.EMPLOYEE_KEY;

UPDATE DW_PROD.HAH.DIM_EMPLOYEE  E
SET E.DERIVED_PAYROLL_FIRST_CHECK_DATE = P.FIRST_PAYROLL_DATE, E.DERIVED_PAYROLL_LAST_CHECK_DATE = P.LAST_PAYROLL_DATE 
FROM (
    SELECT EMPLOYEE_KEY, MIN(PAYROLL_DATE) AS FIRST_PAYROLL_DATE,MAX(PAYROLL_DATE) AS LAST_PAYROLL_DATE
    FROM DW_PROD.HAH.FACT_PAYROLL
    GROUP BY 1
) P
    WHERE E.EMPLOYEE_KEY = P.EMPLOYEE_KEY;

END;
';