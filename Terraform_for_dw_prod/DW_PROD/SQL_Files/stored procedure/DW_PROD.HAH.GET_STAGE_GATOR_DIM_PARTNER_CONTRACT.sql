CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_GATOR_DIM_PARTNER_CONTRACT("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'BEGIN
    --*****************************************************************************************************************************
-- NAME:  GATOR_DIM_PARTNER
--
-- PURPOSE: Creates one row per PARTNER according to Gator.
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 12/27/23    Meet Hariyani         Initial development
--*****************************************************************************************************************************
INSERT OVERWRITE INTO DW_PROD.STAGE.GATOR_DIM_PARTNER_CONTRACT
SELECT DISTINCT MD5(DP.PARTNER_CODE  || ''-'' || CP.SL_EXTERNAL_ID__C || ''-'' || DP.PARTNER_CODE) AS PARTNER_CONTRACT_KEY
				, DP.SOURCE_SYSTEM_ID
				, DP.SYSTEM_CODE		
				, DP.PARTNER_KEY
				, DP.PARTNER_CODE
				, DP.PARTNER_NAME
				, CP.SL_EXTERNAL_ID__C AS CONTRACT_CODE
				, CP.NAME AS CONTRACT_NAME
				, NOT(NVL(CP.ISDELETED, FALSE)) AS ACTIVE_FLAG
				, CP.STARTDATE AS START_DATE
				, CP.ENDDATE AS END_DATE 
				, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
			 	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
			      , Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
				, CURRENT_USER AS ETL_INSERTED_BY
				, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
				, CURRENT_USER AS ETL_LAST_UPDATED_BY
			 	, 0 AS ETL_DELETED_FLAG
FROM DW_PROD.HAH.DIM_PARTNER DP
INNER JOIN DW_PROD.HAH.DIM_PARTNER_PROGRAM_MAPPING MAPPING
	ON MAPPING.PARTNER_CODE = DP.PARTNER_CODE AND MAPPING.PARTNER_NAME = DP.PARTNER_NAME
LEFT JOIN DISC_PROD.HEALTH_NAVIGATOR.CAREPROGRAM CP
	ON MAPPING.PROGRAM_CODE = CP.SL_EXTERNAL_ID__C
WHERE DP.SYSTEM_CODE = ''GATOR''
AND MAPPING.IS_ACTIVE ;
RETURN ''SUCCESS'';
END';