CREATE OR REPLACE PROCEDURE DW_PROD.INTEGRATION.GET_ROSTER_AMS_MAPPING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'BEGIN
------------------------------------------------------------------------------------------------------------------------------
/*
Object Type : 	Procedure
Object Name	: 	GET_ROSTER_AMS_MAPPING
Author		:	Mohit Vaghadiya
Description :
	- This procedure populates the clients that we receive in different roster
	- Gives us a AMS Client key, Program Client Key along with the roster name and tells us if it''s fixed roster 
*/

--*****************************************************************************************************************************
-- CHANGE LOG :
-- Version	Date(MM/DD/YYYY)	Author				Change Description
-- --------	----------------   	------------------	---------------------------------------------------------------------------
-- 1.0		06/01/2023    		Mohit Vaghadiya     Initial PRODelopment
-- 1.1		06/01/2023    		Mohit Vaghadiya     Added ETL Fields
-- 1.2		07/11/2023			Mohit Vaghadiya		Added PAHW FIXED ROSTER Code to Populate PAHW Clients based on PA Visits
-- 1.3		07/11/2023			Mohit Vaghadiya		Added code to look at the disc layer roster table to identify the Client
--													based on current roster
-- 1.4		07/18/2023			Lusy Patel			Added AMERIHEALTH ROSTER to Populate HMPAAC clients.
-- 1.5		07/20/2023			Mohit Vaghadiya		The PAHW Population logic should be looking at latest payor
-- 1.6		08/18/2023			Mohit Vaghadiya		Updated AHC to Fixed Roster = TRUE
-- 1.7		12/15/2023			Lusy Patel			Added logic to Populate HMNYHF clients.
-- 1.8		12/15/2023			Lusy Patel			Added logic to Populate HMILCCCG clients.
-- 1.9		12/5/2023			Lusy Patel			Added logic to Populate HMILCC clients.
-------------------------------------------------------------------------------------------------------------------------------
INSERT OVERWRITE INTO DW_PROD.INTEGRATION.ROSTER_AMS_MAPPING
WITH ROSTER_CLIENT AS
(
	SELECT  AMS.ID AS AMS_CLIENT_KEY
	        , CENTENE.ID AS PROGRAM_CLIENT_KEY
	        , ''CENTENE'' AS ROSTER_NAME
	        , FALSE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_CENTENE_RL_OUTPUT AMS 
	INNER JOIN DW_PROD.INTEGRATION.DIM_CLIENT_CENTENE_RL_OUTPUT CENTENE 
	    ON AMS.CLUSTER_ID = CENTENE.CLUSTER_ID 
	-- Added Below Join to consider the clients in Current Active Roster Only
	INNER JOIN DISC_PROD.CENTENE.CENTENE_SOURCE_DATA CENTENE_CURRENT_ROSTER
		ON CENTENE_CURRENT_ROSTER.EXTERNAL_ID = CENTENE.CLIENT_NUMBER
	WHERE AMS.SOURCE_SYSTEM_ID <> 27 
	        AND CENTENE.SOURCE_SYSTEM_ID = 27
	UNION
	SELECT AMS.ORIGINAL_CLIENT_KEY AS AMS_CLIENT_KEY
			, OSH.ORIGINAL_CLIENT_KEY AS PROGRAM_CLIENT_KEY
			, ''OSH'' AS ROSTER_NAME
			, FALSE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED  AS AMS
	INNER JOIN DW_PROD.INTEGRATION.DIM_CLIENT_MERGED AS OSH 
	    ON UPPER(TRIM(AMS.CLIENT_FIRST_NAME)) = UPPER(TRIM(OSH.CLIENT_FIRST_NAME)) 
	    	AND UPPER(TRIM(AMS.CLIENT_LAST_NAME)) = UPPER(TRIM(OSH.CLIENT_LAST_NAME)) 
	    	AND AMS.CLIENT_DOB=OSH.CLIENT_DOB 
	    	AND AMS.CLIENT_ZIP=OSH.CLIENT_ZIP
    INNER JOIN DW_PROD.HAH.DIM_SOURCE_SYSTEM DSS 
    	ON AMS.SOURCE_SYSTEM_ID = DSS.SOURCE_SYSTEM_ID 
    		AND DSS.SOURCE_SYSTEM_TYPE=''AMS''
	WHERE OSH.ORIGINAL_SOURCE_SYSTEM_ID = 24
	    	AND AMS.ORIGINAL_SOURCE_SYSTEM_ID <> 24
	    	AND AMS.ORIGINAL_CLIENT_KEY=AMS.CLIENT_KEY
	    	AND OSH.ORIGINAL_CLIENT_KEY=OSH.CLIENT_KEY
	UNION
	SELECT AMS.ID AS AMS_CLIENT_KEY
			, MOLINA.ID AS PROGRAM_CLIENT_KEY 
			, ''MOLINA'' AS ROSTER_NAME
			, FALSE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MOLINA_RL_OUTPUT AMS 
	INNER JOIN DW_PROD.INTEGRATION.DIM_CLIENT_MOLINA_RL_OUTPUT MOLINA 
		ON AMS.CLUSTER_ID=MOLINA.CLUSTER_ID 
	-- Added Below Join to consider the clients in Current Active Roster Only
	INNER JOIN DISC_PROD.MOLINA.MOLINA_SOURCE_DATA MOLINA_CURRENT_ROSTER
		ON MOLINA_CURRENT_ROSTER.EXTERNAL_ID = MOLINA.CLIENT_NUMBER
	WHERE AMS.SOURCE_SYSTEM_ID <> 32 
			AND MOLINA.SOURCE_SYSTEM_ID = 32
	UNION
	SELECT DC.CLIENT_KEY
			, DC.CLIENT_KEY AS PROGRAM_CLIENT_KEY
			, ''ORIGINAL_PILOT'' AS ROSTER_NAME
			, TRUE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
	INNER JOIN APP_DB_PROD.CARE_COORDINATION.CLIENT_LIST_50 CL 
		ON CL.CLIENT_KEY = DC.ORIGINAL_CLIENT_KEY
	UNION
	-- The PAHW clients are not getting populated from Roster
	-- The way to identify the PAHW Client is to look at the Clients received service in PA and payor is Centene
	SELECT AMS_CLIENT_KEY
		, PROGRAM_CLIENT_KEY
		, ROSTER_NAME
		, IS_FIXED
	FROM
	(
		SELECT FV.CLIENT_KEY AS AMS_CLIENT_KEY
					, FV.CLIENT_KEY AS PROGRAM_CLIENT_KEY 
					, ''PAHW_ROSTER'' AS ROSTER_NAME
					, FALSE AS IS_FIXED
					, (C.CONTRACT_CODE = ''PHW'') AS IS_PAHW
		FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
		INNER JOIN DW_PROD.INTEGRATION.FACT_VISIT_MERGED FV
				ON DC.ORIGINAL_CLIENT_KEY = FV.CLIENT_KEY
		INNER JOIN DW_PROD.HAH.DIM_CONTRACT C
			ON C.CONTRACT_KEY = FV.CONTRACT_KEY 
		WHERE FV.CONFIRMED_FLAG = ''YES''
		-- Added QUALIFY to look at the Payor/Contract from last confirmed visit
		QUALIFY ROW_NUMBER() OVER (PARTITION BY FV.CLIENT_KEY ORDER BY FV.SERVICE_DATE DESC) = 1
		UNION
		SELECT FV.CLIENT_KEY AS AMS_CLIENT_KEY
				, FV.CLIENT_KEY AS PROGRAM_CLIENT_KEY 
				, ''PAHW_ROSTER'' AS ROSTER_NAME
				, FALSE AS IS_FIXED
				, (CON.CONTRACT_NAME ILIKE ''%CENTENE%'') AS IS_PAHW
		FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
		INNER JOIN DW_PROD.INTEGRATION.FACT_VISIT_MERGED FV
			ON DC.ORIGINAL_CLIENT_KEY = FV.CLIENT_KEY
		INNER JOIN DW_PROD.HAH.DIM_CONTRACT CON
			ON FV.CONTRACT_KEY = CON.CONTRACT_KEY 
		INNER JOIN DW_PROD.HAH.DIM_BRANCH PA_BRANCH
			ON PA_BRANCH.BRANCH_KEY = FV.BRANCH_KEY 
		WHERE FV.CONFIRMED_FLAG =''YES'' 
				AND CON.SOURCE_SYSTEM_ID = 17 
				AND CON.SYSTEM_CODE  IN (''OPENSYSTEMS - PA'',''OSHAH - PA'')
		-- Added QUALIFY to look at the Payor/Contract from last confirmed visit
		QUALIFY ROW_NUMBER() OVER (PARTITION BY FV.CLIENT_KEY ORDER BY FV.SERVICE_DATE DESC) = 1
	)
	WHERE IS_PAHW = TRUE
	UNION
	SELECT AMS.ID AS AMS_CLIENT_KEY
			, AHC.ID AS PROGRAM_CLIENT_KEY
			, ''AMERIHEALTH'' AS ROSTER_NAME 
			, TRUE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_AMERIHEALTH_RL_OUTPUT AMS
	INNER JOIN DW_PROD.INTEGRATION.DIM_CLIENT_AMERIHEALTH_RL_OUTPUT AHC 
		ON AMS.CLUSTER_ID = AHC.CLUSTER_ID
	INNER JOIN DISC_PROD.AMERIHEALTH.AMERIHEALTH_SOURCE_DATA AHC_CURRENT_ROSTER 
		ON AHC_CURRENT_ROSTER.EXTERNAL_ID = AHC.CLIENT_NUMBER
	WHERE AMS.SOURCE_SYSTEM_ID <> 35
			AND AHC.SOURCE_SYSTEM_ID = 35
	UNION
	SELECT AMS_CLIENT_KEY, PROGRAM_CLIENT_KEY, ROSTER_NAME, IS_FIXED FROM ( 
	SELECT FV.CLIENT_KEY AS AMS_CLIENT_KEY
			, FV.CLIENT_KEY AS PROGRAM_CLIENT_KEY 
			, ''HMNYHF_ROSTER'' AS ROSTER_NAME
	, FALSE AS IS_FIXED
	, (CON.CONTRACT_NAME ILIKE ''%HealthFirst%'') AS IS_HealthFirst
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
	INNER JOIN DW_PROD.INTEGRATION.FACT_VISIT_MERGED FV
		ON DC.ORIGINAL_CLIENT_KEY = FV.CLIENT_KEY
	INNER JOIN DW_PROD.HAH.DIM_CONTRACT CON
		ON FV.CONTRACT_KEY = CON.CONTRACT_KEY 
	INNER JOIN DW_PROD.HAH.DIM_BRANCH PA_BRANCH
		ON PA_BRANCH.BRANCH_KEY = FV.BRANCH_KEY 
	WHERE FV.CONFIRMED_FLAG =''YES'' 
	AND CON.SOURCE_SYSTEM_ID = 17 
	AND CON.SYSTEM_CODE  IN (''PREFERRED'',''EDISON'') AND IS_HealthFirst = TRUE
	-- Added QUALIFY to look at the Payor/Contract from last confirmed visit
	QUALIFY ROW_NUMBER() OVER (PARTITION BY FV.CLIENT_KEY ORDER BY FV.SERVICE_DATE DESC) = 1
	)
	UNION 
	SELECT DISTINCT DC.CLIENT_KEY AS AMS_CLIENT_KEY
			, cl.CLIENT_KEY AS PROGRAM_CLIENT_KEY
			, ''HMILCCCG_ROSTER'' AS ROSTER_NAME
			, TRUE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
	INNER JOIN APP_DB_PROD.CARE_COORDINATION.CLIENT_LIST_CC_AND_CCCG CL 
		ON CL.CLIENT_KEY = DC.ORIGINAL_CLIENT_KEY
		WHERE cl.TEST_OR_CONTROL = ''0''
	UNION
	SELECT DISTINCT DC.CLIENT_KEY
			, cl.CLIENT_KEY AS PROGRAM_CLIENT_KEY
			, ''HMILCC_ROSTER'' AS ROSTER_NAME
			, TRUE AS IS_FIXED
	FROM DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DC
	INNER JOIN APP_DB_PROD.CARE_COORDINATION.CLIENT_LIST_CC_AND_CCCG CL 
		ON CL.CLIENT_KEY = DC.ORIGINAL_CLIENT_KEY
	INNER JOIN DW_PROD.INTEGRATION.FACT_VISIT_MERGED FV
		ON DC.ORIGINAL_CLIENT_KEY = FV.CLIENT_KEY
	INNER JOIN DW_PROD.HAH.DIM_CONTRACT CON
		ON FV.CONTRACT_KEY = CON.CONTRACT_KEY 
		WHERE cl.TEST_OR_CONTROL = ''1'' AND con.CONTRACT_NAME = ''MCO COUNTY CARE'' 	
)
SELECT AMS_CLIENT_KEY
		, PROGRAM_CLIENT_KEY
		, ROSTER_NAME
		, IS_FIXED
        , :STR_ETL_TASK_KEY AS ETL_TASK_KEY
        , :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
   		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
   		, CURRENT_USER AS ETL_INSERTED_BY
   		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
    	, CURRENT_USER AS ETL_LAST_UPDATED_BY
    	, 0 AS ETL_DELETED_FLAG
FROM ROSTER_CLIENT;
RETURN ''SUCCESS'';
END';