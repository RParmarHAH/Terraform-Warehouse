CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_ALAYACARE_DIM_SERVICES_1_0("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN
--*****************************************************************************************************************************
-- NAME:  ALAYACARE_DIM_SERVICE_1_0
--
-- PURPOSE: Creates one row per SERVICE_CODE, RATE_TYPE AND SERVICE_LINE combination according to ALAYACARE
--
-- PRODELOPMENT LOG:
-- DATE        AUTHOR                	NOTES:
-- --------    -------------------   	-----------------------------------------------------------------------------------------------
--08/09/2023    trushali
--*****************************************************************************************************************************
INSERT OVERWRITE INTO DW_PROD.STAGE.ALAYACARE_DIM_SERVICES_1_0
SELECT DISTINCT  
MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(BC.BRANCH_ID,-1) || '')'' || ''-'' || S.SERVICE_CODE_ID::STRING || ''-'' || ''ALAYACARE'') AS SERVICE_KEY            
,UPPER(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(BC.BRANCH_ID,-1) || '')'') AS SYSTEM_CODE 
,9 AS SOURCE_SYSTEM_ID          
,S.SERVICE_CODE_ID AS SERVICE_CODE_ID              
, CASE WHEN LENGTH (S.PROPERTIES_NAME) > 50 THEN S.PROPERTIES_DESCRIPTION ELSE S.PROPERTIES_NAME END AS NAME   
,NULL AS BILL_CODE_ID
		, NULL AS IS_EXPENCE
		, NULL AS IS_MULTIPLE
		, NULL AS OTHER_CODE
		, NULL AS DEFAULT_COST
		, NULL AS DEFAULT_PAY_UNIT_FLAG
		, NULL AS DEFAULT_BILL_UNIT_FLAG
		, NULL AS CATEGORY_ID
		, NULL AS PAYROLL_CODE
		, NULL AS DEFAULT_REIMBURSMENT
		, NULL AS WC
		, NULL AS SHIFT_PAY
		, NULL AS OT_PAY
		, NULL AS BILL_EXCLUDE_HOLIDAY
		, NULL AS PAY_EXCLUDED_HOLIDAY
		, NULL AS IS_CAT
		, NULL AS COMMISSION_RATE
		, NULL AS BONUS_POINTS
		, NULL AS ACTIVE
		, NULL AS REVENUE_CODE
		, NULL AS PAY
		, NULL AS POC_FIRST_BIL_LABLE_FLAG
		, NULL AS EXPENCE_TYPE_ID
		, NULL AS CREATED_DATE
		, NULL AS CREATED_USER
		, NULL AS MODIFIED_DATE
		, NULL AS MODIFIED_USER
		, NULL AS TS
		, NULL AS LIST_ITEM_TYPE
		, NULL AS RPT_GROUP_ID
		, NULL AS BRANCH_ID
		, NULL AS OVERRIDE_ID
		, NULL AS DESCRIPTION
		, NULL AS TAX_GROUP_ID
		, NULL AS LEGACY_ID
		, NULL AS LEGACY_BRANCH_ID
		, NULL AS ACCT_ID
		, NULL AS UPLOAD_TELEPHONY
		, NULL AS TELEPHONY_TASK_ID
		, NULL AS INCLUDE_EFT
		, NULL AS PROJECTED_AVG_BILL_VISIT
		, NULL AS PROJECTED_AVG_PAY_VISIT
		, NULL AS PROJECTED_AVG_PAY_HOURLY
		, NULL AS PROJECTED_AVG_BILL_HOURLY
		, NULL AS IS_COPY
		, NULL AS IS_WORKING
		, NULL AS DEDUCT_ARN
		, NULL AS LIVE_IN_RPT_HRS
		, NULL AS ACCT_CODE
		, NULL AS DISPLAY_ON_CLIENT_PORTAL
		, NULL AS DISPLAY_ON_CAREGIVER_PORTAL
		, NULL AS THERAPY_COUNTING_TYPE
		, NULL AS MEDICARE_DISCIPLINE
		, NULL AS DOC_TYPE
		, NULL AS IS_MULTIPLE_SERVICE
		, NULL AS INSERT_DATE
		, NULL AS UPDATE_DATE
		, FALSE AS DELETED_FLAG
		, NULL AS CHANGE_VERSION
		, NULL AS CHANGE_OPERATION,
		-- ETL Fields
    	:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
        :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
 		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER as ETL_INSERTED_BY
		, CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER as ETL_LAST_UPDATED_BY
		, 0 AS ETL_DELETED_FLAG
		, 0 AS ETL_INFERRED_MEMBER_FLAG      
FROM DISC_PROD.ALAYACARE.SERVICE_CODE AS S
LEFT JOIN DISC_PROD.ALAYACARE.SERVICE_CODE_BILL_CODE SBC ON S.SERVICE_CODE_ID = SBC.SERVICE_CODE_ID
LEFT JOIN DISC_PROD.ALAYACARE.BILL_CODE AS BC ON BC.BILL_CODE_ID = SBC.BILL_CODE_ID 
LEFT JOIN DISC_PROD.ALAYACARE.BRANCH AS COMPANY ON COMPANY.BRANCH_ID = BC.BRANCH_ID
LEFT JOIN (SELECT DISTINCT SERVICE_CODE_ID,VISIT_COMPUTED_RATE_UNITS,BRANCH_ID FROM DISC_PROD.ALAYACARE.VISIT where VISIT_COMPUTED_RATE_UNITS is not null) VISITS 
ON VISITS.SERVICE_CODE_ID = S.SERVICE_CODE_ID AND VISITS.BRANCH_ID = NVL(BC.BRANCH_ID,-1)
INNER JOIN DISC_PROD.ALAYACARE.CONFIGURATION CONFIG 
	ON CONFIG.SYSTEM_CODE= SYSTEM_CODE
	AND CONFIG.CONFIGURATION_ACTIVE= TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
  RETURN ''SUCCESS'';
    END;
    ';