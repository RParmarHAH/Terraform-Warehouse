CREATE OR REPLACE PROCEDURE DW_PROD.HAH.MERGE_STAGE_CS_FACT_SURVEY_RESPONSE_DETAIL()
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '

    var sqlCmd = "";
    var sqlStmt = "";
    var result = "";

    try {
      var sqlCmd = `
    MERGE INTO HAH.FACT_SURVEY_RESPONSE_DETAIL FSRD
USING STAGE.CS_FACT_SURVEY_RESPONSE_DETAIL STAGE 
ON FSRD.SURVEY_RESPONSE_DETAIL_KEY = STAGE.SURVEY_RESPONSE_DETAIL_KEY
WHEN MATCHED THEN 
UPDATE SET 
    FSRD.SURVEY_KEY=	STAGE.SURVEY_KEY,
	FSRD.SURVEY_ID=	STAGE.SURVEY_ID,
	FSRD.SOURCE_SYSTEM_ID=STAGE.SOURCE_SYSTEM_ID,
	FSRD.SYSTEM_CODE=STAGE.SYSTEM_CODE,
	FSRD.SURVEY_RESPONSE_HEADER_KEY=	STAGE.SURVEY_RESPONSE_HEADER_KEY,
	FSRD.SURVEY_QUESTION_KEY=	STAGE.SURVEY_QUESTION_KEY,
	FSRD.QUESTION_ID=	STAGE.QUESTION_ID,
	FSRD.ANSWER=	STAGE.ANSWER,
	FSRD.ETL_TASK_KEY=	STAGE.ETL_TASK_KEY,
	FSRD.ETL_INSERTED_TASK_KEY=	STAGE.ETL_INSERTED_TASK_KEY,
	FSRD.ETL_INSERTED_DATE=	STAGE.ETL_INSERTED_DATE,
	FSRD.ETL_INSERTED_BY=	STAGE.ETL_INSERTED_BY,
	FSRD.ETL_LAST_UPDATED_DATE=	STAGE.ETL_LAST_UPDATED_DATE,
	FSRD.ETL_LAST_UPDATED_BY=	STAGE.ETL_LAST_UPDATED_BY,
	FSRD.ETL_DELETED_FLAG=	STAGE.ETL_DELETED_FLAG
WHEN NOT MATCHED THEN 
INSERT ( 
    SURVEY_RESPONSE_DETAIL_KEY,
	SURVEY_KEY,
	SURVEY_ID,
	SOURCE_SYSTEM_ID,
	SYSTEM_CODE,
	SURVEY_RESPONSE_HEADER_KEY,
	SURVEY_QUESTION_KEY,
	QUESTION_ID,
	ANSWER,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG
) 
VALUES (
	STAGE.SURVEY_RESPONSE_DETAIL_KEY,
	STAGE.SURVEY_KEY,
	STAGE.SURVEY_ID,
	STAGE.SOURCE_SYSTEM_ID,
	STAGE.SYSTEM_CODE,
	STAGE.SURVEY_RESPONSE_HEADER_KEY,
	STAGE.SURVEY_QUESTION_KEY,
	STAGE.QUESTION_ID,
	STAGE.ANSWER,
	STAGE.ETL_TASK_KEY,
	STAGE.ETL_INSERTED_TASK_KEY,
	STAGE.ETL_INSERTED_DATE,
	STAGE.ETL_INSERTED_BY,
	STAGE.ETL_LAST_UPDATED_DATE,
	STAGE.ETL_LAST_UPDATED_BY,
	STAGE.ETL_DELETED_FLAG
)

    `;
      sqlStmt = snowflake.createStatement( {sqlText: sqlCmd} );
      rs = sqlStmt.execute();
      sqlCmd = 
            `SELECT "number of rows inserted", "number of rows updated"
              FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))`;
      sqlStmt = snowflake.createStatement( {sqlText: sqlCmd} );
      rs = sqlStmt.execute();
          rs.next();
          result += ''{"Inserted": "'' + rs.getColumnValue(1) + ''", "Updated": "'' + rs.getColumnValue(2) +''", "ErrorCode":"NA", "ErrorState":"NA", "ErrorMessage":"NA", "ErrorStackTrace":"NA"}'';
    }
    catch (err) {
        result = ''{"Inserted": "0", "Updated": "0", "ErrorCode":"''+ err.code +''", "ErrorState":"''+ err.state +''", "ErrorMessage":"''+ err.message +''", "ErrorStackTrace":"''+ err.stackTraceTxt +''"}'';
    }
    return result;
    ';