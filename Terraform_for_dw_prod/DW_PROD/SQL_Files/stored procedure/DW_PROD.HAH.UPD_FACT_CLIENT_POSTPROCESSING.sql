CREATE OR REPLACE PROCEDURE DW_PROD.HAH.UPD_FACT_CLIENT_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN
--*****************************************************************************************************************************
-- NAME:  UPDATE_CLIENT_KEY
--
-- PURPOSE: Update CLIRNT_KEY in FACT_VISIT ,FACT_REVENUE ,FACT_INTAKE ,DIM_INVOICE
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 04/28/2023	Darshan 			Initial development
--*****************************************************************************************************************************


------Update CLIENT_KEY in DIM_INVOICE  table When CLIENT_KEY in DIM_CLIENT get change

UPDATE DW_PROD.HAH.DIM_INVOICE I FROM  
(
SELECT
INVOICE.CLIENT_KEY AS CLIENT_KEY,
INVOICE.SYSTEM_CODE  AS SYSTEM_CODE,
CLNT_MATCH.MASTER_CLIENT_KEY AS MASTER_CLIENT_KEY,
CLNT_MATCH.LATEST_CLIENT_NUMBER AS LATEST_CLIENT_NUMBER
FROM
DISC_DEDUPE_PROD.PUBLIC.VW_CLIENT_MATCH_LIST CLNT_MATCH
JOIN DW_PROD.HAH.DIM_CLIENT CLNT ON CLNT.CLIENT_KEY = CLNT_MATCH.MASTER_CLIENT_KEY
JOIN DW_PROD.HAH.DIM_INVOICE INVOICE ON  INVOICE.CLIENT_KEY = CLNT_MATCH.CLIENT_KEY
AND  INVOICE.CLIENT_KEY <> CLNT_MATCH.MASTER_CLIENT_KEY
GROUP BY 1,2,3,4
)A
SET 
I.CLIENT_KEY = A.MASTER_CLIENT_KEY
--CLIENT_NUMBER = A.LATEST_CLIENT_NUMBER                     --- CLIENT_NUMBER not present in DW_PROD.HAH.DIM_INVOICE
WHERE
I.CLIENT_KEY = A.CLIENT_KEY
AND 
I.SYSTEM_CODE = A.SYSTEM_CODE ;




------Update CLIENT_KEY in FACT_INTAKE table When CLIENT_KEY in DIM_CLIENT get change 

UPDATE DW_PROD.HAH.FACT_INTAKE FIN FROM  
(SELECT
INTAKE.CLIENT_KEY AS CLIENT_KEY,
INTAKE.SYSTEM_CODE  AS SYSTEM_CODE,
CLNT_MATCH.MASTER_CLIENT_KEY AS MASTER_CLIENT_KEY,
CLNT_MATCH.LATEST_CLIENT_NUMBER AS LATEST_CLIENT_NUMBER
FROM
DISC_DEDUPE_PROD.PUBLIC.VW_CLIENT_MATCH_LIST CLNT_MATCH
JOIN DW_PROD.HAH.DIM_CLIENT CLNT ON CLNT.CLIENT_KEY = CLNT_MATCH.MASTER_CLIENT_KEY
JOIN DW_PROD.HAH.FACT_INTAKE INTAKE ON  INTAKE.CLIENT_KEY = CLNT_MATCH.CLIENT_KEY
AND  INTAKE.CLIENT_KEY <> CLNT_MATCH.MASTER_CLIENT_KEY
GROUP BY 1,2,3,4
)X
SET 
FIN.CLIENT_KEY = X.MASTER_CLIENT_KEY,
FIN.CLIENT_NUMBER = X.LATEST_CLIENT_NUMBER
WHERE
FIN.CLIENT_KEY = X.CLIENT_KEY
AND FIN.SYSTEM_CODE = X.SYSTEM_CODE;



---Update CLIENT_KEY in FACT_REVENUE table When CLIENT_KEY in DIM_CLIENT get change 


UPDATE DW_PROD.HAH.FACT_REVENUE R FROM   
(
SELECT
REVENUE.CLIENT_KEY AS CLIENT_KEY,
REVENUE.SYSTEM_CODE  AS SYSTEM_CODE,
CLNT_MATCH.MASTER_CLIENT_KEY AS MASTER_CLIENT_KEY,
CLNT_MATCH.LATEST_CLIENT_NUMBER AS LATEST_CLIENT_NUMBER
FROM
DISC_DEDUPE_PROD.PUBLIC.VW_CLIENT_MATCH_LIST CLNT_MATCH
JOIN DW_PROD.HAH.DIM_CLIENT CLNT ON CLNT.CLIENT_KEY = CLNT_MATCH.MASTER_CLIENT_KEY
JOIN DW_PROD.HAH.FACT_REVENUE REVENUE ON  REVENUE .CLIENT_KEY = CLNT_MATCH.CLIENT_KEY
AND  REVENUE .CLIENT_KEY <> CLNT_MATCH.MASTER_CLIENT_KEY
GROUP BY 1,2,3,4)Y
SET 
R.CLIENT_KEY = Y.MASTER_CLIENT_KEY,
R.CLIENT_NUMBER = Y.LATEST_CLIENT_NUMBER
WHERE
R.CLIENT_KEY = Y.CLIENT_KEY
AND R.SYSTEM_CODE = Y.SYSTEM_CODE;


---Update CLIENT_KEY in FACT_VISIT table When CLIENT_KEY in DIM_CLIENT get change 

UPDATE DW_PROD.HAH.FACT_VISIT V FROM  
(
SELECT
VISIT.CLIENT_KEY AS CLIENT_KEY,
VISIT.SYSTEM_CODE  AS SYSTEM_CODE,
CLNT_MATCH.MASTER_CLIENT_KEY AS MASTER_CLIENT_KEY,
CLNT_MATCH.LATEST_CLIENT_NUMBER  AS LATEST_CLIENT_NUMBER
FROM
DISC_DEDUPE_PROD.PUBLIC.VW_CLIENT_MATCH_LIST CLNT_MATCH
JOIN DW_PROD.HAH.DIM_CLIENT CLNT ON CLNT.CLIENT_KEY = CLNT_MATCH.MASTER_CLIENT_KEY
JOIN DW_PROD.HAH.FACT_VISIT VISIT ON VISIT.CLIENT_KEY = CLNT_MATCH.CLIENT_KEY
AND VISIT.CLIENT_KEY <> CLNT_MATCH.MASTER_CLIENT_KEY
GROUP BY 1,2,3,4
)Z
SET 
V.CLIENT_KEY = Z.MASTER_CLIENT_KEY,
V.CLIENT_NUMBER = Z.LATEST_CLIENT_NUMBER
WHERE
V.CLIENT_KEY = Z.CLIENT_KEY 
AND V.SYSTEM_CODE = Z.SYSTEM_CODE ;



RETURN ''SUCCESS'';
    END;
';