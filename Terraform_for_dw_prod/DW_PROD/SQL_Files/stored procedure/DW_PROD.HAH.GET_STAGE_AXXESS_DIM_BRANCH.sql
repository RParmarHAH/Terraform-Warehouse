CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_AXXESS_DIM_BRANCH("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN 
--*****************************************************************************************************************************
-- NAME:  AXXESS_DIM_BRANCH

-- DEVELOPMENT LOG:
-- DATE			AUTHOR					NOTES:
-- --------		-------------------		---------------------------------------------------------------------------------------
-- 12/29/2021	Abhishek Sunil			Initial Development
-- 04/04/2022	Parag Gajjar			Revised logic
-- 05/04/2022	Parag Gajjar			Logic changes and Customer Dedup Leverage
-- 09/23/2022	Pooja Shah				Appened Home Care
-- 04/26/2023	Abhishek Sunil			Reverted MANSFIELD branch to PRIME MIDWAY branch
-- 05/04/2023   Deepen Gajjar           Modified office name logic	
-- 05/29/2023	Shikhar Saxena			Changed the logic to add SOURCE_SYSTEM_TYPE field		
-- 11/28/2023   Deeepn Gajjar           Leveraging BRANCHINFO table as dimension(master) data for branch													  
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.AXXESS_DIM_BRANCH 
WITH BRANCH_INFO AS (
SELECT ''14''AS SOURCE_SYSTEM_ID, ''HC'' AS SERVICE_LINE,*
FROM DISC_PROD.AXXESS.AXXESS_hC_BRANCHINFO 
UNION 
SELECT ''14''AS SOURCE_SYSTEM_ID, ''HH'' AS SERVICE_LINE,*
FROM DISC_PROD.AXXESS.AXXESS_hh_BRANCHINFO 
)
SELECT 
MD5(''PRIME'' || ''-'' || IFNULL(UPPER(TRIM(BI.BRANCH_ID)),''UNKNOWN'') || ''-'' || ''AXXESS'') AS BRANCH_KEY,
UPPER(NAME) BRANCH_NAME,
''PRIME'' AS SYSTEM_CODE,
''14'' AS SOURCE_SYSTEM_ID,
SOURCE_SYSTEM.SOURCE_SYSTEM_TYPE ,
NVL(OFFICES.OFFICE_CODE,-1) AS OFFICE_NUMBER, 
NVL(OFFICES.OFFICE_CODE,-1) AS OFFICE_CODE,
UPPER(NAME) AS OFFICE_NAME,
UPPER(LOCATION_NAME) AS OFFICE_NAME_ALT,
UPPER(NAME) AS DEPARTMENT_NAME,
SERVICE_LINE AS BRANCH_SERVICE_LINE,
TRUE AS PARENT_FLAG,
MD5(''PRIME'' || ''-'' || IFNULL(UPPER(TRIM(BI.BRANCH_ID)),''UNKNOWN'') || ''-'' || ''AXXESS'') AS PARENT_BRANCH_KEY,
NVL(OFFICES.OFFICE_CODE,-1)  AS PARENT_OFFICE_NUMBER,
NVL(OFFICES.OFFICE_CODE,-1) AS PARENT_OFFICE_CODE,
LOCATION_ADDRESS_STATE_CODE||'' - ''||UPPER("NAME")|| '' ('' || NVL(OFFICES.OFFICE_CODE,-1) || '')'' PARENT_BRANCH_NAME,
LOCATION_ADDRESS_LINE1 AS OFFICE_ADDRESS1 ,
LOCATION_ADDRESS_LINE2 AS OFFICE_ADDRESS2,
LOCATION_ADDRESS_CITY_NAME AS OFFICE_CITY,
LOCATION_ADDRESS_STATE_CODE AS OFFICE_STATE_CODE,
LOCATION_ADDRESS_ZIP_CODE AS OFFICE_ZIP,
PRIMARY_PHONE_NUMBER AS OFFICE_PHONE,
NULL AS OFFICE_TOLL_FREE_PHONE,
FAX_NUMBER AS OFFICE_FAX,
LOCATION_ADDRESS_STATE_CODE||'' - ''||UPPER("NAME") || '' ('' || NVL(OFFICES.OFFICE_CODE,-1) || '')'' DETAILED_OFFICE_NAME,
NULL AS REGION_NUMBER,
NULL AS REGION_NAME,
NULL AS REGION_MANAGER,
NULL AS REGION_MANAGER_EMPLOYEE_KEY,
NULL AS SUBREGION_NAME,
NULL AS PRIMARY_BRANCH_MANAGER_NAME,
NULL AS PRIMARY_BRANCH_EMAIL,
NULL AS PRIMARY_BRANCH_MANAGER_EMPLOYEE_KEY,
NULL AS SECONDARY_BRANCH_MANAGER_NAME,
NULL AS SECONDARY_BRANCH_EMAIL,
NULL AS SECONDARY_BRANCH_MANAGER_EMPLOYEE_KEY,
NULL AS RISKCONNECT_NODE_KEY,
NULL AS RISKCONNECT_NAME,
NULL AS HR_OFFICE_NUMBER,
NULL AS HR_OFFICE_NAME,
TRUE ACTIVE_FLAG,
TO_DATE(''1900-01-01'',''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE,
TO_DATE(''9999-12-31'',''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
:STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE,
CURRENT_USER AS ETL_INSERTED_BY ,
CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE,
CURRENT_USER AS ETL_LAST_UPDATED_BY,
0 AS ETL_DELETED_FLAG,
0 AS ETL_INFERRED_MEMBER_FLAG
FROM BRANCH_INFO BI
LEFT JOIN DISC_PROD.AXXESS.AXXESS_BRANCH_OFFICE_MAPPING OFFICES ON BI.BRANCH_ID  = OFFICES.BRANCH_ID 
LEFT JOIN HAH.DIM_SOURCE_SYSTEM AS SOURCE_SYSTEM ON BI.SOURCE_SYSTEM_ID = SOURCE_SYSTEM.SOURCE_SYSTEM_ID
;
	RETURN ''SUCCESS'';
end;                        
';