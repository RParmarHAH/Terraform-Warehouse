CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_EDISON_FACT_ADMISSION("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN
--*****************************************************************************************************************************
-- NAME:  EDISON FACT ADMISSION
--
-- PURPOSE: Populates Stage EDISON FACT ADMISSION
--
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 3/07/23     Pankti Fadia           Initial version
--*****************************************************************************************************************************
INSERT OVERWRITE INTO DW_PROD."STAGE".EDISON_FACT_ADMISSION

with CLIENT AS
(
    SELECT * FROM
	(
        SELECT MD5((AGENCYID||''-''||MASTER_ID||''-''||''EDISON'' )) as CLIENT_KEY,
		PATIENTID, MASTER_ID, AGENCYID, LASTNAME, FIRSTNAME, OFFICEID --,ADMISSIONID --,OFFICEID
        FROM DISC_DEDUPE_PROD.HHAEXCHANGEEDISON.CLIENT_MASTER_LIST
    )
    UNION
    SELECT * FROM
    (
        SELECT DISTINCT MD5((AGENCYID||''-''||MASTER_ID||''-''||''EDISON'' )) as CLIENT_KEY,
		PATIENTID, MASTER_ID, AGENCYID, LASTNAME, FIRSTNAME, OFFICEID --,ADMISSIONID --,OFFICEID
        FROM DISC_DEDUPE_PROD.HHAEXCHANGEEDISON.CLIENT_MATCH_LIST
        WHERE PATIENTID NOT IN (SELECT PATIENTID FROM DISC_DEDUPE_PROD.HHAEXCHANGEEDISON.CLIENT_MASTER_LIST)
    )
),
REFERRAL AS (
	SELECT * FROM (select ROW_NUMBER() OVER (PARTITION BY UPPER(FIRSTNAME),UPPER(LASTNAME) ORDER BY REF.REFERRALID DESC) AS ROW_NUM,
            REF.*from DISC_PROD.HHAEXCHANGEEDISON.REFERRAL REF WHERE REFERRALSTATUS != ''Lost'') WHERE  ROW_NUM=1
     ),	
ADMISSIONS_DATE AS(
	SELECT * FROM (SELECT ROW_NUMBER () OVER(PARTITION BY PAT.PATIENTID  ORDER BY PAT.SERVICESTARTDATE  DESC) AS RN,
			* FROM DISC_PROD.HHAEXCHANGEEDISON.PATIENTS PAT) WHERE RN=1
	),
COORDINATORS AS(
SELECT * FROM (SELECT ROW_NUMBER () OVER(PARTITION BY TC.COORDINATORNAME ORDER BY TC.COORDINATORID  DESC) AS RN,
			* FROM DISC_PROD.HHAEXCHANGEEDISON.TBLCOORDINATOR_REPL TC) WHERE RN=1
),
VISITS AS (
    SELECT * FROM ( SELECT V.PATIENTID,VI.PRIMARYSERVICECODEID AS SERVICECODEID FROM  DISC_PROD.HHAEXCHANGEEDISON.VISITS V 
	LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.VISITINFO_REPL VI ON VI.VISITID = V.VISITID
	LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.TBLVISITS_REPL TBLV ON TBLV.VISITID = VI.VISITID
	UNION ALL 
	SELECT PA.PATIENTID,SERVICECODEID FROM  DISC_PROD.HHAEXCHANGEEDISON.PATIENTAUTHORIZATION  PA)
 GROUP BY 1,2
    )
SELECT DISTINCT 
MD5(''EDISON'' || ''-'' || CLIENT.PATIENTID || ''-'' || PAT.ADMISSIONID || ''-'' || nvl(REV.REVENUE_SUBCATEGORY_CODE,''UNKNOWN'')|| ''-'' || NVL(S.SERVICECODEID,-1) || ''-'' || ''EDISON'') AS CLIENT_ADMISSION_KEY
	, ''17''  AS SOURCE_SYSTEM_ID
    , ''EDISON'' AS SYSTEM_CODE
    --, MD5(''EDISON'' || ''-'' || CLIENT.PATIENTID || ''-'' || ''EDISON'') AS CLIENT_KEY
      ,DC.CLIENT_KEY AS CLIENT_KEY
    , MD5(''EDISON'' || ''-'' || REFS.REFERRALSOURCEID || ''-'' || ''EDISON'') AS REFERRER_KEY
    --, MD5(''EDISON'' || ''-'' || S.SERVICECODE || ''-'' || ''EDISON'') AS SERVICE_KEY
    ,MD5(''EDISON'' || ''-'' || S.SERVICECODEID || ''-'' ||NVL(REV.REVENUE_SUBCATEGORY_CODE,''UNKNOWN'')|| ''-'' || ''EDISON'') AS SERVICE_KEY
    , MD5(''EDISON'' || ''-'' ||  NVL(PR.PAYERID,-1) || ''-'' || COALESCE(PR.CONTRACTID,PR.PAYERID,S.CONTRACTID) || ''-'' || ''HHAEXCHANGE'') AS PARTNER_CONTRACT_KEY
    , MD5(''EDISON'' || ''-'' || IFNULL((REFD.AGENCYID), -1) || ''-'' || IFNULL(REFD.REFERRALDIAGNOSISID, -1) || ''EDISON'') AS PRIMARY_DIAGNOSIS_KEY
    , COALESCE(RFS.SUBMITTEDDATE, PAT.REFERRALRECEIVEDDATE,R.DATEOFBIRTH) AS REFERRAL_DATE
    , MD5(''EDISON'' || ''-'' || TC.COORDINATORID || ''-'' || ''EDISON'') AS REFERRAL_INTAKE_BY_EMP_KEY
    , REF.ACCEPTEDSERVICES AS REFERRAL_ACCEPTED_SERVICES
    , IFNULL(REFS.REFERRALSOURCETYPE, ''UNKNOWN'') AS REFERRAL_CAMPAIGN
    , NULL  AS PREVIOUS_PROVIDER
    , ADM.SERVICESTARTDATE AS ADMISSION_DATE
    , CASE WHEN PAT.STATUSID = ''01'' THEN ''Waiting''
		   WHEN PAT.STATUSID = ''02'' THEN ''Pending''
		   WHEN PAT.STATUSID = ''03'' THEN ''Active''
		   WHEN PAT.STATUSID = ''04'' THEN ''Hospitalized''
           WHEN PAT.STATUSID = ''05'' THEN ''Discharged''
           WHEN PAT.STATUSID = ''06'' THEN ''Partially Placed''
           WHEN PAT.STATUSID = ''07'' THEN ''ROC''
           WHEN PAT.STATUSID = ''08'' THEN ''Hold''
      ELSE NULL END AS STATUS
    , IFNULL(REFD.CODE, ''UNKNOWN'') AS PRIMARY_DIAGNOSIS
    , IFNULL(REFD.DESCRIPTION, ''UNKNOWN'') AS DIAGNOSIS_NOTES
    , PCR.DISCHARGEDATE AS DISCHARGE_DATE
    , ifnull(PCC.DISCHARGEREASONTEXT, ''UNKNOWN'') AS DISCHARGE_REASON
    , :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE
    , CURRENT_USER as ETL_INSERTED_BY
    , convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE
    , CURRENT_USER  as ETL_LAST_UPDATED_BY
    , 0 as ETL_DELETED_FLAG
FROM CLIENT
INNER JOIN HAH.DIM_CLIENT DC
--   ON DC.CLIENT_NUMBER = CLIENT.MASTER_ID -- change has made on 6 April, 2023.
--   ON DC.CLIENT_NUMBER = RIGHT(CLIENT.MASTER_ID,LEN(CLIENT.MASTER_ID)-3) -- change has made on 11 April, 2023.
	ON DC.CLIENT_KEY = CLIENT.CLIENT_KEY
        AND DC.SYSTEM_CODE = ''EDISON''
LEFT JOIN VISITS V ON V.PATIENTID = CLIENT.PATIENTID
LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.SERVICECODES S ON S.SERVICECODEID = V.SERVICECODEID
LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.VW_EDISON_REVENUE_SEG REV ON REV.SERVICECODEID  = S.SERVICECODEID
LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.CONTRACTS C ON S.CONTRACTID = C.CONTRACTID
LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.CONTRACTRATES CR 
ON  S.SERVICECODEID  = CR.SERVICECODEID 
	AND CR.TODATE :: DATE > GETDATE()
	AND CR.FROMDATE :: DATE <= GETDATE()
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.PATIENTS PAT ON PAT.PATIENTID = CLIENT.PATIENTID
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.PATIENTCONTRACTS_REPL PCR
                   ON PCR.CONTRACTID = C.CONTRACTID AND PCR.PATIENTID = CLIENT.PATIENTID AND PCR.DELETED = ''false''
        LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.PAYER_REPL PR 
ON IFNULL(PR.CONTRACTID,PR.PAYERID) = S.CONTRACTID  
                   LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.PATIENTCONTRACTCHANGES PCC
                   ON PCC.PATIENTID = PCR.PATIENTID and pcc.contractid = pcr.contractid
                   LEFT JOIN ADMISSIONS_DATE AS ADM ON ADM.PATIENTID = PAT.PATIENTID
    //REFERRALS
         LEFT JOIN REFERRAL REF
                   ON UPPER(CLIENT.FIRSTNAME) = UPPER(REF.FIRSTNAME) AND UPPER(CLIENT.LASTNAME) = UPPER(REF.LASTNAME)
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.REFERRALSOURCE REFS ON REFS.NAME = REF.REFERRALSOURCE
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.REFERRALSUBMISSIONS RFS ON RFS.REFERRALID = REF.REFERRALID
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.REFERRALPHYSICIANS REFPHY ON REFPHY.REFERRALID = REF.REFERRALID
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.REFERRALDIAGNOSIS REFD ON REFD.REFERRALID = REF.REFERRALID
         LEFT JOIN DISC_PROD.HHAEXCHANGEEDISON.REFERRAL  R ON PAT.ADMISSIONID = R.ADMISSIONID 
         LEFT JOIN COORDINATORS TC ON 
		TRIM(COALESCE(R.COORDINATOR_1,R.COORDINATOR_2,R.COORDINATOR_3)) =TRIM(TC.COORDINATORNAME)
WHERE pat.agencyid = 155;

RETURN ''SUCCESS'';
end;
';