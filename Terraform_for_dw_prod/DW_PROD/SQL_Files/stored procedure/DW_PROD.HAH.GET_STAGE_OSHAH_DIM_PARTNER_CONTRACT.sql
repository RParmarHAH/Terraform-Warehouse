CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_OSHAH_DIM_PARTNER_CONTRACT("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN
    --*****************************************************************************************************************************
-- NAME:  OSHAH_DIM_PARTNER_CONTRACT
--
-- PURPOSE: Creates one row per PARTNER according to OSHAH 
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 03/22/23     SANKET JAIN          Initial development
-- 07/07/23     Sandesh Gosavi       update code to use config flag
-- 08/17/23     Mirisha              Updated logic for MS
--*****************************************************************************************************************************

INSERT OVERWRITE INTO STAGE.OSHAH_DIM_PARTNER_CONTRACT
WITH STATES AS 
(
SELECT DISTINCT S.SERVICECODEID , C.STATE  FROM DISC_PROD.HHAEXCHANGEOSHAH.SERVICECODES S			-- FOR linked contracts WITH linkedid
JOIN DISC_PROD.HHAEXCHANGEOSHAH.CONTRACTS C	
ON  S.CONTRACTID = C.LINKEDCONTRACTPAYERID															-- NOT joining WITH payer AND THEN payeroffice AS one linked contractid will have multiple contracts, AND thus multilpe payors, which further would have multiple offices per payer (state can be one or more.)
JOIN DISC_PROD.HHAEXCHANGEOSHAH.PAYER_REPL PR ON IFNULL(PR.CONTRACTID,PR.PAYERID) = C.ContractID
) 
, PARTNER AS 
(
	SELECT DISTINCT MD5(''OSHAH'' || ''-'' ||  NVL(PR.PAYERID,-1) || ''-'' || COALESCE(PR.CONTRACTID,PR.PAYERID) || ''-'' || ''HHAEXCHANGE'') AS PARTNER_CONTRACT_KEY
		, 17 AS SOURCE_SYSTEM_ID
		/*, CONCAT(''OSHAH - '',CASE WHEN STATE=''DE'' OR PAYERNAME ILIKE ANY (''%DE'',''%DC Medicaid%'',''%Highmark Health Options%'') THEN ''DE''  
								 ELSE ''PA'' END) AS SYSTEM_CODE*/
		, CONCAT(''OSHAH - '',  nvl(off.STATE,PR.STATE)) AS SYSTEM_CODE
        , nvl(off.STATE,PR.STATE) AS STATE
		, MD5(''OSHAH'' || ''-'' || PR.PAYERID || ''-'' || ''HHAEXCHANGE'') AS PARTNER_KEY                                                                                     
		, COALESCE(PR.PAYERID,PR.CONTRACTID)  AS PARTNER_CODE
		, PR.PAYERNAME AS PARTNER_NAME 
		, COALESCE(PR.CONTRACTID,PR.PAYERID) AS CONTRACT_CODE
		, PR.PAYERNAME AS CONTRACT_NAME
		, PR.STATUS  AS ACTIVE_FLAG
		FROM DISC_PROD.HHAEXCHANGEOSHAH.PAYER_REPL PR
		LEFT JOIN DISC_PROD.HHAEXCHANGEOSHAH.PAYEROFFICES PO ON PR.PAYERID= PO.PAYERID 
		LEFT JOIN DISC_PROD.HHAEXCHANGEOSHAH.OFFICE_OFFICES_REPL OFF ON OFF.OFFICEID = PO.OFFICEID
		WHERE nvl(off.STATE,PR.STATE) IN  (SELECT STATE FROM DISC_PROD.HHAEXCHANGEOSHAH.CONFIGURATION WHERE CONFIG = TRUE)
)
--SELECT * FROM partner;
,ADDITIONAL_PARTNER AS 
(
	SELECT * FROM PARTNER
	UNION ALL
  	SELECT DISTINCT MD5(''OSHAH'' || ''-'' ||  S.CONTRACTID || ''-'' || S.CONTRACTID || ''-'' || ''HHAEXCHANGE'') AS PARTNER_CONTRACT_KEY
		, 17 AS SOURCE_SYSTEM_ID
		, CONCAT(''OSHAH - '', STATES.STATE) AS SYSTEM_CODE
        , STATES.STATE AS STATE
		, MD5(''OSHAH'' || ''-'' || S.CONTRACTID || ''-'' || ''HHAEXCHANGE'') AS PARTNER_KEY
		, S.CONTRACTID  AS PARTNER_CODE
--		, S.CONTRACTNAME AS PARTNER_NAME
		, CASE WHEN S.CONTRACTID IN (14475,20154,16999,17470) THEN regexp_replace(S.CONTRACTNAME,''.....$'','''') 
			   ELSE S.CONTRACTNAME END AS PARTNER_NAME      -- THIS LOGIC IS FROM DIM PARTNER AS NAME FOR CONTRACTID IS DIFFERENT IN DIM PARTNER
		, S.CONTRACTID AS CONTRACT_CODE
--		, S.CONTRACTNAME END AS CONTRACT_NAME
		, CASE WHEN S.CONTRACTID IN (14475,20154,16999,17470) THEN regexp_replace(S.CONTRACTNAME,''.....$'','''') 
			   ELSE S.CONTRACTNAME END AS CONTRACT_NAME		-- THIS LOGIC IS FROM DIM PARTNER AS NAME FOR CONTRACTID IS DIFFERENT IN DIM PARTNER
		, CASE WHEN S.STATUS =''Active'' THEN TRUE ELSE FALSE END AS ACTIVE_FLAG
	FROM DISC_PROD.HHAEXCHANGEOSHAH.SERVICECODES S 
	LEFT JOIN STATES ON STATES.SERVICECODEID  = S."SERVICECODEID" 
	WHERE 1=1
		AND STATES.STATE IN  (SELECT STATE FROM DISC_PROD.HHAEXCHANGEOSHAH.CONFIGURATION WHERE CONFIG = TRUE)
		AND PARTNER_KEY NOT IN 
							(SELECT PARTNER_KEY FROM PARTNER) 
		AND S.CONTRACTID NOT IN (SELECT NVL(CONTRACTID,0) FROM DISC_PROD.HHAEXCHANGEOSHAH.PAYER_REPL)
--	QUALIFY ROW_NUMBER() OVER (PARTITION BY PARTNER_CODE ORDER BY ACTIVE_FLAG desc ) = 1
)
--SELECT * FROM ADDITIONAL_PARTNER;
SELECT DISTINCT *
		, ''1990-01-01''::DATE AS START_DATE
		, ''9999-12-31''::DATE AS END_DATE 
		, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	 	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	    , Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
		, CURRENT_USER AS ETL_INSERTED_BY
		, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
		, CURRENT_USER AS ETL_LAST_UPDATED_BY
	 	, 0::BOOLEAN AS ETL_DELETED_FLAG
FROM ADDITIONAL_PARTNER;

return ''SUCCESS'';
END;
';