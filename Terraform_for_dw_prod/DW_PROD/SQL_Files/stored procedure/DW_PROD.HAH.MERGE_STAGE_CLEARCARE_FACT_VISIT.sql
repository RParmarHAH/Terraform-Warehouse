CREATE OR REPLACE PROCEDURE DW_PROD.HAH.MERGE_STAGE_CLEARCARE_FACT_VISIT()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN

		 
					



    MERGE INTO HAH.FACT_VISIT TGT 
	USING STAGE.CLEARCARE_FACT_VISIT STG 
	ON TGT.VISIT_KEY = STG.VISIT_KEY
WHEN MATCHED THEN 
UPDATE SET 
    TGT.REPORT_DATE= STG.REPORT_DATE
   ,TGT.BRANCH_KEY= STG.BRANCH_KEY
   ,TGT.CLIENT_KEY= STG.CLIENT_KEY
   ,TGT.CONTRACT_KEY= STG.CONTRACT_KEY
   ,TGT.SCHEDULED_EMPLOYEE_KEY= STG.SCHEDULED_EMPLOYEE_KEY
   ,TGT.EMPLOYEE_KEY= STG.EMPLOYEE_KEY
   ,TGT.SOURCE_SYSTEM_ID= STG.SOURCE_SYSTEM_ID
   ,TGT.SUPERVISOR_KEY= STG.SUPERVISOR_KEY
   ,TGT.INVOICE_KEY= STG.INVOICE_KEY
   ,TGT.PAYROLL_KEY= STG.PAYROLL_KEY
   ,TGT.CLIENT_SERVICE_KEY = STG.CLIENT_SERVICE_KEY
   ,TGT.PARTNER_CONTRACT_SERVICE_KEY = STG.PARTNER_CONTRACT_SERVICE_KEY
   ,TGT.BILLING_KEY = STG.BILLING_KEY
   ,TGT.SERVICE_DATE= STG.SERVICE_DATE
   ,TGT.PAYROLL_DATE= STG.PAYROLL_DATE
   ,TGT.BRANCH_NAME= STG.BRANCH_NAME
   ,TGT.CLIENT_NUMBER= STG.CLIENT_NUMBER
   ,TGT.CONTRACT_CODE= STG.CONTRACT_CODE
   ,TGT.SCHEDULED_EMPLOYEE_ID= STG.SCHEDULED_EMPLOYEE_ID
   ,TGT.EMPLOYEE_ID= STG.EMPLOYEE_ID
   ,TGT.SYSTEM_CODE= STG.SYSTEM_CODE
   ,TGT.SUPERVISOR_CODE= STG.SUPERVISOR_CODE
   ,TGT.INVOICE_ID= STG.INVOICE_ID
   ,TGT.CHEQUE_NUMBER= STG.CHEQUE_NUMBER
   ,TGT.CLEAN_SHIFT_FLAG= STG.CLEAN_SHIFT_FLAG
   ,TGT.SCHEDULE_STATUS_CODE= STG.SCHEDULE_STATUS_CODE
   ,TGT.SCHEDULE_STATUS_NAME= STG.SCHEDULE_STATUS_NAME
   ,TGT.SCHEDULE_STATUS_DESCRIPTION= STG.SCHEDULE_STATUS_DESCRIPTION
   ,TGT.VISIT_STATUS_CODE= STG.VISIT_STATUS_CODE
   ,TGT.VISIT_STATUS_NAME= STG.VISIT_STATUS_NAME
   ,TGT.VISIT_STATUS_DESCRIPTION= STG.VISIT_STATUS_DESCRIPTION
   ,TGT.INVOICE_STATUS_CODE= STG.INVOICE_STATUS_CODE
   ,TGT.INVOICE_STATUS_NAME= STG.INVOICE_STATUS_NAME
   ,TGT.INVOICE_STATUS_DESCRIPTION= STG.INVOICE_STATUS_DESCRIPTION
   ,TGT.PAYROLL_STATUS_CODE= STG.PAYROLL_STATUS_CODE
   ,TGT.PAYROLL_STATUS_NAME= STG.PAYROLL_STATUS_NAME
   ,TGT.PAYROLL_STATUS_DESCRIPTION= STG.PAYROLL_STATUS_DESCRIPTION
   ,TGT.CANCEL_REASON_CODE= STG.CANCEL_REASON_CODE
   ,TGT.CANCEL_REASON_DESCRIPTION= STG.CANCEL_REASON_DESCRIPTION
   ,TGT.CANCEL_REASON_NOTES= STG.CANCEL_REASON_NOTES
   ,TGT.EXCEPTION_REASON_INDICATOR= STG.EXCEPTION_REASON_INDICATOR
   ,TGT.RESOLUTION_CODE= STG.RESOLUTION_CODE
   ,TGT.RESOLUTION_DESCRIPTION= STG.RESOLUTION_DESCRIPTION
   ,TGT.REJECTION_CODE= STG.REJECTION_CODE
   ,TGT.REJECTION_DESCRIPTION= STG.REJECTION_DESCRIPTION
   ,TGT.BILL_CODE= STG.BILL_CODE
   ,TGT.BILL_RATE= STG.BILL_RATE
   ,TGT.BILL_UNITS_SERVED= STG.BILL_UNITS_SERVED
   ,TGT.BILL_UNIT_TYPE= STG.BILL_UNIT_TYPE
   ,TGT.OVERHEAD_RATE= STG.OVERHEAD_RATE
   ,TGT.SCHEDULE_TIMEIN= STG.SCHEDULE_TIMEIN
   ,TGT.SCHEDULE_TIMEOUT= STG.SCHEDULE_TIMEOUT
   ,TGT.SCHEDULE_DURATION= STG.SCHEDULE_DURATION
   ,TGT.ACTUAL_TIMEIN= STG.ACTUAL_TIMEIN
   ,TGT.ACTUAL_TIMEOUT= STG.ACTUAL_TIMEOUT
   ,TGT.ACTUAL_DURATION= STG.ACTUAL_DURATION
   ,TGT.ADJUSTED_TIMEIN= STG.ADJUSTED_TIMEIN
   ,TGT.ADJUSTED_TIMEOUT= STG.ADJUSTED_TIMEOUT
   ,TGT.ADJUSTED_DURATION= STG.ADJUSTED_DURATION
   ,TGT.HOURS_SERVED= STG.HOURS_SERVED
   ,TGT.COMMENTS= STG.COMMENTS
   ,TGT.IS_EVV_FLAG= STG.IS_EVV_FLAG
   ,TGT.TIMESHEET_TYPE= STG.TIMESHEET_TYPE
   ,TGT.TRACKING_ID= STG.TRACKING_ID
   ,TGT.ETL_TASK_KEY= STG.ETL_TASK_KEY
   ,TGT.ETL_INSERTED_TASK_KEY= STG.ETL_INSERTED_TASK_KEY
   ,TGT.ETL_INSERTED_DATE= STG.ETL_INSERTED_DATE
   ,TGT.ETL_INSERTED_BY= STG.ETL_INSERTED_BY
   ,TGT.ETL_LAST_UPDATED_DATE= STG.ETL_LAST_UPDATED_DATE
   ,TGT.ETL_LAST_UPDATED_BY= STG.ETL_LAST_UPDATED_BY
   ,TGT.ETL_DELETED_FLAG = STG.ETL_DELETED_FLAG
   ,TGT.CONFIRMED_FLAG= STG.CONFIRMED_FLAG
WHEN NOT MATCHED THEN 
INSERT ( 
    VISIT_KEY
   ,REPORT_DATE
   ,BRANCH_KEY
   ,CLIENT_KEY
   ,CONTRACT_KEY
   ,SCHEDULED_EMPLOYEE_KEY
   ,EMPLOYEE_KEY
   ,SOURCE_SYSTEM_ID
   ,SUPERVISOR_KEY
   ,INVOICE_KEY
   ,PAYROLL_KEY
   ,CLIENT_SERVICE_KEY
   ,PARTNER_CONTRACT_SERVICE_KEY
   ,BILLING_KEY
   ,SERVICE_DATE
   ,PAYROLL_DATE
   ,BRANCH_NAME
   ,CLIENT_NUMBER
   ,CONTRACT_CODE
   ,SCHEDULED_EMPLOYEE_ID
   ,EMPLOYEE_ID
   ,SYSTEM_CODE
   ,SUPERVISOR_CODE
   ,INVOICE_ID
   ,CHEQUE_NUMBER
   ,CLEAN_SHIFT_FLAG
   ,SCHEDULE_STATUS_CODE
   ,SCHEDULE_STATUS_NAME
   ,SCHEDULE_STATUS_DESCRIPTION
   ,VISIT_STATUS_CODE
   ,VISIT_STATUS_NAME
   ,VISIT_STATUS_DESCRIPTION
   ,INVOICE_STATUS_CODE
   ,INVOICE_STATUS_NAME
   ,INVOICE_STATUS_DESCRIPTION
   ,PAYROLL_STATUS_CODE
   ,PAYROLL_STATUS_NAME
   ,PAYROLL_STATUS_DESCRIPTION
   ,CANCEL_REASON_CODE
   ,CANCEL_REASON_DESCRIPTION
   ,CANCEL_REASON_NOTES
   ,EXCEPTION_REASON_INDICATOR
   ,RESOLUTION_CODE
   ,RESOLUTION_DESCRIPTION
   ,REJECTION_CODE
   ,REJECTION_DESCRIPTION
   ,BILL_CODE
   ,BILL_RATE
   ,BILL_UNITS_SERVED
   ,BILL_UNIT_TYPE
   ,OVERHEAD_RATE
   ,SCHEDULE_TIMEIN
   ,SCHEDULE_TIMEOUT
   ,SCHEDULE_DURATION
   ,ACTUAL_TIMEIN
   ,ACTUAL_TIMEOUT
   ,ACTUAL_DURATION
   ,ADJUSTED_TIMEIN
   ,ADJUSTED_TIMEOUT
   ,ADJUSTED_DURATION
   ,HOURS_SERVED
   ,COMMENTS
   ,IS_EVV_FLAG
   ,TIMESHEET_TYPE
   ,TRACKING_ID
   ,ETL_TASK_KEY
   ,ETL_INSERTED_TASK_KEY
   ,ETL_INSERTED_DATE
   ,ETL_INSERTED_BY
   ,ETL_LAST_UPDATED_DATE
   ,ETL_LAST_UPDATED_BY
   ,ETL_DELETED_FLAG
   ,CONFIRMED_FLAG
) 
VALUES (
    STG.VISIT_KEY
   ,STG.REPORT_DATE
   ,STG.BRANCH_KEY
   ,STG.CLIENT_KEY
   ,STG.CONTRACT_KEY
   ,STG.SCHEDULED_EMPLOYEE_KEY
   ,STG.EMPLOYEE_KEY
   ,STG.SOURCE_SYSTEM_ID
   ,STG.SUPERVISOR_KEY
   ,STG.INVOICE_KEY
   ,STG.PAYROLL_KEY
   ,STG.CLIENT_SERVICE_KEY
   ,STG.PARTNER_CONTRACT_SERVICE_KEY
   ,STG.BILLING_KEY
   ,STG.SERVICE_DATE
   ,STG.PAYROLL_DATE
   ,STG.BRANCH_NAME
   ,STG.CLIENT_NUMBER
   ,STG.CONTRACT_CODE
   ,STG.SCHEDULED_EMPLOYEE_ID
   ,STG.EMPLOYEE_ID
   ,STG.SYSTEM_CODE
   ,STG.SUPERVISOR_CODE
   ,STG.INVOICE_ID
   ,STG.CHEQUE_NUMBER
   ,STG.CLEAN_SHIFT_FLAG
   ,STG.SCHEDULE_STATUS_CODE
   ,STG.SCHEDULE_STATUS_NAME
   ,STG.SCHEDULE_STATUS_DESCRIPTION
   ,STG.VISIT_STATUS_CODE
   ,STG.VISIT_STATUS_NAME
   ,STG.VISIT_STATUS_DESCRIPTION
   ,STG.INVOICE_STATUS_CODE
   ,STG.INVOICE_STATUS_NAME
   ,STG.INVOICE_STATUS_DESCRIPTION
   ,STG.PAYROLL_STATUS_CODE
   ,STG.PAYROLL_STATUS_NAME
   ,STG.PAYROLL_STATUS_DESCRIPTION
   ,STG.CANCEL_REASON_CODE
   ,STG.CANCEL_REASON_DESCRIPTION
   ,STG.CANCEL_REASON_NOTES
   ,STG.EXCEPTION_REASON_INDICATOR
   ,STG.RESOLUTION_CODE
   ,STG.RESOLUTION_DESCRIPTION
   ,STG.REJECTION_CODE
   ,STG.REJECTION_DESCRIPTION
   ,STG.BILL_CODE
   ,STG.BILL_RATE
   ,STG.BILL_UNITS_SERVED
   ,STG.BILL_UNIT_TYPE
   ,STG.OVERHEAD_RATE
   ,STG.SCHEDULE_TIMEIN
   ,STG.SCHEDULE_TIMEOUT
   ,STG.SCHEDULE_DURATION
   ,STG.ACTUAL_TIMEIN
   ,STG.ACTUAL_TIMEOUT
   ,STG.ACTUAL_DURATION
   ,STG.ADJUSTED_TIMEIN
   ,STG.ADJUSTED_TIMEOUT
   ,STG.ADJUSTED_DURATION
   ,STG.HOURS_SERVED
   ,STG.COMMENTS
   ,STG.IS_EVV_FLAG
   ,STG.TIMESHEET_TYPE
   ,STG.TRACKING_ID
   ,STG.ETL_TASK_KEY
   ,STG.ETL_INSERTED_TASK_KEY
   ,STG.ETL_INSERTED_DATE
   ,STG.ETL_INSERTED_BY
   ,STG.ETL_LAST_UPDATED_DATE
   ,STG.ETL_LAST_UPDATED_BY
   ,STG.ETL_DELETED_FLAG
   ,STG.CONFIRMED_FLAG
);
SELECT CONCAT(''Message : '',"number of rows inserted", '' Rows Insrted & '' ,"number of rows updated",'' Rows Updated.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;
    ';