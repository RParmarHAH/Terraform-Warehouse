CREATE OR REPLACE PROCEDURE DW_PROD.INTEGRATION.FACT_BUDGET_MERGED_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN

    INSERT OVERWRITE INTO DW_PROD.INTEGRATION.FACT_BUDGET_MERGED  
	SELECT BUDGET.BUDGET_KEY,
		COALESCE(
			CASE BRANCH_MERGED.SOURCE_SYSTEM_ID 
				WHEN 1 THEN ''CostalSyncData''
				WHEN 2 THEN ''CostalSyncData''
				WHEN 3 THEN ''DataFlexSyncData''
				WHEN 4 THEN ''SandataImport''
				-- For completeness
				WHEN 5 THEN ''GpSyncData''
				WHEN 6 THEN ''TrustPointData''
				WHEN 7 THEN ''Matrixcare''
			END, BUDGET.SYSTEM_CODE) AS SYSTEM_CODE, 
		BUDGET.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		COALESCE(BRANCH_MERGED.SOURCE_SYSTEM_ID, BUDGET.SOURCE_SYSTEM_ID) AS SOURCE_SYSTEM_ID,
		BUDGET.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		BUDGET.CALENDAR_DATE,
		COALESCE(BRANCH_MERGED.BRANCH_KEY, BUDGET.BRANCH_KEY) AS BRANCH_KEY,
		BUDGET.BRANCH_KEY AS ORIGINAL_BRANCH_KEY,
		COALESCE(BRANCH_MERGED.OFFICE_STATE_CODE, BUDGET.STATE_CODE) AS STATE_CODE,
		COALESCE(BRANCH_MERGED.BRANCH_NAME, BUDGET.BRANCH_NAME) AS BRANCH_NAME,
		COALESCE(BRANCH_MERGED.OFFICE_NUMBER, BUDGET.OFFICE_NUMBER) AS OFFICE_NUMBER,
		COALESCE(BRANCH_MERGED.OFFICE_CODE, BUDGET.OFFICE_CODE) AS OFFICE_NUMBER,
		BUDGET.SERVICE_LINE_CODE,
		BUDGET.YEAR_MONTH,	
		BUDGET.CLIENT_COUNT_BUDGETED_DAILY,
		BUDGET.CLIENT_COUNT_BUDGETED_MONTHLY,
		BUDGET.CLIENT_COUNT_BUDGETED_MONTHLY_ROLLING_TOTAL,
		BUDGET.HOURS_BUDGETED_DAILY,
		BUDGET.HOURS_BUDGETED_MONTHLY,
		BUDGET.HOURS_BUDGETED_MONTHLY_ROLLING_TOTAL,
		BUDGET.REVENUE_BUDGETED_DAILY,
		BUDGET.REVENUE_BUDGETED_MONTHLY,
		BUDGET.REVENUE_BUDGETED_MONTHLY_ROLLING_TOTAL,		
		BUDGET.ETL_TASK_KEY,
		BUDGET.ETL_INSERTED_TASK_KEY,
		BUDGET.ETL_INSERTED_DATE,
		BUDGET.ETL_INSERTED_BY,
		BUDGET.ETL_LAST_UPDATED_DATE,
		BUDGET.ETL_LAST_UPDATED_BY,
		BUDGET.ETL_DELETED_FLAG,
		BUDGET.CAREGIVER_COUNT_BUDGETED_DAILY,
		BUDGET.CAREGIVER_COUNT_BUDGETED_MONTHLY,
		BUDGET.CAREGIVER_COUNT_BUDGETED_MONTHLY_ROLLING_TOTAL
	FROM HAH.FACT_BUDGET AS BUDGET
	LEFT JOIN INTEGRATION.DIM_BRANCH_MERGED AS BRANCH_MERGED
		ON BRANCH_MERGED.ORIGINAL_BRANCH_KEY = BUDGET.BRANCH_KEY;

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

return return_result;
END;

';