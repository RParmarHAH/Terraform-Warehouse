CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_CLEARCARE_FACT_INTAKE_BKCP_06_10_23("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN
        --*****************************************************************************************************************************
-- NAME:  CLEARCARE FACT INTAKE
--
-- PURPOSE: 
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------        
-- 08/15/202    AYSHWARYA	           INITIAL DEVELOPMENT
--*****************************************************************************************************************************
--
INSERT OVERWRITE INTO STAGE.CLEARCARE_FACT_INTAKE_bkcp_06_10_23
WITH
CLIENTKEY 
AS
 (
	SELECT
		*
	FROM
		(
		SELECT
			PATIENT_ID,
			MASTER_ID,
			AGENCY_ID,
			LAST_NAME,
			FIRST_NAME
		FROM
			DISC_DEDUPE_PROD.CLEARCARE.CLIENT_MASTER_LIST 
	)
	UNION
	SELECT
		*
	FROM
		(
		SELECT
			DISTINCT PATIENT_ID,
			MASTER_ID,
			AGENCY_ID,
			LAST_NAME,
			FIRST_NAME
		FROM
			DISC_DEDUPE_PROD.CLEARCARE.CLIENT_MATCH_LIST
		WHERE
			PATIENT_ID NOT IN (
			SELECT
				PATIENT_ID
			FROM
				DISC_DEDUPE_PROD.CLEARCARE.CLIENT_MASTER_LIST ) 
	)
),
AUTHDATES
AS
(
SELECT 
MIN(START_DATE) AS LATESTAUTHBEGINDT,
MAX(END_DATE) AS LATESTAUTHENDDT,
MAX(START_DATE) AS REAUTHDT,
CLIENT_ID,
BILL_RATE_ID
FROM DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION
GROUP BY CLIENT_ID,BILL_RATE_ID
),
Auths
AS
( 
SELECT
	DISTINCT client_id,
	b.ID,
	initial_hours *( CASE
		WHEN Start_Date > first_day_of_month THEN datediff(week,
		Start_Date,
		Last_day_of_month)
		WHEN End_Date < last_day_of_month THEN datediff(week,
		first_day_of_month,
		End_Date)
		ELSE datediff(week,
		first_day_of_month,
		Last_day_of_month)
	END) AS hourspermonth,
	MONTH,
	YEAR ,
	start_date,
	end_date,
	initial_hours,
	first_day_of_month,
	B.AUTHORIZATION_ID,
	BR.AMOUNT,
	A.AGENCY_ID AS BRANCHID,
	A.NAME AS BRANCHNAME,
	BR.ID AS CONTRACTCODE,
	B.BILL_RATE_ID,
	B.SERVICE_ID
FROM
	hah.dim_date D
INNER JOIN DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION B ON
	d.calendar_date BETWEEN START_DATE AND END_DATE
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON
	BR.ID = B.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = B.CLIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION A ON A.ID = PA.LOCATION_ID
WHERE
	period = 1  -- Weekly
UNION
SELECT
	DISTINCT client_id,
	b.ID,
	initial_hours  AS hourspermonth,
	MONTH,
	YEAR ,
	start_date,
	end_date,
	initial_hours,
	first_day_of_month,
	B.AUTHORIZATION_ID,
	BR.AMOUNT,
	A.AGENCY_ID AS BRANCHID,
	A.NAME AS BRANCHNAME,
	BR.ID AS CONTRACTCODE,
	B.BILL_RATE_ID,
	B.SERVICE_ID
FROM
	hah.dim_date D
INNER JOIN DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION B ON
	d.calendar_date BETWEEN START_DATE AND END_DATE
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON
	BR.ID = B.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = B.CLIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION A ON A.ID = PA.LOCATION_ID
WHERE
	period = 2  -- Monthly
UNION
SELECT
	DISTINCT client_id,
	b.ID,
	Initial_Hours*(( CASE
		WHEN Start_Date > first_day_of_month THEN datediff(week,
		Start_Date,
		Last_day_of_month)
		WHEN End_Date < last_day_of_month THEN datediff(week,
		first_day_of_month,
		End_Date)
		ELSE datediff(week,
		first_day_of_month,
		Last_day_of_month)
	END)/2) AS hourspermonth,
	MONTH,
	YEAR ,
	start_date,
	end_date,
	initial_hours,
	first_day_of_month,
	B.AUTHORIZATION_ID,
	BR.AMOUNT,
	A.AGENCY_ID AS BRANCHID,
	A.NAME AS BRANCHNAME,
	BR.ID AS CONTRACTCODE,
	B.BILL_RATE_ID,
	B.SERVICE_ID
FROM
	hah.dim_date D
INNER JOIN DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION B ON
	d.calendar_date BETWEEN START_DATE AND END_DATE
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON
	BR.ID = B.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = B.CLIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION A ON A.ID = PA.LOCATION_ID
WHERE
	period = 3   --- Every 2 weeks
UNION
SELECT
	DISTINCT client_id,
	b.ID,
	CASE WHEN initial_hours > 24 THEN 24 * ( CASE
		WHEN Start_Date > first_day_of_month THEN datediff(day,dateadd(day,-1,START_date),Last_day_of_month)
		WHEN End_Date < last_day_of_month THEN datediff(day,Previous_month_last_day,End_Date)
		ELSE datediff(day,Previous_month_last_day,Last_day_of_month) END) 
		ELSE initial_hours * ( CASE
		WHEN Start_Date > first_day_of_month THEN datediff(day,dateadd(day,-1,START_date),Last_day_of_month)
		WHEN End_Date < last_day_of_month THEN datediff(day,Previous_month_last_day,End_Date)
		ELSE datediff(day,Previous_month_last_day,Last_day_of_month) END) END  AS hourspermonth,
	MONTH,
	YEAR ,
	start_date,
	end_date,
	initial_hours,
	first_day_of_month,
	B.AUTHORIZATION_ID,
	BR.AMOUNT,
	A.AGENCY_ID AS BRANCHID,
	A.NAME AS BRANCHNAME,
	BR.ID AS CONTRACTCODE,
	B.BILL_RATE_ID,
	B.SERVICE_ID
FROM
	hah.dim_date D
INNER JOIN DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION B ON
	d.calendar_date BETWEEN START_DATE AND END_DATE
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON
	BR.ID = B.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = B.CLIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION A ON A.ID = PA.LOCATION_ID
WHERE
	period = 4 --Daily hours
UNION
SELECT
	DISTINCT client_id,
	b.ID,
	initial_hours /Datediff( MONTH,DATEADD(D,-1,START_DATE),END_DATE)   AS hourspermonth,
	MONTH,
	YEAR ,
	start_date,
	end_date,
	initial_hours,
	first_day_of_month,
	B.AUTHORIZATION_ID,
	BR.AMOUNT,
	A.AGENCY_ID AS BRANCHID,
	A.NAME AS BRANCHNAME,
	BR.ID AS CONTRACTCODE,
	B.BILL_RATE_ID,
	B.SERVICE_ID
FROM
	hah.dim_date D
INNER JOIN DISC_PROD.CLEARCARE.BILLING_CLIENTAUTHORIZATION B ON
	d.calendar_date BETWEEN START_DATE AND END_DATE
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON
	BR.ID = B.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = B.CLIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION A ON A.ID = PA.LOCATION_ID
WHERE
	period IN( 5,6) -- Yearly and Per Authorization
)
	SELECT DISTINCT
	MD5( A.CLIENT_ID || ''-'' || A.AUTHORIZATION_ID || ''-'' || C.AGENCY_ID|| ''-''|| ''CLEARCARE''||''-''|| A.ID || ''- '' || A.FIRST_DAY_OF_MONTH) AS INTAKE_KEY,
	A.FIRST_DAY_OF_MONTH AS REPORT_DATE,
	MD5( AG.AGENCY_ID || ''-'' || AG.NAME || ''-'' || ''CLEARCARE'') AS BRANCH_KEY,
	MD5((''CLEARCARE'' ||''-''||C.MASTER_ID||''-''|| ''CLEARCARE'' )) AS CLIENT_KEY,
	MD5(''CLEARCARE'' || ''-'' || BR.NAME || ''-'' || BR.TYPE || ''-'' || NVL(PP.SERVICE_NAME,''-1'') || ''-'' || ''CLEARCARE'' ) AS CONTRACT_KEY,
 	16 AS SOURCE_SYSTEM_ID,
    REAUTHDT AS REAUTHORIZED_DATE,
	A.AUTHORIZATION_ID AS PRE_AUTH_NUMBER,
	LATESTAUTHBEGINDT AS BEGIN_SERVICE_DATE,
	LATESTAUTHENDDT AS END_SERVICE_DATE,
	A.START_DATE AS LATEST_AUTH_BEGIN_DATE,
	A.END_DATE AS LATEST_AUTH_END_DATE,
	UPPER(BRANCHNAME) AS BRANCH_NAME,
	C.PATIENT_ID AS CLIENT_NUMBER,
	BR.NAME AS CONTRACT_CODE,
	A.AMOUNT AS BILL_RATE,
	''CLEARCARE'' AS SYSTEM_CODE,
	NULL AS CASE_MANAGER,
	hourspermonth AS HOURS_AUTHORIZED_NUMBER,
 	INITIAL_HOURS AS HOURS_AUTHORIZED_NON_ADJUSTED,
	  
    :STR_ETL_TASK_KEY AS ETL_TASK_KEY,
        :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
                        
   CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE,
   CURRENT_USER AS ETL_INSERTED_BY ,
   CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_UPDATED_DATE,
   CURRENT_USER AS ETL_LAST_UPDATED_BY,
   0 AS ETL_DELETED_FLAG
FROM AUTHS A
INNER JOIN CLIENTKEY C ON C.PATIENT_ID = A.CLIENT_ID
INNER JOIN DISC_PROD.CLEARCARE.BILLING_BILLRATE BR ON BR.ID = A.BILL_RATE_ID
INNER JOIN AUTHDATES AD ON AD.CLIENT_ID = A.CLIENT_ID AND AD.BILL_RATE_ID = A.BILL_RATE_ID
LEFT JOIN DISC_PROD.CLEARCARE.PROFILE_PARENTPAYERSERVICE PP ON PP.id = A.SERVICE_ID
LEFT JOIN DISC_PROD.CLEARCARE.BILLING_ITEM IT ON IT.AUTHORIZATION_ID = A.ID
LEFT JOIN DISC_PROD.CLEARCARE.PATIENT_PATIENT PA ON PA.ID = C.PATIENT_ID
LEFT JOIN DISC_PROD.CLEARCARE.AGENCY_AGENCYLOCATION AG ON AG.ID = PA.LOCATION_ID
WHERE A.BRANCHID IN (2459);
;
    SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

    return return_result;
END;
    ';