CREATE OR REPLACE PROCEDURE DW_PROD.INTEGRATION.DIM_PARTNER_CONTRACT_MERGED_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
  RETURN_RESULT VARCHAR(1000);
BEGIN
--*****************************************************************************************************************************
-- NAME:  DIM_PARTNER_CONTRACT_MERGED_POSTPROCESSING
--
-- PURPOSE: To Merge Partners from AMS and UI. Originals are AMS attributes and other are UI attributes.
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 02/01/24	   Shraddha Sejpal       Initial development
--*****************************************************************************************************************************

INSERT OVERWRITE INTO DW_PROD.INTEGRATION.DIM_PARTNER_CONTRACT_MERGED
SELECT PC1.PARTNER_CONTRACT_KEY AS ORIGINAL_PARTNER_CONTRACT_KEY ,
	PC1.PARTNER_KEY AS ORIGINAL_PARTNER_KEY ,
	--P.PARENT_PARTNER_KEY ,
	--P.PARENT_PARTNER_NAME ,
	PC1.PARTNER_CODE AS ORIGINAL_PARTNER_CODE ,
	PC1.PARTNER_NAME AS ORIGINAL_PARTNER_NAME ,
	PC1.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
	PC1.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE ,
	COALESCE(PC2.PARTNER_CONTRACT_KEY, PC1.PARTNER_CONTRACT_KEY) AS PARTNER_CONTRACT_KEY,
	PC2.SOURCE_SYSTEM_ID ,
	PC2.SYSTEM_CODE ,
	PC1.STATE ,
	COALESCE(PC2.PARTNER_KEY, PC1.PARTNER_KEY) AS PARTNER_KEY ,
	COALESCE(PC2.PARTNER_CODE, PC1.PARTNER_CODE) AS PARTNER_CODE ,
	COALESCE(PC2.PARTNER_NAME, PC1.PARTNER_NAME) AS PARTNER_NAME ,
	PC1.CONTRACT_CODE ,
	PC1.CONTRACT_NAME ,
	PC1.ACTIVE_FLAG ,
	PC1.START_DATE ,
	PC1.END_DATE 
	, :STR_ETL_TASK_KEY AS ETL_TASK_KEY
	, :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_INSERTED_DATE
	, CURRENT_USER AS ETL_INSERTED_BY
	, Convert_timezone(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ AS ETL_LAST_UPDATED_DATE
	, CURRENT_USER AS ETL_LAST_UPDATED_BY
	, 0 AS ETL_DELETED_FLAG
FROM HAH.DIM_PARTNER_CONTRACT PC1
LEFT JOIN HAH.DIM_PARTNER_CONTRACT PC2 ON 
PC1.SYSTEM_CODE = PC2.ORIGINAL_SYSTEM_CODE AND UPPER(TRIM(PC1.CONTRACT_CODE)) = UPPER(TRIM(PC2.CONTRACT_CODE)) 
AND UPPER(TRIM(PC1.CONTRACT_NAME)) = UPPER(TRIM(PC2.CONTRACT_NAME)) AND PC1.STATE = PC2.STATE
--LEFT JOIN HAH.DIM_PARTNER P ON PC2.PARTNER_KEY = P.PARTNER_KEY --(TO GET PARENT_PARTNER)
WHERE PC1.SOURCE_SYSTEM_ID NOT IN (28,29);
SELECT CONCAT (''MESSAGE : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
	RETURN return_result;
    END;
    ';