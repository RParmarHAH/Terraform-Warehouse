CREATE OR REPLACE PROCEDURE DW_PROD.REPORT.GET_REPORT_UTILIZATION_2_0("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
 return_result VARCHAR;
BEGIN
	 --*****************************************************************************************************************************
-- NAME:  UTILIZATION_2_0
--
-- PURPOSE: Creates derived monthly metrics for each client based on visit/service data
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------        
-- 		    				         Initial development
-- 11/09/22    Saurav Purohit        Reworked logic to include non-confirmed visits as well and added fields for New Scheduled metrics
-- 17/11/22    Hasnain Motagamwala   Added field NPS by joining HAH.FACT_NPS based on CLIENT_KEY, PERIOD_BEGIN_DATE.
-- 03/20/23	   Shraddha Sejpal		 DW 2.0 changes (replaced FACT_INTAKE with FACT_CLIENT_SERVICE and DIM_CONTRACT with FACT_PARTNER_CONTRACT_SERVICE)       
-- 03/23/23    Sanket Jain           Added updated New Scheduled Metrics,Partner_Code and Service_code  
-- 05/22/23    Nutan Jagnade         Added future_hours_no_caregiver column
-- 08/25/23    Deepen Gajjar         Implemented logic to merge overlapping hours served from sandata PA to HHAX PA in May23 & June23
-- 03/11/23    Sanket Jain 			 Added dataflex SSID in visits CTE
-- 22/12/23	   Sanket Jain		 	 Added CCSI in Visits CTE
-- 22/12/23	   Shraddha Sejpal		 Added Alliance in Visits CTE
--*****************************************************************************************************************************
--NOTE:			If Manual Refresh is required then CLIENT_SERVICE_MONTHLY_AUTHORIZATION,SCHEDULE_METRICS_MONTHLY 
--				should be refreshed first before running this object
--*****************************************************************************************************************************

INSERT OVERWRITE INTO DW_PROD.REPORT.UTILIZATION_2_0

WITH VISITS AS (	
--SELECT SUM(HOURS_SERVED) FROM(
	SELECT DISTINCT DATE_TRUNC(MONTH, VISIT.REPORT_DATE) REPORT_DATE, VISIT.PARTNER_CONTRACT_SERVICE_KEY, VISIT.CONTRACT_KEY,
		VISIT.CLIENT_KEY, 
		VISIT.SOURCE_SYSTEM_ID,
		FIRST_VALUE(VISIT.ORIGINAL_SOURCE_SYSTEM_ID) OVER(PARTITION BY VISIT.CLIENT_KEY ORDER BY CASE WHEN VISIT.CLIENT_KEY = VISIT.ORIGINAL_CLIENT_KEY THEN 1 ELSE 0 END) AS ORIGINAL_SOURCE_SYSTEM_ID,
		FIRST_VALUE(VISIT.ORIGINAL_CLIENT_KEY) OVER(PARTITION BY VISIT.CLIENT_KEY ORDER BY CASE WHEN VISIT.CLIENT_KEY = VISIT.ORIGINAL_CLIENT_KEY THEN 1 ELSE 0 END) AS ORIGINAL_CLIENT_KEY,
		VISIT.CLIENT_NUMBER,
       --  COUNT(DISTINCT DATE( VISIT.REPORT_DATE)) OVER (PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE),CLIENT_KEY,PARTNER_CONTRACT_SERVICE_KEY) AS NO_DAYS,
		MIN(IFF(MAX(VISIT.CONFIRMED_FLAG) = ''YES'' ,VISIT.SERVICE_DATE, NULL)) OVER (PARTITION BY  VISIT.CLIENT_KEY) AS Absolute_First_Service_Date,		--
		MAX(IFF(MAX(VISIT.CONFIRMED_FLAG) = ''YES'' ,VISIT.SERVICE_DATE, NULL)) OVER (PARTITION BY  VISIT.CLIENT_KEY) AS Absolute_Last_Service_Date,		--
		FIRST_VALUE(VISIT.ORIGINAL_CLIENT_NUMBER) OVER(PARTITION BY VISIT.CLIENT_KEY ORDER BY CASE WHEN VISIT.CLIENT_KEY = VISIT.ORIGINAL_CLIENT_KEY THEN 1 ELSE 0 END) AS ORIGINAL_CLIENT_NUMBER,
		FIRST_VALUE(VISIT.BRANCH_KEY) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY,VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY ORDER BY IFF(MAX(VISIT.CONFIRMED_FLAG) = ''YES'', 0, 1), MAX(VISIT.REPORT_DATE) DESC,  NVL(SUM(VISIT.HOURS_SERVED), 0) DESC) BRANCH_KEY,		--
		FIRST_VALUE(VISIT.ORIGINAL_BRANCH_KEY) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.CLIENT_KEY, VISIT.PARTNER_CONTRACT_SERVICE_KEY,VISIT.CONTRACT_KEY ORDER BY CASE WHEN VISIT.CLIENT_KEY = VISIT.ORIGINAL_CLIENT_KEY THEN 1 ELSE 0 END, IFF(MAX(VISIT.CONFIRMED_FLAG) = ''YES'', 0, 1), MAX(VISIT.REPORT_DATE) DESC,  NVL(SUM(VISIT.HOURS_SERVED), 0) DESC) ORIGINAL_BRANCH_KEY,		--
		FIRST_VALUE(VISIT.SUPERVISOR_KEY) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY,VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY ORDER BY IFF(MAX(VISIT.CONFIRMED_FLAG) = ''YES'', 0, 1), MAX(VISIT.REPORT_DATE) DESC,  NVL(SUM(VISIT.HOURS_SERVED), 0) DESC) SUPERVISOR_KEY,		--
		SUM(NVL(SUM(IFF(VISIT.CONFIRMED_FLAG = ''YES'', VISIT.HOURS_SERVED,0)), 0)) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY,VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY) HOURS_SERVED,
		SUM(NVL(SUM(IFF(VISIT.CONFIRMED_FLAG = ''YES'' AND INVOICE_STATUS_NAME =''Billed'', VISIT.BILL_UNITS_SERVED,0)), 0)) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY,VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY) HOURS_BILLED,
		SUM(COUNT(IFF(VISIT.CONFIRMED_FLAG = ''YES'',VISIT.VISIT_KEY,NULL))) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE),VISIT.PARTNER_CONTRACT_SERVICE_KEY, VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY) AS VISITS_ALL,
		SUM(COUNT(IFF(VISIT.CLEAN_SHIFT_FLAG = 1 AND VISIT.CONFIRMED_FLAG = ''YES'', VISIT.VISIT_KEY, NULL))) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY, VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY) AS VISITS_CLEAN_SHIFTS,		--
		SUM(COUNT(IFF(VISIT.CLEAN_SHIFT_FLAG = 0 AND VISIT.CONFIRMED_FLAG = ''YES'', VISIT.VISIT_KEY, NULL))) OVER(PARTITION BY DATE_TRUNC(MONTH, VISIT.REPORT_DATE), VISIT.PARTNER_CONTRACT_SERVICE_KEY, VISIT.CONTRACT_KEY,VISIT.CLIENT_KEY) AS VISITS_NEED_MAINTENANCE		--
		,listagg(DISTINCT iff(max(cc.BILLABLE )=''TRUE'' and max(visit.CONFIRMED_FLAG)=''YES'' and DATE_TRUNC(''MONTH'',VISIT.REPORT_DATE) IN (''2023-06-01'',''2023-05-01'',''2023-08-01'') AND VISIT.ORIGINAL_SOURCE_SYSTEM_ID IN (4,17,3) ,visit.PARTNER_CONTRACT_SERVICE_KEY,null)) 
		OVER (PARTITION BY visit.CLIENT_KEY, DATE_TRUNC(''MONTH'',VISIT.REPORT_DATE) ) AS id																																																											 																																		 
	FROM INTEGRATION.FACT_VISIT_MERGED AS VISIT
	LEFT JOIN DW_PROD.REPORT.VW_DASHBOARD_CONTRACTS cc ON visit.CONTRACT_KEY = cc.CONTRACT_KEY AND cc.BILLABLE =''TRUE'' 																													
	WHERE VISIT.ORIGINAL_SOURCE_SYSTEM_ID IN (4,7,17,13,9,3,19,8,16,1,2)    --VISIT.CONFIRMED_FLAG = ''YES''  -- Only confirmed visits 				   											   
	GROUP BY --DATE( VISIT.REPORT_DATE),
        DATE_TRUNC(MONTH, VISIT.REPORT_DATE),
		VISIT.PARTNER_CONTRACT_SERVICE_KEY,
		VISIT.CONTRACT_KEY,
		VISIT.CLIENT_KEY,
		VISIT.SOURCE_SYSTEM_ID,
		VISIT.ORIGINAL_SOURCE_SYSTEM_ID,
		VISIT.ORIGINAL_CLIENT_KEY,
		VISIT.CLIENT_NUMBER,
        VISIT.SERVICE_DATE,
		VISIT.ORIGINAL_CLIENT_NUMBER,
		VISIT.BRANCH_KEY, 
		VISIT.ORIGINAL_BRANCH_KEY,
		VISIT.SUPERVISOR_KEY
),VISIT AS (
SELECT 
a.REPORT_DATE,
a.PARTNER_CONTRACT_SERVICE_KEY,
a.CONTRACT_KEY,
a.CLIENT_KEY,
a.SOURCE_SYSTEM_ID,
a.ORIGINAL_SOURCE_SYSTEM_ID,
a.ORIGINAL_CLIENT_KEY,
a.CLIENT_NUMBER,
--a.NO_DAYS,
a.ABSOLUTE_FIRST_SERVICE_DATE,
a.ABSOLUTE_LAST_SERVICE_DATE,
a.ORIGINAL_CLIENT_NUMBER,
a.BRANCH_KEY,
a.ORIGINAL_BRANCH_KEY,
a.SUPERVISOR_KEY,
--a.HOURS_SERVED,
--a.HOURS_BILLED,
--a.VISITS_ALL,
--a.VISITS_CLEAN_SHIFTS,
--a.VISITS_NEED_MAINTENANCE,
iff(cc.CONTRACT_KEY IS NOT NULL , b.PARTNER_CONTRACT_SERVICE_KEY,a.PARTNER_CONTRACT_SERVICE_KEY ) AS merged_contract
,IFF(b.PARTNER_CONTRACT_SERVICE_KEY IS NULL , A.HOURS_SERVED, sum(A.HOURS_SERVED) OVER (PARTITION BY CLIENT_KEY, report_date, merged_contract)) AS HOURS_SERVED
,IFF(b.PARTNER_CONTRACT_SERVICE_KEY IS NULL , A.HOURS_BILLED, sum(A.HOURS_BILLED) OVER (PARTITION BY CLIENT_KEY, report_date, merged_contract) ) AS HOURS_BILLED
,IFF(b.PARTNER_CONTRACT_SERVICE_KEY IS NULL , A.VISITS_ALL , sum(A.VISITS_ALL) OVER (PARTITION BY CLIENT_KEY, report_date, merged_contract) ) AS VISITS_ALL 
,IFF(b.PARTNER_CONTRACT_SERVICE_KEY IS NULL , A.VISITS_CLEAN_SHIFTS, sum(A.VISITS_CLEAN_SHIFTS) OVER (PARTITION BY CLIENT_KEY, report_date, merged_contract) ) AS VISITS_CLEAN_SHIFTS
,IFF(b.PARTNER_CONTRACT_SERVICE_KEY IS NULL , A.VISITS_NEED_MAINTENANCE, sum(A.VISITS_NEED_MAINTENANCE) OVER (PARTITION BY CLIENT_KEY, report_date, merged_contract) ) AS VISITS_NEED_MAINTENANCE
FROM VISITS a
LEFT JOIN DW_PROD.HAH.CONTRACT_MAPPING b ON a.id= b.KEY2 OR a.id =b.KEY1 
LEFT JOIN DW_PROD.REPORT.VW_DASHBOARD_CONTRACTS cc ON a.CONTRACT_KEY = cc.CONTRACT_KEY AND cc.BILLABLE =''TRUE'' 
QUALIFY(iff(cc.CONTRACT_KEY IS NOT NULL , b.PARTNER_CONTRACT_SERVICE_KEY,NULL )) IS NULL  OR (merged_contract IS NOT NULL  AND b.PARTNER_CONTRACT_SERVICE_KEY =a.PARTNER_CONTRACT_SERVICE_KEY)
)
, NEW_METRICS AS (
	SELECT	REPORT_DATE, CLIENT_KEY , PARTNER_CONTRACT_SERVICE_KEY , 
		SUM(NM.VISITS_SCHEDULED) AS VISITS_SCHEDULED,
		SUM(NM.VISITS_COMPLETED) AS VISITS_COMPLETED,
		SUM(NM.VISITS_CANCELLED) AS VISITS_CANCELLED,
		SUM(NM.VISITS_IN_REVIEW) AS VISITS_IN_REVIEW,
		SUM(NM.VISITS_MISSED) AS VISITS_MISSED,
		SUM(NM.VISITS_RESCHEDULED) AS VISITS_RESCHEDULED,
		SUM(NM.FUTURE_VISITS) AS FUTURE_VISITS,
		SUM(NM.FUTURE_CANCELLED_VISITS) AS FUTURE_CANCELLED_VISITS,
		SUM(NM.FUTURE_HOLD_VISITS) AS FUTURE_HOLD_VISITS,
		SUM(NM.HOURS_SCHEDULED) AS HOURS_SCHEDULED,
		SUM(NM.HOURS_CANCELLED) AS HOURS_CANCELLED,
		SUM(NM.HOURS_IN_REVIEW) AS HOURS_IN_REVIEW,
		SUM(NM.HOURS_MISSED) AS HOURS_MISSED,
		SUM(NM.HOURS_RESCHEDULED) AS HOURS_RESCHEDULED,
		SUM(NM.FUTURE_HOURS) AS FUTURE_HOURS,
		SUM(NM.FUTURE_HOURS_NO_CAREGIVER) AS FUTURE_HOURS_NO_CAREGIVER,
		SUM(NM.FUTURE_CANCELLED_HOURS) AS FUTURE_CANCELLED_HOURS,
		SUM(NM.FUTURE_HOLD_HOURS) AS FUTURE_HOLD_HOURS,
		MAX(NM.CLIENT_SERVED_FLAG) AS CLIENT_SERVED_FLAG
		FROM REPORT.SCHEDULE_METRICS_MONTHLY  NM
		GROUP BY REPORT_DATE, CLIENT_KEY , PARTNER_CONTRACT_SERVICE_KEY 
)
, AUTHORIZATION AS (
	SELECT SOURCE_SYSTEM_ID,FIRST_DAY_OF_MONTH AS MONTH, PARTNER_CONTRACT_SERVICE_KEY, CLIENT_KEY,ATYPE,--INVALID_FLAG,
	sum(PERIOD_HOURS_AUTHORIZED_NON_ADJUSTED) AS HOURS_AUTHORIZED_NON_ADJUSTED,
	sum(PERIOD_HOURS_AUTHORIZED) AS HOURS_AUTHORIZED
    ,min(AUTH_START_DATE) AS amindate,
	max(AUTH_END_DATE) AS amaxdate
	FROM DW_PROD.REPORT.CLIENT_SERVICE_MONTHLY_AUTHORIZATION GROUP BY 1,2,3,4,5--,6
)
--,
--AUTH_VISIT AS (SELECT VISIT.*,AUTH.INVALID_FLAG FROM  VISIT LEFT JOIN AUTHORIZATION AUTH ON VISIT.REPORT_DATE = AUTH.MONTH AND VISIT.PARTNER_CONTRACT_SERVICE_KEY= AUTH.PARTNER_CONTRACT_SERVICE_KEY 
--	AND VISIT.CLIENT_KEY = AUTH.CLIENT_KEY AND VISIT.SOURCE_SYSTEM_ID = AUTH.SOURCE_SYSTEM_ID ),
--	 A AS (SELECT REPORT_DATE,CLIENT_KEY,PARTNER_CONTRACT_SERVICE_KEY,INVALID_FLAG FROM AUTH_VISIT)
--, B AS (SELECT REPORT_DATE,CLIENT_KEY,PARTNER_CONTRACT_SERVICE_KEY,INVALID_FLAG FROM AUTH_VISIT)
--, TEMP_AUTH AS (SELECT A.*,CASE WHEN A.INVALID_FLAG =TRUE THEN ''YES'' 
--           WHEN A.INVALID_FLAG =FALSE THEN ''NO'' 
--           ELSE FALSE END AS TEMP_FLAG FROM A JOIN B ON A.REPORT_DATE=B.REPORT_DATE AND A.CLIENT_KEY=B.CLIENT_KEY AND A.PARTNER_CONTRACT_SERVICE_KEY=B.PARTNER_CONTRACT_SERVICE_KEY
--WHERE A.INVALID_FLAG<>B.INVALID_FLAG
--)
SELECT DISTINCT VISIT.REPORT_DATE AS PERIOD_BEGIN_DATE,
		COALESCE(BRANCH.OFFICE_STATE_CODE, CLIENT.CLIENT_STATE_CODE) STATE,
		IFNULL(IFF(PCS.SCHEDULE_TYPE=''UNKNOWN'',''Hourly'',PCS.SCHEDULE_TYPE),''Hourly'') AS TYPE,
		BRANCH.BRANCH_KEY,
		VISIT.ORIGINAL_BRANCH_KEY,
		BRANCH.OFFICE_NUMBER,
		BRANCH.DETAILED_OFFICE_NAME AS OFFICE_NAME,
		VISIT.SUPERVISOR_KEY,
		SUPERVISOR.SUPERVISOR_CODE,
		VISIT.Absolute_First_Service_Date,
		VISIT.CLIENT_KEY,
		VISIT.ORIGINAL_CLIENT_KEY, 
		VISIT.CLIENT_NUMBER, 
		VISIT.ORIGINAL_CLIENT_NUMBER,
		VISIT.ORIGINAL_SOURCE_SYSTEM_ID,
		VISIT.SOURCE_SYSTEM_ID,
		VISIT.CONTRACT_KEY,
		PCS.CONTRACT_CODE,
		PCS.PARTNER_CODE,
		PCS.SERVICE_CODE,
	    NM.VISITS_SCHEDULED VISITS_SCHEDULED,
        VISIT.VISITS_ALL VISITS_COMPLETED,
        NM.VISITS_CANCELLED VISITS_CANCELLED,
        NM.VISITS_IN_REVIEW VISITS_IN_REVIEW,
        NM.VISITS_MISSED VISITS_MISSED,
        NM.VISITS_RESCHEDULED VISITS_RESCHEDULED,
        NM.FUTURE_VISITS FUTURE_VISITS,
        NM.FUTURE_CANCELLED_VISITS FUTURE_CANCELLED_VISITS,
        NM.FUTURE_HOLD_VISITS FUTURE_HOLD_VISITS,
        NM.HOURS_SCHEDULED HOURS_SCHEDULED,
        VISIT.HOURS_SERVED HOURS_SERVED,
        NM.HOURS_CANCELLED HOURS_CANCELLED,
        NM.HOURS_IN_REVIEW HOURS_IN_REVIEW,
        NM.HOURS_MISSED HOURS_MISSED,
        NM.HOURS_RESCHEDULED HOURS_RESCHEDULED,
        NM.FUTURE_HOURS FUTURE_HOURS,
        NM.FUTURE_HOURS_NO_CAREGIVER FUTURE_HOURS_NO_CAREGIVER,
        NM.FUTURE_CANCELLED_HOURS FUTURE_CANCELLED_HOURS,
        NM.FUTURE_HOLD_HOURS FUTURE_HOLD_HOURS,
        VISIT.HOURS_BILLED HOURS_BILLED,
		--IFF(AUTH.INVALID_FLAG=''TRUE'' ,0,AUTH.HOURS_AUTHORIZED) HOURS_AUTHORIZED,
         AUTH.HOURS_AUTHORIZED HOURS_AUTHORIZED,
        AUTH.HOURS_AUTHORIZED_NON_ADJUSTED AS HOURS_AUTHORIZED_NON_ADJUSTED,
        IFF(NVL(AUTH.HOURS_AUTHORIZED, 0) <= 0 , NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED) AS UTILIZATION,
        IFF(IFF(NVL(AUTH.HOURS_AUTHORIZED_NON_ADJUSTED , 0) <= 0, NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED_NON_ADJUSTED)>1, 1, 0) AS OVER_AUTHED,
        IFF(IFF(NVL(AUTH.HOURS_AUTHORIZED , 0) <= 0 , NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED)>1, 1, 0) AS OVER_AUTHED_ADJUSTED,
        IFF(AUTH.HOURS_AUTHORIZED_NON_ADJUSTED <VISIT.HOURS_SERVED, NVL(VISIT.HOURS_SERVED, 0) - AUTH.HOURS_AUTHORIZED_NON_ADJUSTED , NULL) AS OVER_AUTHED_HOURS,
        IFF(AUTH.HOURS_AUTHORIZED<VISIT.HOURS_SERVED, NVL(VISIT.HOURS_SERVED, 0) - AUTH.HOURS_AUTHORIZED, NULL) AS OVER_AUTHED_HOURS_ADJUSTED,
        IFF(NVL(VISIT.HOURS_SERVED, 0) > 0 AND NVL(AUTH.HOURS_AUTHORIZED, 0) <= 0, 1, 0) AS SERVED_WITHOUT_AUTH,    
--		IFF(NVL(AUTH.HOURS_AUTHORIZED, 0) <= 0 OR AUTH.INVALID_FLAG=''TRUE'', NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED) AS UTILIZATION,
--		IFF(IFF(NVL(AUTH.HOURS_AUTHORIZED_NON_ADJUSTED , 0) <= 0, NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED_NON_ADJUSTED)>1, 1, 0) AS OVER_AUTHED,
--		IFF(IFF(NVL(AUTH.HOURS_AUTHORIZED , 0) <= 0 OR AUTH.INVALID_FLAG=''TRUE'', NULL, NVL(VISIT.HOURS_SERVED, 0) / AUTH.HOURS_AUTHORIZED)>1, 1, 0) AS OVER_AUTHED_ADJUSTED,
--	    IFF(AUTH.HOURS_AUTHORIZED_NON_ADJUSTED <VISIT.HOURS_SERVED, NVL(VISIT.HOURS_SERVED, 0) - AUTH.HOURS_AUTHORIZED_NON_ADJUSTED , NULL) AS OVER_AUTHED_HOURS,
--		IFF(IFF(AUTH.INVALID_FLAG=''TRUE'' ,0, AUTH.HOURS_AUTHORIZED)<VISIT.HOURS_SERVED, NVL(VISIT.HOURS_SERVED, 0) - IFF(AUTH.INVALID_FLAG=''TRUE'' ,0,AUTH.HOURS_AUTHORIZED), NULL) AS OVER_AUTHED_HOURS_ADJUSTED,
--		IFF(NVL(VISIT.HOURS_SERVED, 0) > 0 AND NVL(IFF(AUTH.INVALID_FLAG=''TRUE'' ,0,AUTH.HOURS_AUTHORIZED), 0) <= 0, 1, 0) AS SERVED_WITHOUT_AUTH,	
	    VISIT.VISITS_ALL AS VISITS_ALL,
        VISIT.VISITS_CLEAN_SHIFTS AS VISITS_CLEAN_SHIFTS,
        VISIT.VISITS_NEED_MAINTENANCE AS VISITS_NEED_MAINTENANCE,
		NM.CLIENT_SERVED_FLAG,
		:STR_ETL_TASK_KEY AS ETL_TASK_KEY,
        :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,
        convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
		CURRENT_USER as ETL_INSERTED_BY ,
		convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_UPDATED_DATE,
		CURRENT_USER as ETL_LAST_UPDATED_BY,
		0 as ETL_DELETED_FLAG,
		VISIT.Absolute_Last_Service_Date,
		NPS,
		VISIT.PARTNER_CONTRACT_SERVICE_KEY
FROM VISIT 
JOIN INTEGRATION.DIM_CLIENT_MERGED CLIENT
		ON CLIENT.ORIGINAL_CLIENT_KEY = VISIT.CLIENT_KEY
LEFT JOIN HAH.FACT_PARTNER_CONTRACT_SERVICE PCS 
		ON PCS.PARTNER_CONTRACT_SERVICE_KEY = VISIT.PARTNER_CONTRACT_SERVICE_KEY 
LEFT JOIN AUTHORIZATION AUTH ON VISIT.REPORT_DATE = AUTH.MONTH AND VISIT.PARTNER_CONTRACT_SERVICE_KEY= AUTH.PARTNER_CONTRACT_SERVICE_KEY 
	AND VISIT.CLIENT_KEY = AUTH.CLIENT_KEY AND VISIT.SOURCE_SYSTEM_ID = AUTH.SOURCE_SYSTEM_ID  
    AND IFNULL(IFF(UPPER( PCS.SCHEDULE_TYPE) IN (''UNKNOWN'',''HOURLY'',''UNIT''),''HOURLY'',UPPER(PCS.SCHEDULE_TYPE)),''HOURLY'') =
CASE WHEN UPPER(AUTH.ATYPE) IN (''UNIT'',''HOURS'') THEN ''HOURLY''
      WHEN UPPER(PCS.SCHEDULE_TYPE) IN (''UNKNOWN'',''HOURLY'') AND (AUTH.ATYPE IS NULL OR AUTH.ATYPE='''') THEN ''HOURLY''
      WHEN UPPER(PCS.SCHEDULE_TYPE) =''VISIT''  AND (AUTH.ATYPE IS NULL OR AUTH.ATYPE='''') THEN ''VISIT''
       WHEN UPPER(PCS.SCHEDULE_TYPE) =''DAILY''  AND (AUTH.ATYPE IS NULL OR AUTH.ATYPE='''') THEN ''DAILY''
      WHEN UPPER(AUTH.ATYPE) IN (''VISITS'') THEN ''VISIT''
      ELSE UPPER(AUTH.ATYPE) end
--LEFT JOIN TEMP_AUTH TA ON VISIT.REPORT_DATE =TA.REPORT_DATE AND  VISIT.PARTNER_CONTRACT_SERVICE_KEY= TA.PARTNER_CONTRACT_SERVICE_KEY 
--AND VISIT.CLIENT_KEY=TA.CLIENT_KEY	AND AUTH.INVALID_FLAG=TA.INVALID_FLAG
JOIN INTEGRATION.DIM_BRANCH_MERGED BRANCH
		ON BRANCH.ORIGINAL_BRANCH_KEY = VISIT.BRANCH_KEY 
LEFT JOIN INTEGRATION.DIM_SUPERVISOR_MERGED SUPERVISOR
		ON SUPERVISOR.ORIGINAL_SUPERVISOR_KEY = VISIT.SUPERVISOR_KEY
LEFT JOIN NEW_METRICS NM 
		ON NM.REPORT_DATE = VISIT.REPORT_DATE AND NM.CLIENT_KEY = VISIT.CLIENT_KEY AND NM.PARTNER_CONTRACT_SERVICE_KEY = VISIT.PARTNER_CONTRACT_SERVICE_KEY
LEFT JOIN DW_PROD.INTEGRATION.FACT_NPS FN
  		ON FN.CLIENT_KEY = VISIT.CLIENT_KEY
  		AND YEAR(VISIT.REPORT_DATE) = YEAR(FN.RECORDED_DATE) 
  		AND MONTH(VISIT.REPORT_DATE) = MONTH(FN.RECORDED_DATE);

SELECT CONCAT(''Message : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;
';