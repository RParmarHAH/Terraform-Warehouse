CREATE OR REPLACE PROCEDURE DW_PROD.HAH.DIM_CLIENT_POSTPROCESSING("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
    return_result VARCHAR;
BEGIN

UPDATE DW_PROD.HAH.DIM_CLIENT C
SET C.FIRST_SERVICE_DATE = V.FIRST_SERVICE_DATE, C.LAST_SERVICE_DATE = V.LAST_SERVICE_DATE 
FROM (
    SELECT C.CLIENT_KEY, MIN(V.REPORT_DATE) FIRST_SERVICE_DATE, MAX(V.REPORT_DATE) LAST_SERVICE_DATE 
    FROM DW_PROD.HAH.DIM_CLIENT C 
    LEFT JOIN DW_PROD.HAH.FACT_VISIT V
        ON C.CLIENT_KEY = V.CLIENT_KEY
	LEFT JOIN DW_PROD.HAH.DIM_CONTRACT DC ON V.CONTRACT_KEY = DC.CONTRACT_KEY
    WHERE DC.BILLABLE_FLAG = TRUE AND V.CONFIRMED_FLAG = ''YES''					-- Added this as we want first & Last confirmed AND billable visit date.
    GROUP BY 1
) V WHERE C.CLIENT_KEY = V.CLIENT_KEY;

SELECT CONCAT(''Message : '',"number of rows updated",'' Rows Updated.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

return return_result;
END;

';