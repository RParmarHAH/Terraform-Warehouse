CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_QUALTRICS_FACT_SURVEY_OPTOUT("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS 'BEGIN
--*****************************************************************************************************************************
-- NAME:  QUALTRICS_FACT_SURVEY_OPTOUT
--
-- PURPOSE: Creates one row per Contact  
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -------------------------------------------------------------------------------------------
-- 			   Paras Bhavnani        Initial development.
-- 10-oct-23   Meet Hariyani		 Made changes in logic to populate UNSUBSCRIBE_END_DATE.
--*****************************************************************************************************************************

INSERT OVERWRITE INTO DW_PROD.STAGE.QUALTRICS_FACT_SURVEY_OPTOUT
WITH WH_EMPLOYEES AS
(SELECT   ROW_NUMBER() OVER (PARTITION BY CAMD.OLD_KEY ORDER BY DEM.EMPLOYEE_LAST_WORKED_DATE DESC) AS RNUM,CAMD.* 
FROM      APP_DB_PROD.CARE_COORDINATION.CAREGIVER_MATCH_DEDUPE CAMD
LEFT JOIN DW_PROD.INTEGRATION.DIM_EMPLOYEE_MERGED DEM 
       ON CAMD.CURRENT_KEYS = DEM.ORIGINAL_EMPLOYEE_KEY 
      AND DEM.ORIGINAL_EMPLOYEE_KEY = DEM.EMPLOYEE_KEY
    WHERE CAMD.OLD_KEY<>CAMD.CURRENT_KEYS)

,WH_CLIENTS AS 
(SELECT ROW_NUMBER() OVER (PARTITION BY CMD.OLD_KEY ORDER BY DCM.LAST_SERVICE_DATE DESC) AS RNUM,CMD.* 
FROM APP_DB_PROD.CARE_COORDINATION.CLIENT_MATCH_DEDUPE CMD
LEFT JOIN DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DCM ON CMD.CURRENT_KEYS = DCM.ORIGINAL_CLIENT_KEY 
AND DCM.ORIGINAL_CLIENT_KEY=DCM.CLIENT_KEY
WHERE CMD.OLD_KEY<>CMD.CURRENT_KEYS)

SELECT CASE WHEN UNSUBSCRIBE_START_DATE is NULL
            THEN MD5(HCOO.CONTACTID||FIRSTNAME||LASTNAME||EXTREF) 
            WHEN UNSUBSCRIBE_START_DATE is NOT NULL
            THEN MD5(HCOO.CONTACTID||FIRSTNAME||LASTNAME||EXTREF||UNSUBSCRIBE_START_DATE)
       END AS QUALTRICS_FACT_SURVEY_OPTOUT_KEY,
       HCOO.CONTACTID,
       FIRSTNAME,
	   LASTNAME,
	   EMPLOYEE_KEY,
       coalesce(whe.current_keys,EMPLOYEE_KEY) as wh_employee_key,
	   CLIENT_KEY,
       coalesce(whc.current_keys,client_KEY) as wh_client_key,
	   UNSUBSCRIBE_START_DATE,
       CASE WHEN NEXT_UNSUBSCRIBE_DATE IS NULL AND COO.CONTACTID IS NOT NULL 
	        THEN NULL
	        WHEN COO.CONTACTID IS NULL
			THEN dateadd(DAY, 1, LAST_INSERTED_DATE)
	        WHEN NEXT_UNSUBSCRIBE_DATE IS NOT NULL
			THEN dateadd(DAY, 1, LAST_INSERTED_DATE) 
	   END AS UNSUBSCRIBE_END_DATE,
       SOURCE_SYSTEM_ID,
       source_system_code,
       ETL_TASK_KEY,
	   ETL_INSERTED_DATE,
	   ETL_INSERTED_BY,
	   ETL_LAST_UPDATED_DATE,
	   ETL_LAST_UPDATED_BY,
	   ETL_DELETED_FLAG
FROM (SELECT CONTACTID,
             FIRSTNAME,
			 LASTNAME,
             EXTREF,  
             DSS.SOURCE_SYSTEM_ID as SOURCE_SYSTEM_ID,
             ''QUALTRICS'' as SOURCE_SYSTEM_CODE, 
			 right(EXTREF,32) AS EMPLOYEE_KEY,
			 LEFT(EXTREF,32) AS CLIENT_KEY,
             MAILINGLISTUNSUBSCRIBEDATE AS UNSUBSCRIBE_START_DATE,
             LAG(UNSUBSCRIBE_START_DATE) OVER (PARTITION BY CONTACTID ORDER BY UNSUBSCRIBE_START_DATE DESC) AS NEXT_UNSUBSCRIBE_DATE,
             NULL AS UNSUBSCRIBE_END_DATE,
			 MAX(HCOO.ETL_INSERTED_DATE) AS LAST_INSERTED_DATE,
             :STR_ETL_TASK_KEY AS ETL_TASK_KEY,
             current_date() AS ETL_INSERTED_DATE,  
			 current_user() AS ETL_INSERTED_BY,
             CURRENT_dATE() AS ETL_LAST_UPDATED_DATE,
			 current_user() AS ETL_LAST_UPDATED_BY,
			 FALSE AS ETL_DELETED_FLAG 
from DISC_PROD.QUALTRICS_SURVEYS.HIST_CC_OPT_OUT HCOO
JOIN DW_PROD.HAH.DIM_SOURCE_SYSTEM DSS
  ON DSS.system_code = ''Qualtrics''

GROUP BY CONTACTID,FIRSTNAME,LASTNAME,EXTREF,UNSUBSCRIBE_START_DATE,SOURCE_SYSTEM_ID ) HCOO

LEFT JOIN WH_EMPLOYEES WHE on right(EXTREF,32) = WHE.old_key AND WHE.RNUM=1
LEFT JOIN WH_CLIENTS WHC on left(EXTREF,32)  = WHC.old_key AND WHC.RNUM=1
LEFT JOIN (SELECT CONTACTID FROM DISC_PROD.QUALTRICS_SURVEYS.CC_OPT_OUT) COO ON COO.CONTACTID = HCOO.CONTACTID																											 
;


RETURN(''SUCCESS'');

END';