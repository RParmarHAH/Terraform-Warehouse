CREATE OR REPLACE PROCEDURE DW_PROD.HAH.MERGE_STAGE_FACT_SURVEY_RESPONSE_DETAIL("SURVEY_ID" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
	RETURN_RESULT VARCHAR;
BEGIN
	MERGE INTO HAH.FACT_SURVEY_RESPONSE_DETAIL FSRD
	USING (SELECT * FROM STAGE.FACT_SURVEY_RESPONSE_DETAIL WHERE SURVEY_ID=:SURVEY_ID) STAGE 
	ON FSRD.SURVEY_RESPONSE_DETAIL_KEY = STAGE.SURVEY_RESPONSE_DETAIL_KEY
	WHEN MATCHED THEN 
	UPDATE SET 
	    FSRD.SURVEY_KEY=	STAGE.SURVEY_KEY,
		FSRD.SURVEY_ID=	STAGE.SURVEY_ID,
		FSRD.SOURCE_SYSTEM_ID=	STAGE.SOURCE_SYSTEM_ID,
		FSRD.SYSTEM_CODE=	STAGE.SYSTEM_CODE,
		FSRD.SURVEY_RESPONSE_HEADER_KEY=	STAGE.SURVEY_RESPONSE_HEADER_KEY,
		FSRD.SURVEY_QUESTION_KEY=	STAGE.SURVEY_QUESTION_KEY,
		FSRD.QUESTION_ID=	STAGE.QUESTION_ID,
		FSRD.ANSWER=	STAGE.ANSWER,
		FSRD.ETL_TASK_KEY=	STAGE.ETL_TASK_KEY,
		FSRD.ETL_INSERTED_TASK_KEY=	STAGE.ETL_INSERTED_TASK_KEY,
		FSRD.ETL_LAST_UPDATED_DATE=	STAGE.ETL_LAST_UPDATED_DATE,
		FSRD.ETL_LAST_UPDATED_BY=	STAGE.ETL_LAST_UPDATED_BY,
		FSRD.ETL_DELETED_FLAG=	STAGE.ETL_DELETED_FLAG
	WHEN NOT MATCHED THEN 
	INSERT ( 
	    SURVEY_RESPONSE_DETAIL_KEY,
		SURVEY_KEY,
		SURVEY_ID,
		SOURCE_SYSTEM_ID,
		SYSTEM_CODE,
		SURVEY_RESPONSE_HEADER_KEY,
		SURVEY_QUESTION_KEY,
		QUESTION_ID,
		ANSWER,
		ETL_TASK_KEY,
		ETL_INSERTED_TASK_KEY,
		ETL_INSERTED_DATE,
		ETL_INSERTED_BY,
		ETL_LAST_UPDATED_DATE,
		ETL_LAST_UPDATED_BY,
		ETL_DELETED_FLAG
	) 
	VALUES (
		STAGE.SURVEY_RESPONSE_DETAIL_KEY,
		STAGE.SURVEY_KEY,
		STAGE.SURVEY_ID,
		STAGE.SOURCE_SYSTEM_ID,
		STAGE.SYSTEM_CODE,
		STAGE.SURVEY_RESPONSE_HEADER_KEY,
		STAGE.SURVEY_QUESTION_KEY,
		STAGE.QUESTION_ID,
		STAGE.ANSWER,
		STAGE.ETL_TASK_KEY,
		STAGE.ETL_INSERTED_TASK_KEY,
		STAGE.ETL_INSERTED_DATE,
		STAGE.ETL_INSERTED_BY,
		STAGE.ETL_LAST_UPDATED_DATE,
		STAGE.ETL_LAST_UPDATED_BY,
		STAGE.ETL_DELETED_FLAG
	);

	SELECT CONCAT(''Message : '',"number of rows inserted", '' Rows Inserted & '' ,"number of rows updated",'' Rows Updated.'') into :RETURN_RESULT FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
	return RETURN_RESULT;
END;
';