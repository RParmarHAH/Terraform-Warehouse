CREATE OR REPLACE PROCEDURE DW_PROD.HAH.GET_STAGE_ALAYACARE_DIM_CONTRACT("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
  RETURN_RESULT VARCHAR(1000);
BEGIN
    --*****************************************************************************************************************************
-- NAME:  ALAYACARE_DIM_CONTRACT
--
-- PURPOSE: Creates one row per CONTRACT according to Alayacare
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- --------    -------------------   -----------------------------------------------------------------------------------------------
-- 10/26/2021  MOIN SAIYED        Initial development
-- 11/15/2021  Mir Ali			  Added Revenue_Category mapping as provided by the business
-- 30/06/2023  Pinkal Panchal	  Changed Contract_key and Joins to add PRIVATE PAY - COST SHARE Contract
--*****************************************************************************************************************************
INSERT OVERWRITE INTO STAGE.ALAYACARE_DIM_CONTRACT
SELECT DATA.* FROM (
SELECT 
MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(F.BRANCH_ID,-1) || '')'' || ''-'' || F.FUNDER_ID::STRING || ''-'' || NVL(NVL(S.SERVICE_CODE_ID::STRING,TO_VARCHAR(BCF.BILL_CODE_ID)), '''') || ''-'' || ''ALAYACARE'') AS CONTRACT_KEY
--MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(F.BRANCH_ID,-1) || '')'' || ''-'' || F.FUNDER_ID::STRING || ''-'' || NVL(S.SERVICE_CODE_ID::STRING, '''') || ''-'' || ''ALAYACARE'') AS CONTRACT_KEY
,F.FUNDER_ID AS CONTRACT_CODE
,UPPER(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(F.BRANCH_ID,-1) || '')'') AS SYSTEM_CODE
,9 AS SOURCE_SYSTEM_ID
,F.NAME AS "CONTRACT_NAME"
--,S.SERVICE_CODE_ID::STRING AS "SERVICE_CODE_ID"
,NVL(NVL(S.SERVICE_CODE_ID::STRING,TO_VARCHAR(BCF.BILL_CODE_ID)), '''') AS "SERVICE_CODE_ID"
,MD5(NVL(TRIM(COMPANY.PROPERTIES_TBL_GT_ACCOUNT_DESCRIPTION), ''Unknown'') || '' ('' || NVL(F.BRANCH_ID,-1) || '')'' || ''-'' || S.SERVICE_CODE_ID::STRING || ''-'' || ''ALAYACARE'') AS SERVICE_KEY
,NULL AS DEFAULT_BILL_CODE --NEED TO CHECK LOGIC OF MATRIXCARE
,NULL AS PAYROLL_CODE
,CASE WHEN CHARINDEX(''HOMECARE'', REPLACE(UPPER(BC.GL_REVENUE_ACC_ACCOUNT_NAME), '' '', '''')) > 0
		THEN ''HC''
	WHEN CHARINDEX(''HOMEHEALTH'', REPLACE(UPPER(BC.GL_REVENUE_ACC_ACCOUNT_NAME), '' '', '''')) > 0
		THEN ''HH''
	ELSE ''NA'' END AS REVENUE_CATEGORY
,CASE REVENUE_CATEGORY
	WHEN ''HC'' THEN ''HC''
	WHEN ''HH'' THEN ''HHA''
	ELSE ''NA'' END AS REVENUE_SUBCATEGORY_CODE
,CASE REVENUE_CATEGORY
	WHEN ''HC'' THEN ''HOME CARE''
	WHEN ''HH'' THEN ''HOME HEALTH AIDE''
	ELSE ''NA'' END AS REVENUE_SUBCATEGORY_NAME
,MEDICAID_PAYER_CODE AS PAYOR_CODE
,REVENUE_CATEGORY
		|| '' - '' ||
	REVENUE_SUBCATEGORY_NAME
AS PAYOR_DESCRIPTION
,REVENUE_CATEGORY AS SERVICE_LINE_CODE
,REVENUE_CATEGORY AS SERVICE_LINE_DESCRIPTION
,F.PROFILE_STATE AS "CONTRACT_STATE_CODE"
,''1HR'' AS TIME_TRANSLATION_CODE
,''1'' AS TIME_TRANSLATION_DIVIDER
,NULL AS PAY_TRAVELS_CODE
,FALSE AS MILEAGE_FLAG
,TRUE AS PAYABLE_FLAG
,IFF(BC.EXCLUDE_BILLING = ''yes'', FALSE, TRUE) AS BILLABLE_FLAG
,NULL AS BILLED_BY_QUARTER_HOURS
,NULL AS BILLED_BY_HALF_HOURS
,TO_DATE(''1900-01-01'', ''YYYY-MM-DD'') AS EFFECTIVE_FROM_DATE
,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'') AS EFFECTIVE_TO_DATE,
 :STR_ETL_TASK_KEY AS ETL_TASK_KEY,
 :STR_ETL_TASK_KEY AS ETL_INSERTED_TASK_KEY,      
convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
CURRENT_USER as ETL_INSERTED_BY,
convert_timezone(''UTC'', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_UPDATED_DATE,
CURRENT_USER as ETL_LAST_UPDATED_BY,
0 as ETL_DELETED_FLAG,
0 as ETL_INFERRED_MEMBER_FLAG
FROM DISC_PROD.ALAYACARE.FUNDER F 
LEFT JOIN DISC_PROD.ALAYACARE.SERVICE_CODE_BILL_CODE SBC ON F.FUNDER_ID = SBC.FUNDER_ID 
LEFT JOIN DISC_PROD.ALAYACARE.SERVICE_CODE S ON SBC.SERVICE_CODE_ID = S.SERVICE_CODE_ID
LEFT JOIN DISC_PROD.ALAYACARE.BILL_CODE AS BCF ON CASE WHEN BCF.FUNDER_ID =21 THEN BCF.FUNDER_ID = F.FUNDER_ID END 
LEFT JOIN DISC_PROD.ALAYACARE.BILL_CODE AS BC ON BC.BILL_CODE_ID = SBC.BILL_CODE_ID 
LEFT JOIN DISC_PROD.ALAYACARE.BRANCH AS COMPANY
	ON COMPANY.BRANCH_ID = F.BRANCH_ID)DATA 
INNER JOIN DISC_PROD.ALAYACARE.CONFIGURATION CONFIG 
	ON UPPER(CONFIG.SYSTEM_CODE) = UPPER(DATA.SYSTEM_CODE)
	AND CONFIG.CONFIGURATION_ACTIVE=TRUE
	AND CONFIG.SYSTEM_CODE IS NOT NULL;
SELECT CONCAT (''MESSAGE : '',"number of rows inserted",'' Rows Inserted.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
	RETURN return_result;
    END;
    ';