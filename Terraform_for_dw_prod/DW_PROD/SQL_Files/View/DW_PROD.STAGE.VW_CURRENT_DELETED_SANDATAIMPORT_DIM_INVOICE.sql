create or replace view DW_PROD.STAGE.VW_CURRENT_DELETED_SANDATAIMPORT_DIM_INVOICE(
	INVOICE_KEY
) as
WITH CLIENT AS
(
	SELECT * FROM
	(
		SELECT CLIENTID, MASTER_ID,AGENCYID
		FROM DISC_DEDUPE_PROD.SANDATAIMPORT.CLIENT_MASTER_LIST
        WHERE AGENCYID=8485 
	)
	UNION
	SELECT * FROM
	(
		SELECT DISTINCT CLIENTID, MASTER_ID,AGENCYID
		FROM DISC_DEDUPE_PROD.SANDATAIMPORT.CLIENT_MATCH_LIST
		WHERE CLIENTID NOT IN (SELECT CLIENTID FROM DISC_DEDUPE_PROD.SANDATAIMPORT.CLIENT_MASTER_LIST ) 
        AND AGENCYID=8485
	))
SELECT
      CASE WHEN D.SERVICEID IN ('CARECO','VBPCG')
			THEN md5('CC_'||inv.AGENCYID ||'-'|| inv.INVOICENUMBER ||'-'|| 'SANDATAIMPORT') 
			ELSE md5(inv.AGENCYID ||'-'|| inv.INVOICENUMBER ||'-'|| 'SANDATAIMPORT') END AS INVOICE_KEY --PK
FROM DISC_PROD.SANDATAIMPORT.SANDATA_INVOICEHEADER inv
LEFT JOIN DISC_PROD.SANDATAIMPORT.SANDATA_INVOICEDETAILS D ON D.AGENCYID = inv.AGENCYID AND D.INVOICENUMBER = inv.INVOICENUMBER 
LEFT JOIN DISC_PROD.SANDATAIMPORT.SANDATA_PAYORS pay ON inv.payorid = pay.PAYORID AND inv.BILLCODE = pay.BILLCODE
    AND inv.AGENCYID = pay.AGENCYID
LEFT JOIN DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS ADM
    ON ADM.AGENCYID = INV.AGENCYID AND ADM.ADMISSIONID = INV.ADMISSIONID
LEFT JOIN CLIENT CL ON CL.AGENCYID= ADM.AGENCYID AND ADM.CLIENTID = CL.CLIENTID
WHERE inv.AGENCYID = '8485' --limit to PA ONLY
AND inv.ETL_DELETED_FLAG = TRUE
AND CAST(inv.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT CAST(MAX(ETL_LAST_UPDATED_DATE) AS DATE) FROM DISC_PROD.SANDATAIMPORT.HIST_SANDATA_INVOICEHEADER);