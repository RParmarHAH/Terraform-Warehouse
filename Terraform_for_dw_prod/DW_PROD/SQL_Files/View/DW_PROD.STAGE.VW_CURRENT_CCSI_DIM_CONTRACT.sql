create or replace view DW_PROD.STAGE.VW_CURRENT_CCSI_DIM_CONTRACT(
	CONTRACT_KEY
) as 
--INSERT OVERWRITE INTO DW_DEV.HAH.DIM_CONTRACT 
WITH  ALL_DATA AS 
(
	SELECT * FROM DISC_PROD.CCSI.RAWVRFP           
)
,BILLABLE AS        -------- LOGIC FOR BILLABLE FLAG
(
	SELECT DISTINCT  UPPER (TRIM (CONTRACT_NO)) AS CONTRACT_NO , COUNT (DISTINCT PAY_EMPLOYEE) AS CNT
		FROM ALL_DATA 
	WHERE CONTRACT_NO IS NOT NULL 
	GROUP BY 1
)
SELECT DISTINCT 
  MD5( 'CCSI' || B.CONTRACT_NO || '-' || 'CCSI') AS CONTRACT_KEY 
 FROM  ALL_DATA  R
LEFT JOIN BILLABLE B ON UPPER (TRIM (R.CONTRACT_NO)) = B.CONTRACT_NO 
WHERE R.CONTRACT_NO IS NOT NULL;