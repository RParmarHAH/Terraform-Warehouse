create or replace view DW_PROD.REPORT.VW_LATEST_PERIOD_PAID_BY_BRANCH(
	BRANCH_KEY,
	LATEST_PAY_PERIOD_END_DATE,
	LATEST_PAY_PERIOD_START_DATE,
	LATEST_PAYROLL_DATE,
	LAST_DAY_OF_WEEK_BEFORE_PERIOD_END
) as
        SELECT BRANCH_KEY,
        MAX(PAY_PERIOD_END_DATE) AS LATEST_PAY_PERIOD_END_DATE,
        MAX(PAY_PERIOD_START_DATE) AS LATEST_PAY_PERIOD_START_DATE,
        MAX(PAYROLL_DATE) AS LATEST_PAYROLL_DATE,
        CASE WHEN DAYNAME(MAX(PAY_PERIOD_END_DATE))='Sun' THEN MAX(PAY_PERIOD_END_DATE) ELSE MAX(HAH_PREVIOUS_WEEK_LAST_DAY) END 
        AS LAST_DAY_OF_WEEK_BEFORE_PERIOD_END
        FROM HAH.FACT_PAYROLL P
        JOIN HAH.DIM_DATE D ON P.PAY_PERIOD_END_DATE=D.CALENDAR_DATE
        GROUP BY BRANCH_KEY;