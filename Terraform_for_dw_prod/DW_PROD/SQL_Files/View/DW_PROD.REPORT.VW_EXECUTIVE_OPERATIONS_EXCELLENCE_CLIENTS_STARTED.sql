create or replace view DW_PROD.REPORT.VW_EXECUTIVE_OPERATIONS_EXCELLENCE_CLIENTS_STARTED(
	PERIOD_BEGIN_DATE,
	CLIENT_KEY,
	REVENUE_CATEGORY,
	FIRST_SERVICE_DATE,
	FIRST_BRANCH_KEY,
	FIRST_SUPERVISOR_KEY
) as
WITH NEW_CLIENTS AS (
	SELECT DISTINCT MIN(CLIENTS.PERIOD_BEGIN_DATE) OVER(PARTITION BY CLIENTS.CLIENT_KEY, CONTRACTS.REVENUE_CATEGORY) AS PERIOD_BEGIN_DATE,
		CLIENTS.CLIENT_KEY,
		CONTRACTS.REVENUE_CATEGORY,
		MIN(MIN(CLIENTS.FIRST_SERVICE_DATE)) OVER(PARTITION BY CLIENTS.CLIENT_KEY, CONTRACTS.REVENUE_CATEGORY) AS FIRST_SERVICE_DATE,
		FIRST_VALUE(CLIENTS.FIRST_BRANCH_KEY) OVER(PARTITION BY CLIENTS.CLIENT_KEY, CONTRACTS.REVENUE_CATEGORY ORDER BY MIN(CLIENTS.FIRST_SERVICE_DATE), SUM(CLIENTS.HOURS_SERVED) DESC) AS FIRST_BRANCH_KEY,
		FIRST_VALUE(CLIENTS.FIRST_SUPERVISOR_KEY) OVER(PARTITION BY CLIENTS.CLIENT_KEY, CONTRACTS.REVENUE_CATEGORY ORDER BY MIN(CLIENTS.FIRST_SERVICE_DATE), SUM(CLIENTS.HOURS_SERVED) DESC) AS FIRST_SUPERVISOR_KEY
	FROM REPORT.CLIENTS_STARTED CLIENTS
	JOIN REPORT.VW_DASHBOARD_CONTRACTS CONTRACTS
		ON CONTRACTS.CONTRACT_KEY = CLIENTS.CONTRACT_KEY
	WHERE CONTRACTS.INCLUDE_FOR_EXEC_OPS_CLIENTS = 1
	GROUP BY CLIENTS.PERIOD_BEGIN_DATE,
		CLIENTS.CLIENT_KEY,
		CONTRACTS.REVENUE_CATEGORY,
		CLIENTS.FIRST_BRANCH_KEY,
		CLIENTS.FIRST_SUPERVISOR_KEY
), CLIENTS_STARTED_BY_REVENUE_CATEGORY AS (
	SELECT CLIENTS.*
	FROM NEW_CLIENTS CLIENTS
	JOIN REPORT.VW_EXECUTIVE_OPERATIONS_EXCELLENCE_CLIENTS_STARTED_DIM_DATE DATES
		ON DATES.PERIOD_BEGIN_DATE = CLIENTS.PERIOD_BEGIN_DATE
)
	SELECT PERIOD_BEGIN_DATE,
		CLIENT_KEY,
		REVENUE_CATEGORY,
		FIRST_SERVICE_DATE,
		FIRST_BRANCH_KEY,
		FIRST_SUPERVISOR_KEY
	FROM CLIENTS_STARTED_BY_REVENUE_CATEGORY;