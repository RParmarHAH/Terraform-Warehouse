create or replace view DW_PROD.REPORT.VW_CLIENTS_REFERRED_WIP(
	REFERRED_DATE,
	CLIENT_KEY,
	CLIENT_NUMBER,
	CLIENT_NAME,
	DAYS_TO_SERVICE,
	BRANCH_KEY,
	CONTRACT_KEY,
	FIRST_PARTNER_CONTRACT_SERVICE_KEY,
	TYPE,
	SOURCE_SYSTEM_ID,
	ORIGINAL_SOURCE_SYSTEM_ID
) as
SELECT DISTINCT
DATE_TRUNC('MONTH',R.REFERRED_DATE) AS REFERRED_DATE,
R.CLIENT_KEY,
R.CLIENT_NUMBER ,
R.CLIENT_NAME ,
R.DAYS_TO_SERVICE ,
R.BRANCH_KEY, 
R.FIRST_CONTRACT_KEY AS CONTRACT_KEY,
R.FIRST_PARTNER_CONTRACT_SERVICE_KEY ,
R.TYPE,
R.SOURCE_SYSTEM_ID ,
R.ORIGINAL_SOURCE_SYSTEM_ID 
FROM REPORT.CLIENTS_REFERRED_1_0  R
JOIN REPORT.VW_DASHBOARD_CONTRACTS DC ON R.FIRST_CONTRACT_KEY=DC.CONTRACT_KEY 
    AND DC.INCLUDE_FOR_EXEC_OPS_CLIENTS=1
WHERE R.REFERRED_DATE BETWEEN DATE_TRUNC(MONTH ,DATEADD(MONTH ,-13,CURRENT_DATE)) AND CURRENT_DATE
UNION ALL 
SELECT DISTINCT
DATE_TRUNC('MONTH',R.REFERRED_DATE) AS REFERRED_DATE,
R.CLIENT_KEY,
R.CLIENT_NUMBER ,
R.CLIENT_NAME ,
R.DAYS_TO_SERVICE ,
R.BRANCH_KEY, 
R.FIRST_CONTRACT_KEY AS CONTRACT_KEY,
R.FIRST_PARTNER_CONTRACT_SERVICE_KEY ,
R.TYPE,
R.SOURCE_SYSTEM_ID ,
R.ORIGINAL_SOURCE_SYSTEM_ID 
FROM REPORT.CLIENTS_REFERRED_2_0  R
JOIN DW_PROD.HAH.FACT_PARTNER_CONTRACT_SERVICE PCS ON PCS.PARTNER_CONTRACT_SERVICE_KEY = R.FIRST_PARTNER_CONTRACT_SERVICE_KEY 
JOIN DW_PROD.HAH.DIM_SERVICES S ON PCS.SERVICE_KEY =S.SERVICE_KEY 
WHERE R.REFERRED_DATE BETWEEN DATE_TRUNC(MONTH ,DATEADD(MONTH,-13,CURRENT_DATE)) AND CURRENT_DATE
AND S.REVENUE_CATEGORY NOT IN ('CLS','CC','NA');