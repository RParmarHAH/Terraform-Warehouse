create or replace view DW_PROD.HAH.VW_DIM_BRANCH_MERGED(
	ORIGINAL_BRANCH_KEY,
	ORIGINAL_SOURCE_SYSTEM_ID,
	ORIGINAL_SYSTEM_CODE,
	ORIGINAL_OFFICE_CODE,
	BRANCH_KEY,
	BRANCH_NAME,
	SYSTEM_CODE,
	SOURCE_SYSTEM_ID,
	OFFICE_NUMBER,
	OFFICE_CODE,
	OFFICE_NAME,
	OFFICE_NAME_ALT,
	DEPARTMENT_NAME,
	BRANCH_SERVICE_LINE,
	PARENT_FLAG,
	PARENT_BRANCH_KEY,
	PARENT_OFFICE_NUMBER,
	PARENT_OFFICE_CODE,
	PARENT_BRANCH_NAME,
	OFFICE_ADDRESS1,
	OFFICE_ADDRESS2,
	OFFICE_CITY,
	OFFICE_STATE_CODE,
	OFFICE_ZIP,
	OFFICE_PHONE,
	OFFICE_TOLL_FREE_PHONE,
	OFFICE_FAX,
	DETAILED_OFFICE_NAME,
	REGION_NUMBER,
	REGION_NAME,
	REGION_MANAGER,
	REGION_MANAGER_EMPLOYEE_KEY,
	SUBREGION_NAME,
	PRIMARY_BRANCH_MANAGER_NAME,
	PRIMARY_BRANCH_EMAIL,
	PRIMARY_BRANCH_MANAGER_EMPLOYEE_KEY,
	SECONDARY_BRANCH_MANAGER_NAME,
	SECONDARY_BRANCH_EMAIL,
	SECONDARY_BRANCH_MANAGER_EMPLOYEE_KEY,
	RISKCONNECT_NODE_KEY,
	RISKCONNECT_NAME,
	HR_OFFICE_NUMBER,
	HR_OFFICE_NAME,
	ACTIVE_FLAG,
	EFFECTIVE_FROM_DATE,
	EFFECTIVE_TO_DATE,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG,
	ETL_INFERRED_MEMBER_FLAG,
	PARENT_BRANCH_NAME_SHORTENED
) as
WITH DATAFLEX_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID = 3
), COASTAL_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER 
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID IN (1, 2)
), EXCEL_OFFICES AS (
	SELECT BRANCH_KEY, OFFICE_STATE_CODE, OFFICE_NUMBER 
	FROM HAH.DIM_BRANCH 
	WHERE SOURCE_SYSTEM_ID = 4
), MERGED_OFFICES AS (
	-- Coastal offices
	SELECT DATAFLEX.BRANCH_KEY AS OLD_SYSTEM_BRANCH_KEY, COASTAL.BRANCH_KEY AS NEW_SYSTEM_BRANCH_KEY
	FROM DATAFLEX_OFFICES AS DATAFLEX
	JOIN COASTAL_OFFICES AS COASTAL
		ON COASTAL.OFFICE_STATE_CODE = DATAFLEX.OFFICE_STATE_CODE AND COASTAL.OFFICE_NUMBER = DATAFLEX.OFFICE_NUMBER
	-- Excel offices
	UNION
	SELECT DATAFLEX.BRANCH_KEY AS OLD_SYSTEM_BRANCH_KEY, EXCEL.BRANCH_KEY AS NEW_SYSTEM_BRANCH_KEY
	FROM DATAFLEX_OFFICES AS DATAFLEX
	JOIN EXCEL_OFFICES AS EXCEL
		ON EXCEL.OFFICE_STATE_CODE = DATAFLEX.OFFICE_STATE_CODE AND EXCEL.OFFICE_NUMBER = DATAFLEX.OFFICE_NUMBER
)
	SELECT BRANCH.BRANCH_KEY as ORIGINAL_BRANCH_KEY,
		BRANCH.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		BRANCH.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		BRANCH.OFFICE_CODE AS ORIGINAL_OFFICE_CODE,
		NEW_BRANCH.*,
		TRIM(
		-- Remove Prepended State from Parent_Branch_Name
		REGEXP_REPLACE(
			SUBSTRING(
				NEW_BRANCH.PARENT_BRANCH_NAME,
				1, LEN(NEW_BRANCH.PARENT_BRANCH_NAME) - CHARINDEX('(', REVERSE(NEW_BRANCH.PARENT_BRANCH_NAME)) - 1 -- Remove appended office_code/office_number from Parent_Branch_Name
			)
		, '[A-Z]{2,} -', '', 1, 1)) AS PARENT_BRANCH_NAME_SHORTENED
	FROM HAH.DIM_BRANCH AS BRANCH
	LEFT JOIN MERGED_OFFICES AS MERGED_OFFICES
		ON MERGED_OFFICES.OLD_SYSTEM_BRANCH_KEY = BRANCH.BRANCH_KEY
	LEFT JOIN HAH.DIM_BRANCH AS NEW_BRANCH
		ON NEW_BRANCH.BRANCH_KEY = COALESCE(MERGED_OFFICES.NEW_SYSTEM_BRANCH_KEY, BRANCH.BRANCH_KEY);