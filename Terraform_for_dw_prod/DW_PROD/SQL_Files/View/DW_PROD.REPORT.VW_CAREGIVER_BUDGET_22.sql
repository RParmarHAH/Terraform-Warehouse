create or replace view DW_PROD.REPORT.VW_CAREGIVER_BUDGET_22(
	BRANCH_KEY,
	BRANCH_NAME,
	OFFICE_STATE_CODE,
	SERVICE_MONTH,
	REVENUE_CATEGORY_CODE,
	CAREGIVERS_BUDGETED
) as
WITH CB AS (
SELECT STATE,BRANCH BRANCH_NAME, SUBSTR(REVENUE_CATEGORY,1,2) REVENUE_CATEGORY_CODE,
CASE SERVICE_MONTH
WHEN 'JAN' THEN DATE('2022-01-01')
WHEN 'FEB' THEN DATE('2022-02-01')
WHEN 'MAR' THEN DATE('2022-03-01')
WHEN 'APR' THEN DATE('2022-04-01')
WHEN 'MAY' THEN DATE('2022-05-01')
WHEN 'JUN' THEN DATE('2022-06-01')
WHEN 'JUL' THEN DATE('2022-07-01')
WHEN 'AUG' THEN DATE('2022-08-01')
WHEN 'SEP' THEN DATE('2022-09-01')
WHEN 'OCT' THEN DATE('2022-10-01')
WHEN 'NOV' THEN DATE('2022-11-01')
WHEN 'DEC' THEN DATE('2022-12-01') END SERVICE_MONTH,
CAREGIVERS_BUDGETED FROM REPORT.CAREGIVER_BUDGET_22
UNPIVOT(CAREGIVERS_BUDGETED FOR SERVICE_MONTH IN (JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC))
),
BM AS (
	SELECT BRANCH_KEY,OFFICE_NAME,BRANCH_NAME,CASE
	WHEN BRANCH_NAME LIKE 'A_%' THEN CONCAT(SPLIT_PART(BRANCH_NAME,'_',2),' AD') 
	WHEN BRANCH_NAME='SAVANNAH - SCL' THEN 'SCL SUMMARY'
	WHEN BRANCH_NAME='SAVANNAH CORE' THEN 'SAV CORE'
	WHEN BRANCH_NAME='SAVANNAH-DD' AND SOURCE_SYSTEM_ID=6 THEN 'SAVANNAH DD'
	WHEN BRANCH_NAME='H_INDIANAPOLIS EAST' THEN 'INDIANAPOLIS HOSPICE'
	--WHEN BRANCH_NAME=''
	END ALT_NAME, OFFICE_STATE_CODE
	FROM HAH.DIM_BRANCH
)
SELECT DISTINCT BM.BRANCH_KEY, BM.BRANCH_NAME, BM.OFFICE_STATE_CODE, CB.SERVICE_MONTH, CB.REVENUE_CATEGORY_CODE, CB.CAREGIVERS_BUDGETED FROM CB
LEFT JOIN BM ON 
UPPER(TRIM(BM.OFFICE_NAME)) = UPPER(TRIM(CB.BRANCH_NAME)) OR 
UPPER(TRIM(BM.BRANCH_NAME)) = UPPER(TRIM(CB.BRANCH_NAME)) OR 
UPPER(TRIM(BM.ALT_NAME)) = UPPER(TRIM(CB.BRANCH_NAME));