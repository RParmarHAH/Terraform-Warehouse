create or replace view DW_PROD.INTEGRATION.VW_DIM_EMPLOYEE_MERGED(
	ORIGINAL_EMPLOYEE_KEY,
	ORIGINAL_SOURCE_SYSTEM_ID,
	ORIGINAL_SYSTEM_CODE,
	ORIGINAL_EMPLOYEE_NUMBER,
	ORIGINAL_EMPLOYEE_PID,
	EMPLOYEE_KEY,
	EMPLOYEE_ID,
	SYSTEM_CODE,
	SOURCE_SYSTEM_ID,
	EMPLOYEE_PID,
	EMPLOYEE_NUMBER,
	EMPLOYEE_DOB,
	EMPLOYEE_DATE_OF_DEATH,
	EMPLOYEE_HIRE_DATE,
	EMPLOYEE_REHIRE_DATE,
	EMPLOYEE_BENEFIT_START_DATE,
	EMPLOYEE_FIRST_CHECK_DATE,
	EMPLOYEE_LAST_CHECK_DATE,
	EMPLOYEE_LAST_WORKED_DATE,
	EMPLOYEE_TERMINATE_DATE,
	REASON_TO_TERMINATE,
	ACTIVE_EMPLOYEE_FLAG,
	ABLE_TO_REHIRE_FLAG,
	EMPLOYEE_PREFIX,
	EMPLOYEE_FIRST_NAME,
	EMPLOYEE_MIDDLE_NAME,
	EMPLOYEE_LAST_NAME,
	EMPLOYEE_SUFFIX,
	EMPLOYEE_ADDRESS1,
	EMPLOYEE_ADDRESS2,
	EMPLOYEE_CITY,
	EMPLOYEE_STATE_CODE,
	EMPLOYEE_ZIP,
	EMPLOYEE_HOME_PHONE,
	EMPLOYEE_CELL_PHONE,
	EMPLOYEE_WORK_PHONE,
	EMPLOYEE_PERSONAL_EMAIL,
	EMPLOYEE_WORK_EMAIL,
	LINKED_IN_PROFILE_URL,
	EMPLOYEE_GENDER,
	EMPLOYEE_ETHNICITY,
	HISPANIC_OR_LATINO,
	EMPLOYEE_LANGUAGE,
	EMPLOYEE_MARITAL_STATUS,
	EMPLOYEE_TYPE,
	EMPLOYEE_CATEGORY,
	EXEMPT_FLAG,
	JOB_TITLE,
	JOB_DESCRIPTION,
	CLASS_ID,
	WORKERS_COMP,
	PAYROLL_ID,
	PERCENT_401K_DEDUCTION,
	AMOUNT_401K_DEDUCTION,
	JAZZHR_APPLICANT_ID,
	JAZZHR_USER_ID,
	JAZZHR_CONTACT_ID,
	WORK_STATE,
	SUTA_STATE,
	EMPLOYEE_DEPARTMENT,
	EMPLOYEE_OFFICE_CODE,
	PRIMARY_BRANCH_KEY,
	PRIMARY_BRANCH_STATE,
	PRIMARY_BRANCH_NAME,
	PRIMARY_BRANCH_SYSTEM_CODE,
	CASE_MANAGER_FLAG,
	SUPERVISOR_FLAG,
	COORDINATOR_FLAG,
	LINKED_ID,
	SALARY,
	PAY_RATE,
	EFFECTIVE_FROM_DATE,
	EFFECTIVE_TO_DATE,
	MDM_DIM_EMPLOYEE_KEY,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG,
	ETL_INFERRED_MEMBER_FLAG,
	DERIVED_FIRST_SERVICE_DATE,
	DERIVED_LAST_SERVICE_DATE,
	DERIVED_PAYROLL_FIRST_CHECK_DATE,
	DERIVED_PAYROLL_LAST_CHECK_DATE,
	AMS_SOURCE_SYSTEM,
	PAYROLL_SOURCE_SYSTEM,
	LOCATION_HIERARCHY,
	APPLICANT_ID,
	STATUS,
	DERIVED_EMPLOYEE_HIRE_DATE,
	DERIVED_EMPLOYEE_REHIRE_DATE,
	DERIVED_EMPLOYEE_BENEFIT_START_DATE,
	DERIVED_EMPLOYEE_FIRST_CHECK_DATE,
	DERIVED_EMPLOYEE_LAST_CHECK_DATE,
	DERIVED_EMPLOYEE_LAST_WORKED_DATE,
	DERIVED_ACTIVE_EMPLOYEE_FLAG,
	DERIVED_EMPLOYEE_TERMINATE_DATE
) as
WITH DATAFLEX_EMPLOYEES AS (
	SELECT EMPLOYEE.EMPLOYEE_KEY, LIST.SYSTEM_CODE, EMPLOYEE.EMPLOYEE_PID
	FROM (
		SELECT SOURCE_SYSTEM_ID, IFF(SYSTEM_CODE IN ('GA', 'SC'), 'GA', SYSTEM_CODE) AS SYSTEM_CODE, EMPLOYEE_PID 
		FROM HAH.DIM_EMPLOYEE
		WHERE SOURCE_SYSTEM_ID = 3
		GROUP BY SOURCE_SYSTEM_ID, IFF(SYSTEM_CODE IN ('GA', 'SC'), 'GA', SYSTEM_CODE), EMPLOYEE_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_EMPLOYEE AS EMPLOYEE
		ON EMPLOYEE.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND IFF(EMPLOYEE.SYSTEM_CODE IN ('GA', 'SC'), 'GA', EMPLOYEE.SYSTEM_CODE) = LIST.SYSTEM_CODE AND EMPLOYEE.EMPLOYEE_PID = LIST.EMPLOYEE_PID
), COASTAL_EMPLOYEES AS (
	SELECT EMPLOYEE.EMPLOYEE_KEY, EMPLOYEE.EMPLOYEE_PID
	FROM (
		SELECT EMPLOYEE_PID
		FROM HAH.DIM_EMPLOYEE
		WHERE SOURCE_SYSTEM_ID IN (1, 2)
		GROUP BY EMPLOYEE_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_EMPLOYEE AS EMPLOYEE
		ON EMPLOYEE.SOURCE_SYSTEM_ID IN (1, 2) AND EMPLOYEE.EMPLOYEE_PID = LIST.EMPLOYEE_PID
), EXCEL_EMPLOYEES AS (
	SELECT EMPLOYEE.EMPLOYEE_KEY, EMPLOYEE.EMPLOYEE_PID
	FROM (
		SELECT SOURCE_SYSTEM_ID, EMPLOYEE_PID
		FROM HAH.DIM_EMPLOYEE
		WHERE SOURCE_SYSTEM_ID = 4
		GROUP BY SOURCE_SYSTEM_ID, EMPLOYEE_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_EMPLOYEE AS EMPLOYEE
		ON EMPLOYEE.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND EMPLOYEE.EMPLOYEE_PID = LIST.EMPLOYEE_PID
), CCSI_EMPLOYEES AS ( 
	SELECT EMPLOYEE.EMPLOYEE_KEY, EMPLOYEE.EMPLOYEE_PID
	FROM (
		SELECT SOURCE_SYSTEM_ID, EMPLOYEE_PID
		FROM HAH.DIM_EMPLOYEE
		WHERE SOURCE_SYSTEM_ID = 8 
--		GROUP BY SOURCE_SYSTEM_ID, EMPLOYEE_PID
--		HAVING COUNT(*) = 1  --Removing having clause as duplicate pid filter out and not getting captured in merged ccsi logic
	) LIST
	JOIN HAH.DIM_EMPLOYEE AS EMPLOYEE
		ON EMPLOYEE.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND EMPLOYEE.EMPLOYEE_PID = LIST.EMPLOYEE_PID--) WHERE EMPLOYEE_KEY IN ('0b0dcff5ada77627679826ec217e626f');
), GP_EMPLOYEES AS ( 
	SELECT EMPLOYEE.EMPLOYEE_KEY, EMPLOYEE.EMPLOYEE_PID, EMPLOYEE.SYSTEM_CODE 
	FROM (
		SELECT SOURCE_SYSTEM_ID, EMPLOYEE_PID
		FROM HAH.DIM_EMPLOYEE
		WHERE SOURCE_SYSTEM_ID = 5 
		GROUP BY SOURCE_SYSTEM_ID, EMPLOYEE_PID
		HAVING COUNT(*) = 1
	) LIST
	JOIN HAH.DIM_EMPLOYEE AS EMPLOYEE
		ON EMPLOYEE.SOURCE_SYSTEM_ID = LIST.SOURCE_SYSTEM_ID AND EMPLOYEE.EMPLOYEE_PID = LIST.EMPLOYEE_PID 
),MERGED_EMPLOYEES AS (
	-- Coastal
	SELECT DATAFLEX.EMPLOYEE_KEY AS OLD_SYSTEM_EMPLOYEE_KEY, COASTAL.EMPLOYEE_KEY AS NEW_SYSTEM_EMPLOYEE_KEY
	FROM DATAFLEX_EMPLOYEES AS DATAFLEX
	JOIN COASTAL_EMPLOYEES AS COASTAL
		ON COASTAL.EMPLOYEE_PID = DATAFLEX.EMPLOYEE_PID
	WHERE DATAFLEX.SYSTEM_CODE = 'GA'
	-- Excel
	UNION
	SELECT DATAFLEX.EMPLOYEE_KEY AS OLD_SYSTEM_EMPLOYEE_KEY, EXCEL.EMPLOYEE_KEY AS NEW_SYSTEM_EMPLOYEE_KEY
	FROM DATAFLEX_EMPLOYEES AS DATAFLEX
	JOIN EXCEL_EMPLOYEES AS EXCEL
		ON EXCEL.EMPLOYEE_PID = DATAFLEX.EMPLOYEE_PID
	WHERE DATAFLEX.SYSTEM_CODE = 'PA'
	--Matrixcare
--	UNION 
--	SELECT DATAFLEX_EMP_KEY AS OLD_SYSTEM_EMPLOYEE_KEY, MATRIX_EMP_KEY AS NEW_SYSTEM_EMPLOYEE_KEY
--	FROM INTEGRATION.DATAFLEXSYNCDATA_MATRIXCARE_EMPLOYEE_MAPPING 
),MERGED_CCSI AS (
    SELECT DATAFLEX.EMPLOYEE_KEY AS NEW_SYSTEM_EMPLOYEE_KEY, CCSI.EMPLOYEE_KEY AS OLD_SYSTEM_EMPLOYEE_KEY
	FROM CCSI_EMPLOYEES AS CCSI
	JOIN DATAFLEX_EMPLOYEES AS DATAFLEX
		ON TRIM(CCSI.EMPLOYEE_PID) = TRIM(DATAFLEX.EMPLOYEE_PID)
	WHERE DATAFLEX.SYSTEM_CODE = 'IL'
	)
	SELECT DISTINCT EMPLOYEE.EMPLOYEE_KEY AS ORIGINAL_EMPLOYEE_KEY,
		EMPLOYEE.SOURCE_SYSTEM_ID AS ORIGINAL_SOURCE_SYSTEM_ID,
		EMPLOYEE.SYSTEM_CODE AS ORIGINAL_SYSTEM_CODE,
		EMPLOYEE.EMPLOYEE_NUMBER AS ORIGINAL_EMPLOYEE_NUMBER,
       	EMPLOYEE.EMPLOYEE_PID AS ORIGINAL_EMPLOYEE_PID,
		NEW_EMPLOYEE.EMPLOYEE_KEY,
        NEW_EMPLOYEE.EMPLOYEE_ID,
        NEW_EMPLOYEE.SYSTEM_CODE,
        NEW_EMPLOYEE.SOURCE_SYSTEM_ID,
        NEW_EMPLOYEE.EMPLOYEE_PID,
        NEW_EMPLOYEE.EMPLOYEE_NUMBER,
        NEW_EMPLOYEE.EMPLOYEE_DOB,
        NEW_EMPLOYEE.EMPLOYEE_DATE_OF_DEATH,
        NEW_EMPLOYEE.EMPLOYEE_HIRE_DATE,
        NEW_EMPLOYEE.EMPLOYEE_REHIRE_DATE,
        NEW_EMPLOYEE.EMPLOYEE_BENEFIT_START_DATE,
        NEW_EMPLOYEE.EMPLOYEE_FIRST_CHECK_DATE,
        NEW_EMPLOYEE.EMPLOYEE_LAST_CHECK_DATE,
        NEW_EMPLOYEE.EMPLOYEE_LAST_WORKED_DATE,
        NEW_EMPLOYEE.EMPLOYEE_TERMINATE_DATE,
        NEW_EMPLOYEE.REASON_TO_TERMINATE,
        NEW_EMPLOYEE.ACTIVE_EMPLOYEE_FLAG,
        NEW_EMPLOYEE.ABLE_TO_REHIRE_FLAG,
        NEW_EMPLOYEE.EMPLOYEE_PREFIX,
        NEW_EMPLOYEE.EMPLOYEE_FIRST_NAME,
        NEW_EMPLOYEE.EMPLOYEE_MIDDLE_NAME,
        NEW_EMPLOYEE.EMPLOYEE_LAST_NAME,
        NEW_EMPLOYEE.EMPLOYEE_SUFFIX,
        NEW_EMPLOYEE.EMPLOYEE_ADDRESS1,
        NEW_EMPLOYEE.EMPLOYEE_ADDRESS2,
        NEW_EMPLOYEE.EMPLOYEE_CITY,
        NEW_EMPLOYEE.EMPLOYEE_STATE_CODE,
        NEW_EMPLOYEE.EMPLOYEE_ZIP,
        NEW_EMPLOYEE.EMPLOYEE_HOME_PHONE,
        NEW_EMPLOYEE.EMPLOYEE_CELL_PHONE,
        NEW_EMPLOYEE.EMPLOYEE_WORK_PHONE,
        NEW_EMPLOYEE.EMPLOYEE_PERSONAL_EMAIL,
        NEW_EMPLOYEE.EMPLOYEE_WORK_EMAIL,
        NEW_EMPLOYEE.LINKED_IN_PROFILE_URL,
        NEW_EMPLOYEE.EMPLOYEE_GENDER,
        NEW_EMPLOYEE.EMPLOYEE_ETHNICITY,
        NEW_EMPLOYEE.HISPANIC_OR_LATINO, 
        NEW_EMPLOYEE.EMPLOYEE_LANGUAGE,
        NEW_EMPLOYEE.EMPLOYEE_MARITAL_STATUS,
        NEW_EMPLOYEE.EMPLOYEE_TYPE,
        NEW_EMPLOYEE.EMPLOYEE_CATEGORY,
        NEW_EMPLOYEE.EXEMPT_FLAG,
        NEW_EMPLOYEE.JOB_TITLE,
        NEW_EMPLOYEE.JOB_DESCRIPTION,
        NEW_EMPLOYEE.CLASS_ID,
        NEW_EMPLOYEE.WORKERS_COMP,
        NEW_EMPLOYEE.PAYROLL_ID,
        NEW_EMPLOYEE.PERCENT_401K_DEDUCTION,
        NEW_EMPLOYEE.AMOUNT_401K_DEDUCTION,
        NEW_EMPLOYEE.JAZZHR_APPLICANT_ID,
        NEW_EMPLOYEE.JAZZHR_USER_ID,
        NEW_EMPLOYEE.JAZZHR_CONTACT_ID,
        NEW_EMPLOYEE.WORK_STATE,
        NEW_EMPLOYEE.SUTA_STATE,
        NEW_EMPLOYEE.EMPLOYEE_DEPARTMENT,
        NEW_EMPLOYEE.EMPLOYEE_OFFICE_CODE,
        NEW_EMPLOYEE.PRIMARY_BRANCH_KEY,
        NEW_EMPLOYEE.PRIMARY_BRANCH_STATE,
        NEW_EMPLOYEE.PRIMARY_BRANCH_NAME,
        NEW_EMPLOYEE.PRIMARY_BRANCH_SYSTEM_CODE,
        NEW_EMPLOYEE.CASE_MANAGER_FLAG,
        NEW_EMPLOYEE.SUPERVISOR_FLAG,
        NEW_EMPLOYEE.COORDINATOR_FLAG,
        NEW_EMPLOYEE.LINKED_ID,
        NEW_EMPLOYEE.SALARY,
        NEW_EMPLOYEE.PAY_RATE,
        NEW_EMPLOYEE.EFFECTIVE_FROM_DATE,
        NEW_EMPLOYEE.EFFECTIVE_TO_DATE ,
        NEW_EMPLOYEE.MDM_DIM_EMPLOYEE_KEY,
        NEW_EMPLOYEE.ETL_TASK_KEY,
        NEW_EMPLOYEE.ETL_INSERTED_TASK_KEY,
        NEW_EMPLOYEE.ETL_INSERTED_DATE,
        NEW_EMPLOYEE.ETL_INSERTED_BY,
        NEW_EMPLOYEE.ETL_LAST_UPDATED_DATE,
        NEW_EMPLOYEE.ETL_LAST_UPDATED_BY,
        NEW_EMPLOYEE.ETL_DELETED_FLAG,
        NEW_EMPLOYEE.ETL_INFERRED_MEMBER_FLAG,
		NEW_EMPLOYEE.DERIVED_FIRST_SERVICE_DATE,
	    NEW_EMPLOYEE.DERIVED_LAST_SERVICE_DATE,
	    NEW_EMPLOYEE.DERIVED_PAYROLL_FIRST_CHECK_DATE,
	    NEW_EMPLOYEE.DERIVED_PAYROLL_LAST_CHECK_DATE,
	    NEW_EMPLOYEE.AMS_SOURCE_SYSTEM,
	    NEW_EMPLOYEE.PAYROLL_SOURCE_SYSTEM,
	    NEW_EMPLOYEE.LOCATION_HIERARCHY,
	    NEW_EMPLOYEE.APPLICANT_ID,
	    NEW_EMPLOYEE.STATUS,
		MIN(EMPLOYEE.EMPLOYEE_HIRE_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_HIRE_DATE,
		MAX(EMPLOYEE.EMPLOYEE_REHIRE_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_REHIRE_DATE,
		MAX(EMPLOYEE.EMPLOYEE_BENEFIT_START_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_BENEFIT_START_DATE,
		MIN(EMPLOYEE.EMPLOYEE_FIRST_CHECK_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_FIRST_CHECK_DATE,
		MAX(EMPLOYEE.EMPLOYEE_LAST_CHECK_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_LAST_CHECK_DATE,
		MAX(EMPLOYEE.EMPLOYEE_LAST_WORKED_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_LAST_WORKED_DATE,
		MAX(EMPLOYEE.ACTIVE_EMPLOYEE_FLAG) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_ACTIVE_EMPLOYEE_FLAG,
		MAX(EMPLOYEE.EMPLOYEE_TERMINATE_DATE) OVER (PARTITION BY NEW_EMPLOYEE.EMPLOYEE_KEY) AS DERIVED_EMPLOYEE_TERMINATE_DATE
	FROM HAH.DIM_EMPLOYEE AS EMPLOYEE
	LEFT JOIN MERGED_EMPLOYEES AS MERGED_EMPLOYEES
		ON MERGED_EMPLOYEES.OLD_SYSTEM_EMPLOYEE_KEY = EMPLOYEE.EMPLOYEE_KEY
    LEFT JOIN MERGED_CCSI AS MERGED_CCSI
		ON MERGED_CCSI.OLD_SYSTEM_EMPLOYEE_KEY = EMPLOYEE.EMPLOYEE_KEY
	JOIN HAH.DIM_EMPLOYEE AS NEW_EMPLOYEE
		ON NEW_EMPLOYEE.EMPLOYEE_KEY = COALESCE(MERGED_EMPLOYEES.NEW_SYSTEM_EMPLOYEE_KEY, MERGED_CCSI.NEW_SYSTEM_EMPLOYEE_KEY,EMPLOYEE.EMPLOYEE_KEY);