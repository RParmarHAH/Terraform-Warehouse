create or replace view DW_PROD.STAGE.VW_CURRENT_DELETED_MATRIXCARE_DIM_SUPERVISOR(
	SUPERVISOR_KEY
) as
WITH SUPERVISORS AS
(
	SELECT DISTINCT NVL( mccg.CAR_SUPERVISOR, mccg.CAR_MANAGER) AS SUPERVISOR_CODE,
		MAX( mccg.ETL_LAST_UPDATED_DATE) AS ETL_LAST_UPDATED_DATE
	FROM DISC_PROD.MATRIXCARE.STVHC_T_CAREGIVER mccg
	WHERE NVL( mccg.CAR_SUPERVISOR, mccg.CAR_MANAGER) IS NOT NULL
	GROUP BY 1
)
(SELECT DISTINCT 
	md5( 'MATRIXCARE' || '-' || s.SUPERVISOR_CODE || '-' || 'MATRIXCARE') AS SUPERVISOR_KEY
 FROM SUPERVISORS AS s
 LEFT OUTER JOIN DISC_PROD.MATRIXCARE.HIST_STVHC_T_CAREGIVER mccg
	ON s.SUPERVISOR_CODE = mccg.CAR_ID
 WHERE (mccg.ETL_LAST_UPDATED_DATE >= '1900-01-01' OR s.ETL_LAST_UPDATED_DATE >= '1900-01-01')
 	AND mccg.ETL_DELETED_FLAG = TRUE
 	AND CAST( mccg.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT MAX( ETL_LAST_UPDATED_DATE::DATE) FROM DISC_PROD.MATRIXCARE.HIST_STVHC_T_CAREGIVER)
);