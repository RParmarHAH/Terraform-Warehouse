create or replace view DW_PROD.REPORT.VW_COVID_19_ONHOLDASOFDATE_DATAFLEX(
	STATE,
	OFFICENAME,
	ONHOLDSTARTDATE,
	CLIENTID
) as
SELECT DISTINCT
OFFICE_STATE_CODE as State,
OFFICE_NAME AS OfficeName,
DT.Calendar_Date as OnHoldStartDate,
v.client_key as clientid
  FROM HAH.FACT_VISIT V
      JOIN HAH.DIM_CLIENT CL
          ON V.SOURCE_SYSTEM_ID = CL.SOURCE_SYSTEM_ID
             AND V.CLIENT_KEY = CL.CLIENT_KEY
       JOIN HAH.DIM_BRANCH b
            ON V.SOURCE_SYSTEM_ID = B.SOURCE_SYSTEM_ID
            AND V.BRANCH_KEY = B.BRANCH_KEY
       JOIN HAH.DIM_CONTRACT C
        on V.SOURCE_SYSTEM_ID = C.SOURCE_SYSTEM_ID
        AND C.CONTRACT_KEY = V.CONTRACT_KEY
      JOIN HAH.DIM_Date AS dt 
           ON dt.Calendar_Date BETWEEN IFNULL(CL.On_Hold_Start_Date, DATEADD( DAY, 1, CURRENT_DATE)) 
           AND IFNULL( CL.On_Hold_End_Date, DATEADD( DAY, 1, CURRENT_DATE)) 
WHERE dt.Calendar_Date 
BETWEEN CAST( '2020-01-01' AS DATE) AND CURRENT_DATE 
AND V.SOURCE_SYSTEM_ID = 3 AND C.BILLABLE_FLAG = TRUE AND C.PAYABLE_FLAG = TRUE
AND C.REVENUE_CATEGORY <> 'CLS' AND NVL(MILEAGE_FLAG,FALSE) = FALSE AND 
CONTRACT_NAME NOT LIKE '%TRANSPORT%' AND CONTRACT_NAME NOT LIKE '%DRUG%'
AND CONTRACT_NAME NOT LIKE '%DCFS%'
--BETWEEN CAST( '2020-01-01' AS DATE) AND CURRENT_DATE 
--GROUP BY State,OfficeName,OnHoldStartDate
;