create or replace view DW_PROD.REPORT.EMPLOYEE_DERIVED_MONTHLY_VISIT_METRICS_W_BILLABLE_MASTER_EMP_KEY(
	SERVICE_MONTH,
	ORG_EMPLOYEE_KEY,
	EMPLOYEE_KEY,
	ORIGINAL_SOURCE_SYSTEM_ID,
	SOURCE_SYSTEM_ID,
	EMPLOYEE_ID,
	SYSTEM_CODE,
	EMPLOYEE_PID,
	EMPLOYEE_NUMBER,
	PAYROLL_ID,
	EMPLOYEE_CATEGORY,
	DERIVED_EMPLOYEE_CATEGORY,
	FIRST_NAME,
	LAST_NAME,
	EMPLOYEE_DOB,
	EMPLOYEE_GENDER,
	EMPLOYEE_ETHNICITY,
	CCSI_FLAG,
	BRANCH_KEY,
	BRANCH_NAME,
	BRANCH_STATE_CODE,
	FIRST_SERVICE_MONTH,
	LAST_SERVICE_MONTH,
	TENURE_IN_MONTHS,
	NUMBER_MONTHS_WITH_SERVICE,
	NUMBER_MONTHS_WO_SERVICE,
	NUMBER_OF_GAPS_IN_SERVICE,
	SMALLEST_GAP_IN_SERVICE,
	LARGEST_GAP_IN_SERVICE,
	NEW_HIRE_FLAG,
	FIRST_MONTH_INACTIVE_FLAG,
	ACTIVE_FLAG,
	REACTIVATED_FLAG,
	NUMBER_OF_SERVICE_LINES_PROVIDED,
	HC_SERVICE_LINE_PROVIDED,
	HH_SERVICE_LINE_PROVIDED,
	CLS_SERVICE_LINE_PROVIDED,
	NA_SERVICE_LINE_PROVIDED,
	IS_SERVICE_LINE_PROVIDED,
	NS_SERVICE_LINE_PROVIDED,
	OTHER_SERVICE_LINE_PROVIDED,
	NUMBER_OF_VISITS,
	PREVIOUS_MONTH_NUMBER_OF_VISITS,
	PREVIOUS_2_MONTH_NUMBER_OF_VISITS,
	NEXT_MONTH_NUMBER_OF_VISITS,
	NEXT_2_MONTH_NUMBER_OF_VISITS,
	NUMBER_OF_DISTINCT_CLIENTS,
	PREVIOUS_MONTH_NUMBER_OF_DISTINCT_CLIENTS,
	PREVIOUS_2_MONTH_NUMBER_OF_DISTINCT_CLIENTS,
	NEXT_MONTH_NUMBER_OF_DISTINCT_CLIENTS,
	NEXT_2_MONTH_NUMBER_OF_DISTINCT_CLIENTS,
	SUM_OF_HOURS_SERVED,
	PREVIOUS_MONTH_SUM_OF_HOURS_SERVED,
	PREVIOUS_2_MONTH_SUM_OF_HOURS_SERVED,
	NEXT_MONTH_SUM_OF_HOURS_SERVED,
	NEXT_2_MONTH_SUM_OF_HOURS_SERVED,
	NUMBER_OF_HC_VISITS,
	NUMBER_OF_DISTINCT_HC_CLIENTS,
	SUM_OF_HC_HOURS_SERVED,
	NUMBER_OF_HH_VISITS,
	NUMBER_OF_DISTINCT_HH_CLIENTS,
	SUM_OF_HH_HOURS_SERVED,
	NUMBER_OF_CLS_VISITS,
	NUMBER_OF_DISTINCT_CLS_CLIENTS,
	SUM_OF_CLS_HOURS_SERVED,
	NUMBER_OF_NA_VISITS,
	NUMBER_OF_DISTINCT_NA_CLIENTS,
	SUM_OF_NA_HOURS_SERVED,
	NUMBER_OF_IS_VISITS,
	NUMBER_OF_DISTINCT_IS_CLIENTS,
	SUM_OF_IS_HOURS_SERVED,
	NUMBER_OF_NS_VISITS,
	NUMBER_OF_DISTINCT_NS_CLIENTS,
	SUM_OF_NS_HOURS_SERVED,
	NUMBER_OF_OTHER_VISITS,
	NUMBER_OF_DISTINCT_OTHER_CLIENTS,
	SUM_OF_OTHER_HOURS_SERVED
) as
SELECT distinct SERVICE_MONTH,  --COUNT:2,872,623 SUM: 260,320,129 DIST_EMP:121,708
FIRST_VALUE(EMP_MAP.Original_EMPLOYEE_KEY) OVER (PARTITION BY EMP_MAP.Employee_Key ORDER BY IFF(EMP_MAP.ORIGINAL_EMPLOYEE_KEY <> EMP_MAP.EMPLOYEE_KEY, 0, 1)) AS ORG_EMPLOYEE_KEY, 
EDM_BILL.EMPLOYEE_KEY,EDM_BILL.ORIGINAL_SOURCE_SYSTEM_ID,
EDM_BILL.SOURCE_SYSTEM_ID, EDM_BILL.EMPLOYEE_ID, EDM_BILL.SYSTEM_CODE, EDM_BILL.EMPLOYEE_PID, EDM_BILL.EMPLOYEE_NUMBER, 
EDM_BILL.PAYROLL_ID, EDM_BILL.EMPLOYEE_CATEGORY, EDM_BILL.DERIVED_EMPLOYEE_CATEGORY , 
EDM_BILL.FIRST_NAME, EDM_BILL.LAST_NAME, EDM_BILL.EMPLOYEE_DOB, 
EDM_BILL.EMPLOYEE_GENDER, EDM_BILL.EMPLOYEE_ETHNICITY, 
EDM_BILL.CCSI_FLAG,
EDM_BILL.BRANCH_KEY, EDM_BILL.BRANCH_NAME, EDM_BILL.BRANCH_STATE_CODE, 
EDM_BILL.FIRST_SERVICE_MONTH, EDM_BILL.LAST_SERVICE_MONTH,EDM_BILL.TENURE_IN_MONTHS, NUMBER_MONTHS_WITH_SERVICE, NUMBER_MONTHS_WO_SERVICE, NUMBER_OF_GAPS_IN_SERVICE, SMALLEST_GAP_IN_SERVICE, LARGEST_GAP_IN_SERVICE, NEW_HIRE_FLAG, FIRST_MONTH_INACTIVE_FLAG, ACTIVE_FLAG, REACTIVATED_FLAG, NUMBER_OF_SERVICE_LINES_PROVIDED, HC_SERVICE_LINE_PROVIDED, HH_SERVICE_LINE_PROVIDED, CLS_SERVICE_LINE_PROVIDED, NA_SERVICE_LINE_PROVIDED, IS_SERVICE_LINE_PROVIDED, NS_SERVICE_LINE_PROVIDED,OTHER_SERVICE_LINE_PROVIDED, NUMBER_OF_VISITS, PREVIOUS_MONTH_NUMBER_OF_VISITS, PREVIOUS_2_MONTH_NUMBER_OF_VISITS, NEXT_MONTH_NUMBER_OF_VISITS, NEXT_2_MONTH_NUMBER_OF_VISITS, NUMBER_OF_DISTINCT_CLIENTS, PREVIOUS_MONTH_NUMBER_OF_DISTINCT_CLIENTS, PREVIOUS_2_MONTH_NUMBER_OF_DISTINCT_CLIENTS, NEXT_MONTH_NUMBER_OF_DISTINCT_CLIENTS, NEXT_2_MONTH_NUMBER_OF_DISTINCT_CLIENTS, SUM_OF_HOURS_SERVED, PREVIOUS_MONTH_SUM_OF_HOURS_SERVED, PREVIOUS_2_MONTH_SUM_OF_HOURS_SERVED, NEXT_MONTH_SUM_OF_HOURS_SERVED, NEXT_2_MONTH_SUM_OF_HOURS_SERVED, NUMBER_OF_HC_VISITS, NUMBER_OF_DISTINCT_HC_CLIENTS, SUM_OF_HC_HOURS_SERVED, NUMBER_OF_HH_VISITS, NUMBER_OF_DISTINCT_HH_CLIENTS, SUM_OF_HH_HOURS_SERVED, NUMBER_OF_CLS_VISITS, NUMBER_OF_DISTINCT_CLS_CLIENTS, SUM_OF_CLS_HOURS_SERVED, NUMBER_OF_NA_VISITS, NUMBER_OF_DISTINCT_NA_CLIENTS, SUM_OF_NA_HOURS_SERVED, NUMBER_OF_IS_VISITS, NUMBER_OF_DISTINCT_IS_CLIENTS, SUM_OF_IS_HOURS_SERVED, NUMBER_OF_NS_VISITS, NUMBER_OF_DISTINCT_NS_CLIENTS, SUM_OF_NS_HOURS_SERVED,
NUMBER_OF_OTHER_VISITS,
NUMBER_OF_DISTINCT_OTHER_CLIENTS,
SUM_OF_OTHER_HOURS_SERVED
FROM REPORT.EMPLOYEE_DERIVED_MONTHLY_VISIT_METRICS_W_BILLABLE EDM_BILL 
LEFT JOIN INTEGRATION.DIM_EMPLOYEE_MERGED EMP_MAP on EMP_MAP.EMPLOYEE_KEY=EDM_BILL.EMPLOYEE_KEY;