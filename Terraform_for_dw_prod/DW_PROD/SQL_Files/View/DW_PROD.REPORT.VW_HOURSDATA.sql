create or replace view DW_PROD.REPORT.VW_HOURSDATA(
	DETAILED_OFFICE_NAME,
	OFFICE_STATE_CODE,
	SERVICELINE,
	CALENDAR_DATE,
	OFFICE_NUMBER,
	BUDGETEDHOURSMONTH,
	BUDGETEDHOURS,
	ACTUALHOURS,
	TOTALDAYSOFMONTHSOFAR
) as
WITH PAYROLLPERIODS
AS
(
SELECT OFFICE_STATE_CODE AS STATE,CAST(MAX(PERIOD_END_DATE) AS DATE) as PERIODEND
FROM HAH.FACT_BRANCH_PAYROLL_PERIODS o       
WHERE CHECK_DATE < Current_Date() -- This should be CheckDate NOT PeriodEnd, it takes a while for all the timesheets to be entered
group by OFFICE_STATE_CODE
),
DIMDATE
AS
(
  select CALENDAR_DATE,FIRST_DAY_OF_MONTH,
  DATEDIFF(day,FIRST_DAY_OF_MONTH,LAST_DAY_OF_MONTH) + 1 AS MONTHDAYS,
  CASE WHEN DATEDIFF(MONTH,CALENDAR_DATE,PERIODEND) = 0 THEN 
  DATEDIFF(day,FIRST_DAY_OF_MONTH,PERIODEND) + 1 ELSE 
  DATEDIFF(day,FIRST_DAY_OF_MONTH,LAST_DAY_OF_MONTH) + 1 END TOTALDAYSOFMONTHSOFAR ,STATE,PERIODEND
  FROM
  DW_PROD.hah.dim_date
  cross join 
  (select state,PERIODEND from PAYROLLPERIODS) PAYROLLPERIODS
  where CALENDAR_DATE > '2019-12-31' and CALENDAR_DATE <= PERIODEND
  --GROUP BY CALENDAR_DATE,FIRST_DAY_OF_MONTH,LAST_DAY_OF_MONTH
),
BUDGET
AS
(
  SELECT BRANCH.BRANCH_KEY,BRANCH.DETAILED_OFFICE_NAME,BRANCH.OFFICE_STATE_CODE,SERVICELINE,CALENDAR_DATE,VALUE,
  MONTHDAYS,TOTALDAYSOFMONTHSOFAR,BRANCH.OFFICE_NUMBER,
  CASE WHEN VALUE = 0 THEN 0 ELSE VALUE/MONTHDAYS END AS BUDGETEDHOURS
  FROM DIMDATE
  --DIMDATE
  LEFT JOIN
  "DISC_DEV"."BI_REPOSITORY"."KMOFFICEBUDGETS" OFFICEBUDGET
  ON CAST(OFFICEBUDGET.MONTH AS DATE) = CAST(FIRST_DAY_OF_MONTH AS DATE)
  AND TRIM(OFFICEBUDGET.DBNAME) = DIMDATE.STATE
  INNER JOIN
  "DW_DEV"."HAH"."DIM_SOURCE_SYSTEM" SOURCESYSTEM
  ON SOURCESYSTEM.BUDGET_SYSTEM_CODE = OFFICEBUDGET.SOURCE
  INNER JOIN
   (
      select DISTINCT SOURCE_SYSTEM_ID,BRANCH_KEY,DETAILED_OFFICE_NAME,OFFICE_STATE_CODE,
       CASE WHEN SYSTEM_CODE = '8485' THEN 'PA' ELSE SYSTEM_CODE END as SYSTEM_CODE,OFFICE_NUMBER 
        from HAH.DIM_BRANCH
    )BRANCH 
  ON BRANCH.OFFICE_NUMBER = TRIM(OFFICEBUDGET.OFFICENUMBER)
  AND BRANCH.SYSTEM_CODE = TRIM(OFFICEBUDGET.DBNAME)
  AND BRANCH.SOURCE_SYSTEM_ID = SOURCESYSTEM.SOURCE_SYSTEM_ID
  WHERE TRIM(METRIC) = 'H' -- Filtering only for hours
),
VISITHOURDATA
AS
(
    select SERVICE_DATE,REVENUE_CATEGORY,
    ---COMBINIG WARRINGTON TO PHILADELPHIA
    CASE WHEN VISIT.BRANCH_KEY = '7720221ce6c4c024d83b150bb1db2fac' THEN 
  '48959194ec91cc1be0c583385dc46141' ELSE VISIT.BRANCH_KEY END AS BRANCH_KEY ,VISIT.SYSTEM_CODE,
    SUM(HOURS_SERVED) AS HOURS 
    from DW_PROD.HAH.FACT_VISIT VISIT
    inner join 
    (SELECT CONTRACT_KEY, 
     CONTRACT_CODE,contract_name,
     CASE WHEN SOURCE_SYSTEM_ID = 4 THEN 'HC' ELSE REVENUE_CATEGORY END AS REVENUE_CATEGORY,
     CASE WHEN SOURCE_SYSTEM_ID = 4 THEN TRUE ELSE BILLABLE_FLAG END AS BILLABLE_FLAG,
     CASE WHEN CONTRACT_STATE_CODE = 'AL' AND  CONTRACT_CODE = 'Z2' THEN TRUE
          WHEN CONTRACT_STATE_CODE = 'MO' AND CONTRACT_CODE = 'MI' THEN TRUE 
          WHEN SOURCE_SYSTEM_ID = 4 THEN FALSE 
          ELSE MILEAGE_FLAG END AS MILEAGE_FLAG
     FROM DW_PROD.HAH.DIM_CONTRACT) CONTRACT 
    ON CONTRACT.CONTRACT_KEY = VISIT.CONTRACT_KEY
    AND BILLABLE_FLAG = TRUE and NVL(MILEAGE_FLAG,FALSE) = FALSE
    AND CONTRACT.CONTRACT_KEY NOT IN 
    (
      select distinct contract_KEY from hah.dim_contract where upper(contract_name) like '%DCFS%' or 
      upper(contract_name) like '%DRUG%' or upper(contract_name) like '%TRANSPORT%'
    )
    
    INNER JOIN 
    (
      select DISTINCT SOURCE_SYSTEM_ID,BRANCH_KEY,DETAILED_OFFICE_NAME,OFFICE_STATE_CODE,
       CASE WHEN SYSTEM_CODE = '8485' THEN 'PA' ELSE SYSTEM_CODE END as SYSTEM_CODE,OFFICE_NUMBER 
        from HAH.DIM_BRANCH
    )BRANCH
    ON BRANCH.BRANCH_KEY = VISIT.BRANCH_KEY
    INNER JOIN PAYROLLPERIODS
    ON SERVICE_DATE >= '2020-01-01' AND SERVICE_DATE <= PayrollPeriods.PeriodEnd -- this should be the end of the period not CURRENT_DATE() 
    AND PAYROLLPERIODS.STATE = BRANCH.OFFICE_STATE_CODE
    GROUP BY SERVICE_DATE,REVENUE_CATEGORY, CASE WHEN VISIT.BRANCH_KEY = '7720221ce6c4c024d83b150bb1db2fac' THEN 
  '48959194ec91cc1be0c583385dc46141' ELSE VISIT.BRANCH_KEY END,VISIT.SYSTEM_CODE
)
SELECT distinct DETAILED_OFFICE_NAME,OFFICE_STATE_CODE,TRIM(SERVICELINE) AS SERVICELINE,CALENDAR_DATE,OFFICE_NUMBER,

VALUE/TOTALDAYSOFMONTHSOFAR AS BUDGETEDHOURSMONTH,
BUDGETEDHOURS, HOURS AS ACTUALHOURS,
TOTALDAYSOFMONTHSOFAR
--SELECT *, (Budget.BudgetedHours - VisitHourData.Hours) AS Difference
FROM BUDGET
LEFT OUTER JOIN VISITHOURDATA
ON VISITHOURDATA.SERVICE_DATE = BUDGET.CALENDAR_DATE
AND VISITHOURDATA.REVENUE_CATEGORY = TRIM(BUDGET.SERVICELINE)
AND VISITHOURDATA.BRANCH_KEY = BUDGET.BRANCH_KEY
where TRIM(SERVICELINE) != 'CLS' and OFFICE_STATE_CODE not in ('SC','GA')
;