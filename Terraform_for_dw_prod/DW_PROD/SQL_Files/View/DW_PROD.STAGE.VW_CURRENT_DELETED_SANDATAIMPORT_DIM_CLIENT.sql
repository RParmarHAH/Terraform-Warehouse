create or replace view DW_PROD.STAGE.VW_CURRENT_DELETED_SANDATAIMPORT_DIM_CLIENT(
	CLIENT_KEY
) as
WITH VISIT AS (
    SELECT
        F.SYSTEM_CODE AS AGENCYID,
        F.CLIENT_NUMBER AS CLIENTID,
        MAX(F.SERVICE_DATE) AS LAST_TIMEOUT,
        MIN(F.SERVICE_DATE) AS FIRST_TIMEIN,
        MAX(F.ETL_LAST_UPDATED_DATE) AS ETL_LAST_UPDATED_DATE
    FROM HAH.FACT_VISIT F
	WHERE F.SYSTEM_CODE = '8485' AND F.CONFIRMED_FLAG='YES'
-- F.STATUS_CODE IN ('02', '03','04', '05')
    GROUP BY 1,2
),
--added by mohan kewlani on 10-21-2022
 CA_PHW AS  (
SELECT IFF(ADMISSIONTYPE='PHW',1,2) AS TOD,*
FROM DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS WHERE AGENCYID=8485)
,
CA_CMB AS (
SELECT ROW_NUMBER() OVER (PARTITION BY T.CLIENTID ORDER BY TOD,MRN) AS RNUM,
		T.CLIENTID,
        T.AGENCYID,
        T.TOD,
        T.ADMISSIONTYPE,
        FIRST_VALUE(IFF(LENGTH (T.MRN)>0 ,LPAD(trim(t.MRN,'~'),10,'0'),'')) OVER (PARTITION BY T.CLIENTID  ORDER BY T.TOD ASC,T.UPDATEDAT DESC) MRN,
        T.ROC AS ROC,
        t.SOC AS SOC,
		T.UPDATEDAT as UPDATEDAT,
        T.ID AS ID FROM CA_PHW T      
        ) ,
 serv as (SELECT    
      	t.CLIENTID,
      	t.AGENCYID,
      	MIN(t.ROC) AS ROC,
     	MIN(t.SOC) AS SOC,
		MIN(t.MRN) AS MRN,
    	MAX(T.UPDATEDAT) as UPDATEDAT,
    	MAX(T.ID) AS max_ID     
      	FROM CA_CMB   t
      	GROUP BY t.CLIENTID,
     			 t.AGENCYID),    
--serv as (
 --   SELECT
   --     t.CLIENTID,
    --    t.AGENCYID,
    --    MIN(t.ROC) AS ROC,
    --    MIN(t.SOC) AS SOC,
	--	MIN(t.MRN) AS MRN,
     --   MAX(UPDATEDAT) as UPDATEDAT,
     --   MAX(ID) AS max_ID
   -- FROM DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS t
   -- WHERE t.AGENCYID = 8485
   -- GROUP BY 1, 2
  --  ),
hold_status AS (
   SELECT * FROM (SELECT 
    a.CLIENTID,
    a.AGENCYID,
    a.ADMISSIONSTATUS AS STATUS_CODE,
    ETL_LAST_UPDATED_DATE,
    ROW_NUMBER() OVER (PARTITION BY CLIENTID ORDER BY ETL_LAST_UPDATED_DATE DESC) AS RN
   FROM DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS a 
   WHERE a.AGENCYID = 8485) WHERE RN=1
  ),
coord as (
    SELECT
        t.CLIENTID,
        t.AGENCYID,
        MAX(nvl(Coordinators.STAFFID::string, 'Unknown-' || nvl(t.agencyID,'S'))) AS CURRENT_SUPERVISOR_CODE,
        MAX(TO_CHAR(Coordinators.LASTNAME) || ', ' || TO_CHAR(Coordinators.FIRSTNAME) || ' ' || TO_CHAR(Coordinators.MIDDLEINITIAL)) AS CURRENT_SUPERVISOR_NAME
    FROM DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS t
    INNER JOIN serv s
        on t.CLIENTID = s.CLIENTID
        and t.AGENCYID = s.AGENCYID
        and t.ID = s.max_ID
    LEFT JOIN DISC_PROD.SANDATAIMPORT.SANDATA_STAFFS Coordinators
        ON Coordinators.agencyID = t.agencyID
        AND Coordinators.staffID = t.CoordinatorID
    WHERE t.AGENCYID = 8485
    GROUP BY 1,2
    )
SELECT
      md5(C.AGENCYID || '-' || C.MASTER_ID || '-'  ||  'SANDATAIMPORT' ) AS CLIENT_KEY
FROM DISC_DEDUPE_PROD.SANDATAIMPORT.CLIENT_MASTER_LIST C
LEFT JOIN VISIT
    ON VISIT.AGENCYID = C.AGENCYID
    AND VISIT.CLIENTID = C.CLIENTID
LEFT JOIN serv serv
    ON serv.AGENCYID = C.AGENCYID
    AND serv.CLIENTID = C.CLIENTID
LEFT JOIN coord coord
        ON coord.AGENCYID = C.AGENCYID
    AND coord.CLIENTID = C.CLIENTID
LEFT JOIN hold_status
    ON hold_status.AGENCYID = C.AGENCYID
    AND hold_status.CLIENTID = C.CLIENTID
LEFT JOIN HAH.DIM_STATE S ON S.STATE_ISO_CODE=UPPER(TRIM(C.STATE))
WHERE C.AGENCYID = 8485
AND (C.ETL_LAST_UPDATED_DATE >= '1900-01-01' OR hold_status.ETL_LAST_UPDATED_DATE >= '1900-01-01' OR VISIT.ETL_LAST_UPDATED_DATE >= '1900-01-01')
	AND C.ETL_DELETED_FLAG = TRUE
	AND CAST(C.ETL_LAST_UPDATED_DATE AS DATE) IN (SELECT CAST(MAX(ETL_LAST_UPDATED_DATE) AS DATE) FROM DISC_PROD.SANDATAIMPORT.HIST_SANDATA_CLIENTS);