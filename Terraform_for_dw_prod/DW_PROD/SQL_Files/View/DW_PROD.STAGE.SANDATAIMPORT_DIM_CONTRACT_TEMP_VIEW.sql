create or replace view DW_PROD.STAGE.SANDATAIMPORT_DIM_CONTRACT_TEMP_VIEW(
	CONTRACT_KEY,
	CONTRACT_CODE,
	SYSTEM_CODE,
	SOURCE_SYSTEM_ID,
	CONTRACT_NAME,
	SERVICE_CODE_ID,
	SERVICE_KEY,
	DEFAULT_BILL_CODE,
	PAYROLL_CODE,
	REVENUE_CATEGORY,
	REVENUE_SUBCATEGORY_CODE,
	REVENUE_SUBCATEGORY_NAME,
	PAYOR_CODE,
	PAYOR_DESCRIPTION,
	SERVICE_LINE_CODE,
	SERVICE_LINE_DESCRIPTION,
	CONTRACT_STATE_CODE,
	TIME_TRANSLATION_CODE,
	TIME_TRANSLATION_DIVIDER,
	PAY_TRAVELS_CODE,
	MILEAGE_FLAG,
	PAYABLE_FLAG,
	BILLABLE_FLAG,
	BILLED_BY_QUARTER_HOURS,
	BILLED_BY_HALF_HOURS,
	EFFECTIVE_FROM_DATE,
	EFFECTIVE_TO_DATE,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG,
	ETL_INFERRED_MEMBER_FLAG
) as 
WITH MAPPING AS 
(
SELECT DISTINCT
SANDATA_ADMSN.SERVICEID,
		CA.ADMISSIONTYPE AS CONTRACT_CODE,
		
		 CA.AGENCYID   AS SYSTEM_CODE,
		
		COALESCE(M.CONTRACT_NAME, 'Unknown') AS CONTRACT_NAME,
		
		CASE WHEN SANDATA_ADMSN.SERVICEID IN('CARECO','VBPCG')
				THEN 'CC'
			ELSE COALESCE(M.REVENUE_CATEGORY, 'HC') END AS REVENUE_CATEGORY,
		
		CASE WHEN SANDATA_ADMSN.SERVICEID IN('CARECO','VBPCG')
				THEN 'CC'
			ELSE COALESCE(M.REVENUE_SUBCATEGORY_CODE, 'HC')  END AS REVENUE_SUBCATEGORY_CODE,
			
		CASE WHEN  SANDATA_ADMSN.SERVICEID IN('CARECO','VBPCG')
			THEN 'CARE COORDINATE'
			ELSE COALESCE(M.REVENUE_SUBCATEGORY_NAME, 'HOME CARE') END AS REVENUE_SUBCATEGORY_NAME,
			
		 
		COALESCE(M.BILLABLE_FLAG, TRUE) AS BILLABLE_FLAG,
		COALESCE(M.PAYABLE_FLAG, TRUE) AS PAYABLE_FLAG,
		COALESCE(M.MILEAGE_FLAG, FALSE) AS MILEAGE_FLAG,
		CASE WHEN SANDATA_ADMSN.SERVICEID IN('CARECO','VBPCG')
			THEN 'CARECO'
			ELSE NULL END AS SERVICE
    FROM DISC_PROD.SANDATAIMPORT.SANDATA_CLIENTADMISSIONS CA
    LEFT JOIN DW_PROD.HAH.FACT_REVENUE_SUBCATEGORY_CONTRACT_MAPPING M
    	ON M.SOURCE_SYSTEM_ID = 4 AND M.SYSTEM_CODE = CA.AGENCYID AND M.CONTRACT_CODE = CA.ADMISSIONTYPE
    LEFT JOIN DISC_PROD.SANDATAIMPORT.SANDATA_ADMISSIONSERVICES SANDATA_ADMSN 
    	ON SANDATA_ADMSN.ADMISSIONID = CA.ADMISSIONID
	WHERE CA.AGENCYID = '8485'
	)
SELECT DISTINCT 
	CASE WHEN SERVICE IN ('CARECO')
	THEN md5('CC_'||C.SYSTEM_CODE || '-' || C.CONTRACT_CODE || '-'  ||  'SANDATAIMPORT')
	ELSE md5(C.SYSTEM_CODE || '-' || C.CONTRACT_CODE || '-'  ||  'SANDATAIMPORT')
	END AS CONTRACT_KEY
    , C.CONTRACT_CODE,
    CASE WHEN SERVICE IN ('CARECO') THEN 'CC_'||C.SYSTEM_CODE
    	ELSE C.SYSTEM_CODE END AS SYSTEM_CODE
    ,4 AS SOURCE_SYSTEM_ID
    ,C.CONTRACT_NAME
    ,NULL AS SERVICE_CODE_ID
	,NULL AS SERVICE_KEY
    ,null AS DEFAULT_BILL_CODE -- Can get bill code from openSam but some are nulls
    ,null AS PAYROLL_CODE
    ,C.REVENUE_CATEGORY
	,C.REVENUE_SUBCATEGORY_CODE
	,C.REVENUE_SUBCATEGORY_NAME
    ,C.REVENUE_CATEGORY AS PAYOR_CODE
    ,C.REVENUE_CATEGORY || ' - ' || C.REVENUE_SUBCATEGORY_NAME AS PAYOR_DESCRIPTION
    ,C.REVENUE_CATEGORY AS SERVICE_LINE_CODE
    ,C.REVENUE_CATEGORY || ' - ' || C.REVENUE_SUBCATEGORY_NAME AS SERVICE_LINE_DESCRIPTION
    ,CASE WHEN C.SYSTEM_CODE = '8485' THEN 'PA' 
    	WHEN C.SYSTEM_CODE = 'CC_8485' THEN 'PA' ELSE NULL END AS CONTRACT_STATE_CODE -- Get need to extrnal id table
    ,'1HR' AS TIME_TRANSLATION_CODE
    ,1 AS TIME_TRANSLATION_DIVIDER
	,NULL AS PAY_TRAVELS_CODE         
    ,C.MILEAGE_FLAG AS MILEAGE_FLAG
    ,C.PAYABLE_FLAG AS PAYABLE_FLAG
    ,C.BILLABLE_FLAG AS BILLABLE_FLAG
	,NULL AS BILLED_BY_QUARTER_HOURS
	,NULL AS BILLED_BY_HALF_HOURS
    ,TO_DATE('1900-01-01', 'YYYY-MM-DD') AS EFFECTIVE_FROM_DATE
    ,TO_DATE('9999-12-31', 'YYYY-MM-DD') AS EFFECTIVE_TO_DATE,
    
    '63013' AS ETL_TASK_KEY,
    '63013' AS  ETL_INSERTED_TASK_KEY,
        
    convert_timezone('UTC', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_INSERTED_DATE,
    CURRENT_USER as ETL_INSERTED_BY ,
    convert_timezone('UTC', CURRENT_TIMESTAMP)::timestamp_ntz as ETL_LAST_UPDATED_DATE,
    CURRENT_USER as ETL_LAST_UPDATED_BY,
    0 as ETL_DELETED_FLAG,
    0 AS ETL_INFERRED_MEMBER_FLAG
 FROM MAPPING AS C WHERE SERVICE IN ('CARECO');