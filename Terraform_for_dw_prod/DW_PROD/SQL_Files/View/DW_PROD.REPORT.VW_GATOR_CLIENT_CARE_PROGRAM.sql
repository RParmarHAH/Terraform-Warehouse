create or replace view DW_PROD.REPORT.VW_GATOR_CLIENT_CARE_PROGRAM(
	ACCOUNT_ID,
	CLIENT_KEY,
	ORIGINAL_CLIENT_KEY,
	BRANCH_KEY,
	CLIENT_FIRST_NAME,
	CLIENT_LAST_NAME,
	CARE_PROGRAM_NAME,
	CARE_PROGRAM_CODE,
	CLIENT_CARE_PROGRAM_STATUS,
	ROSTER_DISQUALIFICATION,
	GEOGRAPHY_DISQUALIFICATION,
	CARE_ACTIVE_DISQUALIFICATION,
	OPT_OUT_FLAG,
	OPT_OUT_REASON
) as
------------------------------------------------------------------------------------------------------------------------------
/*
Object Type : 	View
Object Name	: 	VW_GATOR_CLIENT_CARE_PROGRAM
Author		:	Mohit Vaghadiya
Description :
	- Provides Client Care Program Information from Gator
*/
--*****************************************************************************************************************************
-- CHANGE LOG :
-- Version	Date(MM/DD/YYYY)	Author				Change Description
-- --------	----------------   	------------------	---------------------------------------------------------------------------
-- 1.0		09/08/2023   		Mohit Vaghadiya		Initial development
-- 1.1		10/19/2023			Mohit Vaghadiya		Added Filter to Exclude Test Account (Accounts W/O Client Key)
-- 1.2		10/20/2023			Mohit Vaghadiya		Getting Legacy Clients From Archived Table if they are not in Current Care Program Enrollee
-------------------------------------------------------------------------------------------------------------------------------
WITH GATOR_CLIENT_CARE_PROGRAM AS
(
	SELECT DISTINCT GATOR_CLIENT.ID AS ACCOUNT_ID
					, GATOR_CLIENT_MAP.CLIENT_KEY AS CLIENT_KEY
					, GATOR_CLIENT_MAP.ORIGINAL_CLIENT_KEY AS ORIGINAL_CLIENT_KEY
					, LEFT(GATOR_CLIENT.BRANCH_KEY__C, 32) AS BRANCH_KEY
					, NVL(NULLIF(TRIM(DW_CLIENT.CLIENT_FIRST_NAME), ''), GATOR_CLIENT.FIRSTNAME) AS CLIENT_FIRST_NAME 
					, NVL(NULLIF(TRIM(DW_CLIENT.CLIENT_LAST_NAME), ''), GATOR_CLIENT.LASTNAME ) AS CLIENT_LAST_NAME 
					, CARE_PROGRAM.NAME AS CARE_PROGRAM_NAME
					, CARE_PROGRAM.SL_EXTERNAL_ID__C AS CARE_PROGRAM_CODE
					, CLIENT_CARE_PROGRAM.STATUS AS CLIENT_CARE_PROGRAM_STATUS
					, CLIENT_CARE_PROGRAM.ROSTER_DISQUALIFICATION__C AS ROSTER_DISQUALIFICATION
					, CLIENT_CARE_PROGRAM.GEOGRAPHY_DISQUALIFICATION__C AS GEOGRAPHY_DISQUALIFICATION
					, CLIENT_CARE_PROGRAM.CARE_ACTIVE_DISQUALIFICATION__C AS CARE_ACTIVE_DISQUALIFICATION
					, NVL(CLIENT_CARE_PROGRAM.DISENROLL__C, FALSE) AS OPT_OUT_FLAG
					, CLIENT_CARE_PROGRAM.DISENROLL_REASON__C AS OPT_OUT_REASON
	-- Getting Client List from Gator Account Table, regadless of they are in any Care Program OR Not
	FROM DISC_PROD.HEALTH_NAVIGATOR.ACCOUNT GATOR_CLIENT
	INNER JOIN DISC_PROD.HEALTH_NAVIGATOR.RECORDTYPE RECORD_TYPE
		ON RECORD_TYPE.ID = GATOR_CLIENT.RECORDTYPEID
			AND RECORD_TYPE.NAME = 'Client' -- Only Client Accounts
	LEFT JOIN DW_PROD.REPORT.VW_GATOR_CLIENT_MAPPING GATOR_CLIENT_MAP -- Using this view to get Client and Original Client Keys
			ON GATOR_CLIENT_MAP.ACCOUNT_ID = GATOR_CLIENT.ID
	LEFT JOIN DW_PROD.INTEGRATION.DIM_CLIENT_MERGED DW_CLIENT
		ON DW_CLIENT.ORIGINAL_CLIENT_KEY = GATOR_CLIENT_MAP.ORIGINAL_CLIENT_KEY 
	-- Getting Client Care Program Information from Gator
	LEFT JOIN DISC_PROD.HEALTH_NAVIGATOR.CAREPROGRAMENROLLEE CLIENT_CARE_PROGRAM
		INNER JOIN DISC_PROD.HEALTH_NAVIGATOR.CAREPROGRAM CARE_PROGRAM
			ON CARE_PROGRAM.ID = CLIENT_CARE_PROGRAM.CAREPROGRAMID 
		ON CLIENT_CARE_PROGRAM.ACCOUNTID = GATOR_CLIENT.ID
)
, ARCHIVED_CLIENTS AS
(
	-- Legacy Archived Clients
	SELECT GATOR_CLIENT.ID AS ACCOUNT_ID
			, ARCHIVED_CLIENTS.CLIENT_KEY AS CLIENT_KEY
			, COALESCE(GATOR_CLIENT_MAP.ORIGINAL_CLIENT_KEY, ARCHIVED_CLIENTS.CLIENT_KEY) AS ORIGINAL_CLIENT_KEY
			, LEFT(GATOR_CLIENT.BRANCH_KEY__C, 32) AS BRANCH_KEY
			, ARCHIVED_CLIENTS.CLIENT_FIRST_NAME AS CLIENT_FIRST_NAME
			, ARCHIVED_CLIENTS.CLIENT_LAST_NAME AS CLIENT_LAST_NAME
			, ARCHIVED_CLIENTS.CARE_PROGRAM_NAME AS CARE_PROGRAM_NAME
			, ARCHIVED_CLIENTS.CARE_PROGRAM_CODE AS CARE_PROGRAM_CODE
			, 'Legacy' AS CLIENT_CARE_PROGRAM_STATUS
			, 'N/A' AS ROSTER_DISQUALIFICATION
			, 'N/A' AS GEOGRAPHY_DISQUALIFICATION
			, 'N/A' AS CARE_ACTIVE_DISQUALIFICATION
			, FALSE AS OPT_OUT_FLAG
			, NULL AS OPT_OUT_REASON
	-- Below Table contains Legacy Archived Clients ** REPORT.ARCHIVED_CC_CLIENT_CARE_PROGRAM 
	-- One time build off of Distribution List Table ** CARE_COORDINATION.COMBINED_CAREGIVER_CLIENT_HISTORY 
	FROM DW_PROD.REPORT.ARCHIVED_CC_CLIENT_CARE_PROGRAM ARCHIVED_CLIENTS
	INNER JOIN DISC_PROD.HEALTH_NAVIGATOR.ACCOUNT GATOR_CLIENT
		ON LEFT(GATOR_CLIENT.HEALTHCLOUDGA__SOURCESYSTEMID__C, 32) = ARCHIVED_CLIENTS.CLIENT_KEY 
	INNER JOIN DISC_PROD.HEALTH_NAVIGATOR.RECORDTYPE RECORD_TYPE
			ON RECORD_TYPE.ID = GATOR_CLIENT.RECORDTYPEID
				AND RECORD_TYPE.NAME = 'Client'
	LEFT JOIN DISC_PROD.HEALTH_NAVIGATOR.CAREPROGRAMENROLLEE CLIENT_CARE_PROGRAM
		LEFT JOIN DISC_PROD.HEALTH_NAVIGATOR.CAREPROGRAM CARE_PROGRAM
				ON CARE_PROGRAM.ID = CLIENT_CARE_PROGRAM.CAREPROGRAMID 
			ON CLIENT_CARE_PROGRAM.ACCOUNTID = GATOR_CLIENT.ID
				AND CARE_PROGRAM.SL_EXTERNAL_ID__C = ARCHIVED_CLIENTS.CARE_PROGRAM_CODE
--				AND CLIENT_CARE_PROGRAM.STATUS = 'Legacy'
	LEFT JOIN DW_PROD.REPORT.VW_GATOR_CLIENT_MAPPING GATOR_CLIENT_MAP
			ON GATOR_CLIENT_MAP.ACCOUNT_ID = GATOR_CLIENT.ID
	WHERE CLIENT_CARE_PROGRAM.ID IS NULL
	GROUP BY ALL
)
, DATASET AS
(
	-- Client Care Program Information From Gator
	SELECT CLIENT_CARE_PROGRAM.ACCOUNT_ID
			, CLIENT_CARE_PROGRAM.CLIENT_KEY
			, CLIENT_CARE_PROGRAM.ORIGINAL_CLIENT_KEY
			, CLIENT_CARE_PROGRAM.BRANCH_KEY
			, CLIENT_CARE_PROGRAM.CLIENT_FIRST_NAME
			, CLIENT_CARE_PROGRAM.CLIENT_LAST_NAME
			, CLIENT_CARE_PROGRAM.CARE_PROGRAM_NAME
			, CLIENT_CARE_PROGRAM.CARE_PROGRAM_CODE
			, CLIENT_CARE_PROGRAM.CLIENT_CARE_PROGRAM_STATUS
			, CLIENT_CARE_PROGRAM.ROSTER_DISQUALIFICATION
			, CLIENT_CARE_PROGRAM.GEOGRAPHY_DISQUALIFICATION
			, CLIENT_CARE_PROGRAM.CARE_ACTIVE_DISQUALIFICATION
			, CLIENT_CARE_PROGRAM.OPT_OUT_FLAG
			, CLIENT_CARE_PROGRAM.OPT_OUT_REASON
	FROM GATOR_CLIENT_CARE_PROGRAM CLIENT_CARE_PROGRAM
	LEFT JOIN ARCHIVED_CLIENTS ARCHIVED_CLIENTS
		ON ARCHIVED_CLIENTS.ACCOUNT_ID = CLIENT_CARE_PROGRAM.ACCOUNT_ID
	-- Below Condition is added to make sure if client is/was enrolled in any program (including OSH)
	-- Don't pull the client records w/o any Care Program
	-- If Client is/was not enrolled in any Program (including OSH), they should come w/o program information
	WHERE (CLIENT_CARE_PROGRAM.CARE_PROGRAM_CODE IS NULL AND ARCHIVED_CLIENTS.CLIENT_KEY IS NULL)
			OR CLIENT_CARE_PROGRAM.CARE_PROGRAM_CODE IS NOT NULL
	UNION
	-- Client Care Program Information for Legacy Archived Clients
	SELECT ACCOUNT_ID
			, CLIENT_KEY
			, ORIGINAL_CLIENT_KEY
			, BRANCH_KEY
			, CLIENT_FIRST_NAME
			, CLIENT_LAST_NAME
			, CARE_PROGRAM_NAME
			, CARE_PROGRAM_CODE
			, CLIENT_CARE_PROGRAM_STATUS
			, ROSTER_DISQUALIFICATION
			, GEOGRAPHY_DISQUALIFICATION
			, CARE_ACTIVE_DISQUALIFICATION
			, OPT_OUT_FLAG
			, OPT_OUT_REASON
	FROM ARCHIVED_CLIENTS
)
SELECT ACCOUNT_ID
		, CLIENT_KEY
		, ORIGINAL_CLIENT_KEY
		, BRANCH_KEY
		, CLIENT_FIRST_NAME
		, CLIENT_LAST_NAME
		, CARE_PROGRAM_NAME
		, CARE_PROGRAM_CODE
		, CLIENT_CARE_PROGRAM_STATUS
		, ROSTER_DISQUALIFICATION
		, GEOGRAPHY_DISQUALIFICATION
		, CARE_ACTIVE_DISQUALIFICATION
		, OPT_OUT_FLAG
		, OPT_OUT_REASON
FROM DATASET
WHERE CLIENT_KEY IS NOT NULL -- Excluding Test records W/O Gator Client Key;
;