CREATE OR REPLACE PROCEDURE DISC_PROD.RISKONNECT.GET_HIERARCHY_NODE("TASKKEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS ' 
--*****************************************************************************************************************************
-- NAME:  DISC_PROD.RISKONNECT.GET_HIERARCHY_NODE 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO DISC_PROD.RISKONNECT.HIST_HIERARCHY_NODE from (SELECT T.$1  AS  Id,  T.$2  AS  OwnerId,  T.$3  AS  IsDeleted,  T.$4  AS  Name,  REPLACE(T.$5,''T'','' '')::TIMESTAMP_NTZ(9) AS CreatedDate,  T.$6  AS  CreatedById,  REPLACE(T.$7,''T'','' '')::TIMESTAMP_NTZ(9) AS  LastModifiedDate,  T.$8  AS  LastModifiedById,  REPLACE(T.$9,''T'','' '')::TIMESTAMP_NTZ(9)  AS  SystemModstamp,  T.$10  AS  LastActivityDate,  T.$11  AS  LastViewedDate,  T.$12  AS  LastReferencedDate,  T.$13  AS  ConnectionReceivedId,  T.$14  AS  ConnectionSentId,  T.$15  AS  rkl__Active__c,  T.$16  AS  rkl__Address_Line1__c,  T.$17  AS  rkl__Address_Line2__c,  T.$18  AS  rkl__City__c,  T.$19  AS  rkl__Country__c,  T.$20  AS  rkl__Date_Active__c,  T.$21  AS  rkl__Date_Inactive__c,  T.$22  AS  rkl__Date_Location_Closed__c,  T.$23  AS  rkl__Date_Location_Opened__c,  T.$24  AS  rkl__Date_Parent_Relationship_Effective__c,  T.$25  AS  rkl__ID_Prior__c,  T.$26  AS  rkl__Latitude__c,  T.$27  AS  rkl__Location_10_Code__c,  T.$28  AS  rkl__Location_10_Name__c,  T.$29  AS  rkl__Location_10_Node__c,  T.$30  AS  rkl__Location_1_Code__c,  T.$31  AS  rkl__Location_1_Name__c,  T.$32  AS  rkl__Location_1_Node__c,  T.$33  AS  rkl__Location_2_Code__c,  T.$34  AS  rkl__Location_2_Name__c,  T.$35  AS  rkl__Location_2_Node__c,  T.$36  AS  rkl__Location_3_Code__c,  T.$37  AS  rkl__Location_3_Name__c,  T.$38  AS  rkl__Location_3_Node__c,  T.$39  AS  rkl__Location_4_Code__c,  T.$40  AS  rkl__Location_4_Name__c,  T.$41  AS  rkl__Location_4_Node__c,  T.$42  AS  rkl__Location_5_Code__c,  T.$43  AS  rkl__Location_5_Name__c,  T.$44  AS  rkl__Location_5_Node__c,  T.$45  AS  rkl__Location_6_Code__c,  T.$46  AS  rkl__Location_6_Name__c,  T.$47  AS  rkl__Location_6_Node__c,  T.$48  AS  rkl__Location_7_Code__c,  T.$49  AS  rkl__Location_7_Name__c,  T.$50  AS  rkl__Location_7_Node__c,  T.$51  AS  rkl__Location_8_Code__c,  T.$52  AS  rkl__Location_8_Name__c,  T.$53  AS  rkl__Location_8_Node__c,  T.$54  AS  rkl__Location_9_Code__c,  T.$55  AS  rkl__Location_9_Name__c,  T.$56  AS  rkl__Location_9_Node__c,  T.$57  AS  rkl__Longitude__c,  T.$58  AS  rkl__Node_Code__c,  T.$59  AS  rkl__Node_Key__c,  T.$60  AS  rkl__Node_Level__c,  T.$61  AS  rkl__Node_Name__c,  T.$62  AS  rkl__Number_of_Offset_Levels__c,  T.$63  AS  rkl__Parent_Code_Formula__c,  T.$64  AS  rkl__Parent_Level_Formula__c,  T.$65  AS  rkl__Parent_Name__c,  T.$66  AS  rkl__Parent_Node_Key__c,  T.$67  AS  rkl__Parent_Node__c,  T.$68  AS  rkl__Parent_SIC_or_NAICS_Code__c,  T.$69  AS  rkl__Permit_Claims__c,  T.$70  AS  rkl__Postal_Code__c,  T.$71  AS  rkl__Primary_Contact__c,  T.$72  AS  rkl__SIC_or_NAICS_Node_Code__c,  T.$73  AS  rkl__State__c,  T.$74  AS  rkl__Is_Leaf__c,  T.$75  AS  Labor_Hours__c,  T.$76  AS  Sales__c,  T.$77  AS  Payroll__c,  T.$78  AS  Headcount__c,  T.$79  AS  Miles_Driven__c,  T.$80  AS  rkl__Property_Collection_Status__c,  T.$81  AS  rkl__Exposure_Summary_1__c,  T.$82  AS  rkl__Exposure_Summary_2__c,  T.$83  AS  rkl__Exposure_Summary_3__c,  T.$84  AS  rkl__Exposure_Summary_4__c,  T.$85  AS  rkl__Exposure_Summary_5__c,  T.$86  AS  rkl__RK_Test_Rollup__c,  T.$87  AS  Search_Location__c, T.$88 as AE_Reviewer_1__c  , T.$89  AS  Primary_Location_Indicator__c,  T.$90  AS  Location_Level_Name__c,  T.$91  AS  Office_Manager__c,  T.$92  AS  Phone__c,  T.$93  AS  Fax__c,  T.$94  AS  rkl__RK_Share_Group_1__c,  T.$95  AS  Code_Losses_to_this_Location__c,  T.$96  AS  Tax_ID__c,  T.$97  AS  CLS_DD_Manager_Phone__c,  T.$98  AS  CLS_DD_Manager_Email__c,  T.$99  AS  Total_Annual_Hours__c,  T.$100  AS  CLS_DD_Manager__c,  T.$101  AS  Skilled_Manager__c,  T.$102  AS  Total_Annual_Visits__c,  T.$103  AS  Property__c,  T.$104  AS  Total_Annual_Payroll__c,  T.$105  AS  rkl__RK_Share_Group_2__c,  T.$106  AS  Total_Employee_Count__c,  T.$107  AS  rkl__RK_Share_Group__c,  T.$108  AS  rkl__Renewal_Contact__c,  T.$109  AS  Skilled_Manager_Phone__c,  T.$110  AS  Region__c,  T.$111  AS  rkl__Renewal_User__c,  T.$112  AS  Skilled_Manager_Email__c,  T.$113  AS  Hierarchy_Notes__c,  T.$114  AS  Clean_Up__c,  T.$115  AS  Change_Reason__c,  T.$116  AS  Union_Branch__c,  T.$117  AS  Supervisor_headcount__c,-1 AS ETL_TASK_KEY, -1 AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Riskonnect/Daily_data (file_format => DISC_PROD.STAGE.CSV_FORMAT,PATTERN => ''.*Hierarchy_Node.*[.]csv'')T);

    --ViewSQL
    CREATE OR REPLACE TABLE DISC_PROD.RISKONNECT.HIERARCHY_NODE AS SELECT Id,  OwnerId,  IsDeleted,  Name,  CreatedDate,  CreatedById,  LastModifiedDate,  LastModifiedById,  SystemModstamp,  LastActivityDate,  LastViewedDate,  LastReferencedDate,  ConnectionReceivedId,  ConnectionSentId,  Active__c,  Address_Line1__c,  Address_Line2__c,  City__c,  Country__c,  Date_Active__c,  Date_Inactive__c,  Date_Location_Closed__c,  Date_Location_Opened__c,  Date_Parent_Relationship_Effective__c,  ID_Prior__c,  Latitude__c,  Location_10_Code__c,  Location_10_Name__c,  Location_10_Node__c,  Location_1_Code__c,  Location_1_Name__c,  Location_1_Node__c,  Location_2_Code__c,  Location_2_Name__c,  Location_2_Node__c,  Location_3_Code__c,  Location_3_Name__c,  Location_3_Node__c,  Location_4_Code__c,  Location_4_Name__c,  Location_4_Node__c,  Location_5_Code__c,  Location_5_Name__c,  Location_5_Node__c,  Location_6_Code__c,  Location_6_Name__c,  Location_6_Node__c,  Location_7_Code__c,  Location_7_Name__c,  Location_7_Node__c,  Location_8_Code__c,  Location_8_Name__c,  Location_8_Node__c,  Location_9_Code__c,  Location_9_Name__c,  Location_9_Node__c,  Longitude__c,  Node_Code__c,  Node_Key__c,  Node_Level__c,  Node_Name__c,  Number_of_Offset_Levels__c,  Parent_Code_Formula__c,  Parent_Level_Formula__c,  Parent_Name__c,  Parent_Node_Key__c,  Parent_Node__c,  Parent_SIC_or_NAICS_Code__c,  Permit_Claims__c,  Postal_Code__c,  Primary_Contact__c,  SIC_or_NAICS_Node_Code__c,  State__c,  Is_Leaf__c,  Labor_Hours__c,  Sales__c,  Payroll__c,  Headcount__c,  Miles_Driven__c,  Property_Collection_Status__c,  Exposure_Summary_1__c,  Exposure_Summary_2__c,  Exposure_Summary_3__c,  Exposure_Summary_4__c,  Exposure_Summary_5__c,  RK_Test_Rollup__c,  Search_Location__c, AE_Reviewer_1__c, Primary_Location_Indicator__c,  Location_Level_Name__c,  Office_Manager__c,  Phone__c,  Fax__c,  RK_Share_Group_1__c,  Code_Losses_to_this_Location__c,  Tax_ID__c,  CLS_DD_Manager_Phone__c,  CLS_DD_Manager_Email__c,  Total_Annual_Hours__c,  CLS_DD_Manager__c,  Skilled_Manager__c,  Total_Annual_Visits__c,  Property__c,  Total_Annual_Payroll__c,  RK_Share_Group_2__c,  Total_Employee_Count__c,  RK_Share_Group__c,  Renewal_Contact__c,  Skilled_Manager_Phone__c,  Region__c,  Renewal_User__c,  Skilled_Manager_Email__c,  Hierarchy_Notes__c,  Clean_Up__c,  Change_Reason__c,  Union_Branch__c,  Supervisor_headcount__c,:TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, CURRENT_USER() AS ETL_INSERTED_BY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, CURRENT_USER() AS ETL_LAST_UPDATED_BY, 0 AS ETL_DELETED_FLAG FROM DISC_PROD.RISKONNECT.HIST_HIERARCHY_NODE WHERE (ID,ETL_LAST_UPDATED_DATE) IN (SELECT ID,MAX(ETL_LAST_UPDATED_DATE) FROM DISC_PROD.RISKONNECT.HIST_HIERARCHY_NODE GROUP BY ID);

    return ''Success'';
END;
';