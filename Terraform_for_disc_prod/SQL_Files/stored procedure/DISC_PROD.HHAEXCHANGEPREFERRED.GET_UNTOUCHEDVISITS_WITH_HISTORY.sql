CREATE OR REPLACE PROCEDURE DISC_PROD.HHAEXCHANGEPREFERRED.GET_UNTOUCHEDVISITS_WITH_HISTORY("TASKKEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
/*****************************************************************************************************************************
NAME:  	 GET_UNTOUCHEDVISITS_WITH_HISTORY
PURPOSE: TO LOAD UNTOUCHEDVISITS TABLE INCREMENTALLY
DATE           AUTHOR                NOTES:
---------- 	   -------------------   -----------------------------------------------------------------------------------------------
20231028     Ravi Suthar    		 Initial development
20240115     Ravi Suthar    		 InAdded HHAEXCHANGEPREFERRED.UNTOUCHEDVISITS Load Logic
*****************************************************************************************************************************/
BEGIN
	INSERT OVERWRITE INTO DISC_PROD.HHAEXCHANGEPREFERRED.UntouchedVisits (SELECT t.$1 AS AgencyID, t.$2 AS AdmissionID, t.$3 AS OfficePatientCode, t.$4 AS PatientName, t.$5 AS MedicaidNumber, t.$6 AS AltPatientID, t.$7 AS VisitDate, t.$8 AS ScheduleTime, t.$9 AS AideName, t.$10 AS AideCode, t.$11 AS Discipline, t.$12 AS VisitStatus, t.$13 AS VisitStatusText, t.$14 AS Billed, t.$15 AS ServiceCode, t.$16 AS CHHAName, t.$17 AS VisitTime, t.$18 AS PayRate, t.$19 AS ScheduledMins, t.$20 AS VisitMins, t.$21 AS VisitHrs, t.$22 AS CoordinatorName, t.$23 AS TimesheetRequire, t.$24 AS PayrateCode, t.$25 AS CreatedDate, t.$26 AS VendorInvoiceNumber, t.$27 AS VisitCreatedDate, t.$28 AS VisitModifiedDate, t.$29 AS VisitID, t.$30 AS OnHoldVisit, t.$31 AS MissedVisit, t.$32 AS CountyName, t.$33 AS SYS_CHANGE_VERSION, t.$34 AS SYS_CHANGE_OPERATION, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, ''RSUTHAR'' AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, ''RSUTHAR'' AS ETL_LAST_UPDATED_BY, DECODE(t.$34,''D'', True, False) AS ETL_DELETED_FLAG FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/To_Be_Processed/ (file_format => DISC_PROD.STAGE.MY_CSV_FORMAT,PATTERN => ''.*HHAEXCHANGEPREFERRED_dbo_UntouchedVisits.*[.]csv.gz'')T WHERE t.$1 IN (243, 371));

	MERGE INTO DISC_PROD.HHAEXCHANGEPREFERRED.HIST_UNTOUCHEDVISITS_WITH_HISTORY OLD_DATA 
	USING (SELECT t.$1 AS AgencyID, t.$2 AS AdmissionID, t.$3 AS OfficePatientCode, t.$4 AS PatientName, t.$5 AS MedicaidNumber, t.$6 AS AltPatientID, t.$7 AS VisitDate, t.$8 AS ScheduleTime, t.$9 AS AideName, t.$10 AS AideCode, t.$11 AS Discipline, t.$12 AS VisitStatus, t.$13 AS VisitStatusText, t.$14 AS Billed, t.$15 AS ServiceCode, t.$16 AS CHHAName, t.$17 AS VisitTime, t.$18 AS PayRate, t.$19 AS ScheduledMins, t.$20 AS VisitMins, t.$21 AS VisitHrs, t.$22 AS CoordinatorName, t.$23 AS TimesheetRequire, t.$24 AS PayrateCode, t.$25 AS CreatedDate, t.$26 AS VendorInvoiceNumber, t.$27 AS VisitCreatedDate, t.$28 AS VisitModifiedDate, t.$29 AS VisitID, t.$30 AS OnHoldVisit, t.$31 AS MissedVisit, t.$32 AS CountyName, t.$33 AS SYS_CHANGE_VERSION, t.$34 AS SYS_CHANGE_OPERATION, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, ''RSUTHAR'' AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, ''RSUTHAR'' AS ETL_LAST_UPDATED_BY, DECODE(t.$34,''D'', True, False) AS ETL_DELETED_FLAG FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/To_Be_Processed/ (file_format => DISC_PROD.STAGE.MY_CSV_FORMAT,PATTERN => ''.*HHAEXCHANGEPREFERRED_dbo_UntouchedVisits.*[.]csv.gz'')T WHERE t.$1 IN (243, 371)) NEW_DATA
	ON EQUAL_NULL(OLD_DATA.AgencyID,NEW_DATA.AgencyID) AND EQUAL_NULL(OLD_DATA.VisitID,NEW_DATA.VisitID) AND EQUAL_NULL(OLD_DATA.ADMISSIONID,NEW_DATA.ADMISSIONID) AND EQUAL_NULL(OLD_DATA.OFFICEPATIENTCODE,NEW_DATA.OFFICEPATIENTCODE) AND EQUAL_NULL(OLD_DATA.PATIENTNAME,NEW_DATA.PATIENTNAME) AND EQUAL_NULL(OLD_DATA.MEDICAIDNUMBER,NEW_DATA.MEDICAIDNUMBER) AND EQUAL_NULL(OLD_DATA.ALTPATIENTID,NEW_DATA.ALTPATIENTID) AND EQUAL_NULL(OLD_DATA.VISITDATE,NEW_DATA.VISITDATE) AND EQUAL_NULL(OLD_DATA.SCHEDULETIME,NEW_DATA.SCHEDULETIME) AND EQUAL_NULL(OLD_DATA.AIDENAME,NEW_DATA.AIDENAME) AND EQUAL_NULL(OLD_DATA.AIDECODE,NEW_DATA.AIDECODE) AND EQUAL_NULL(OLD_DATA.DISCIPLINE,NEW_DATA.DISCIPLINE) AND EQUAL_NULL(OLD_DATA.VISITSTATUS,NEW_DATA.VISITSTATUS) AND EQUAL_NULL(OLD_DATA.VISITSTATUSTEXT,NEW_DATA.VISITSTATUSTEXT) AND EQUAL_NULL(OLD_DATA.BILLED,NEW_DATA.BILLED) AND EQUAL_NULL(OLD_DATA.SERVICECODE,NEW_DATA.SERVICECODE) AND EQUAL_NULL(OLD_DATA.CHHANAME,NEW_DATA.CHHANAME) AND EQUAL_NULL(OLD_DATA.VISITTIME,NEW_DATA.VISITTIME) AND EQUAL_NULL(OLD_DATA.PAYRATE,NEW_DATA.PAYRATE) AND EQUAL_NULL(OLD_DATA.SCHEDULEDMINS,NEW_DATA.SCHEDULEDMINS) AND EQUAL_NULL(OLD_DATA.VISITMINS,NEW_DATA.VISITMINS) AND EQUAL_NULL(OLD_DATA.VISITHRS,NEW_DATA.VISITHRS) AND EQUAL_NULL(OLD_DATA.COORDINATORNAME,NEW_DATA.COORDINATORNAME) AND EQUAL_NULL(OLD_DATA.TIMESHEETREQUIRE,NEW_DATA.TIMESHEETREQUIRE) AND EQUAL_NULL(OLD_DATA.PAYRATECODE,NEW_DATA.PAYRATECODE) AND EQUAL_NULL(OLD_DATA.CREATEDDATE,NEW_DATA.CREATEDDATE) AND EQUAL_NULL(OLD_DATA.VENDORINVOICENUMBER,NEW_DATA.VENDORINVOICENUMBER) AND EQUAL_NULL(OLD_DATA.VISITCREATEDDATE,NEW_DATA.VISITCREATEDDATE) AND EQUAL_NULL(OLD_DATA.VISITMODIFIEDDATE,NEW_DATA.VISITMODIFIEDDATE) AND EQUAL_NULL(OLD_DATA.VISITID,NEW_DATA.VISITID) AND EQUAL_NULL(OLD_DATA.ONHOLDVISIT,NEW_DATA.ONHOLDVISIT) AND EQUAL_NULL(OLD_DATA.MISSEDVISIT,NEW_DATA.MISSEDVISIT) AND EQUAL_NULL(OLD_DATA.COUNTYNAME,NEW_DATA.COUNTYNAME)
	WHEN NOT MATCHED THEN 
	INSERT ( 
		AGENCYID,
		ADMISSIONID,
		OFFICEPATIENTCODE,
		PATIENTNAME,
		MEDICAIDNUMBER,
		ALTPATIENTID,
		VISITDATE,
		SCHEDULETIME,
		AIDENAME,
		AIDECODE,
		DISCIPLINE,
		VISITSTATUS,
		VISITSTATUSTEXT,
		BILLED,
		SERVICECODE,
		CHHANAME,
		VISITTIME,
		PAYRATE,
		SCHEDULEDMINS,
		VISITMINS,
		VISITHRS,
		COORDINATORNAME,
		TIMESHEETREQUIRE,
		PAYRATECODE,
		CREATEDDATE,
		VENDORINVOICENUMBER,
		VISITCREATEDDATE,
		VISITMODIFIEDDATE,
		VISITID,
		ONHOLDVISIT,
		MISSEDVISIT,
		COUNTYNAME,
		SYS_CHANGE_VERSION,
		SYS_CHANGE_OPERATION,
		ETL_TASK_KEY,
		ETL_INSERTED_TASK_KEY,
		ETL_INSERTED_DATE,
		ETL_INSERTED_BY,
		ETL_LAST_UPDATED_DATE,
		ETL_LAST_UPDATED_BY,
		ETL_DELETED_FLAG
	) 
	VALUES (
		NEW_DATA.AGENCYID,
		NEW_DATA.ADMISSIONID,
		NEW_DATA.OFFICEPATIENTCODE,
		NEW_DATA.PATIENTNAME,
		NEW_DATA.MEDICAIDNUMBER,
		NEW_DATA.ALTPATIENTID,
		NEW_DATA.VISITDATE,
		NEW_DATA.SCHEDULETIME,
		NEW_DATA.AIDENAME,
		NEW_DATA.AIDECODE,
		NEW_DATA.DISCIPLINE,
		NEW_DATA.VISITSTATUS,
		NEW_DATA.VISITSTATUSTEXT,
		NEW_DATA.BILLED,
		NEW_DATA.SERVICECODE,
		NEW_DATA.CHHANAME,
		NEW_DATA.VISITTIME,
		NEW_DATA.PAYRATE,
		NEW_DATA.SCHEDULEDMINS,
		NEW_DATA.VISITMINS,
		NEW_DATA.VISITHRS,
		NEW_DATA.COORDINATORNAME,
		NEW_DATA.TIMESHEETREQUIRE,
		NEW_DATA.PAYRATECODE,
		NEW_DATA.CREATEDDATE,
		NEW_DATA.VENDORINVOICENUMBER,
		NEW_DATA.VISITCREATEDDATE,
		NEW_DATA.VISITMODIFIEDDATE,
		NEW_DATA.VISITID,
		NEW_DATA.ONHOLDVISIT,
		NEW_DATA.MISSEDVISIT,
		NEW_DATA.COUNTYNAME,
		NEW_DATA.SYS_CHANGE_VERSION,
		NEW_DATA.SYS_CHANGE_OPERATION,
		NEW_DATA.ETL_TASK_KEY,
		NEW_DATA.ETL_INSERTED_TASK_KEY,
		NEW_DATA.ETL_INSERTED_DATE,
		NEW_DATA.ETL_INSERTED_BY,
		NEW_DATA.ETL_LAST_UPDATED_DATE,
		NEW_DATA.ETL_LAST_UPDATED_BY,
		NEW_DATA.ETL_DELETED_FLAG    
	);
	
	UPDATE DISC_PROD.HHAEXCHANGEPREFERRED.HIST_UNTOUCHEDVISITS_WITH_HISTORY SET ETL_DELETED_FLAG=TRUE,ETL_LAST_UPDATED_DATE=CURRENT_TIMESTAMP(),ETL_LAST_UPDATED_BY=CURRENT_USER() 
		WHERE VISITDATE>=(SELECT MIN(t.$7) FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/To_Be_Processed/ (file_format => DISC_PROD.STAGE.MY_CSV_FORMAT,PATTERN => ''.*HHAEXCHANGEPREFERRED_dbo_UntouchedVisits.*[.]csv.gz'') T WHERE t.$1 IN (243, 371)) 
		AND (AGENCYID,VISITID) NOT IN (SELECT DISTINCT t.$1 AS AgencyID, t.$29 AS VisitID FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/To_Be_Processed/ (file_format => DISC_PROD.STAGE.MY_CSV_FORMAT,PATTERN => ''.*HHAEXCHANGEPREFERRED_dbo_UntouchedVisits.*[.]csv.gz'')T WHERE t.$1 IN (243, 371));
	
	UPDATE DISC_PROD.HHAEXCHANGEPREFERRED.HIST_UNTOUCHEDVISITS_WITH_HISTORY SET ETL_DELETED_FLAG=FALSE,ETL_LAST_UPDATED_DATE=CURRENT_TIMESTAMP(),ETL_LAST_UPDATED_BY=CURRENT_USER() WHERE ETL_DELETED_FLAG=TRUE AND (AGENCYID,VISITID) IN (SELECT DISTINCT t.$1 AS AgencyID, t.$29 AS VisitID FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/To_Be_Processed/ (file_format => DISC_PROD.STAGE.MY_CSV_FORMAT,PATTERN => ''.*HHAEXCHANGEPREFERRED_dbo_UntouchedVisits.*[.]csv.gz'')T WHERE t.$1 IN (243, 371));

	CREATE OR REPLACE TABLE DISC_PROD.HHAEXCHANGEPREFERRED.UNTOUCHEDVISITS_WITH_HISTORY AS SELECT * FROM DISC_PROD.HHAEXCHANGEPREFERRED.HIST_UNTOUCHEDVISITS_WITH_HISTORY WHERE ETL_DELETED_FLAG=FALSE AND (AGENCYID,VISITID,ETL_INSERTED_DATE) IN (SELECT AGENCYID,VISITID,MAX(ETL_INSERTED_DATE) FROM DISC_PROD.HHAEXCHANGEPREFERRED.HIST_UNTOUCHEDVISITS_WITH_HISTORY GROUP BY AGENCYID,VISITID);

    RETURN ''Success'';
END;
';