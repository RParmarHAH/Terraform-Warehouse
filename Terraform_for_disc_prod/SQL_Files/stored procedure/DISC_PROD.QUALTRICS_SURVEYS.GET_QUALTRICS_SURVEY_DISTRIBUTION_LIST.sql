CREATE OR REPLACE PROCEDURE DISC_PROD.QUALTRICS_SURVEYS.GET_QUALTRICS_SURVEY_DISTRIBUTION_LIST("TASKKEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN
	--TARGETSQL
	INSERT OVERWRITE INTO DISC_PROD.QUALTRICS_SURVEYS.QUALTRICS_SURVEY_DISTRIBUTION_LIST SELECT a.$1 AS ID,NULL AS PARENT_DISTRIBUTION_ID,a.$2 AS OWNER_ID,a.$3 AS ORGANIZATION_ID,a.$4 AS REQUEST_STATUS,a.$5 AS REQUEST_TYPE,a.$6 AS SURVEY_ID,a.$7 AS NAME,a.$8 AS SEND_DATE,NULL CREATED_DATE,NULL AS MODIFIED_DATE,NULL AS HEADERS,a.$9 AS RECIPIENTS,a.$10 AS MESSAGE,a.$11 AS STATS,a.$12 AS SURVEY_LINK_EXPIRATION_DATE,:TaskKey AS ETL_TASK_KEY,:TaskKey AS ETL_INSERTED_TASK_KEY,CURRENT_TIMESTAMP(),CURRENT_USER(),CURRENT_TIMESTAMP(),CURRENT_USER(),NULL FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Qualtrics/Qualtrics_Survey_Distribution_List/(file_format => DISC_PROD.STAGE.CSV_FORMAT, PATTERN=>''.*Distribution_List.*.'') a WHERE a.$1 LIKE ''SMSD%''
	UNION
	SELECT a.$1 AS ID,a.$2 AS PARENT_DISTRIBUTION_ID,a.$3 AS OWNER_ID,a.$4 AS ORGANIZATION_ID,a.$5 AS REQUEST_STATUS,a.$6 AS REQUEST_TYPE,CAST(parse_json(a.$13::variant)[''surveyId''] AS STRING) AS SURVEY_ID,NULL AS NAME,a.$7 AS SEND_DATE,a.$8 AS CREATED_DATE,a.$9 AS MODIFIED_DATE,a.$10 AS HEADERS,a.$11 AS RECIPIENTS,a.$12 AS MESSAGE,a.$14 AS STATS,CAST(parse_json(a.$13::variant)[''expirationDate''] AS STRING) AS SURVEY_LINK_EXPIRATION_DATE,:TaskKey AS ETL_TASK_KEY,:TaskKey AS ETL_INSERTED_TASK_KEY,CURRENT_TIMESTAMP(),CURRENT_USER(),CURRENT_TIMESTAMP(),CURRENT_USER(),NULL FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Qualtrics/Qualtrics_Survey_Distribution_List/(file_format => DISC_PROD.STAGE.CSV_FORMAT, PATTERN=>''.*Distribution_List.*.'') a WHERE a.$1 LIKE ''EMD%'';
END;
';