CREATE OR REPLACE PROCEDURE DISC_PROD.PAYLOCITY.GET_EMPLOYEE_DETAILS("TASKKEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS ' 
--*****************************************************************************************************************************
-- NAME:  DISC_PROD.PAYLOCITY.GET_EMPLOYEE_DETAILS 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO DISC_PROD.PAYLOCITY.HIST_EMPLOYEE_DETAILS FROM (select j.$1:companyId as companyid, j.$1:employeeId as employeeid,  j.$1:api_response as apiresponse, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG  FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Paylocity/EMPLOYEE_DETAILS/COMPANY(file_format => DISC_PROD.STAGE.MY_JSON_FORMAT) j);

    --ViewSQL
    CREATE OR REPLACE TABLE DISC_PROD.PAYLOCITY.EMPLOYEE_DETAILS AS SELECT distinct companyid companyid, apiresponse:additionalDirectDeposit[0]:accountNumber::varchar additionalDirectDeposit_accountNumber,apiresponse:additionalDirectDeposit[0]:accountType::varchar additionalDirectDeposit_accountType,apiresponse:additionalDirectDeposit[0]:amount::number(38,2) additionalDirectDeposit_amount,apiresponse:additionalDirectDeposit[0]:amountType::varchar additionalDirectDeposit_amountType,apiresponse:additionalDirectDeposit[0]:blockSpecial::boolean additionalDirectDeposit_blockSpecial,apiresponse:additionalDirectDeposit[0]:isSkipPreNote::boolean additionalDirectDeposit_isSkipPreNote,apiresponse:additionalDirectDeposit[0]:nameOnAccount::varchar additionalDirectDeposit_nameOnAccount,apiresponse:additionalDirectDeposit[0]:preNoteDate::varchar additionalDirectDeposit_preNoteDate,apiresponse:additionalDirectDeposit[0]:routingNumber::varchar additionalDirectDeposit_routingNumber,apiresponse:additionalRate[0]:changeReason::varchar additionalRate_changeReason,apiresponse:additionalRate[0]:costCenter1::varchar additionalRate_costCenter1,apiresponse:additionalRate[0]:costCenter2::varchar additionalRate_costCenter2,apiresponse:additionalRate[0]:costCenter3::varchar additionalRate_costCenter3,apiresponse:additionalRate[0]:effectiveDate::varchar additionalRate_effectiveDate,apiresponse:additionalRate[0]:endCheckDate::varchar additionalRate_endCheckDate,apiresponse:additionalRate[0]:job::varchar additionalRate_job,apiresponse:additionalRate[0]:rate::number(38,2) additionalRate_rate,apiresponse:additionalRate[0]:rateCode::varchar additionalRate_rateCode,apiresponse:additionalRate[0]:rateNotes::varchar additionalRate_rateNotes,apiresponse:additionalRate[0]:ratePer::varchar additionalRate_ratePer,apiresponse:additionalRate[0]:shift::varchar additionalRate_shift,apiresponse:benefitSetup:benefitClass::varchar benefitSetup_benefitClass,apiresponse:benefitSetup:benefitClassEffectiveDate::varchar benefitSetup_benefitClassEffectiveDate,apiresponse:benefitSetup:benefitSalary::number(38,2) benefitSetup_benefitSalary,apiresponse:benefitSetup:benefitSalaryEffectiveDate::varchar benefitSetup_benefitSalaryEffectiveDate,apiresponse:benefitSetup:doNotApplyAdministrativePeriod::boolean benefitSetup_doNotApplyAdministrativePeriod,apiresponse:benefitSetup:isMeasureAcaEligibility::boolean benefitSetup_isMeasureAcaEligibility,apiresponse:birthDate::varchar birthDate,apiresponse:companyFEIN::varchar companyFEIN,apiresponse:companyName::varchar companyName,apiresponse:currency::varchar currency,apiresponse:customBooleanFields[0]:category customBooleanFields_category,apiresponse:customBooleanFields[0]:label::varchar customBooleanFields_label,apiresponse:customBooleanFields[0]:value::boolean customBooleanFields_value,apiresponse:customDateFields[0]:category customDateFields_category,apiresponse:customDateFields[0]:label::varchar customDateFields_label,apiresponse:customDateFields[0]:value::varchar customDateFields_value,apiresponse:customDropDownFields[0]:category customDropDownFields_category,apiresponse:customDropDownFields[0]:label::varchar customDropDownFields_label,apiresponse:customDropDownFields[0]:value::varchar customDropDownFields_value,apiresponse:customNumberFields[0]:category customNumberFields_category,apiresponse:customNumberFields[0]:label::varchar customNumberFields_label,apiresponse:customNumberFields[0]:value::number(38,2) customNumberFields_value,apiresponse:customTextFields[0]:category customTextFields_category,apiresponse:customTextFields[0]:label::varchar customTextFields_label,apiresponse:customTextFields[0]:value::varchar customTextFields_value,apiresponse:departmentPosition:changeReason::varchar departmentPosition_changeReason,apiresponse:departmentPosition:clockBadgeNumber::varchar departmentPosition_clockBadgeNumber,apiresponse:departmentPosition:costCenter1::varchar departmentPosition_costCenter1,apiresponse:departmentPosition:costCenter2::varchar departmentPosition_costCenter2,apiresponse:departmentPosition:costCenter3::varchar departmentPosition_costCenter3,apiresponse:departmentPosition:effectiveDate::varchar departmentPosition_effectiveDate,apiresponse:departmentPosition:employeeType::varchar departmentPosition_employeeType,apiresponse:departmentPosition:equalEmploymentOpportunityClass::varchar departmentPosition_equalEmploymentOpportunityClass,apiresponse:departmentPosition:isMinimumWageExempt::boolean departmentPosition_isMinimumWageExempt,apiresponse:departmentPosition:isOvertimeExempt::boolean departmentPosition_isOvertimeExempt,apiresponse:departmentPosition:isSupervisorReviewer::boolean departmentPosition_isSupervisorReviewer,apiresponse:departmentPosition:isUnionDuesCollected::boolean departmentPosition_isUnionDuesCollected,apiresponse:departmentPosition:isUnionInitiationCollected::boolean departmentPosition_isUnionInitiationCollected,apiresponse:departmentPosition:jobTitle::varchar departmentPosition_jobTitle,apiresponse:departmentPosition:payGroup::varchar departmentPosition_payGroup,apiresponse:departmentPosition:positionCode::varchar departmentPosition_positionCode,apiresponse:departmentPosition:reviewerCompanyNumber::varchar departmentPosition_reviewerCompanyNumber,apiresponse:departmentPosition:reviewerEmployeeId::varchar departmentPosition_reviewerEmployeeId,apiresponse:departmentPosition:shift::varchar departmentPosition_shift,apiresponse:departmentPosition:supervisorCompanyNumber::varchar departmentPosition_supervisorCompanyNumber,apiresponse:departmentPosition:supervisorEmployeeId::varchar departmentPosition_supervisorEmployeeId,apiresponse:departmentPosition:tipped::varchar departmentPosition_tipped,apiresponse:departmentPosition:unionAffiliationDate::varchar departmentPosition_unionAffiliationDate,apiresponse:departmentPosition:unionCode::varchar departmentPosition_unionCode,apiresponse:departmentPosition:unionPosition::varchar departmentPosition_unionPosition,apiresponse:departmentPosition:workersCompensation::varchar departmentPosition_workersCompensation,apiresponse:disabilityDescription::varchar disabilityDescription,apiresponse:emergencyContacts[0]:address1::varchar emergencyContacts_address1,apiresponse:emergencyContacts[0]:address2::varchar emergencyContacts_address2,apiresponse:emergencyContacts[0]:city::varchar emergencyContacts_city,apiresponse:emergencyContacts[0]:country::varchar emergencyContacts_country,apiresponse:emergencyContacts[0]:county::varchar emergencyContacts_county,apiresponse:emergencyContacts[0]:email::varchar emergencyContacts_email,apiresponse:emergencyContacts[0]:firstName::varchar emergencyContacts_firstName,apiresponse:emergencyContacts[0]:homePhone::varchar emergencyContacts_homePhone,apiresponse:emergencyContacts[0]:lastName::varchar emergencyContacts_lastName,apiresponse:emergencyContacts[0]:mobilePhone::varchar emergencyContacts_mobilePhone,apiresponse:emergencyContacts[0]:notes::varchar emergencyContacts_notes,apiresponse:emergencyContacts[0]:pager::varchar emergencyContacts_pager,apiresponse:emergencyContacts[0]:primaryPhone::varchar emergencyContacts_primaryPhone,apiresponse:emergencyContacts[0]:priority::varchar emergencyContacts_priority,apiresponse:emergencyContacts[0]:relationship::varchar emergencyContacts_relationship,apiresponse:emergencyContacts[0]:state::varchar emergencyContacts_state,apiresponse:emergencyContacts[0]:syncEmployeeInfo::boolean emergencyContacts_syncEmployeeInfo,apiresponse:emergencyContacts[0]:workExtension::varchar emergencyContacts_workExtension,apiresponse:emergencyContacts[0]:workPhone::varchar emergencyContacts_workPhone,apiresponse:emergencyContacts[0]:zip::varchar emergencyContacts_zip,apiresponse:employeeId::varchar employeeId,apiresponse:ethnicity::varchar ethnicity,apiresponse:federalTax:amount::number(38,2) federalTax_amount,apiresponse:federalTax:deductionsAmount::number(38,2) federalTax_deductionsAmount,apiresponse:federalTax:dependentsAmount::number(38,2) federalTax_dependentsAmount,apiresponse:federalTax:exemptions::number(38,2) federalTax_exemptions,apiresponse:federalTax:filingStatus::varchar federalTax_filingStatus,apiresponse:federalTax:higherRate::boolean federalTax_higherRate,apiresponse:federalTax:otherIncomeAmount::number(38,2) federalTax_otherIncomeAmount,apiresponse:federalTax:percentage::number(38,2) federalTax_percentage,apiresponse:federalTax:taxCalculationCode::varchar federalTax_taxCalculationCode,apiresponse:federalTax:w4FormYear::number(38,2) federalTax_w4FormYear,apiresponse:firstName::varchar firstName,apiresponse:gender::varchar gender,apiresponse:homeAddress:address1::varchar homeAddress_address1,apiresponse:homeAddress:address2::varchar homeAddress_address2,apiresponse:homeAddress:city::varchar homeAddress_city,apiresponse:homeAddress:country::varchar homeAddress_country,apiresponse:homeAddress:county::varchar homeAddress_county,apiresponse:homeAddress:emailAddress::varchar homeAddress_emailAddress,apiresponse:homeAddress:mobilePhone::varchar homeAddress_mobilePhone,apiresponse:homeAddress:phone::varchar homeAddress_phone,apiresponse:homeAddress:postalCode::varchar homeAddress_postalCode,apiresponse:homeAddress:state::varchar homeAddress_state,apiresponse:isHighlyCompensated::boolean isHighlyCompensated,apiresponse:isSmoker::boolean isSmoker,apiresponse:lastName::varchar lastName,apiresponse:localTax[0]:exemptions::number(38,2) localTax_exemptions,apiresponse:localTax[0]:exemptions2::number(38,2) localTax_exemptions2,apiresponse:localTax[0]:filingStatus::varchar localTax_filingStatus,apiresponse:localTax[0]:residentPSD::varchar localTax_residentPSD,apiresponse:localTax[0]:taxCode::varchar localTax_taxCode,apiresponse:localTax[0]:workPSD::varchar localTax_workPSD,apiresponse:mainDirectDeposit:accountNumber::varchar mainDirectDeposit_accountNumber,apiresponse:mainDirectDeposit:accountType::varchar mainDirectDeposit_accountType,apiresponse:mainDirectDeposit:blockSpecial::boolean mainDirectDeposit_blockSpecial,apiresponse:mainDirectDeposit:isSkipPreNote::boolean mainDirectDeposit_isSkipPreNote,apiresponse:mainDirectDeposit:nameOnAccount::varchar mainDirectDeposit_nameOnAccount,apiresponse:mainDirectDeposit:preNoteDate::varchar mainDirectDeposit_preNoteDate,apiresponse:mainDirectDeposit:routingNumber::varchar mainDirectDeposit_routingNumber,apiresponse:maritalStatus::varchar maritalStatus,apiresponse:middleName::varchar middleName,apiresponse:nonPrimaryStateTax:amount::number(38,2) nonPrimaryStateTax_amount,apiresponse:nonPrimaryStateTax:deductionsAmount::number(38,2) nonPrimaryStateTax_deductionsAmount,apiresponse:nonPrimaryStateTax:dependentsAmount::number(38,2) nonPrimaryStateTax_dependentsAmount,apiresponse:nonPrimaryStateTax:exemptions::number(38,2) nonPrimaryStateTax_exemptions,apiresponse:nonPrimaryStateTax:exemptions2::number(38,2) nonPrimaryStateTax_exemptions2,apiresponse:nonPrimaryStateTax:filingStatus::varchar nonPrimaryStateTax_filingStatus,apiresponse:nonPrimaryStateTax:higherRate::boolean nonPrimaryStateTax_higherRate,apiresponse:nonPrimaryStateTax:otherIncomeAmount::number(38,2) nonPrimaryStateTax_otherIncomeAmount,apiresponse:nonPrimaryStateTax:percentage::number(38,2) nonPrimaryStateTax_percentage,apiresponse:nonPrimaryStateTax:reciprocityCode::varchar nonPrimaryStateTax_reciprocityCode,apiresponse:nonPrimaryStateTax:specialCheckCalc::varchar nonPrimaryStateTax_specialCheckCalc,apiresponse:nonPrimaryStateTax:taxCalculationCode::varchar nonPrimaryStateTax_taxCalculationCode,apiresponse:nonPrimaryStateTax:taxCode::varchar nonPrimaryStateTax_taxCode,apiresponse:nonPrimaryStateTax:w4FormYear::number(38,2) nonPrimaryStateTax_w4FormYear,apiresponse:ownerPercent::number(38,2) ownerPercent,apiresponse:preferredName::varchar preferredName,apiresponse:primaryPayRate:annualSalary::number(38,2) primaryPayRate_annualSalary,apiresponse:primaryPayRate:baseRate::number(38,2) primaryPayRate_baseRate,apiresponse:primaryPayRate:beginCheckDate::varchar primaryPayRate_beginCheckDate,apiresponse:primaryPayRate:changeReason::varchar primaryPayRate_changeReason,apiresponse:primaryPayRate:defaultHours::number(38,2) primaryPayRate_defaultHours,apiresponse:primaryPayRate:effectiveDate::varchar primaryPayRate_effectiveDate,apiresponse:primaryPayRate:isAutoPay::boolean primaryPayRate_isAutoPay,apiresponse:primaryPayRate:payFrequency::varchar primaryPayRate_payFrequency,apiresponse:primaryPayRate:payGrade::varchar primaryPayRate_payGrade,apiresponse:primaryPayRate:payRateNote::varchar primaryPayRate_payRateNote,apiresponse:primaryPayRate:payType::varchar primaryPayRate_payType,apiresponse:primaryPayRate:ratePer::varchar primaryPayRate_ratePer,apiresponse:primaryPayRate:salary::number(38,2) primaryPayRate_salary,apiresponse:primaryStateTax:amount::number(38,2) primaryStateTax_amount,apiresponse:primaryStateTax:deductionsAmount::number(38,2) primaryStateTax_deductionsAmount,apiresponse:primaryStateTax:dependentsAmount::number(38,2) primaryStateTax_dependentsAmount,apiresponse:primaryStateTax:exemptions::number(38,2) primaryStateTax_exemptions,apiresponse:primaryStateTax:exemptions2::number(38,2) primaryStateTax_exemptions2,apiresponse:primaryStateTax:filingStatus::varchar primaryStateTax_filingStatus,apiresponse:primaryStateTax:higherRate::boolean primaryStateTax_higherRate,apiresponse:primaryStateTax:otherIncomeAmount::number(38,2) primaryStateTax_otherIncomeAmount,apiresponse:primaryStateTax:percentage::number(38,2) primaryStateTax_percentage,apiresponse:primaryStateTax:specialCheckCalc::varchar primaryStateTax_specialCheckCalc,apiresponse:primaryStateTax:taxCalculationCode::varchar primaryStateTax_taxCalculationCode,apiresponse:primaryStateTax:taxCode::varchar primaryStateTax_taxCode,apiresponse:primaryStateTax:w4FormYear::number(38,2) primaryStateTax_w4FormYear,apiresponse:priorLastName::varchar priorLastName,apiresponse:salutation::varchar salutation,apiresponse:ssn::varchar ssn,apiresponse:status:adjustedSeniorityDate::varchar status_adjustedSeniorityDate,apiresponse:status:changeReason::varchar status_changeReason,apiresponse:status:effectiveDate::varchar status_effectiveDate,apiresponse:status:employeeStatus::varchar status_employeeStatus,apiresponse:status:hireDate::varchar status_hireDate,apiresponse:status:isEligibleForRehire::boolean status_isEligibleForRehire,apiresponse:status:reHireDate::varchar status_reHireDate,apiresponse:status:statusType::varchar status_statusType,apiresponse:status:terminationDate::varchar status_terminationDate,apiresponse:suffix::varchar suffix,apiresponse:taxSetup:fitwExemptNotes::varchar taxSetup_fitwExemptNotes,apiresponse:taxSetup:fitwExemptReason::varchar taxSetup_fitwExemptReason,apiresponse:taxSetup:futaExemptNotes::varchar taxSetup_futaExemptNotes,apiresponse:taxSetup:futaExemptReason::varchar taxSetup_futaExemptReason,apiresponse:taxSetup:isEmployee943::boolean taxSetup_isEmployee943,apiresponse:taxSetup:isPension::boolean taxSetup_isPension,apiresponse:taxSetup:isStatutory::boolean taxSetup_isStatutory,apiresponse:taxSetup:medExemptNotes::varchar taxSetup_medExemptNotes,apiresponse:taxSetup:medExemptReason::varchar taxSetup_medExemptReason,apiresponse:taxSetup:sitwExemptNotes::varchar taxSetup_sitwExemptNotes,apiresponse:taxSetup:sitwExemptReason::varchar taxSetup_sitwExemptReason,apiresponse:taxSetup:ssExemptNotes::varchar taxSetup_ssExemptNotes,apiresponse:taxSetup:ssExemptReason::varchar taxSetup_ssExemptReason,apiresponse:taxSetup:suiExemptNotes::varchar taxSetup_suiExemptNotes,apiresponse:taxSetup:suiExemptReason::varchar taxSetup_suiExemptReason,apiresponse:taxSetup:suiState::varchar taxSetup_suiState,apiresponse:taxSetup:taxDistributionCode1099R::varchar taxSetup_taxDistributionCode1099R,apiresponse:taxSetup:taxForm::varchar taxSetup_taxForm,apiresponse:veteranDescription::varchar veteranDescription,apiresponse:webTime:badgeNumber::varchar webTime_badgeNumber,apiresponse:webTime:chargeRate::number(38,2) webTime_chargeRate,apiresponse:webTime:isTimeLaborEnabled::boolean webTime_isTimeLaborEnabled,apiresponse:workAddress:address1::varchar workAddress_address1,apiresponse:workAddress:address2::varchar workAddress_address2,apiresponse:workAddress:city::varchar workAddress_city,apiresponse:workAddress:country::varchar workAddress_country,apiresponse:workAddress:county::varchar workAddress_county,apiresponse:workAddress:emailAddress::varchar workAddress_emailAddress,apiresponse:workAddress:location::varchar workAddress_location,apiresponse:workAddress:mailStop::varchar workAddress_mailStop,apiresponse:workAddress:mobilePhone::varchar workAddress_mobilePhone,apiresponse:workAddress:pager::varchar workAddress_pager,apiresponse:workAddress:phone::varchar workAddress_phone,apiresponse:workAddress:phoneExtension::varchar workAddress_phoneExtension,apiresponse:workAddress:postalCode::varchar workAddress_postalCode,apiresponse:workAddress:state::varchar workAddress_state,apiresponse:workEligibility:alienOrAdmissionDocumentNumber::varchar workEligibility_alienOrAdmissionDocumentNumber,apiresponse:workEligibility:attestedDate::varchar workEligibility_attestedDate,apiresponse:workEligibility:countryOfIssuance::varchar workEligibility_countryOfIssuance,apiresponse:workEligibility:foreignPassportNumber::varchar workEligibility_foreignPassportNumber,apiresponse:workEligibility:i94AdmissionNumber::varchar workEligibility_i94AdmissionNumber,apiresponse:workEligibility:i9DateVerified::varchar workEligibility_i9DateVerified,apiresponse:workEligibility:i9Notes::varchar workEligibility_i9Notes,apiresponse:workEligibility:isI9Verified::boolean workEligibility_isI9Verified,apiresponse:workEligibility:isSsnVerified::boolean workEligibility_isSsnVerified,apiresponse:workEligibility:ssnDateVerified::varchar workEligibility_ssnDateVerified,apiresponse:workEligibility:ssnNotes::varchar workEligibility_ssnNotes,apiresponse:workEligibility:visaType::varchar workEligibility_visaType,apiresponse:workEligibility:workAuthorization::varchar workEligibility_workAuthorization,apiresponse:workEligibility:workUntil::varchar workEligibility_workUntil, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM DISC_PROD.PAYLOCITY.HIST_EMPLOYEE_DETAILS WHERE ETL_LAST_UPDATED_DATE = (SELECT MAX(ETL_LAST_UPDATED_DATE) FROM DISC_PROD.PAYLOCITY.HIST_EMPLOYEE_DETAILS);

    return ''Success'';
END;
';