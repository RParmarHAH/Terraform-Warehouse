CREATE OR REPLACE PROCEDURE DISC_PROD.QUALTRICS_SURVEYS.LOAD_DISC_QUALTRICS_SURVEY_RESPONSE("SURVEY_ID" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '

DECLARE
	SQL VARCHAR;
BEGIN
	DELETE FROM DISC_PROD.QUALTRICS_SURVEYS.QUALTRICS_SURVEY_RESPONSE WHERE SURVEY_ID=:SURVEY_ID;
	
	SELECT ''INSERT INTO DISC_PROD.QUALTRICS_SURVEYS.QUALTRICS_SURVEY_RESPONSE SELECT ''''''||SURVEY_ID||'''''',''''''||SURVEY_NAME||'''''',CURRENT_TIMESTAMP(),A.$1 FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Qualtrics_Surveys/''||SURVEY_ID||''/(file_format => DISC_PROD.STAGE.MY_JSON_FORMAT,pattern =>''''.*''||SURVEY_ID||''_Response.*.'''') A;''
	INTO :SQL
	FROM DW_PROD.HAH.DIM_SURVEY 
	WHERE SURVEY_ID=:SURVEY_ID;

	execute immediate SQL;

	INSERT INTO DISC_PROD.QUALTRICS_SURVEYS.HIST_QUALTRICS_SURVEY_RESPONSE(SURVEY_ID,SURVEY_NAME,LOAD_TIME,SURVEY_JSON) SELECT SURVEY_ID, SURVEY_NAME, LOAD_TIME, SURVEY_JSON FROM DISC_PROD.QUALTRICS_SURVEYS.QUALTRICS_SURVEY_RESPONSE WHERE SURVEY_ID=:SURVEY_ID;

return ''Succeeded.'';
END
';