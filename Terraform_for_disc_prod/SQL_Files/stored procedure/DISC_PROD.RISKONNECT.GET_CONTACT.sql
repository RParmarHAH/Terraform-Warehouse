CREATE OR REPLACE PROCEDURE DISC_PROD.RISKONNECT.GET_CONTACT("TASKKEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS ' 
--*****************************************************************************************************************************
-- NAME:  DISC_PROD.RISKONNECT.GET_CONTACT 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO DISC_PROD.RISKONNECT.HIST_CONTACT from (SELECT T.$1 AS Id,T.$2 AS IsDeleted,T.$3 AS MasterRecordId,T.$4 AS AccountId,T.$5 AS LastName,T.$6 AS FirstName,T.$7 AS Salutation,T.$8 AS Name,  T.$9 AS RecordTypeId,  T.$10 AS OtherStreet,  T.$11 AS OtherCity,  T.$12 AS OtherState,  T.$13 AS OtherPostalCode,  T.$14 AS OtherCountry,  T.$15 AS OtherLatitude,  T.$16 AS OtherLongitude,  T.$17 AS OtherGeocodeAccuracy,  T.$18 AS OtherAddress,  T.$19 AS MailingStreet,  T.$20 AS MailingCity,  T.$21 AS MailingState,  T.$22 AS MailingPostalCode,  T.$23 AS MailingCountry,  T.$24 AS MailingLatitude,  T.$25 AS MailingLongitude,  T.$26 AS MailingGeocodeAccuracy,  T.$27 AS Phone,  T.$28 AS Fax,  T.$29 AS MobilePhone,  T.$30 AS HomePhone,  T.$31 AS OtherPhone,  T.$32 AS AssistantPhone,  T.$33 AS ReportsToId,  T.$34 AS Email,  T.$35 AS Title,  T.$36 AS Department,  T.$37 AS AssistantName,  T.$38 AS LeadSource,  T.$39 AS Birthdate,  T.$40 AS Description,  T.$41 AS OwnerId,  REPLACE(T.$42,''T'','' '')::TIMESTAMP_NTZ(9) AS CreatedDate,  T.$43 AS CreatedById,  REPLACE(T.$44,''T'','' '')::TIMESTAMP_NTZ(9) AS LastModifiedDate,  T.$45 AS LastModifiedById,  REPLACE(T.$46,''T'','' '')::TIMESTAMP_NTZ(9) AS SystemModstamp,  T.$47 AS LastActivityDate,  T.$48 AS LastCURequestDate,  T.$49 AS LastCUUpdateDate,  T.$50 AS LastViewedDate,  T.$51 AS LastReferencedDate,  T.$52 AS EmailBouncedReason,  T.$53 AS EmailBouncedDate,  T.$54 AS IsEmailBounced,  T.$55 AS PhotoUrl,  T.$56 AS Jigsaw,  T.$57 AS JigsawContactId,  T.$58 AS ConnectionReceivedId,  T.$59 AS ConnectionSentId,  T.$60 AS IndividualId,  T.$61 AS Account_id_Prior_c__c,  T.$62 AS Apartment_Number__c,  T.$63 AS Average_Weekly_Wage__c,  T.$64 AS City__c,  T.$65 AS Contact_Type__c,  T.$66 AS Country__c,  T.$67 AS Date_of_Death__c,  T.$68 AS Driver_s_License_State__c,  T.$69 AS Run_Mvr__c,  T.$70 AS Employee_Age__c,  T.$71 AS Employee_ID__c,  T.$72 AS Last_MVR_Run_Date__c,  T.$73 AS Employment_Status__c,  T.$74 AS Gender__c,  T.$75 AS Hire_Date__c,  T.$76 AS ID_Prior__c,  T.$77 AS Job_Code__c,  T.$78 AS Level__c,  T.$79 AS Location__c,  T.$80 AS Middle_Initial__c,  T.$81 AS Pay_Type__c,  T.$82 AS Prior_Incident_id__c,  T.$83 AS Prior_Location_id__c,  T.$84 AS Reports_to_id_Prior__c,  T.$86 AS SSN__c,  T.$87 AS Salary__c,  T.$88 AS State__c,  T.$89 AS Supervisor_ID__c,  T.$90 AS Tax_Id__c,  T.$91 AS Termination_Date__c,  T.$92 AS Zip_Code__c,  T.$93 AS Permanent_Accommodation__c,  T.$94 AS Location_Name__c,  T.$95 AS Supervisor_Name__c,  T.$96 AS Supervisor_Title__c,  T.$97 AS Role__c,  TRIM(T.$98) AS Address_1__c,  T.$99 AS Portal_Tester__c,  T.$100 AS Watch_Level__c,  T.$101 AS MVR_Status__c,  T.$102 AS Chart_ID_PA_only__c,  T.$103 AS Client__c,  T.$104 AS Marital_Status__c,  T.$105 AS Initial_Hire_Date__c,  T.$106 AS Active_Inactive__c,  T.$107 AS Service_End_Date__c,  T.$108 AS Is_EE_a_passenger_van_driver__c,  T.$109 AS Service_Start_Date__c,  T.$110 AS Formatting_Error__c,  T.$111 AS Client_ID_Formula__c,  T.$112 AS Department_Code__c,  TRIM(T.$113) AS Ethnic_Origin__c,  TRIM(T.$114) AS Contact_Email__c,  T.$115 AS Permanent_Restrictions__c,  T.$116 AS Medicaid__c,  T.$117 AS Client_ID__c,  T.$118 AS Training_Hours_Earned_2017__c,  T.$119 AS Training_Hours_Needed__c,  T.$120 AS Exam_Date__c,  T.$121 AS Training_Notes__c,  T.$122 AS Training_Year__c,  T.$123 AS Comments__c,  T.$124 AS IDOA_Hours__c,  T.$125 AS Date_Litigation_Hold_Requested__c,  T.$126 AS Training_Hours_Earned_2018__c,  T.$127 AS Training_Earned__c,  T.$128 AS Total_Hours_Earned__c,  T.$129 AS Other_Training_Hours_Earned__c,  T.$130 AS Report_Received__c,  T.$131 AS Grade__c,  T.$132 AS Referred_By__c,  T.$133 AS Mail_Merge__c,  T.$134 AS LOA_letter_address__c,  T.$135 AS Field_or_Admin__c,  T.$136 AS Prior_ID_Number__c,  T.$137 AS Data_Warehouse_ID__c,  T.$138 AS Employee_Number__c,  T.$139 AS Position__c,  T.$140 AS Riskonnect_License_Holder__c,  T.$141 AS Masked_SSN__c,  T.$142 AS Supervisor__c,  T.$143 AS Address_2__c,  T.$144 AS Driver_s_License_Number__c,-1 AS ETL_TASK_KEY, -1 AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM @DISC_PROD.STAGE.AWSAZSTAGEPROD/Riskonnect/Daily_data (file_format => DISC_PROD.STAGE.CSV_FORMAT_UTF8_FALSE,PATTERN => ''.*Contact_.*[.]csv'')T) ;

    --ViewSQL
    CREATE OR REPLACE TABLE DISC_PROD.RISKONNECT.Contact AS SELECT ID,ISDELETED,MASTERRECORDID,ACCOUNTID,LASTNAME,FIRSTNAME,SALUTATION,NAME,RECORDTYPEID,OTHERSTREET,OTHERCITY,OTHERSTATE,OTHERPOSTALCODE,OTHERCOUNTRY,OTHERLATITUDE, OTHERLONGITUDE, OTHERGEOCODEACCURACY, OTHERADDRESS, MAILINGSTREET, MAILINGCITY, MAILINGSTATE, MAILINGPOSTALCODE, MAILINGCOUNTRY, MAILINGLATITUDE, MAILINGLONGITUDE, MAILINGGEOCODEACCURACY, PHONE, FAX, MOBILEPHONE, HOMEPHONE, OTHERPHONE, ASSISTANTPHONE, REPORTSTOID, EMAIL, TITLE, DEPARTMENT, ASSISTANTNAME, LEADSOURCE, BIRTHDATE, DESCRIPTION, OWNERID, CREATEDDATE, CREATEDBYID, LASTMODIFIEDDATE, LASTMODIFIEDBYID, SYSTEMMODSTAMP, LASTACTIVITYDATE, LASTCUREQUESTDATE, LASTCUUPDATEDATE, LASTVIEWEDDATE, LASTREFERENCEDDATE, EMAILBOUNCEDREASON, EMAILBOUNCEDDATE, ISEMAILBOUNCED, PHOTOURL, JIGSAW, JIGSAWCONTACTID, CONNECTIONRECEIVEDID, CONNECTIONSENTID, INDIVIDUALID, ACCOUNT_ID_PRIOR_C__C, APARTMENT_NUMBER__C, AVERAGE_WEEKLY_WAGE__C, CITY__C, CONTACT_TYPE__C, COUNTRY__C, DATE_OF_DEATH__C, DRIVER_S_LICENSE_STATE__C, RUN_MVR__C, EMPLOYEE_AGE__C, EMPLOYEE_ID__C, LAST_MVR_RUN_DATE__C, EMPLOYMENT_STATUS__C, GENDER__C, HIRE_DATE__C, ID_PRIOR__C, JOB_CODE__C, LEVEL__C, LOCATION__C, MIDDLE_INITIAL__C, PAY_TYPE__C, PRIOR_INCIDENT_ID__C, PRIOR_LOCATION_ID__C, REPORTS_TO_ID_PRIOR__C, SSN__C, SALARY__C, STATE__C, SUPERVISOR_ID__C, TAX_ID__C, TERMINATION_DATE__C, ZIP_CODE__C, PERMANENT_ACCOMMODATION__C, LOCATION_NAME__C, SUPERVISOR_NAME__C, SUPERVISOR_TITLE__C, ROLE__C, ADDRESS_1__C, PORTAL_TESTER__C, WATCH_LEVEL__C, MVR_STATUS__C, CHART_ID_PA_ONLY__C, CLIENT__C, MARITAL_STATUS__C, INITIAL_HIRE_DATE__C, ACTIVE_INACTIVE__C, SERVICE_END_DATE__C, IS_EE_A_PASSENGER_VAN_DRIVER__C, SERVICE_START_DATE__C, FORMATTING_ERROR__C, CLIENT_ID_FORMULA__C, DEPARTMENT_CODE__C, ETHNIC_ORIGIN__C, CONTACT_EMAIL__C, PERMANENT_RESTRICTIONS__C, MEDICAID__C, CLIENT_ID__C, TRAINING_HOURS_EARNED_2017__C, TRAINING_HOURS_NEEDED__C, EXAM_DATE__C, TRAINING_NOTES__C, TRAINING_YEAR__C, COMMENTS__C, IDOA_HOURS__C, DATE_LITIGATION_HOLD_REQUESTED__C, TRAINING_HOURS_EARNED_2018__C, TRAINING_EARNED__C, TOTAL_HOURS_EARNED__C, OTHER_TRAINING_HOURS_EARNED__C, REPORT_RECEIVED__C, GRADE__C, REFERRED_BY__C, MAIL_MERGE__C, LOA_LETTER_ADDRESS__C, FIELD_OR_ADMIN__C, PRIOR_ID_NUMBER__C, DATA_WAREHOUSE_ID__C, EMPLOYEE_NUMBER__C, POSITION__C, RISKONNECT_LICENSE_HOLDER__C, MASKED_SSN__C, SUPERVISOR__C, ADDRESS_2__C, DRIVER_S_LICENSE_NUMBER__C, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, CURRENT_USER() AS ETL_INSERTED_BY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, CURRENT_USER() AS ETL_LAST_UPDATED_BY, 0 AS ETL_DELETED_FLAG FROM DISC_PROD.RISKONNECT.HIST_Contact  WHERE (ID,ETL_LAST_UPDATED_DATE) IN (SELECT ID,MAX(ETL_LAST_UPDATED_DATE) FROM DISC_PROD.RISKONNECT.HIST_CONTACT GROUP BY ID);

    return ''Success'';
END;
';