CREATE OR REPLACE PROCEDURE DISC_PROD.PAYOR_CONTRACT_UI.GET_PAYOR("STR_ETL_TASK_KEY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
--*****************************************************************************************************************************
-- NAME:  LOAD_PAYOR 
--
-- PURPOSE: USING THIS SP FOR DISCOVERY TABLE LOAD
--
-- DEVELOPMENT LOG:
-- DATE        AUTHOR                NOTES:
-- ----------  -------------------   -----------------------------------------------------------------------------------------------
-- 2023-11-20 KOMAL DHOKAI            INITIAL DEVELOPMENT
--*****************************************************************************************************************************

DECLARE
    RETURN_RESULT VARCHAR;
BEGIN
MERGE INTO DISC_PROD.PAYOR_CONTRACT_UI.PAYOR TGT 
USING APP_DB_PROD.PAYOR_CONTRACT_MAPPING.PAYOR STAGE 
ON TGT.PAYOR_ID = STAGE.PAYOR_ID
WHEN MATCHED THEN 
UPDATE SET 
	 TGT.PAYOR_NAME = STAGE.PAYOR_NAME
	,TGT.PAYOR_TYPE_CODE = STAGE.PAYOR_TYPE_CODE
	,TGT.NOTES = STAGE.NOTES
	,TGT.PARENT_PAYOR_ID = STAGE.PARENT_PAYOR_ID
	,TGT.PARENT_PAYOR_NAME = STAGE.PARENT_PAYOR_NAME
	,TGT.ETL_LAST_UPDATED_DATE = CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ 
	,TGT.ETL_LAST_UPDATED_BY = CURRENT_USER
    ,TGT.UPDOPERATION = STAGE.UPDOPERATION
    ,TGT.DELETE_FLAG = STAGE.DELETE_FLAG
	,TGT.PAYOR_STATE_CODE = STAGE.PAYOR_STATE_CODE
WHEN NOT MATCHED THEN 
INSERT 
	(PAYOR_ID
	,PAYOR_NAME
	,PAYOR_TYPE_CODE
	,NOTES
	,PARENT_PAYOR_ID
	,PARENT_PAYOR_NAME
	,ETL_TASK_KEY
	,ETL_INSERTED_TASK_KEY
	,ETL_INSERTED_DATE
	,ETL_INSERTED_BY
	,ETL_LAST_UPDATED_DATE
	,ETL_LAST_UPDATED_BY
    ,UPDOPERATION
    ,DELETE_FLAG
	,PAYOR_STATE_CODE)
VALUES 
	(STAGE.PAYOR_ID
	,STAGE.PAYOR_NAME
	,STAGE.PAYOR_TYPE_CODE
	,STAGE.NOTES
	,STAGE.PARENT_PAYOR_ID
	,STAGE.PARENT_PAYOR_NAME
    ,:STR_ETL_TASK_KEY  
	,:STR_ETL_TASK_KEY
	,CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ 
	,CURRENT_USER
	,CONVERT_TIMEZONE(''UTC'', CURRENT_TIMESTAMP)::TIMESTAMP_NTZ 
	,CURRENT_USER
    ,STAGE.UPDOPERATION
    ,STAGE.DELETE_FLAG
	,STAGE.PAYOR_STATE_CODE)
;
SELECT CONCAT(''Message : '',"number of rows inserted", '' Rows Inserted & '' ,"number of rows updated",'' Rows Updated.'') into :return_result FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
return return_result;
END;
';