CREATE OR REPLACE PROCEDURE DISC_PROD.TRUSTPOINTDATA.EMPLOYEES_CV("STR_ETL_TASK_KEY" VARCHAR(16777216), "STR_CDC_START" VARCHAR(16777216), "STR_CDC_END" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
BEGIN 
-- *****************************************************************************************************************************
-- NAME:  EMPLOYEES_CV 
--
-- PURPOSE: USING THIS SP FOR DISCOVERY TABLE LOAD
--
-- DEVELOPMENT LOG:
-- DATE            	AUTHOR                  	NOTES:
-- ----------      	-------------------     	-----------------------------------------------------------------------------------------------
-- 2023-11-20     	JIGAR PRAJAPATI          	INITIAL DEVELOPMENT
--*****************************************************************************************************************************

	CREATE OR REPLACE
	TABLE DISC_PROD.TRUSTPOINTDATA.EMPLOYEES AS
	WITH curr_v AS (
	SELECT 
			COMPANY,
		EMPLOYEE_NUMBER, 
			MAX(ETL_LAST_UPDATED_DATE) AS MAX_LAST_UPDATED_DATE
	FROM
		DISC_PROD.TRUSTPOINTDATA.HIST_EMPLOYEES
	GROUP BY
		COMPANY,
		EMPLOYEE_NUMBER
	)
	SELECT
		t.* EXCLUDE ETL_DELETED_FLAG,
		CASE
			WHEN ETL_INSERTED_DATE::DATE <> CURRENT_DATE THEN TRUE
			ELSE t.ETL_DELETED_FLAG
		END AS ETL_DELETED_FLAG
	FROM
		DISC_PROD.TRUSTPOINTDATA.HIST_EMPLOYEES T
	INNER JOIN curr_v v 
		ON
		t.COMPANY = v.COMPANY
		AND t.EMPLOYEE_NUMBER = v.EMPLOYEE_NUMBER
		AND t.ETL_LAST_UPDATED_DATE = v.MAX_LAST_UPDATED_DATE;
END;
';