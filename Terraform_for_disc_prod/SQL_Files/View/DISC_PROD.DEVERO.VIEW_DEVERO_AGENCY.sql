create or replace view DISC_PROD.DEVERO.VIEW_DEVERO_AGENCY(
	AGENCY_ID,
	BILLING_SYSTEM_AGENCY_ID,
	INTERNAL_NAME,
	DISPLAY_NAME,
	EMAIL,
	PHONE,
	FAX,
	ADDRESS,
	ADDRESS2,
	CITY,
	STATE,
	ZIP_CODE,
	PARENT_AGENCY_ID,
	MEDICARE_PROVIDER_NUMBER,
	MEDICAID_PROVIDER_NUMBER,
	BRANCH_ID,
	HHA_AGENCY_ID,
	IS_HOSPICE,
	TIMEZONE,
	DATE_MODIFIED,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG
) as (
WITH RESULT_DATA AS 
(
SELECT 	DISTINCT
      	A.AGENCY_ID
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'BILLING_SYSTEM_AGENCY_ID'):"$" :: STRING AS BILLING_SYSTEM_AGENCY_ID
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'INTERNAL_NAME'):"$" :: STRING AS INTERNAL_NAME
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'DISPLAY_NAME'):"$" :: STRING AS DISPLAY_NAME
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'EMAIL'):"$" :: STRING AS EMAIL
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'PHONE'):"$" :: STRING AS PHONE
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'FAX'):"$" :: STRING AS FAX
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'ADDRESS'):"$" :: STRING AS ADDRESS
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'ADDRESS2'):"$" :: STRING AS ADDRESS2
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'CITY'):"$" :: STRING AS CITY
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'STATE'):"$" :: STRING AS STATE
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'ZIP_CODE'):"$" :: STRING AS ZIP_CODE
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'PARENT_AGENCY_ID'):"$" :: STRING AS PARENT_AGENCY_ID
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'MEDICARE_PROVIDER_NUMBER'):"$" :: STRING AS MEDICARE_PROVIDER_NUMBER
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'MEDICAID_PROVIDER_NUMBER'):"$" :: STRING AS MEDICAID_PROVIDER_NUMBER
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'BRANCH_ID'):"$" :: STRING AS BRANCH_ID
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'HHA_AGENCY_ID'):"$" :: STRING AS HHA_AGENCY_ID
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'IS_HOSPICE'):"$" :: STRING AS IS_HOSPICE
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'TIMEZONE'):"$" :: STRING AS TIMEZONE
		, XMLGET(PARSE_XML(A.AGENCY_XML), 'DATE_MODIFIED'):"$" :: STRING AS DATE_MODIFIED
		, A.ETL_TASK_KEY
		, A.ETL_INSERTED_TASK_KEY
		, A.ETL_INSERTED_DATE
		, A.ETL_INSERTED_BY
		, A.ETL_LAST_UPDATED_DATE
		, A.ETL_LAST_UPDATED_BY
		, A.ETL_DELETED_FLAG
		, ROW_NUMBER() OVER(PARTITION BY A.AGENCY_ID ORDER BY DATE_MODIFIED DESC) AS LATEST_MODIFIED
  FROM DISC_PROD.DEVERO.HIST_DEVERO_AGENCY  A
--WHERE DATE(A.ETL_LAST_UPDATED_DATE) = COALESCE((
--SELECT MAX(DATE(ETL_LAST_UPDATED_DATE)) FROM DISC_PROD.DEVERO.HIST_DEVERO_AGENCY),DATE(GETDATE()))
)
SELECT AGENCY_ID,
	BILLING_SYSTEM_AGENCY_ID,
	INTERNAL_NAME,
	DISPLAY_NAME,
	EMAIL,
	PHONE,
	FAX,
	ADDRESS,
	ADDRESS2,
	CITY,
	STATE,
	ZIP_CODE,
	PARENT_AGENCY_ID,
	MEDICARE_PROVIDER_NUMBER,
	MEDICAID_PROVIDER_NUMBER,
	BRANCH_ID,
	HHA_AGENCY_ID,
	IS_HOSPICE,
	TIMEZONE,
	DATE_MODIFIED,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG
FROM RESULT_DATA
WHERE LATEST_MODIFIED = 1
);