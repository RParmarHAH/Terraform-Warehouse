create or replace view DISC_PROD.MATRIXCARE.VW_CURRENT_STVHC_T_CAREGIVER(
	CAR_ID,
	CAR_LASTNAME,
	CAR_FIRSTNAME,
	CAR_MIDDLENAME,
	CAR_STATUSID,
	CAR_BRANCHID,
	CAR_REGIONID,
	CAR_INTERNALID,
	CAR_PHONE,
	CAR_PHONETYPE,
	CAR_TITLE,
	CAR_SKILLCD,
	CAR_ADDRESS1,
	CAR_ADDRESS2,
	CAR_CITY,
	CAR_STATEORPROVINCE,
	CAR_POSTALCODE,
	CAR_COUNTY,
	CAR_COUNTRY,
	CAR_EMAIL1,
	CAR_EMAIL2,
	CAR_TEXTMESSAGE,
	CAR_BIRTHDATE,
	CAR_SPOUSENAME,
	CAR_NOTES,
	CAR_ADPFILENUM,
	CAR_NPI,
	CAR_EMPSUBCOD_UD,
	CAR_GROUP,
	CAR_EMPOTFLAG,
	CAR_TELEPHONYID,
	CAR_SUPERVISOR,
	CAR_MANAGER,
	CAR_INTERNALCASEMGR,
	CAR_SHIFTDIFFFLAG,
	CAR_PAYTYPE,
	CAR_WAGECHARTID,
	CAR_PAYRATE,
	CAR_NUMALLOWANCES,
	CAR_WITHHOLD,
	CAR_PAYPREFERENCE,
	CAR_VACATIONHOURS,
	CAR_DDBANKACCTTYPE,
	CAR_EXCLUDEHOLIDAY,
	CAR_CREATEDDATE,
	CAR_CREATEDUSER,
	CAR_MODIFIEDDATE,
	CAR_MODIFIEDUSER,
	CAR_TS,
	CAR_ROLE,
	CAR_LEGACYID,
	CAR_LEGACYBRANCHID,
	CAR_EMPSSN,
	CAR_DDBANKROUTINGNUM,
	CAR_DDBANKACCTNUM,
	CAR_CALCUNIQUESSN,
	CAR_BONUSPOINTSTHERSHOLD,
	CAR_EMPSEXID,
	CAR_MARITALSTATID,
	CAR_EMPSALUTID,
	CAR_NICKNAME,
	CAR_ALLOWMASSEMAIL,
	CAR_REFERRALTERRITORYID,
	CAR_UPLOADTELEPHONY,
	CAR_WSNUMALLOWANCES,
	CAR_WSWITHHOLD,
	CAR_SUISDI_TAXJURISDICTION,
	CAR_FEDFILINGSTATUS,
	CAR_WSFILINGSTATUS,
	CAR_WORKSTATE,
	CAR_RSNUMALLOWANCES,
	CAR_RSWITHHOLD,
	CAR_RSFILINGSTATUS,
	CAR_TELEPHONYALLOWCAREGIVERPHONE,
	CAR_EDIADDITIONALID,
	CAR_EDIADDITIONALIDTYPE,
	CAR_RACEID,
	CAR_EMPMHFLAG,
	INSERTDATE,
	UPDATEDATE,
	DELETEDFLAG,
	SYS_CHANGE_VERSION,
	SYS_CHANGE_OPERATION,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG
) as
--*******************************************************************************************************************************
-- NAME				: VW_CURRENT_STVHC_T_Caregiver
--
-- PURPOSE			: To Populate the Caregiver data to discovery layer
--
-- DEVELOPMENT LOG	:
-- Version #	DATE			AUTHOR				NOTES:
-- ----------	------------	----------------	----------------------------------------------------------------------------
-- v001			12/28/2022		Mohit Vaghadiya		Initial version
-- v002			12/29/2022		Mohit Vaghadiya		Updated Logic to include caregivers listed under CLS Branches where the service 
--													provided from HelpAtHome/Non-CLS branch
---v003         01/12/2024    Trushali Ramoliya     added a training branch CTE in order to exclude those the branches as per IDDOX-605 Exclude Training Branches Employee for Matrixcare
--********************************************************************************************************************************
WITH
TRAININ_BRANCH AS (
SELECT BR_NAME AS OFFICE_NAME,BR_ID AS OFFICE_NUMBER,'MATRIXCARE' AS SYSTEM_CODE , 7 AS SOURCE_SYSTEM_ID, 
  CURRENT_DATE AS CUTTOFF_DATE   FROM  Matrixcare.STVHC_T_Branches
WHERE  BR_NAME ilike ANY ('%train%', '%system%', '%audit%', '%admin%', '%referral%')
),
EXCLUDE_LIST AS 
(
	SELECT DISTINCT CAR_BRANCHID
	FROM MatrixCare.HIST_STVHC_T_Caregiver br
	INNER JOIN UTIL.Migrated_Branch_By_SourceSystem BR_EX 
		ON BR_eX.OFFIcE_NUMBER = BR.CAR_BRANCHID
			AND SOURCE_SYSTEM_ID = 7
			AND SYSTEM_CODE = 'MATRIXCARE'
			UNION 
  SELECT OFFICE_NUMBER FROM TRAININ_BRANCH
),curr_v AS 
(
	SELECT DISTINCT C.car_ID
			, MAX(C.ETL_LAST_UPDATED_DATE) AS MAX_LAST_UPDATED_DATE
	FROM MatrixCare.HIST_STVHC_T_Caregiver C
	WHERE C.car_branchid NOT IN (SELECT DISTINCT EL.CAR_BRANCHID FROM EXCLUDE_LIST EL)
			-- Added for v002
			OR EXISTS(SELECT 1 FROM MatrixCare.HIST_STVHC_T_SCHEDULES S 
					  WHERE S.SCH_CAREGIVERID = C.CAR_ID AND S.SCH_BRANCHID = c.car_branchid 
					  		AND S.SCH_BRANCHID NOT IN (SELECT DISTINCT CAR_BRANCHID FROM EXCLUDE_LIST)
					  )
	GROUP BY C.car_ID
)
SELECT t.*
FROM MatrixCare.HIST_STVHC_T_Caregiver T
INNER JOIN curr_v v 
	ON t.car_ID = v.car_ID
		AND t.ETL_DELETED_FLAG = FALSE
		AND t.ETL_LAST_UPDATED_DATE = v.MAX_LAST_UPDATED_DATE;