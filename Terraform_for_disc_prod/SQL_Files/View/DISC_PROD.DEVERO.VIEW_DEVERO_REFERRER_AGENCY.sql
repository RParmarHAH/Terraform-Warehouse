create or replace view DISC_PROD.DEVERO.VIEW_DEVERO_REFERRER_AGENCY(
	REFERRER_ID,
	AGENCY_ID,
	DATE_MODIFIED,
	ETL_TASK_KEY,
	ETL_INSERTED_TASK_KEY,
	ETL_INSERTED_DATE,
	ETL_INSERTED_BY,
	ETL_LAST_UPDATED_DATE,
	ETL_LAST_UPDATED_BY,
	ETL_DELETED_FLAG
) as (
WITH RESULT_DATA AS
(
SELECT     DISTINCT
          R.REFERRER_ID
        , REFERRER.VALUE:"$" :: STRING AGENCY_ID
        , XMLGET(PARSE_XML(R.REFERRER_XML), 'DATE_MODIFIED'):"$"::STRING AS DATE_MODIFIED
        , R.ETL_TASK_KEY
        , R.ETL_INSERTED_TASK_KEY
        , R.ETL_INSERTED_DATE
        , R.ETL_INSERTED_BY
        , R.ETL_LAST_UPDATED_DATE
        , R.ETL_LAST_UPDATED_BY
        , R.ETL_DELETED_FLAG
        , ROW_NUMBER() OVER(PARTITION BY R.REFERRER_ID,AGENCY_ID ORDER BY DATE_MODIFIED DESC) AS LATEST_MODIFIED
  FROM DISC_PROD.DEVERO.HIST_DEVERO_REFERRER  R
, LATERAL FLATTEN(XMLGET(PARSE_XML(R.REFERRER_XML), 'AGENCY_IDS'):"$":: ARRAY) REFERRER
--WHERE DATE(R.ETL_LAST_UPDATED_DATE) = COALESCE((
--SELECT MAX(DATE(ETL_LAST_UPDATED_DATE)) FROM DISC_PROD.DEVERO.HIST_DEVERO_REFERRER),DATE(GETDATE()))
)
SELECT REFERRER_ID,
    AGENCY_ID,
    DATE_MODIFIED,
    ETL_TASK_KEY,
    ETL_INSERTED_TASK_KEY,
    ETL_INSERTED_DATE,
    ETL_INSERTED_BY,
    ETL_LAST_UPDATED_DATE,
    ETL_LAST_UPDATED_BY,
    ETL_DELETED_FLAG
FROM RESULT_DATA
WHERE LATEST_MODIFIED = 1
);