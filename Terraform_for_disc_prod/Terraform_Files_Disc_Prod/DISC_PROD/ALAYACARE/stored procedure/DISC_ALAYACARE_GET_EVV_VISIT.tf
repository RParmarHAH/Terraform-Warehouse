resource "snowflake_procedure" "DISC_ALAYACARE_GET_EVV_VISIT" {
	name ="GET_EVV_VISIT"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "ALAYACARE"
	language  = "SQL"
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

begin

//    Insert Records in Hist table
    COPY INTO DISC_${var.SF_ENVIRONMENT}.ALAYACARE.HIST_EVV_VISIT FROM (
      SELECT
        DISTINCT
        IFF(j.METADATA$FILENAME LIKE ''%AL.json'', ''AL'', ''GA'') BRANCH_STATE_CODE,
        IFF(j.METADATA$FILENAME LIKE ''%AL.json'', ''3554'', ''1002'') BRANCH_ID,
        j.$1:alayacare_visit_id::number as alayacare_visit_id,
        j.$1:invoice_number::varchar as invoice_number,
        j.$1 as ApiResponse,
        -1 AS ETL_TASK_KEY, -1 AS ETL_INSERTED_TASK_KEY, 
        current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, 
        current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 
        0 as ETL_DELETED_FLAG
      FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/Alayacare/EVV_Visit/alayacare_evv_visit (file_format => DISC_${var.SF_ENVIRONMENT}.STAGE.MY_JSON_FORMAT) j
    );
              
//     Merge records in current view table
    MERGE INTO DISC_${var.SF_ENVIRONMENT}.ALAYACARE.EVV_VISIT TGT
    USING ( 
            SELECT *, 
                ROW_NUMBER() OVER (PARTITION BY ALAYACARE_VISIT_ID ORDER BY IFF(APIRESPONSE:claim_status::varchar = ''void'', 0, 1) DESC) R  
                FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.HIST_EVV_VISIT
            WHERE ETL_LAST_UPDATED_DATE = (SELECT MAX(ETL_LAST_UPDATED_DATE) FROM DISC_${var.SF_ENVIRONMENT}.ALAYACARE.HIST_EVV_VISIT)
            QUALIFY R = 1
          ) STAGE
    ON TGT.ALAYACARE_VISIT_ID = STAGE.ALAYACARE_VISIT_ID 
        AND (
                IFNULL(TGT.INVOICE_NUMBER, '''') = IFNULL(STAGE.INVOICE_NUMBER, '''')
                OR (TGT.INVOICE_NUMBER IS NULL AND STAGE.INVOICE_NUMBER IS NOT NULL)
            )
    WHEN MATCHED THEN
    UPDATE SET 
        TGT.BRANCH_STATE_CODE = STAGE.BRANCH_STATE_CODE,
        TGT.BRANCH_ID = STAGE.BRANCH_ID,
        TGT.alayacare_client_id = STAGE.APIRESPONSE:alayacare_client_id::number,
        TGT.alayacare_employee_id = STAGE.APIRESPONSE:alayacare_employee_id::number,
        TGT.alayacare_funder_id = STAGE.APIRESPONSE:alayacare_funder_id::number,
        TGT.alayacare_funder_state = STAGE.APIRESPONSE:alayacare_funder_state::varchar,
        TGT.alayacare_service_id = STAGE.APIRESPONSE:alayacare_service_id::number,
        TGT.alayacare_visit_id = STAGE.ALAYACARE_VISIT_ID,
        TGT.bill_code_code = STAGE.APIRESPONSE:bill_code:code::varchar,
        TGT.bill_code_description = STAGE.APIRESPONSE:bill_code:description::varchar,
        TGT.bill_code_id = STAGE.APIRESPONSE:bill_code:id::number,
        TGT.bill_code_units = STAGE.APIRESPONSE:bill_code:units::varchar,
        TGT.bill_code_is_midnight_rule_applicable = STAGE.APIRESPONSE:bill_code:is_midnight_rule_applicable::boolean,
        TGT.cancelled = STAGE.APIRESPONSE:cancelled::boolean,
        TGT.cancel_code_id = STAGE.APIRESPONSE:cancel_code:id::number,
        TGT.cancel_code_code = STAGE.APIRESPONSE:cancel_code:code::varchar,
        TGT.cancel_code_description = STAGE.APIRESPONSE:cancel_code:description::varchar,
        TGT.cancel_code_is_billable = STAGE.APIRESPONSE:cancel_code:is_billable::boolean,
        TGT.client_ac_id = STAGE.APIRESPONSE:client:ac_id::varchar,
        TGT.client_address = STAGE.APIRESPONSE:client:address::varchar,
        TGT.client_address_suite = STAGE.APIRESPONSE:client:address_suite::varchar,
        TGT.client_attributes = STAGE.APIRESPONSE:client:attributes,
        TGT.client_birthday = STAGE.APIRESPONSE:client:birthday::varchar,
        TGT.client_city = STAGE.APIRESPONSE:client:city::varchar,
        TGT.client_first_name = STAGE.APIRESPONSE:client:first_name::varchar,
        TGT.client_gender = STAGE.APIRESPONSE:client:gender::varchar,
        TGT.client_last_name = STAGE.APIRESPONSE:client:last_name::varchar,
        TGT.client_phone = STAGE.APIRESPONSE:client:phone::varchar,
        TGT.client_phone_other = STAGE.APIRESPONSE:client:phone_other::varchar,
        TGT.client_phone_personal = STAGE.APIRESPONSE:client:phone_personal::varchar,
        TGT.client_state = STAGE.APIRESPONSE:client:state::varchar,
        TGT.client_zip = STAGE.APIRESPONSE:client:zip::varchar,
        TGT.client_timezone = STAGE.APIRESPONSE:client:timezone::varchar,
        TGT.client_diagnoses = STAGE.APIRESPONSE:client:diagnoses,
        TGT.client_id = STAGE.APIRESPONSE:client_id::varchar,
        TGT.created_by = STAGE.APIRESPONSE:created_by::varchar,
        TGT.created_on = STAGE.APIRESPONSE:created_on::varchar,
        TGT.employee_ac_id = STAGE.APIRESPONSE:employee:ac_id::varchar,
        TGT.employee_attributes = STAGE.APIRESPONSE:employee:attributes,
        TGT.employee_birthday = STAGE.APIRESPONSE:employee:birthday::varchar,
        TGT.employee_email = STAGE.APIRESPONSE:employee:email::varchar,
        TGT.employee_first_name = STAGE.APIRESPONSE:employee:first_name::varchar,
        TGT.employee_gender = STAGE.APIRESPONSE:employee:gender::varchar,
        TGT.employee_last_name = STAGE.APIRESPONSE:employee:last_name::varchar,
        TGT.employee_phone = STAGE.APIRESPONSE:employee:phone::varchar,
        TGT.employee_updated_by = STAGE.APIRESPONSE:employee:updated_by,
        TGT.employee_updated_on = STAGE.APIRESPONSE:employee:updated_on::varchar,
        TGT.employee_id = STAGE.APIRESPONSE:employee_id::varchar,
        TGT.funder_id = STAGE.APIRESPONSE:funder_id::varchar,
        TGT.service_id = STAGE.APIRESPONSE:service_id::varchar,
        TGT.visit_id = STAGE.APIRESPONSE:visit_id::varchar,
        TGT.status = STAGE.APIRESPONSE:status::varchar,
        TGT.evv_status = STAGE.APIRESPONSE:evv_status::varchar,
        TGT.start_at = STAGE.APIRESPONSE:start_at::varchar,
        TGT.end_at = STAGE.APIRESPONSE:end_at::varchar,
        TGT.updated_by = STAGE.APIRESPONSE:updated_by::varchar,
        TGT.updated_on = STAGE.APIRESPONSE:updated_on::varchar,
        TGT.timezone = STAGE.APIRESPONSE:timezone::varchar,
        TGT.invoice_number = STAGE.INVOICE_NUMBER,
        TGT.invoice_line_item_number = STAGE.APIRESPONSE:invoice_line_item_number::varchar,
        TGT.invoice_line_units_billed = STAGE.APIRESPONSE:invoice_line_units_billed::number,
        TGT.invoice_line_rate_by_billing_increment = STAGE.APIRESPONSE:invoice_line_rate_by_billing_increment::number,
        TGT.invoice_line_billing_increment = STAGE.APIRESPONSE:invoice_line_billing_increment::number,
        TGT.invoice_total = STAGE.APIRESPONSE:invoice_total::varchar,
        TGT.invoice_quantity = STAGE.APIRESPONSE:invoice_quantity::varchar,
        TGT.invoice_quantity_units = STAGE.APIRESPONSE:invoice_quantity_units::varchar,
        TGT.invoice_unit_price = STAGE.APIRESPONSE:invoice_unit_price::varchar,
        TGT.claim_status = STAGE.APIRESPONSE:claim_status::varchar,
        TGT.claim_update_flow = STAGE.APIRESPONSE:claim_update_flow::varchar,
        TGT.funder_ac_id = STAGE.APIRESPONSE:funder:ac_id::varchar,
        TGT.funder_address = STAGE.APIRESPONSE:funder:address::varchar,
        TGT.funder_address_suite = STAGE.APIRESPONSE:funder:address_suite::varchar,
        TGT.funder_code = STAGE.APIRESPONSE:funder:code::varchar,
        TGT.funder_city = STAGE.APIRESPONSE:funder:city::varchar,
        TGT.funder_description = STAGE.APIRESPONSE:funder:description::varchar,
        TGT.funder_name = STAGE.APIRESPONSE:funder:name::varchar,
        TGT.funder_state = STAGE.APIRESPONSE:funder:state::varchar,
        TGT.funder_zip = STAGE.APIRESPONSE:funder:zip::varchar,
        TGT.service_name = STAGE.APIRESPONSE:service:name::varchar,
        TGT.service_start_date = STAGE.APIRESPONSE:service:start_date::varchar,
        TGT.service_service_code_id = STAGE.APIRESPONSE:service:service_code_id::number,
        TGT.service_service_code_name = STAGE.APIRESPONSE:service:service_code_name::varchar,
        TGT.service_attributes = STAGE.APIRESPONSE:service:attributes,
        TGT.work_sessions = STAGE.APIRESPONSE:work_sessions,
        TGT.timekeeping_first_clock_in_time = STAGE.APIRESPONSE:timekeeping:first_clock_in_time::varchar,
        TGT.timekeeping_last_clock_out_time = STAGE.APIRESPONSE:timekeeping:last_clock_out_time::varchar,
        TGT.timekeeping_adjusted_start_time = STAGE.APIRESPONSE:timekeeping:adjusted_start_time::varchar,
        TGT.timekeeping_adjusted_end_time = STAGE.APIRESPONSE:timekeeping:adjusted_end_time::varchar,
        TGT.timekeeping_is_adjusted_start_time = STAGE.APIRESPONSE:timekeeping:is_adjusted_start_time::boolean,
        TGT.timekeeping_is_adjusted_end_time = STAGE.APIRESPONSE:timekeeping:is_adjusted_end_time::boolean,
        TGT.notes = STAGE.APIRESPONSE:notes,
        TGT.exceptions = STAGE.APIRESPONSE:exceptions,
        TGT.referring_provider_npi = STAGE.APIRESPONSE:referring_provider:npi::varchar,
        TGT.referring_provider_first_name = STAGE.APIRESPONSE:referring_provider:first_name::varchar,
        TGT.referring_provider_last_name = STAGE.APIRESPONSE:referring_provider:last_name::varchar,
        TGT.interventions_name = STAGE.APIRESPONSE:interventions:name::varchar,
        TGT.ETL_TASK_KEY= STAGE.ETL_TASK_KEY
      ,TGT.ETL_LAST_UPDATED_DATE= STAGE.ETL_LAST_UPDATED_DATE
      ,TGT.ETL_LAST_UPDATED_BY= STAGE.ETL_LAST_UPDATED_BY
      ,TGT.ETL_DELETED_FLAG= STAGE.ETL_DELETED_FLAG
    WHEN NOT MATCHED THEN 
    INSERT (
        BRANCH_STATE_CODE,
        BRANCH_ID,
        ALAYACARE_CLIENT_ID,
        ALAYACARE_EMPLOYEE_ID,
        ALAYACARE_FUNDER_ID,
        ALAYACARE_FUNDER_STATE,
        ALAYACARE_SERVICE_ID,
        ALAYACARE_VISIT_ID,
        BILL_CODE_CODE,
        BILL_CODE_DESCRIPTION,
        BILL_CODE_ID,
        BILL_CODE_UNITS,
        BILL_CODE_IS_MIDNIGHT_RULE_APPLICABLE,
        CANCELLED,
        CANCEL_CODE_ID,
        CANCEL_CODE_CODE,
        CANCEL_CODE_DESCRIPTION,
        CANCEL_CODE_IS_BILLABLE,
        CLIENT_AC_ID,
        CLIENT_ADDRESS,
        CLIENT_ADDRESS_SUITE,
        CLIENT_ATTRIBUTES,
        CLIENT_BIRTHDAY,
        CLIENT_CITY,
        CLIENT_FIRST_NAME,
        CLIENT_GENDER,
        CLIENT_LAST_NAME,
        CLIENT_PHONE,
        CLIENT_PHONE_OTHER,
        CLIENT_PHONE_PERSONAL,
        CLIENT_STATE,
        CLIENT_ZIP,
        CLIENT_TIMEZONE,
        CLIENT_DIAGNOSES,
        CLIENT_ID,
        CREATED_BY,
        CREATED_ON,
        EMPLOYEE_AC_ID,
        EMPLOYEE_ATTRIBUTES,
        EMPLOYEE_BIRTHDAY,
        EMPLOYEE_EMAIL,
        EMPLOYEE_FIRST_NAME,
        EMPLOYEE_GENDER,
        EMPLOYEE_LAST_NAME,
        EMPLOYEE_PHONE,
        EMPLOYEE_UPDATED_BY,
        EMPLOYEE_UPDATED_ON,
        EMPLOYEE_ID,
        FUNDER_ID,
        SERVICE_ID,
        VISIT_ID,
        STATUS,
        EVV_STATUS,
        START_AT,
        END_AT,
        UPDATED_BY,
        UPDATED_ON,
        TIMEZONE,
        INVOICE_NUMBER,
        INVOICE_LINE_ITEM_NUMBER,
        INVOICE_LINE_UNITS_BILLED,
        INVOICE_LINE_RATE_BY_BILLING_INCREMENT,
        INVOICE_LINE_BILLING_INCREMENT,
        INVOICE_TOTAL,
        INVOICE_QUANTITY,
        INVOICE_QUANTITY_UNITS,
        INVOICE_UNIT_PRICE,
        CLAIM_STATUS,
        claim_update_flow,
        FUNDER_AC_ID,
        FUNDER_ADDRESS,
        FUNDER_ADDRESS_SUITE,
        FUNDER_CODE,
        FUNDER_CITY,
        FUNDER_DESCRIPTION,
        FUNDER_NAME,
        FUNDER_STATE,
        FUNDER_ZIP,
        SERVICE_NAME,
        SERVICE_START_DATE,
        SERVICE_SERVICE_CODE_ID,
        SERVICE_SERVICE_CODE_NAME,
        SERVICE_ATTRIBUTES,
        WORK_SESSIONS,
        TIMEKEEPING_FIRST_CLOCK_IN_TIME,
        TIMEKEEPING_LAST_CLOCK_OUT_TIME,
        TIMEKEEPING_ADJUSTED_START_TIME,
        TIMEKEEPING_ADJUSTED_END_TIME,
        TIMEKEEPING_IS_ADJUSTED_START_TIME,
        TIMEKEEPING_IS_ADJUSTED_END_TIME,
        NOTES,
        EXCEPTIONS,
        REFERRING_PROVIDER_NPI,
        REFERRING_PROVIDER_FIRST_NAME,
        REFERRING_PROVIDER_LAST_NAME,
        INTERVENTIONS_NAME,
        ETL_TASK_KEY,
        ETL_INSERTED_TASK_KEY,
        ETL_INSERTED_DATE,
        ETL_INSERTED_BY,
        ETL_LAST_UPDATED_DATE,
        ETL_LAST_UPDATED_BY,
        ETL_DELETED_FLAG
    )
    VALUES
    (
        STAGE.BRANCH_STATE_CODE,
        STAGE.BRANCH_ID,
        STAGE.APIRESPONSE:alayacare_client_id::number,
        STAGE.APIRESPONSE:alayacare_employee_id::number,
        STAGE.APIRESPONSE:alayacare_funder_id::number,
        STAGE.APIRESPONSE:alayacare_funder_state::varchar,
        STAGE.APIRESPONSE:alayacare_service_id::number,
        STAGE.ALAYACARE_VISIT_ID,
        STAGE.APIRESPONSE:bill_code:code::varchar,
        STAGE.APIRESPONSE:bill_code:description::varchar,
        STAGE.APIRESPONSE:bill_code:id::number,
        STAGE.APIRESPONSE:bill_code:units::varchar,
        STAGE.APIRESPONSE:bill_code:is_midnight_rule_applicable::boolean,
        STAGE.APIRESPONSE:cancelled::boolean,
        STAGE.APIRESPONSE:cancel_code:id::number,
        STAGE.APIRESPONSE:cancel_code:code::varchar,
        STAGE.APIRESPONSE:cancel_code:description::varchar,
        STAGE.APIRESPONSE:cancel_code:is_billable::boolean,
        STAGE.APIRESPONSE:client:ac_id::varchar,
        STAGE.APIRESPONSE:client:address::varchar,
        STAGE.APIRESPONSE:client:address_suite::varchar,
        STAGE.APIRESPONSE:client:attributes,
        STAGE.APIRESPONSE:client:birthday::varchar,
        STAGE.APIRESPONSE:client:city::varchar,
        STAGE.APIRESPONSE:client:first_name::varchar,
        STAGE.APIRESPONSE:client:gender::varchar,
        STAGE.APIRESPONSE:client:last_name::varchar,
        STAGE.APIRESPONSE:client:phone::varchar,
        STAGE.APIRESPONSE:client:phone_other::varchar,
        STAGE.APIRESPONSE:client:phone_personal::varchar,
        STAGE.APIRESPONSE:client:state::varchar,
        STAGE.APIRESPONSE:client:zip::varchar,
        STAGE.APIRESPONSE:client:timezone::varchar,
        STAGE.APIRESPONSE:client:diagnoses,
        STAGE.APIRESPONSE:client_id::varchar,
        STAGE.APIRESPONSE:created_by::varchar,
        STAGE.APIRESPONSE:created_on::varchar,
        STAGE.APIRESPONSE:employee:ac_id::varchar,
        STAGE.APIRESPONSE:employee:attributes,
        STAGE.APIRESPONSE:employee:birthday::varchar,
        STAGE.APIRESPONSE:employee:email::varchar,
        STAGE.APIRESPONSE:employee:first_name::varchar,
        STAGE.APIRESPONSE:employee:gender::varchar,
        STAGE.APIRESPONSE:employee:last_name::varchar,
        STAGE.APIRESPONSE:employee:phone::varchar,
        STAGE.APIRESPONSE:employee:updated_by,
        STAGE.APIRESPONSE:employee:updated_on::varchar,
        STAGE.APIRESPONSE:employee_id::varchar,
        STAGE.APIRESPONSE:funder_id::varchar,
        STAGE.APIRESPONSE:service_id::varchar,
        STAGE.APIRESPONSE:visit_id::varchar,
        STAGE.APIRESPONSE:status::varchar,
        STAGE.APIRESPONSE:evv_status::varchar,
        STAGE.APIRESPONSE:start_at::varchar,
        STAGE.APIRESPONSE:end_at::varchar,
        STAGE.APIRESPONSE:updated_by::varchar,
        STAGE.APIRESPONSE:updated_on::varchar,
        STAGE.APIRESPONSE:timezone::varchar,
        STAGE.INVOICE_NUMBER,
        STAGE.APIRESPONSE:invoice_line_item_number::varchar,
        STAGE.APIRESPONSE:invoice_line_units_billed::number,
        STAGE.APIRESPONSE:invoice_line_rate_by_billing_increment::number,
        STAGE.APIRESPONSE:invoice_line_billing_increment::number,
        STAGE.APIRESPONSE:invoice_total::varchar,
        STAGE.APIRESPONSE:invoice_quantity::varchar,
        STAGE.APIRESPONSE:invoice_quantity_units::varchar,
        STAGE.APIRESPONSE:invoice_unit_price::varchar,
        STAGE.APIRESPONSE:claim_status::varchar,
        STAGE.APIRESPONSE:claim_update_flow::varchar,
        STAGE.APIRESPONSE:funder:ac_id::varchar,
        STAGE.APIRESPONSE:funder:address::varchar,
        STAGE.APIRESPONSE:funder:address_suite::varchar,
        STAGE.APIRESPONSE:funder:code::varchar,
        STAGE.APIRESPONSE:funder:city::varchar,
        STAGE.APIRESPONSE:funder:description::varchar,
        STAGE.APIRESPONSE:funder:name::varchar,
        STAGE.APIRESPONSE:funder:state::varchar,
        STAGE.APIRESPONSE:funder:zip::varchar,
        STAGE.APIRESPONSE:service:name::varchar,
        STAGE.APIRESPONSE:service:start_date::varchar,
        STAGE.APIRESPONSE:service:service_code_id::number,
        STAGE.APIRESPONSE:service:service_code_name::varchar,
        STAGE.APIRESPONSE:service:attributes,
        STAGE.APIRESPONSE:work_sessions,
        STAGE.APIRESPONSE:timekeeping:first_clock_in_time::varchar,
        STAGE.APIRESPONSE:timekeeping:last_clock_out_time::varchar,
        STAGE.APIRESPONSE:timekeeping:adjusted_start_time::varchar,
        STAGE.APIRESPONSE:timekeeping:adjusted_end_time::varchar,
        STAGE.APIRESPONSE:timekeeping:is_adjusted_start_time::boolean,
        STAGE.APIRESPONSE:timekeeping:is_adjusted_end_time::boolean,
        STAGE.APIRESPONSE:notes,
        STAGE.APIRESPONSE:exceptions,
        STAGE.APIRESPONSE:referring_provider:npi::varchar,
        STAGE.APIRESPONSE:referring_provider:first_name::varchar,
        STAGE.APIRESPONSE:referring_provider:last_name::varchar,
        STAGE.APIRESPONSE:interventions:name::varchar,
        STAGE.ETL_TASK_KEY
      ,STAGE.ETL_INSERTED_TASK_KEY
      ,STAGE.ETL_INSERTED_DATE
      ,STAGE.ETL_INSERTED_BY
      ,STAGE.ETL_LAST_UPDATED_DATE
      ,STAGE.ETL_LAST_UPDATED_BY
      ,STAGE.ETL_DELETED_FLAG
    );
 
    return ''Succeeded.'';
 
end;

 EOT
}

