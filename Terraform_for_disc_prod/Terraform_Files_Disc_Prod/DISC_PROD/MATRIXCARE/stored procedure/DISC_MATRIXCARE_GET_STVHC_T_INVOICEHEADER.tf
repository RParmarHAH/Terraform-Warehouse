resource "snowflake_procedure" "DISC_MATRIXCARE_GET_STVHC_T_INVOICEHEADER" {
	name ="GET_STVHC_T_INVOICEHEADER"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "MATRIXCARE"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

--*****************************************************************************************************************************
-- NAME:  DISC_${var.SF_ENVIRONMENT}.MatrixCare.GET_STVHC_T_InvoiceHeader 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO MatrixCare.HIST_STVHC_T_InvoiceHeader FROM (SELECT t.$1 AS invh_ID, t.$2 AS invh_InvoiceNumber, t.$3 AS invh_InvoiceDate, t.$4 AS invh_PeriodClosedID, t.$5 AS invh_BranchID, t.$6 AS invh_BillTypeID, t.$7 AS invh_Status, t.$8 AS invh_PayerID, t.$9 AS invh_ClientID, t.$10 AS invh_BatchID, t.$11 AS invh_DraftID, t.$12 AS invh_POCID, t.$13 AS invh_InvoiceTotalRound, t.$14 AS invh_InvoiceTotalRoundDecimal, t.$15 AS invh_InvoiceLineRound, t.$16 AS invh_InvoiceLineRoundDecimal, t.$17 AS invh_CancelDate, t.$18 AS invh_CancelUser, t.$19 AS invh_CreatedUser, t.$20 AS invh_CreatedDate, t.$21 AS invh_ModifiedUser, t.$22 AS invh_ModifiedDate, t.$23 AS invh_TS, t.$24 AS invh_ClientControlNo, t.$25 AS invh_TypeOfBill, t.$26 AS invh_FedTaxID, t.$27 AS invh_StatementFrom, t.$28 AS invh_StatementThrough, t.$29 AS invh_ClientLastName, t.$30 AS invh_ClientFirstName, t.$31 AS invh_ClientMiddleName, t.$32 AS invh_ClientSuffixName, t.$33 AS invh_Address1, t.$34 AS invh_Address2, t.$35 AS invh_City, t.$36 AS invh_StateOrProvince, t.$37 AS invh_PostalCode, t.$38 AS invh_County, t.$39 AS invh_Country, t.$40 AS invh_DOB, t.$41 AS invh_Sex, t.$42 AS invh_ClientNumber, t.$43 AS invh_PrvdrName, t.$44 AS invh_PrvdrAddress1, t.$45 AS invh_PrvdrAddress2, t.$46 AS invh_PrvdrCity, t.$47 AS invh_PrvdrStateOrProvince, t.$48 AS invh_PrvdrPostalCode, t.$49 AS invh_PrvdrCounty, t.$50 AS invh_PrvdrCountry, t.$51 AS invh_PrvdrTelephone, t.$52 AS invh_PrvdrFax, t.$53 AS invh_PrvdrEmail, t.$54 AS invh_PrvdrNPI, t.$55 AS invh_PrvdrType1, t.$56 AS invh_PrvdrID1, t.$57 AS invh_PrvdrType2, t.$58 AS invh_PrvdrID2, t.$59 AS invh_PrvdrType3, t.$60 AS invh_PrvdrID3, t.$61 AS invh_PayName, t.$62 AS invh_PayAddress1, t.$63 AS invh_PayAddress2, t.$64 AS invh_PayCity, t.$65 AS invh_PayStateOrProvince, t.$66 AS invh_PayPostalCode, t.$67 AS invh_PayCounty, t.$68 AS invh_PayCountry, t.$69 AS invh_AdmissionDate, t.$70 AS invh_AdmissionHR, t.$71 AS invh_AdmissionType, t.$72 AS invh_AdmissionSRC, t.$73 AS invh_MedicalRecordNumber, t.$74 AS invh_RPartyName, t.$75 AS invh_RPartyAddress1, t.$76 AS invh_RPartyAddress2, t.$77 AS invh_RPartyCity, t.$78 AS invh_RPartyStateOrProvince, t.$79 AS invh_RPartyPostalCode, t.$80 AS invh_RPartyCounty, t.$81 AS invh_RPartyCountry, t.$82 AS invh_CurrentPayerLocation, t.$83 AS invh_Payer1, t.$84 AS invh_ProviderNo1, t.$85 AS invh_RelInfo1, t.$86 AS invh_AsgBen1, t.$87 AS invh_PriorPayments1, t.$88 AS invh_EstAmountDue1, t.$89 AS invh_Payer2, t.$90 AS invh_ProviderNo2, t.$91 AS invh_RelInfo2, t.$92 AS invh_AsgBen2, t.$93 AS invh_PriorPayments2, t.$94 AS invh_EstAmountDue2, t.$95 AS invh_Payer3, t.$96 AS invh_ProviderNo3, t.$97 AS invh_RelInfo3, t.$98 AS invh_AsgBen3, t.$99 AS invh_PriorPayments3, t.$100 AS invh_EstAmountDue3, t.$101 AS invh_DueFromPatient, t.$102 AS invh_InsuredsName1, t.$103 AS invh_P_Rel1, t.$104 AS invh_GroupName1, t.$105 AS invh_InsuranceGroupNo1, t.$106 AS invh_InsuredsName2, t.$107 AS invh_P_Rel2, t.$108 AS invh_GroupName2, t.$109 AS invh_InsuranceGroupNo2, t.$110 AS invh_InsuredsName3, t.$111 AS invh_P_Rel3, t.$112 AS invh_GroupName3, t.$113 AS invh_InsuranceGroupNo3, t.$114 AS invh_TreatmentAuthCode1, t.$115 AS invh_EmployerName1, t.$116 AS invh_TreatmentAuthCode2, t.$117 AS invh_EmployerName2, t.$118 AS invh_TreatmentAuthCode3, t.$119 AS invh_EmployerName3, t.$120 AS invh_ICDVersion, t.$121 AS invh_PrinDiagCd, t.$122 AS invh_ADMDiagCode, t.$123 AS invh_VisitReason1, t.$124 AS invh_VisitReason2, t.$125 AS invh_VisitReason3, t.$126 AS invh_PPSCode, t.$127 AS invh_ECode1, t.$128 AS invh_ECode2, t.$129 AS invh_ECode3, t.$130 AS invh_Attend_PhysID, t.$131 AS invh_Oper_PhysID, t.$132 AS invh_Other_PhysID1, t.$133 AS invh_Other_PhysID2, t.$134 AS invh_Remarks, t.$135 AS invh_UB04, t.$136 AS invh_OtherDiagnosticsCodeData, t.$137 AS invh_ProcedureCodeData, t.$138 AS invh_AttendingPhysicanData, t.$139 AS invh_OperatingPhysicianData, t.$140 AS invh_OtherPhysician1Data, t.$141 AS invh_OtherPhysician2Data, t.$142 AS invh_CMS1500, t.$143 AS invh_LegacyID, t.$144 AS invh_LegacyBranchId, t.$145 AS invh_AcctExtID, t.$146 AS invh_Balance, t.$147 AS invh_TotalCharges, t.$148 AS invh_ClientPhone, t.$149 AS invh_AdmissionID, t.$150 AS invh_EFTID, t.$151 AS invh_ClientPayerID, t.$152 AS invh_SignedName, t.$153 AS invh_SignedDate, t.$154 AS invh_AuthCode, t.$155 AS invh_Notes, t.$156 AS invh_OriginalServCharges, t.$157 AS invh_OriginalExpCharges, t.$158 AS invh_OriginalTaxCharges, t.$159 AS invh_AdjustedServCharges, t.$160 AS invh_AdjustedExpCharges, t.$161 AS invh_AdjustedTaxCharges, t.$162 AS invh_DisplayTotal, t.$163 AS invh_OriginalCharges, t.$164 AS invh_InvoiceVersion, t.$165 AS invh_GroupingProcessID, t.$166 AS invh_InvoicePrintLine, t.$167 AS invh_RollUpTaxesOnPrint, t.$168 AS invh_Cert_SSN_HIC_ID_No1, t.$169 AS invh_Cert_SSN_HIC_ID_No2, t.$170 AS invh_Cert_SSN_HIC_ID_No3, t.$171 AS invh_JoinICDVersion, t.$172 AS invh_TransferFromInvoiceHeaderID, t.$173 AS invh_TransferToInvoiceHeaderID, t.$174 AS invh_TransferType, t.$175 AS invh_COBInvoiceID, t.$176 AS invh_SchedulePayersChecksum, t.$177 AS invh_COBSequence, t.$178 AS invh_CancelEFTID, t.$179 AS invh_AssociatedPPSInvoiceHeaderID, t.$180 AS invh_RoyaltyFrontPercentage, t.$181 AS InsertDate, t.$182 AS UpdateDate, t.$183 AS DeletedFlag, t.$184 AS SYS_CHANGE_VERSION, CASE WHEN t.$183 = True THEN ''D'' WHEN t.$181 = t.$182 THEN ''I'' ELSE ''U'' END AS SYS_CHANGE_OPERATION, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, COALESCE(t.$183, False) AS ETL_DELETED_FLAG FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/To_Be_Processed/MATRIXCARE/ (PATTERN => ''.*BIDW_17523_AdaptiveNursing_STVHC_T_InvoiceHeader.*[.]csv.gz'' , FILE_FORMAT=>DISC_${var.SF_ENVIRONMENT}.STAGE.MY_CSV_FORMAT) t);

    --ViewSQL
    CREATE OR REPLACE TABLE MatrixCare.STVHC_T_InvoiceHeader AS WITH curr_v AS (SELECT invh_ID, MAX(ETL_LAST_UPDATED_DATE) AS MAX_LAST_UPDATED_DATE FROM MatrixCare.HIST_STVHC_T_InvoiceHeader GROUP BY invh_ID) ,EXCLUDE_LIST AS ( SELECT DISTINCT INVH_BRANCHID FROM MatrixCare.HIST_STVHC_T_InvoiceHeader br  INNER JOIN UTIL.Migrated_Branch_By_SourceSystem  BR_EX ON BR_eX.OFFIcE_NUMBER = BR.INVH_BRANCHID AND SOURCE_SYSTEM_ID = 7 AND SYSTEM_CODE = ''MATRIXCARE'') SELECT t.* FROM MatrixCare.HIST_STVHC_T_InvoiceHeader t INNER JOIN curr_v v ON t.invh_ID = v.invh_ID AND t.ETL_DELETED_FLAG = FALSE AND t.ETL_LAST_UPDATED_DATE = v.MAX_LAST_UPDATED_DATE AND t.INVH_BRANCHID NOT IN (SELECT INVH_BRANCHID FROM EXCLUDE_LIST) ;

    return ''Success'';
END;

 EOT
}

