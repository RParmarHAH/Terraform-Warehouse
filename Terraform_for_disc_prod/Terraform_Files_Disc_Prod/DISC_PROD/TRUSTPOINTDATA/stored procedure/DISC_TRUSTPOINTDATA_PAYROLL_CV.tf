resource "snowflake_procedure" "DISC_TRUSTPOINTDATA_PAYROLL_CV" {
	name ="PAYROLL_CV"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "TRUSTPOINTDATA"
	language  = "SQL"

	arguments {
		name = "STR_ETL_TASK_KEY"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_START"
		type = "VARCHAR(16777216)"
}	

	arguments {
		name = "STR_CDC_END"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

CREATE OR REPLACE TABLE DISC_${var.SF_ENVIRONMENT}.TRUSTPOINTDATA.Payroll AS WITH curr_v AS  
(SELECT COMPANY, PAYROLL_DATE, CHECK_NUMBER, MAX(ETL_LAST_UPDATED_DATE) AS MAX_LAST_UPDATED_DATE  
 FROM DISC_${var.SF_ENVIRONMENT}.TRUSTPOINTDATA.HIST_PAYROLL GROUP BY COMPANY, PAYROLL_DATE, CHECK_NUMBER )  
 SELECT t.* FROM DISC_${var.SF_ENVIRONMENT}.TRUSTPOINTDATA.HIST_PAYROLL t INNER JOIN curr_v v ON t.COMPANY = v.COMPANY 
 AND t.PAYROLL_DATE = v.PAYROLL_DATE AND t.CHECK_NUMBER = v.CHECK_NUMBER AND t.ETL_DELETED_FLAG = FALSE 
 AND t.ETL_LAST_UPDATED_DATE = v.MAX_LAST_UPDATED_DATE;
   
 EOT
}

