resource "snowflake_view" "DISC_DEVERO_VIEW_DEVERO_PATIENT_LIBRARY" {
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "DEVERO"
	name = "VIEW_DEVERO_PATIENT_LIBRARY"
	statement = <<-SQL
	 (
WITH RESUT_DATA AS
(
SELECT DISTINCT
              PL.PATIENT_ID
            , PLIB.VALUE:"$"::STRING AS AGENCY_ID
            , XMLGET(PARSE_XML(PL.PATIENT_LIBRARY_XML), 'ACTIVE'):"$":: STRING AS ACTIVE
            , XMLGET(PARSE_XML(PL.PATIENT_LIBRARY_XML), 'DATE_MODIFIED'):"$":: STRING AS DATE_MODIFIED
            , PL.ETL_TASK_KEY
            , PL.ETL_INSERTED_TASK_KEY
            , PL.ETL_INSERTED_DATE
            , PL.ETL_INSERTED_BY
            , PL.ETL_LAST_UPDATED_DATE
            , PL.ETL_LAST_UPDATED_BY
            , PL.ETL_DELETED_FLAG
            , ROW_NUMBER() OVER(PARTITION BY PL.PATIENT_ID,AGENCY_ID ORDER BY DATE_MODIFIED DESC) AS LATEST_MODIFIED
    FROM DISC_${var.SF_ENVIRONMENT}.DEVERO.HIST_${var.SF_ENVIRONMENT}ERO_PATIENT_LIBRARY PL
  , LATERAL FLATTEN(XMLGET(PARSE_XML(PL.PATIENT_LIBRARY_XML), 'AGENCY_IDS'):"$":: ARRAY) PLIB
--WHERE DATE(PL.ETL_LAST_UPDATED_DATE) = COALESCE((
--SELECT MAX(DATE(ETL_LAST_UPDATED_DATE)) FROM DISC_${var.SF_ENVIRONMENT}.DEVERO.HIST_${var.SF_ENVIRONMENT}ERO_PATIENT_LIBRARY),DATE(GETDATE()))
)
SELECT  PATIENT_ID
        , AGENCY_ID
        , ACTIVE
        , DATE_MODIFIED
        , ETL_TASK_KEY
        , ETL_INSERTED_TASK_KEY
        , ETL_INSERTED_DATE
        , ETL_INSERTED_BY
        , ETL_LAST_UPDATED_DATE
        , ETL_LAST_UPDATED_BY
        , ETL_DELETED_FLAG
FROM RESUT_DATA
WHERE LATEST_MODIFIED = 1
);
SQL
	or_replace = true 
	is_secure = false 
}

