resource "snowflake_procedure" "DISC_RISKONNECT_GET_INTAKE" {
	name ="GET_INTAKE"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "RISKONNECT"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

--*****************************************************************************************************************************
-- NAME:  DISC_${var.SF_ENVIRONMENT}.RISKONNECT.GET_INTAKE 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO DISC_${var.SF_ENVIRONMENT}.RISKONNECT.HIST_Intake from (SELECT T.$1 AS Id,  T.$2 AS OwnerId,  T.$3 AS IsDeleted,  T.$4 AS Name, REPLACE(T.$5,''T'','' '')::TIMESTAMP_NTZ(9) AS CreatedDate,  T.$6 AS CreatedById, REPLACE(T.$7,''T'','' '')::TIMESTAMP_NTZ(9) AS LastModifiedDate,  T.$8 AS LastModifiedById, REPLACE(T.$9,''T'','' '')::TIMESTAMP_NTZ(9) AS SystemModstamp,  T.$10 AS LastActivityDate,  T.$11 AS LastViewedDate,  T.$12 AS LastReferencedDate,  T.$13 AS ConnectionReceivedId,  T.$14 AS ConnectionSentId,  T.$15 AS Additional_Witnesses__c,  T.$16 AS Auto_Company_Vehicle__c,  T.$17 AS Auto_Incident__c,  T.$18 AS Auto_Non_Employee_Injury__c,  T.$19 AS Auto_Non_Employee_Property_Damage__c,  T.$20 AS Comments__c,  T.$21 AS Company_Property_Damage__c,  T.$22 AS Employee_Injury__c,  T.$23 AS IM_Delete_Flag__c,  T.$24 AS IM_Status__c,  T.$25 AS Incident_Address_2__c,  T.$26 AS Incident_Address__c,  T.$27 AS Incident_City__c,  T.$28 AS Incident_Date__c,  T.$29 AS Incident_Day_of_Week__c,  T.$30 AS Incident_Description__c,  T.$31 AS Incident_Location__c,  T.$32 AS Incident_Postal_Code__c,  T.$33 AS Incident_Region__c,  T.$34 AS Incident_State__c,  T.$35 AS Location_Name__c,  T.$36 AS Near_Miss_Grouping__c,  T.$37 AS Near_Miss__c,  T.$38 AS Occur_on_Company_Premises__c,  T.$39 AS Report_Date__c,  T.$40 AS Report_Time__c,  T.$41 AS Reported_By_Contact__c,  T.$42 AS Reported_By_Name__c,  T.$43 AS Reported_By__c,  T.$44 AS Reported_by_First_Name__c,  T.$45 AS Reported_by_Last_Name__c,  T.$46 AS Reported_by_Phone__c,  T.$47 AS Unsafe_Act__c,  T.$48 AS Unsafe_Condition__c,  T.$49 AS Unsafe_Equipment__c,  T.$50 AS Unsafe_Use_of_Equipment__c,  T.$51 AS Witness_1_Contact_Information__c,  T.$52 AS Witness_1_Name__c,  T.$53 AS Witness_2_Contact_Information__c,  T.$54 AS Witness_2_Name__c,  T.$55 AS Witness_3_Contact_Information__c,  T.$56 AS Witness_3_Name__c,  T.$57 AS Witnesses__c,  T.$58 AS X3rd_Party_Bodily_Injury__c,  T.$59 AS X3rd_Party_Property_Damage__c,  T.$60 AS Additional_Entities__c,  T.$61 AS Additional_Exposures__c,  T.$62 AS Admit_Date__c,  T.$63 AS Critical_Event__c,  T.$64 AS Discovery_Time_AM_PM__c,  T.$65 AS Discovery_Time_Picklist__c,  T.$66 AS Entities__c,  T.$67 AS Entity_1_Contact_Name__c,  T.$68 AS Entity_1_Notification_Date__c,  T.$69 AS Entity_1_Notification_Method__c,  T.$70 AS Entity_1_Notification_Time_AM_PM__c,  T.$71 AS Entity_1_Notification_Time__c,  T.$72 AS Entity_1_Type__c,  T.$73 AS Entity_2_Contact_Name__c,  T.$74 AS Entity_2_Notification_Date__c,  T.$75 AS Entity_2_Notification_Method__c,  T.$76 AS Entity_2_Notification_Time_AM_PM__c,  T.$77 AS Entity_2_Notification_Time__c,  T.$78 AS Entity_2_Type__c,  T.$79 AS Entity_3_Contact_Name__c,  T.$80 AS Entity_3_Notification_Date__c,  T.$81 AS Entity_3_Notification_Method__c,  T.$82 AS Entity_3_Notification_Time_AM_PM__c,  T.$83 AS Entity_3_Notification_Time__c,  T.$84 AS Entity_3_Type__c,  T.$85 AS Entity_4_Contact_Name__c,  T.$86 AS Entity_4_Notification_Date__c,  T.$87 AS Entity_4_Notification_Method__c,  T.$88 AS Entity_4_Notification_Time_AM_PM__c,  T.$89 AS Entity_4_Notification_Time__c,  T.$90 AS Entity_4_Type__c,  T.$91 AS Entity_Type_1_Other_Description__c,  T.$92 AS Entity_Type_2_Other_Description__c,  T.$93 AS Entity_Type_3_Other_Description__c,  T.$94 AS Entity_Type_4_Other_Description__c,  T.$95 AS Exposed_1_Name__c,  T.$96 AS Exposed_2_Name__c,  T.$97 AS Exposed_3_Name__c,  T.$98 AS Exposed_4_Name__c,  T.$99 AS Exposed_5_Name__c,  T.$100 AS Exposed_6_Name__c,  T.$101 AS Exposed_7_Name__c,  T.$102 AS Exposure_1_Date_of_Exposure__c,  T.$103 AS Exposure_1_Employee_or_Client__c,  T.$104 AS Exposure_1_Quarantined__c,  T.$105 AS Exposure_1_Wearing_PPE__c,  T.$106 AS Exposure_2_Date_of_Exposure__c,  T.$107 AS Exposure_2_Employee_or_Client__c,  T.$108 AS Exposure_2_Quarantined__c,  T.$109 AS Exposure_2_Wearing_PPE__c,  T.$110 AS Exposure_3_Date_of_Exposure__c,  T.$111 AS Exposure_3_Employee_or_Client__c,  T.$112 AS Exposure_3_Quarantined__c,  T.$113 AS Exposure_3_Wearing_PPE__c,  T.$114 AS Exposure_4_Date_of_Exposure__c,  T.$115 AS Exposure_4_Employee_or_Client__c,  T.$116 AS Exposure_4_Quarantined__c,  T.$117 AS Exposure_4_Wearing_PPE__c,  T.$118 AS Exposure_5_Date_of_Exposure__c,  T.$119 AS Exposure_5_Employee_or_Client__c,  T.$120 AS Exposure_5_Quarantined__c,  T.$121 AS Exposure_5_Wearing_PPE__c,  T.$122 AS Exposure_6_Date_of_Exposure__c,  T.$123 AS Exposure_6_Employee_or_Client__c,  T.$124 AS Exposure_6_Quarantined__c,  T.$125 AS Exposure_6_Wearing_PPE__c,  T.$126 AS Exposure_7_Date_of_Exposure__c,  T.$127 AS Exposure_7_Employee_or_Client__c,  T.$128 AS Exposure_7_Quarantined__c,  T.$129 AS Exposure_7_Wearing_PPE__c,  T.$130 AS Exposures__c,  T.$131 AS Facility__c,  T.$132 AS How_was_event_Preventable__c,  T.$133 AS Immediate_Actions_Other_Description__c,  T.$134 AS Immediate_Actions__c,  T.$135 AS Incident_Date_and_or_Time_Approximated__c,  T.$136 AS Incident_Location_Name__c,  T.$137 AS Incident_Location_Type_Detail__c,  T.$138 AS Incident_Location_Type_Other__c,  T.$139 AS Incident_Location_Type__c,  T.$140 AS Incident_Time_AM_PM__c,  T.$141 AS Incident_Time__c,  T.$142 AS Non_Critical_Event__c,  T.$143 AS Office__c,  T.$144 AS Participant_Status_Other_Description__c,  T.$145 AS Participant_Status__c,  T.$146 AS Preventable_Event__c,  T.$147 AS Relationship_to_Participant__c,  T.$148 AS Reported_by_Email__c,  T.$149 AS Reported_by_Title__c,  T.$150 AS Service_Line_Other_Description__c,  T.$151 AS Service_Line__c,  T.$152 AS Severity_Level__c,  T.$153 AS Severity_for_Participant_Employee__c,  T.$154 AS State__c,  T.$155 AS Witness_1_Relationship_to_Participant__c,  T.$156 AS Witness_2_Relationship_to_Participant__c,  T.$157 AS Witness_3_Relationship_to_Participant__c,  T.$158 AS X3rd_Party_Reporter__c,  T.$159 AS X3rd_Party_Witness__c,  T.$160 AS Reviewed_by_Quality__c,  T.$161 AS Event_Lag_Time__c,  T.$162 AS Resolution_Status__c,  T.$163 AS Resolution_Date__c,  T.$164 AS Resolution_Time__c,  T.$165 AS Convert_to_Claim__c,  T.$166 AS Days_to_Notify_Entity__c,  T.$167 AS Branch_State__c,  T.$168 AS Incident_During_Staff_s_Scheduled_Shift__c,  T.$169 AS Request_claim_be_converted__c,  T.$170 AS Alleged_Theft__c, -1 AS ETL_TASK_KEY, -1 AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/Riskonnect/Daily_data (file_format => DISC_${var.SF_ENVIRONMENT}.STAGE.CSV_FORMAT_UTF8_FALSE,PATTERN => ''.*Intake_.*[.]csv'')T);

    --ViewSQL
    CREATE OR REPLACE TABLE DISC_${var.SF_ENVIRONMENT}.RISKONNECT.Intake AS SELECT ID,  OWNERID,  ISDELETED,  NAME,  CREATEDDATE,  CREATEDBYID,  LASTMODIFIEDDATE,  LASTMODIFIEDBYID,  SYSTEMMODSTAMP,  LASTACTIVITYDATE,  LASTVIEWEDDATE,  LASTREFERENCEDDATE,  CONNECTIONRECEIVEDID,  CONNECTIONSENTID,  ADDITIONAL_WITNESSES__C,  AUTO_COMPANY_VEHICLE__C,  AUTO_INCIDENT__C,  AUTO_NON_EMPLOYEE_INJURY__C,  AUTO_NON_EMPLOYEE_PROPERTY_DAMAGE__C,  COMMENTS__C,  COMPANY_PROPERTY_DAMAGE__C,  EMPLOYEE_INJURY__C,  IM_DELETE_FLAG__C,  IM_STATUS__C,  INCIDENT_ADDRESS_2__C,  INCIDENT_ADDRESS__C,  INCIDENT_CITY__C,  INCIDENT_DATE__C,  INCIDENT_DAY_OF_WEEK__C,  INCIDENT_DESCRIPTION__C,  INCIDENT_LOCATION__C,  INCIDENT_POSTAL_CODE__C,  INCIDENT_REGION__C,  INCIDENT_STATE__C,  LOCATION_NAME__C,  NEAR_MISS_GROUPING__C,  NEAR_MISS__C,  OCCUR_ON_COMPANY_PREMISES__C,  REPORT_DATE__C,  REPORT_TIME__C,  REPORTED_BY_CONTACT__C,  REPORTED_BY_NAME__C,  REPORTED_BY__C,  REPORTED_BY_FIRST_NAME__C,  REPORTED_BY_LAST_NAME__C,  REPORTED_BY_PHONE__C,  UNSAFE_ACT__C,  UNSAFE_CONDITION__C,  UNSAFE_EQUIPMENT__C,  UNSAFE_USE_OF_EQUIPMENT__C,  WITNESS_1_CONTACT_INFORMATION__C,  WITNESS_1_NAME__C,  WITNESS_2_CONTACT_INFORMATION__C,  WITNESS_2_NAME__C,  WITNESS_3_CONTACT_INFORMATION__C,  WITNESS_3_NAME__C,  WITNESSES__C,  X3RD_PARTY_BODILY_INJURY__C,  X3RD_PARTY_PROPERTY_DAMAGE__C,  ADDITIONAL_ENTITIES__C,  ADDITIONAL_EXPOSURES__C,  ADMIT_DATE__C,  CRITICAL_EVENT__C,  DISCOVERY_TIME_AM_PM__C,  DISCOVERY_TIME_PICKLIST__C,  ENTITIES__C,  ENTITY_1_CONTACT_NAME__C,  ENTITY_1_NOTIFICATION_DATE__C,  ENTITY_1_NOTIFICATION_METHOD__C,  ENTITY_1_NOTIFICATION_TIME_AM_PM__C,  ENTITY_1_NOTIFICATION_TIME__C,  ENTITY_1_TYPE__C,  ENTITY_2_CONTACT_NAME__C,  ENTITY_2_NOTIFICATION_DATE__C,  ENTITY_2_NOTIFICATION_METHOD__C,  ENTITY_2_NOTIFICATION_TIME_AM_PM__C,  ENTITY_2_NOTIFICATION_TIME__C,  ENTITY_2_TYPE__C,  ENTITY_3_CONTACT_NAME__C,  ENTITY_3_NOTIFICATION_DATE__C,  ENTITY_3_NOTIFICATION_METHOD__C,  ENTITY_3_NOTIFICATION_TIME_AM_PM__C,  ENTITY_3_NOTIFICATION_TIME__C,  ENTITY_3_TYPE__C,  ENTITY_4_CONTACT_NAME__C,  ENTITY_4_NOTIFICATION_DATE__C,  ENTITY_4_NOTIFICATION_METHOD__C,  ENTITY_4_NOTIFICATION_TIME_AM_PM__C,  ENTITY_4_NOTIFICATION_TIME__C,  ENTITY_4_TYPE__C,  ENTITY_TYPE_1_OTHER_DESCRIPTION__C,  ENTITY_TYPE_2_OTHER_DESCRIPTION__C,  ENTITY_TYPE_3_OTHER_DESCRIPTION__C,  ENTITY_TYPE_4_OTHER_DESCRIPTION__C,  EXPOSED_1_NAME__C,  EXPOSED_2_NAME__C,  EXPOSED_3_NAME__C,  EXPOSED_4_NAME__C,  EXPOSED_5_NAME__C,  EXPOSED_6_NAME__C,  EXPOSED_7_NAME__C,  EXPOSURE_1_DATE_OF_EXPOSURE__C,  EXPOSURE_1_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_1_QUARANTINED__C,  EXPOSURE_1_WEARING_PPE__C,  EXPOSURE_2_DATE_OF_EXPOSURE__C,  EXPOSURE_2_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_2_QUARANTINED__C,  EXPOSURE_2_WEARING_PPE__C,  EXPOSURE_3_DATE_OF_EXPOSURE__C,  EXPOSURE_3_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_3_QUARANTINED__C,  EXPOSURE_3_WEARING_PPE__C,  EXPOSURE_4_DATE_OF_EXPOSURE__C,  EXPOSURE_4_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_4_QUARANTINED__C,  EXPOSURE_4_WEARING_PPE__C,  EXPOSURE_5_DATE_OF_EXPOSURE__C,  EXPOSURE_5_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_5_QUARANTINED__C,  EXPOSURE_5_WEARING_PPE__C,  EXPOSURE_6_DATE_OF_EXPOSURE__C,  EXPOSURE_6_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_6_QUARANTINED__C,  EXPOSURE_6_WEARING_PPE__C,  EXPOSURE_7_DATE_OF_EXPOSURE__C,  EXPOSURE_7_EMPLOYEE_OR_CLIENT__C,  EXPOSURE_7_QUARANTINED__C,  EXPOSURE_7_WEARING_PPE__C,  EXPOSURES__C,  FACILITY__C,  HOW_WAS_EVENT_PREVENTABLE__C,  IMMEDIATE_ACTIONS_OTHER_DESCRIPTION__C,  IMMEDIATE_ACTIONS__C,  INCIDENT_DATE_AND_OR_TIME_APPROXIMATED__C,  INCIDENT_LOCATION_NAME__C,  INCIDENT_LOCATION_TYPE_DETAIL__C,  INCIDENT_LOCATION_TYPE_OTHER__C,  INCIDENT_LOCATION_TYPE__C,  INCIDENT_TIME_AM_PM__C,  INCIDENT_TIME__C,  NON_CRITICAL_EVENT__C,  OFFICE__C,  PARTICIPANT_STATUS_OTHER_DESCRIPTION__C,  PARTICIPANT_STATUS__C,  PREVENTABLE_EVENT__C,  RELATIONSHIP_TO_PARTICIPANT__C,  REPORTED_BY_EMAIL__C,  REPORTED_BY_TITLE__C,  SERVICE_LINE_OTHER_DESCRIPTION__C,  SERVICE_LINE__C,  SEVERITY_LEVEL__C,  SEVERITY_FOR_PARTICIPANT_EMPLOYEE__C,  STATE__C,  WITNESS_1_RELATIONSHIP_TO_PARTICIPANT__C,  WITNESS_2_RELATIONSHIP_TO_PARTICIPANT__C,  WITNESS_3_RELATIONSHIP_TO_PARTICIPANT__C,  X3RD_PARTY_REPORTER__C,  X3RD_PARTY_WITNESS__C,  REVIEWED_BY_QUALITY__C,  EVENT_LAG_TIME__C,  RESOLUTION_STATUS__C,  RESOLUTION_DATE__C,  RESOLUTION_TIME__C,  CONVERT_TO_CLAIM__C,  DAYS_TO_NOTIFY_ENTITY__C,  BRANCH_STATE__C,  INCIDENT_DURING_STAFF_S_SCHEDULED_SHIFT__C,  REQUEST_CLAIM_BE_CONVERTED__C,  ALLEGED_THEFT__C, :TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, CURRENT_USER() AS ETL_INSERTED_BY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, CURRENT_USER() AS ETL_LAST_UPDATED_BY, 0 AS ETL_DELETED_FLAG FROM DISC_${var.SF_ENVIRONMENT}.RISKONNECT.HIST_Intake WHERE (ID,ETL_LAST_UPDATED_DATE) IN (SELECT ID,MAX(ETL_LAST_UPDATED_DATE) FROM DISC_${var.SF_ENVIRONMENT}.RISKONNECT.HIST_Intake GROUP BY ID);

    return ''Success'';
END;

 EOT
}

