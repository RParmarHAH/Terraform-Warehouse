resource "snowflake_procedure" "DISC_PARADOX_GET_CANDIDATE_JOURNEY" {
	name ="GET_CANDIDATE_JOURNEY"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "PARADOX"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

--*****************************************************************************************************************************
-- NAME:  GET_CANDIDATE_JOURNEY 
--
-- PURPOSE: USING THIS SP FOR DISCOVERY TABLE LOAD
--
-- DEVELOPMENT LOG:
-- DATE				AUTHOR										NOTES:
-- ----------		-------------------							-----------------------------------------------------------------------------------------------
-- 2023-11-20		KOMAL DHOKAI/RAVI SUTHAR					INITIAL DEVELOPMENT
--*****************************************************************************************************************************

 
BEGIN 
    --TARGETSQL
    COPY INTO DISC_${var.SF_ENVIRONMENT}.PARADOX.HIST_CANDIDATE_JOURNEY FROM ( SELECT A.$1 REQ_ID, A.$2 JOB_TITLE, A.$3 STORE, A.$4 ORGANIZATIONAL_ALIGNMENT, A.$5 STATE, A.$6 CITY, A.$7 CANDIDATE_ID, A.$8 CANDIDATE_NAME, A.$9 PHONE_NUMBER, A.$10 EMAIL, A.$11 STATUS, A.$12 CANDIDATE_ENGAGED_CLICKED_APPLY_NOW, A.$13 CANDIDATE_CAPTURE_COMPLETE_SCREENING_COMPLETE, A.$14 REJECTED_DID_NOT_MEET_AGE_REQUIREMENTS, A.$15 INTERVIEW_REQUEST_SENT, A.$16 INTERVIEW_ACCEPTED_BY_CANDIDATE, A.$17 INTERVIEW_REQUEST_CANCELED_USER, A.$18 INTERVIEW_REQUEST_CANCELED_CANDIDATE, A.$19 INTERVIEW_SCHEDULED, A.$20 INTERVIEW_NO_SHOW, A.$21 REJECTED_NOT_ELIGIBLE_FOR_WORK, A.$22 HIRE, A.$23 TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_ACCEPTANCE, A.$24 TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_SCHEDULED, A.$25 TIME_FROM_INTERVIEW_REQUEST_SENT_TO_INTERVIEW_SCHEDULED_, A.$26 TIME_FROM_INTERVIEW_SCHEDULED_TO_HIRE, A.$27 TIME_FROM_CAPTURE_COMPLETE_TO_HIRE, A.$28 CANDIDATE_SOURCE, A.$29 CANDIDATE_SOURCED_FROM_NAME, A.$30 RECORDED_VIDEO_INTERVIEW, A.$31 RECORDED_VIDEO_RESPONSE_COUNT, A.$32 RECORDED_VIDEO_QUESTIONS_SENT, A.$33 ALL_RECORDED_VIDEO_ANSWERS_WITHIN_24_HOURS, A.$34 TOTAL_PARADOX_VIDEO_MEETINGS, A.$35 TOTAL_PARADOX_VIDEO_DURATION_IN_MINUTES, A.$36 SEND_FULL_APPLICATION_FORM, A.$37 FULL_APPLICATION_FORM_COMPLETE, A.$38 ONBOARDING_SENT, A.$39 ONBOARDING_COMPLETE, A.$40 TIME_FROM_INTERVIEW_SCHEDULED_TO_ONBOARDING_COMPLETE, A.$41 OFFER_SENT, A.$42 OFFER_ACCEPTED, A.$43 OFFER_DECLINED, A.$44 TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_SENT, A.$45 TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_ACCEPTED, A.$46 ANTICIPATED_START_DATE_HIRE_DETAILS, A.$47 TIME_FROM_INTERVIEW_SCHEDULED_TO_START_DATE, A.$48 JOB_TITLE_CODE, A.$49 PROFILE_ID, A.$50 MULTIPLE_RECORDS, A.$51 PRIMARY_IDENTIFIER, A.$52 REAPPLY_IN_CAPTURE, A.$53 REAPPLY_IN_JOB_SEARCH, A.$54 REAPPLY_IN_CAMPAIGN, :TASKKEY AS ETL_TASK_KEY, :TASKKEY AS ETL_INSERTED_TASK_KEY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, CURRENT_USER() AS ETL_INSERTED_BY, CURRENT_TIMESTAMP::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, CURRENT_USER() AS ETL_LAST_UPDATED_BY, 0 AS ETL_DELETED_FLAG  FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/PARADOX/Upload_file/HireCandidate.Journey.Report (FILE_FORMAT => DISC_${var.SF_ENVIRONMENT}.STAGE.CSV_FORMAT) A);

    --VIEWSQL
    MERGE INTO DISC_${var.SF_ENVIRONMENT}.PARADOX.CANDIDATE_JOURNEY TGT  USING (   SELECT *   FROM DISC_${var.SF_ENVIRONMENT}.PARADOX.HIST_CANDIDATE_JOURNEY WHERE ETL_LAST_UPDATED_DATE = ( SELECT MAX(ETL_LAST_UPDATED_DATE) FROM DISC_${var.SF_ENVIRONMENT}.PARADOX.HIST_CANDIDATE_JOURNEY)    ) STAGE  ON TGT.CANDIDATE_ID = STAGE.CANDIDATE_ID WHEN MATCHED THEN  UPDATE SET     TGT.REQ_ID = STAGE.REQ_ID, TGT.JOB_TITLE = STAGE.JOB_TITLE, TGT.STORE = STAGE.STORE, TGT.ORGANIZATIONAL_ALIGNMENT = STAGE.ORGANIZATIONAL_ALIGNMENT, TGT.STATE = STAGE.STATE, TGT.CITY = STAGE.CITY, TGT.CANDIDATE_ID = STAGE.CANDIDATE_ID, TGT.CANDIDATE_NAME = STAGE.CANDIDATE_NAME, TGT.PHONE_NUMBER = STAGE.PHONE_NUMBER, TGT.EMAIL = STAGE.EMAIL, TGT.STATUS = STAGE.STATUS, TGT.CANDIDATE_ENGAGED_CLICKED_APPLY_NOW = STAGE.CANDIDATE_ENGAGED_CLICKED_APPLY_NOW, TGT.CANDIDATE_CAPTURE_COMPLETE_SCREENING_COMPLETE = STAGE.CANDIDATE_CAPTURE_COMPLETE_SCREENING_COMPLETE, TGT.REJECTED__DID_NOT_MEET_AGE_REQUIREMENTS = STAGE.REJECTED__DID_NOT_MEET_AGE_REQUIREMENTS, TGT.INTERVIEW_REQUEST_SENT = STAGE.INTERVIEW_REQUEST_SENT, TGT.INTERVIEW_ACCEPTED_BY_CANDIDATE = STAGE.INTERVIEW_ACCEPTED_BY_CANDIDATE, TGT.INTERVIEW_REQUEST_CANCELED_USER = STAGE.INTERVIEW_REQUEST_CANCELED_USER, TGT.INTERVIEW_REQUEST_CANCELED_CANDIDATE = STAGE.INTERVIEW_REQUEST_CANCELED_CANDIDATE, TGT.INTERVIEW_SCHEDULED = STAGE.INTERVIEW_SCHEDULED, TGT.INTERVIEW_NO_SHOW = STAGE.INTERVIEW_NO_SHOW, TGT.REJECTED__NOT_ELIGIBLE_FOR_WORK = STAGE.REJECTED__NOT_ELIGIBLE_FOR_WORK, TGT.HIRE = STAGE.HIRE, TGT.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_ACCEPTANCE = STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_ACCEPTANCE, TGT.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_SCHEDULED = STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_SCHEDULED, TGT.TIME_FROM_INTERVIEW_REQUEST_SENT_TO_INTERVIEW_SCHEDULED_ = STAGE.TIME_FROM_INTERVIEW_REQUEST_SENT_TO_INTERVIEW_SCHEDULED_, TGT.TIME_FROM_INTERVIEW_SCHEDULED_TO_HIRE = STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_HIRE, TGT.TIME_FROM_CAPTURE_COMPLETE_TO_HIRE = STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_HIRE, TGT.CANDIDATE_SOURCE = STAGE.CANDIDATE_SOURCE, TGT.CANDIDATE_SOURCED_FROM_NAME = STAGE.CANDIDATE_SOURCED_FROM_NAME, TGT.RECORDED_VIDEO_INTERVIEW = STAGE.RECORDED_VIDEO_INTERVIEW, TGT.RECORDED_VIDEO_RESPONSE_COUNT = STAGE.RECORDED_VIDEO_RESPONSE_COUNT, TGT.RECORDED_VIDEO_QUESTIONS_SENT = STAGE.RECORDED_VIDEO_QUESTIONS_SENT, TGT.ALL_RECORDED_VIDEO_ANSWERS_WITHIN_24_HOURS = STAGE.ALL_RECORDED_VIDEO_ANSWERS_WITHIN_24_HOURS, TGT.TOTAL_PARADOX_VIDEO_MEETINGS = STAGE.TOTAL_PARADOX_VIDEO_MEETINGS, TGT.TOTAL_PARADOX_VIDEO_DURATION_IN_MINUTES = STAGE.TOTAL_PARADOX_VIDEO_DURATION_IN_MINUTES, TGT.SEND_FULL_APPLICATION_FORM = STAGE.SEND_FULL_APPLICATION_FORM, TGT.FULL_APPLICATION_FORM_COMPLETE = STAGE.FULL_APPLICATION_FORM_COMPLETE, TGT.ONBOARDING_SENT = STAGE.ONBOARDING_SENT, TGT.ONBOARDING_COMPLETE = STAGE.ONBOARDING_COMPLETE, TGT.TIME_FROM_INTERVIEW_SCHEDULED_TO_ONBOARDING_COMPLETE = STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_ONBOARDING_COMPLETE, TGT.OFFER_SENT = STAGE.OFFER_SENT, TGT.OFFER_ACCEPTED = STAGE.OFFER_ACCEPTED, TGT.OFFER_DECLINED = STAGE.OFFER_DECLINED, TGT.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_SENT = STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_SENT, TGT.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_ACCEPTED = STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_ACCEPTED, TGT.ANTICIPATED_START_DATE_HIRE_DETAILS = STAGE.ANTICIPATED_START_DATE_HIRE_DETAILS, TGT.TIME_FROM_INTERVIEW_SCHEDULED_TO_START_DATE = STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_START_DATE, TGT.JOB_TITLE_CODE = STAGE.JOB_TITLE_CODE, TGT.PROFILE_ID = STAGE.PROFILE_ID, TGT.MULTIPLE_RECORDS = STAGE.MULTIPLE_RECORDS, TGT.PRIMARY_IDENTIFIER = STAGE.PRIMARY_IDENTIFIER, TGT.REAPPLY_IN_CAPTURE = STAGE.REAPPLY_IN_CAPTURE, TGT.REAPPLY_IN_JOB_SEARCH = STAGE.REAPPLY_IN_JOB_SEARCH, TGT.REAPPLY_IN_CAMPAIGN = STAGE.REAPPLY_IN_CAMPAIGN    ,TGT.ETL_TASK_KEY= STAGE.ETL_TASK_KEY    ,TGT.ETL_LAST_UPDATED_DATE= STAGE.ETL_LAST_UPDATED_DATE    ,TGT.ETL_LAST_UPDATED_BY= STAGE.ETL_LAST_UPDATED_BY    ,TGT.ETL_DELETED_FLAG= STAGE.ETL_DELETED_FLAG::NUMBER WHEN NOT MATCHED THEN  INSERT (     REQ_ID, JOB_TITLE, STORE, ORGANIZATIONAL_ALIGNMENT, STATE, CITY, CANDIDATE_ID, CANDIDATE_NAME, PHONE_NUMBER, EMAIL, STATUS, CANDIDATE_ENGAGED_CLICKED_APPLY_NOW, CANDIDATE_CAPTURE_COMPLETE_SCREENING_COMPLETE, REJECTED__DID_NOT_MEET_AGE_REQUIREMENTS, INTERVIEW_REQUEST_SENT, INTERVIEW_ACCEPTED_BY_CANDIDATE, INTERVIEW_REQUEST_CANCELED_USER, INTERVIEW_REQUEST_CANCELED_CANDIDATE, INTERVIEW_SCHEDULED, INTERVIEW_NO_SHOW, REJECTED__NOT_ELIGIBLE_FOR_WORK, HIRE, TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_ACCEPTANCE, TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_SCHEDULED, TIME_FROM_INTERVIEW_REQUEST_SENT_TO_INTERVIEW_SCHEDULED_, TIME_FROM_INTERVIEW_SCHEDULED_TO_HIRE, TIME_FROM_CAPTURE_COMPLETE_TO_HIRE, CANDIDATE_SOURCE, CANDIDATE_SOURCED_FROM_NAME, RECORDED_VIDEO_INTERVIEW, RECORDED_VIDEO_RESPONSE_COUNT, RECORDED_VIDEO_QUESTIONS_SENT, ALL_RECORDED_VIDEO_ANSWERS_WITHIN_24_HOURS, TOTAL_PARADOX_VIDEO_MEETINGS, TOTAL_PARADOX_VIDEO_DURATION_IN_MINUTES, SEND_FULL_APPLICATION_FORM, FULL_APPLICATION_FORM_COMPLETE, ONBOARDING_SENT, ONBOARDING_COMPLETE, TIME_FROM_INTERVIEW_SCHEDULED_TO_ONBOARDING_COMPLETE, OFFER_SENT, OFFER_ACCEPTED, OFFER_DECLINED, TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_SENT, TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_ACCEPTED, ANTICIPATED_START_DATE_HIRE_DETAILS, TIME_FROM_INTERVIEW_SCHEDULED_TO_START_DATE, JOB_TITLE_CODE, PROFILE_ID, MULTIPLE_RECORDS, PRIMARY_IDENTIFIER, REAPPLY_IN_CAPTURE, REAPPLY_IN_JOB_SEARCH, REAPPLY_IN_CAMPAIGN, ETL_TASK_KEY, ETL_INSERTED_TASK_KEY, ETL_INSERTED_DATE, ETL_INSERTED_BY, ETL_LAST_UPDATED_DATE, ETL_LAST_UPDATED_BY, ETL_DELETED_FLAG )  VALUES (    STAGE.REQ_ID, STAGE.JOB_TITLE, STAGE.STORE, STAGE.ORGANIZATIONAL_ALIGNMENT, STAGE.STATE, STAGE.CITY, STAGE.CANDIDATE_ID, STAGE.CANDIDATE_NAME, STAGE.PHONE_NUMBER, STAGE.EMAIL, STAGE.STATUS, STAGE.CANDIDATE_ENGAGED_CLICKED_APPLY_NOW, STAGE.CANDIDATE_CAPTURE_COMPLETE_SCREENING_COMPLETE, STAGE.REJECTED__DID_NOT_MEET_AGE_REQUIREMENTS, STAGE.INTERVIEW_REQUEST_SENT, STAGE.INTERVIEW_ACCEPTED_BY_CANDIDATE, STAGE.INTERVIEW_REQUEST_CANCELED_USER, STAGE.INTERVIEW_REQUEST_CANCELED_CANDIDATE, STAGE.INTERVIEW_SCHEDULED, STAGE.INTERVIEW_NO_SHOW, STAGE.REJECTED__NOT_ELIGIBLE_FOR_WORK, STAGE.HIRE, STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_ACCEPTANCE, STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_INTERVIEW_SCHEDULED, STAGE.TIME_FROM_INTERVIEW_REQUEST_SENT_TO_INTERVIEW_SCHEDULED_, STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_HIRE, STAGE.TIME_FROM_CAPTURE_COMPLETE_TO_HIRE, STAGE.CANDIDATE_SOURCE, STAGE.CANDIDATE_SOURCED_FROM_NAME, STAGE.RECORDED_VIDEO_INTERVIEW, STAGE.RECORDED_VIDEO_RESPONSE_COUNT, STAGE.RECORDED_VIDEO_QUESTIONS_SENT, STAGE.ALL_RECORDED_VIDEO_ANSWERS_WITHIN_24_HOURS, STAGE.TOTAL_PARADOX_VIDEO_MEETINGS, STAGE.TOTAL_PARADOX_VIDEO_DURATION_IN_MINUTES, STAGE.SEND_FULL_APPLICATION_FORM, STAGE.FULL_APPLICATION_FORM_COMPLETE, STAGE.ONBOARDING_SENT, STAGE.ONBOARDING_COMPLETE, STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_ONBOARDING_COMPLETE, STAGE.OFFER_SENT, STAGE.OFFER_ACCEPTED, STAGE.OFFER_DECLINED, STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_SENT, STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_OFFER_ACCEPTED, STAGE.ANTICIPATED_START_DATE_HIRE_DETAILS, STAGE.TIME_FROM_INTERVIEW_SCHEDULED_TO_START_DATE, STAGE.JOB_TITLE_CODE, STAGE.PROFILE_ID, STAGE.MULTIPLE_RECORDS, STAGE.PRIMARY_IDENTIFIER, STAGE.REAPPLY_IN_CAPTURE, STAGE.REAPPLY_IN_JOB_SEARCH, STAGE.REAPPLY_IN_CAMPAIGN, STAGE.ETL_TASK_KEY, STAGE.ETL_INSERTED_TASK_KEY, STAGE.ETL_INSERTED_DATE, STAGE.ETL_INSERTED_BY, STAGE.ETL_LAST_UPDATED_DATE, STAGE.ETL_LAST_UPDATED_BY, STAGE.ETL_DELETED_FLAG::NUMBER );

    RETURN ''SUCCESS'';
END;


 EOT
}

