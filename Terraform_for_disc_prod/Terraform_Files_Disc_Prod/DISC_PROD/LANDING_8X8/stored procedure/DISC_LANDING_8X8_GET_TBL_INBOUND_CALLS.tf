resource "snowflake_procedure" "DISC_LANDING_8X8_GET_TBL_INBOUND_CALLS" {
	name ="GET_TBL_INBOUND_CALLS"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "LANDING_8X8"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

--*****************************************************************************************************************************
-- NAME:  DISC_${var.SF_ENVIRONMENT}.LANDING_8X8.GET_TBL_INBOUND_CALLS 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                				NOTES:
-- ----------  		-------------------   				-----------------------------------------------------------------------------------------------
-- 2024-01-04 		RSUTHAR/KDHOKAI/MJARECHA            Initial Development
--*****************************************************************************************************************************
BEGIN

	-- TargetSQL 
	INSERT 	INTO DISC_${var.SF_ENVIRONMENT}.LANDING_8X8.HIST_TBL_INBOUND_CALLS SELECT DISTINCT 	DNIS, AA_DESTINATION, CALL_ID, START_TIME_UTC, TO_TIMESTAMP(START_TIME, ''YYYY-MM-DDTHH24:MI:SS.FF3TZHTZM'')::TIMESTAMP_NTZ, CONNECT_TIME_UTC, CONNECT_TIME, DISCONNECTED_TIME_UTC, TO_TIMESTAMP(DISCONNECTED_TIME, ''YYYY-MM-DDTHH24:MI:SS.FF3TZHTZM'')::TIMESTAMP_NTZ, TALK_TIME_MS, TALK_TIME, CALLER, CALLER_NAME, CALLEE, CALLEE_NAME, DIRECTION, CALLER_ID, MISSED, ABANDONED, ANSWERED, ANSWERED_TIME, CALLEE_DISCONNECT_ON_HOLD, CALLER_DISCONNECT_ON_HOLD, PBX_ID, SIP_CALL_ID, LAST_LEG_DISPOSITION, CALL_LEG_COUNT, CALL_TIME, RING_DURATION, ABANDONED_TIME, CALLEE_HOLD_DURATION_MS, CALLEE_HOLD_DURATION, WAIT_TIME_MS, WAIT_TIME, DEPARTMENTS, BRANCHES, 	:TaskKey AS ETL_TASK_KEY, 	:TaskKey AS ETL_INSERTED_TASK_KEY, 	current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, 	current_user() AS ETL_INSERTED_BY, 	current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, 	current_user() AS ETL_LAST_UPDATED_BY FROM AWS_LANDING_INGEST_DB_${var.SF_ENVIRONMENT}.LANDING_8X8_SCHEMA.LANDING_8X8_TBL_INBOUND_CALLS;
 

	-- ViewSQL 
	MERGE INTO DISC_${var.SF_ENVIRONMENT}.LANDING_8X8.TBL_INBOUND_CALLS TGT USING ( SELECT 	* FROM 	DISC_${var.SF_ENVIRONMENT}.LANDING_8X8.HIST_TBL_INBOUND_CALLS WHERE 	ETL_LAST_UPDATED_DATE = ( 	SELECT 		MAX(ETL_LAST_UPDATED_DATE) 	FROM 		DISC_${var.SF_ENVIRONMENT}.LANDING_8X8.HIST_TBL_INBOUND_CALLS)) STAGE ON 	TGT.CALL_ID = STAGE.CALL_ID 	WHEN MATCHED THEN UPDATE SET 	TGT.DNIS = STAGE.DNIS, TGT.AA_DESTINATION = STAGE.AA_DESTINATION, TGT.CALL_ID = STAGE.CALL_ID, TGT.START_TIME_UTC = STAGE.START_TIME_UTC, TGT.START_TIME = STAGE.START_TIME, TGT.CONNECT_TIME_UTC = STAGE.CONNECT_TIME_UTC, TGT.CONNECT_TIME = STAGE.CONNECT_TIME, TGT.DISCONNECTED_TIME_UTC = STAGE.DISCONNECTED_TIME_UTC, TGT.DISCONNECTED_TIME = STAGE.DISCONNECTED_TIME, TGT.TALK_TIME_MS = STAGE.TALK_TIME_MS, TGT.TALK_TIME = STAGE.TALK_TIME, TGT.CALLER = STAGE.CALLER, TGT.CALLER_NAME = STAGE.CALLER_NAME, TGT.CALLEE = STAGE.CALLEE, TGT.CALLEE_NAME = STAGE.CALLEE_NAME, TGT.DIRECTION = STAGE.DIRECTION, TGT.CALLER_ID = STAGE.CALLER_ID, TGT.MISSED = STAGE.MISSED, TGT.ABANDONED = STAGE.ABANDONED, TGT.ANSWERED = STAGE.ANSWERED, TGT.ANSWERED_TIME = STAGE.ANSWERED_TIME, TGT.CALLEE_DISCONNECT_ON_HOLD = STAGE.CALLEE_DISCONNECT_ON_HOLD, TGT.CALLER_DISCONNECT_ON_HOLD = STAGE.CALLER_DISCONNECT_ON_HOLD, TGT.PBX_ID = STAGE.PBX_ID, TGT.SIP_CALL_ID = STAGE.SIP_CALL_ID, TGT.LAST_LEG_DISPOSITION = STAGE.LAST_LEG_DISPOSITION, TGT.CALL_LEG_COUNT = STAGE.CALL_LEG_COUNT, TGT.CALL_TIME = STAGE.CALL_TIME, TGT.RING_DURATION = STAGE.RING_DURATION, TGT.ABANDONED_TIME = STAGE.ABANDONED_TIME, TGT.CALLEE_HOLD_DURATION_MS = STAGE.CALLEE_HOLD_DURATION_MS, TGT.CALLEE_HOLD_DURATION = STAGE.CALLEE_HOLD_DURATION, TGT.WAIT_TIME_MS = STAGE.WAIT_TIME_MS, TGT.WAIT_TIME = STAGE.WAIT_TIME, TGT.DEPARTMENTS = STAGE.DEPARTMENTS, TGT.BRANCHES = STAGE.BRANCHES, 	TGT.ETL_TASK_KEY = STAGE.ETL_TASK_KEY , 	TGT.ETL_LAST_UPDATED_DATE = STAGE.ETL_LAST_UPDATED_DATE , 	TGT.ETL_LAST_UPDATED_BY = STAGE.ETL_LAST_UPDATED_BY 	WHEN NOT MATCHED THEN INSERT 	( DNIS, AA_DESTINATION, CALL_ID, START_TIME_UTC, START_TIME, CONNECT_TIME_UTC, CONNECT_TIME, DISCONNECTED_TIME_UTC, DISCONNECTED_TIME, TALK_TIME_MS, TALK_TIME, CALLER, CALLER_NAME, CALLEE, CALLEE_NAME, DIRECTION, CALLER_ID, MISSED, ABANDONED, ANSWERED, ANSWERED_TIME, CALLEE_DISCONNECT_ON_HOLD, CALLER_DISCONNECT_ON_HOLD, PBX_ID, SIP_CALL_ID, LAST_LEG_DISPOSITION, CALL_LEG_COUNT, CALL_TIME, RING_DURATION, ABANDONED_TIME, CALLEE_HOLD_DURATION_MS, CALLEE_HOLD_DURATION, WAIT_TIME_MS, WAIT_TIME, DEPARTMENTS, BRANCHES, 	ETL_TASK_KEY , 	ETL_INSERTED_TASK_KEY , 	ETL_INSERTED_DATE , 	ETL_INSERTED_BY , 	ETL_LAST_UPDATED_DATE , 	ETL_LAST_UPDATED_BY ) VALUES ( STAGE.DNIS, STAGE.AA_DESTINATION, STAGE.CALL_ID, STAGE.START_TIME_UTC, STAGE.START_TIME, STAGE.CONNECT_TIME_UTC, STAGE.CONNECT_TIME, STAGE.DISCONNECTED_TIME_UTC, STAGE.DISCONNECTED_TIME, STAGE.TALK_TIME_MS, STAGE.TALK_TIME, STAGE.CALLER, STAGE.CALLER_NAME, STAGE.CALLEE, STAGE.CALLEE_NAME, STAGE.DIRECTION, STAGE.CALLER_ID, STAGE.MISSED, STAGE.ABANDONED, STAGE.ANSWERED, STAGE.ANSWERED_TIME, STAGE.CALLEE_DISCONNECT_ON_HOLD, STAGE.CALLER_DISCONNECT_ON_HOLD, STAGE.PBX_ID, STAGE.SIP_CALL_ID, STAGE.LAST_LEG_DISPOSITION, STAGE.CALL_LEG_COUNT, STAGE.CALL_TIME, STAGE.RING_DURATION, STAGE.ABANDONED_TIME, STAGE.CALLEE_HOLD_DURATION_MS, STAGE.CALLEE_HOLD_DURATION, STAGE.WAIT_TIME_MS, STAGE.WAIT_TIME, STAGE.DEPARTMENTS, STAGE.BRANCHES, STAGE.ETL_TASK_KEY , STAGE.ETL_INSERTED_TASK_KEY , STAGE.ETL_INSERTED_DATE , STAGE.ETL_INSERTED_BY , STAGE.ETL_LAST_UPDATED_DATE , STAGE.ETL_LAST_UPDATED_BY);

return ''Success'';
END;

 EOT
}

