resource "snowflake_procedure" "DISC_DOCEBO_GET_PAYROLL" {
	name ="GET_PAYROLL"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "DOCEBO"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

--*****************************************************************************************************************************
-- NAME:  DISC_${var.SF_ENVIRONMENT}.DOCEBO.GET_PAYROLL 
--
-- PURPOSE: To Load Discovery Layer Tables
--
-- DEVELOPMENT LOG:
-- DATE        		AUTHOR                	NOTES:
-- ----------  		-------------------   	-----------------------------------------------------------------------------------------------
-- 2023-11-20 		Ravi Suthar            	Initial Development
--*****************************************************************************************************************************

BEGIN 
    --TargetSQL
    COPY INTO DISC_${var.SF_ENVIRONMENT}.DOCEBO.HIST_PAYROLL FROM (SELECT A.$1 Username, A.$2 Are_you_or_are_you_applying_to_be_an_inhome_caregiver, A.$3 Branches, A.$4 Business_Unit, A.$5 Deactivated, A.$6 Direct_Manager, A.$7 Do_you_have_a_Home_Health_Certification, A.$8 Email, A.$9 Email_Address, A.$10 Email_Validation_Status, A.$11 Field_or_Admin, A.$12 First_Name, A.$13 First_Service_Date, A.$14 Full_Name, A.$15 Hire_Date, A.$16 Hourly, A.$17 Job_Level, A.$18 Job_Title, A.$19 Last_Name, A.$20 Location, A.$21 Manager_Name, A.$22 Payroll_ID, A.$23 Phone_Number, A.$24 Preferred_Language, A.$25 State, A.$26 Term_Date, A.$27 User_Creation_Date, A.$28 User_Expiration_Date, A.$29 User_Last_Access_Date, A.$30 User_Level, A.$31 User_Suspension_Date, A.$32 User_unique_ID, A.$33 Course_Name, A.$34 Course_Category, A.$35 Course_Category_Code, A.$36 Course_code, A.$37 Course_Creation_Date, A.$38 Course_duration, A.$39 Course_end_date, A.$40 Course_has_expired, A.$41 Course_Internal_ID, A.$42 Course_Start_Date, A.$43 Course_Status, A.$44 Course_Type, A.$45 Course_Unique_ID, A.$46 Credits_CEUs, A.$47 Language, A.$48 Completion_Date, A.$49 Course_First_Access_Date, A.$50 Course_Last_Access_Date, A.$51 Enrollment_Date, A.$52 Enrollment_End_Date, A.$53 Enrollment_Start_Date, A.$54 Course_Enrollment_Status, A.$55 Final_Score, A.$56 Initial_score, A.$57 User_Course_Level, A.$58 Course_Progress_percentage, A.$59 Number_of_Actions, A.$60 Number_of_Sessions, A.$61 Session_Time, A.$62 Training_Material_Time, A.$63 percentage_of_Training_Material_from_Mobile_App, A.$64 Time_in_Training_Material_from_Mobile_App, A.$65 Training_Material_Access_from_Mobile_App, :TaskKey AS ETL_TASK_KEY,  :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE,  current_user() AS ETL_LAST_UPDATED_BY,  0 as ETL_DELETED_FLAG  FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/Docebo_SFTP_Files/Upload_file/payroll(file_format => DISC_${var.SF_ENVIRONMENT}.STAGE.CSV_Format)  A);

    --ViewSQL
    MERGE INTO DISC_${var.SF_ENVIRONMENT}.DOCEBO.PAYROLL TGT  USING ( SELECT * FROM DISC_${var.SF_ENVIRONMENT}.DOCEBO.HIST_PAYROLL WHERE ETL_LAST_UPDATED_DATE = (SELECT MAX(ETL_LAST_UPDATED_DATE) FROM DISC_${var.SF_ENVIRONMENT}.DOCEBO.HIST_PAYROLL) ) STAGE  ON TGT.User_unique_ID = STAGE.User_unique_ID AND TGT.Course_Unique_ID = STAGE.Course_Unique_ID WHEN MATCHED THEN  UPDATE SET  TGT.Username = STAGE.Username, TGT.Are_you_or_are_you_applying_to_be_an_inhome_caregiver = STAGE.Are_you_or_are_you_applying_to_be_an_inhome_caregiver, TGT.Branches = STAGE.Branches, TGT.Business_Unit = STAGE.Business_Unit, TGT.Deactivated = STAGE.Deactivated, TGT.Direct_Manager = STAGE.Direct_Manager, TGT.Do_you_have_a_Home_Health_Certification = STAGE.Do_you_have_a_Home_Health_Certification, TGT.Email = STAGE.Email, TGT.Email_Address = STAGE.Email_Address, TGT.Email_Validation_Status = STAGE.Email_Validation_Status, TGT.Field_or_Admin = STAGE.Field_or_Admin, TGT.First_Name = STAGE.First_Name, TGT.First_Service_Date = STAGE.First_Service_Date, TGT.Full_Name = STAGE.Full_Name, TGT.Hire_Date = STAGE.Hire_Date, TGT.Hourly = STAGE.Hourly, TGT.Job_Level = STAGE.Job_Level, TGT.Job_Title = STAGE.Job_Title, TGT.Last_Name = STAGE.Last_Name, TGT.Location = STAGE.Location, TGT.Manager_Name = STAGE.Manager_Name, TGT.Payroll_ID = STAGE.Payroll_ID, TGT.Phone_Number = STAGE.Phone_Number, TGT.Preferred_Language = STAGE.Preferred_Language, TGT.State = STAGE.State, TGT.Term_Date = STAGE.Term_Date, TGT.User_Creation_Date = STAGE.User_Creation_Date, TGT.User_Expiration_Date = STAGE.User_Expiration_Date, TGT.User_Last_Access_Date = STAGE.User_Last_Access_Date, TGT.User_Level = STAGE.User_Level, TGT.User_Suspension_Date = STAGE.User_Suspension_Date, TGT.User_unique_ID = STAGE.User_unique_ID, TGT.Course_Name = STAGE.Course_Name, TGT.Course_Category = STAGE.Course_Category, TGT.Course_Category_Code = STAGE.Course_Category_Code, TGT.Course_code = STAGE.Course_code, TGT.Course_Creation_Date = STAGE.Course_Creation_Date, TGT.Course_duration = STAGE.Course_duration, TGT.Course_end_date = STAGE.Course_end_date, TGT.Course_has_expired = STAGE.Course_has_expired, TGT.Course_Internal_ID = STAGE.Course_Internal_ID, TGT.Course_Start_Date = STAGE.Course_Start_Date, TGT.Course_Status = STAGE.Course_Status, TGT.Course_Type = STAGE.Course_Type, TGT.Course_Unique_ID = STAGE.Course_Unique_ID, TGT.Credits_CEUs = STAGE.Credits_CEUs, TGT.Language = STAGE.Language, TGT.Completion_Date = STAGE.Completion_Date, TGT.Course_First_Access_Date = STAGE.Course_First_Access_Date, TGT.Course_Last_Access_Date = STAGE.Course_Last_Access_Date, TGT.Enrollment_Date = STAGE.Enrollment_Date, TGT.Enrollment_End_Date = STAGE.Enrollment_End_Date, TGT.Enrollment_Start_Date = STAGE.Enrollment_Start_Date, TGT.Course_Enrollment_Status = STAGE.Course_Enrollment_Status, TGT.Final_Score = STAGE.Final_Score, TGT.Initial_score = STAGE.Initial_score, TGT.User_Course_Level = STAGE.User_Course_Level, TGT.Course_Progress_percentage = STAGE.Course_Progress_percentage, TGT.Number_of_Actions = STAGE.Number_of_Actions, TGT.Number_of_Sessions = STAGE.Number_of_Sessions, TGT.Session_Time = STAGE.Session_Time, TGT.Training_Material_Time = STAGE.Training_Material_Time, TGT.percentage_of_Training_Material_from_Mobile_App = STAGE.percentage_of_Training_Material_from_Mobile_App, TGT.Time_in_Training_Material_from_Mobile_App = STAGE.Time_in_Training_Material_from_Mobile_App, TGT.Training_Material_Access_from_Mobile_App = STAGE.Training_Material_Access_from_Mobile_App, TGT.ETL_TASK_KEY= STAGE.ETL_TASK_KEY ,TGT.ETL_LAST_UPDATED_DATE= STAGE.ETL_LAST_UPDATED_DATE ,TGT.ETL_LAST_UPDATED_BY= STAGE.ETL_LAST_UPDATED_BY ,TGT.ETL_DELETED_FLAG= STAGE.ETL_DELETED_FLAG::INT WHEN NOT MATCHED THEN  INSERT (  Username, Are_you_or_are_you_applying_to_be_an_inhome_caregiver, Branches, Business_Unit, Deactivated, Direct_Manager, Do_you_have_a_Home_Health_Certification, Email, Email_Address, Email_Validation_Status, Field_or_Admin, First_Name, First_Service_Date, Full_Name, Hire_Date, Hourly, Job_Level, Job_Title, Last_Name, Location, Manager_Name, Payroll_ID, Phone_Number, Preferred_Language, State, Term_Date, User_Creation_Date, User_Expiration_Date, User_Last_Access_Date, User_Level, User_Suspension_Date, User_unique_ID, Course_Name, Course_Category, Course_Category_Code, Course_code, Course_Creation_Date, Course_duration, Course_end_date, Course_has_expired, Course_Internal_ID, Course_Start_Date, Course_Status, Course_Type, Course_Unique_ID, Credits_CEUs, Language, Completion_Date, Course_First_Access_Date, Course_Last_Access_Date, Enrollment_Date, Enrollment_End_Date, Enrollment_Start_Date, Course_Enrollment_Status, Final_Score, Initial_score, User_Course_Level, Course_Progress_percentage, Number_of_Actions, Number_of_Sessions, Session_Time, Training_Material_Time, percentage_of_Training_Material_from_Mobile_App, Time_in_Training_Material_from_Mobile_App, Training_Material_Access_from_Mobile_App, ETL_TASK_KEY, ETL_INSERTED_TASK_KEY, ETL_INSERTED_DATE, ETL_INSERTED_BY, ETL_LAST_UPDATED_DATE, ETL_LAST_UPDATED_BY, ETL_DELETED_FLAG )  VALUES (   STAGE.Username, STAGE.Are_you_or_are_you_applying_to_be_an_inhome_caregiver, STAGE.Branches, STAGE.Business_Unit, STAGE.Deactivated, STAGE.Direct_Manager, STAGE.Do_you_have_a_Home_Health_Certification, STAGE.Email, STAGE.Email_Address, STAGE.Email_Validation_Status, STAGE.Field_or_Admin, STAGE.First_Name, STAGE.First_Service_Date, STAGE.Full_Name, STAGE.Hire_Date, STAGE.Hourly, STAGE.Job_Level, STAGE.Job_Title, STAGE.Last_Name, STAGE.Location, STAGE.Manager_Name, STAGE.Payroll_ID, STAGE.Phone_Number, STAGE.Preferred_Language, STAGE.State, STAGE.Term_Date, STAGE.User_Creation_Date, STAGE.User_Expiration_Date, STAGE.User_Last_Access_Date, STAGE.User_Level, STAGE.User_Suspension_Date, STAGE.User_unique_ID, STAGE.Course_Name, STAGE.Course_Category, STAGE.Course_Category_Code, STAGE.Course_code, STAGE.Course_Creation_Date, STAGE.Course_duration, STAGE.Course_end_date, STAGE.Course_has_expired, STAGE.Course_Internal_ID, STAGE.Course_Start_Date, STAGE.Course_Status, STAGE.Course_Type, STAGE.Course_Unique_ID, STAGE.Credits_CEUs, STAGE.Language, STAGE.Completion_Date, STAGE.Course_First_Access_Date, STAGE.Course_Last_Access_Date, STAGE.Enrollment_Date, STAGE.Enrollment_End_Date, STAGE.Enrollment_Start_Date, STAGE.Course_Enrollment_Status, STAGE.Final_Score, STAGE.Initial_score, STAGE.User_Course_Level, STAGE.Course_Progress_percentage, STAGE.Number_of_Actions, STAGE.Number_of_Sessions, STAGE.Session_Time, STAGE.Training_Material_Time, STAGE.percentage_of_Training_Material_from_Mobile_App, STAGE.Time_in_Training_Material_from_Mobile_App, STAGE.Training_Material_Access_from_Mobile_App, STAGE.ETL_TASK_KEY, STAGE.ETL_INSERTED_TASK_KEY, STAGE.ETL_INSERTED_DATE, STAGE.ETL_INSERTED_BY, STAGE.ETL_LAST_UPDATED_DATE, STAGE.ETL_LAST_UPDATED_BY, STAGE.ETL_DELETED_FLAG::INT );

    return ''Success'';
END;

 EOT
}

