resource "snowflake_view" "DISC_HHAEXCHANGEEDISON_VW_EDISON_REVENUE_SEG" {
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "HHAEXCHANGEEDISON"
	name = "VW_EDISON_REVENUE_SEG"
	statement = <<-SQL
	 (
WITH VW_EDISON_REVENUE_SEG AS (
    SELECT
        V.VISITID,
        SC.CONTRACTID,
        SC.SERVICECODEID,
        CASE
            WHEN (
                PRIMARYBILLTO ILIKE '%ELDERSERVE%'
                AND PRIMARYBILLTO ILIKE '%CONCERN%'
            )
            OR PRIMARYBILLTO ILIKE '%Archcare - SRO%' THEN 'CC'
            WHEN OFC.OFFICECODE = 'CDP' THEN 'CDPAP'
            WHEN OFC.OFFICECODE = 'ACF' THEN 'MANORS'
            WHEN SC.CONTRACTID = 106 OR TV.PAYERID = 119 THEN 'PP'
            ELSE 'LHCSA'
        END REVENUE_SUBCATEGORY_CODE,
        CASE
            WHEN REVENUE_SUBCATEGORY_CODE = 'CDPAP' THEN 'CONSUMER DIRECT PERSONAL ASSISTANCE PROGRAM'
            WHEN REVENUE_SUBCATEGORY_CODE = 'LHCSA' THEN 'LICENSED HOME CARE AGENCY SERVICE'
            WHEN REVENUE_SUBCATEGORY_CODE = 'MANORS' THEN 'MANORS'
            WHEN REVENUE_SUBCATEGORY_CODE = 'CC' THEN 'CLUSTER CARE'
            WHEN REVENUE_SUBCATEGORY_CODE = 'PP' THEN 'PRIVATE PAY'
            ELSE 'UNKNOWN'
        END REVENUE_SUBCATEGORY_NAME,
        CASE
            WHEN REVENUE_SUBCATEGORY_CODE IN ('CDPAP', 'LHCSA', 'PP') THEN 'HC'
			WHEN REVENUE_SUBCATEGORY_CODE IN ('MANORS', 'CC') THEN 'OTHER'
            ELSE 'UNKNOWN'
        END REVENUE_CATEGORY
    FROM (
    		-- When there are multiple visits by visits id, let's consider just latest one
 			SELECT VISITID
				, PRIMARYBILLTO
				, OFFICEID
				, CONTRACTID
				, PAYERID
			FROM HHAEXCHANGEEDISON.VISITS
			QUALIFY ROW_NUMBER() OVER(PARTITION BY VISITID ORDER BY LASTMODIFIEDDATE) = 1
		) V
        INNER JOIN HHAEXCHANGEEDISON.VISITINFO_REPL VISITS
		ON VISITS.VISITID = V.VISITID
		JOIN HHAEXCHANGEEDISON.TBLVISITS_REPL TV ON VISITS.VISITID = TV.VISITID
        LEFT JOIN DISC_${var.SF_ENVIRONMENT}.HHAEXCHANGEEDISON.OFFICE_OFFICES_REPL OFC ON OFC.OFFICEID = V.OFFICEID --RSUTHAR CHANGE Disc_dev TO Disc_prod
        	LEFT JOIN HHAEXCHANGEEDISON.SERVICECODES SC 
		ON VISITS.PRIMARYSERVICECODEID = SC.SERVICECODEID
			AND  VISITS.AGENCYID = SC.AGENCYID
			WHERE VISITS.AGENCYID=155
             GROUP BY 1,2,3,4
) 
SELECT VISITID,
	CONTRACTID,
	SERVICECODEID,
	REVENUE_SUBCATEGORY_CODE,
	REVENUE_SUBCATEGORY_NAME,
	REVENUE_CATEGORY
FROM VW_EDISON_REVENUE_SEG 
);
SQL
	or_replace = true 
	is_secure = false 
}

