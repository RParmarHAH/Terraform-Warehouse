resource "snowflake_procedure" "DISC_ZENDESK_GET_USER" {
	name ="GET_USER"
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "ZENDESK"
	language  = "SQL"

	arguments {
		name = "TASKKEY"
		type = "VARCHAR(16777216)"
}	
	return_type = "VARCHAR(16777216)"
	execute_as = "OWNER"
	statement = <<-EOT

BEGIN 
    --TargetSQL
    INSERT INTO DISC_${var.SF_ENVIRONMENT}.ZENDESK.HIST_USER SELECT DISTINCT ''AMS'' AS SOURCE,j.$1:id::varchar id,j.$1::VARIANT JSON_DATA,:TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/Zendesk/output/user_ams.json(file_format => DISC_${var.SF_ENVIRONMENT}.STAGE.MY_JSON_FORMAT) j UNION SELECT DISTINCT ''Payroll'' AS SOURCE,j2.$1:id::varchar id,j2.$1::VARIANT JSON_DATA,:TaskKey AS ETL_TASK_KEY, :TaskKey AS ETL_INSERTED_TASK_KEY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_INSERTED_DATE, current_user() AS ETL_INSERTED_BY, current_timestamp::TIMESTAMP_NTZ(9) AS ETL_LAST_UPDATED_DATE, current_user() AS ETL_LAST_UPDATED_BY, 0 as ETL_DELETED_FLAG FROM @DISC_${var.SF_ENVIRONMENT}.STAGE.AWSAZSTAGEPROD/Zendesk/output/user_payroll.json(file_format => DISC_${var.SF_ENVIRONMENT}.STAGE.MY_JSON_FORMAT) j2;

    --ViewSQL
    MERGE INTO DISC_${var.SF_ENVIRONMENT}.ZENDESK.USER TGT USING (SELECT * FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.HIST_USER WHERE ETL_LAST_UPDATED_DATE = (SELECT MAX(ETL_LAST_UPDATED_DATE) FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.HIST_USER)) STAGE ON TGT.ID = STAGE.ID AND TGT.SOURCE = STAGE.SOURCE WHEN MATCHED THEN UPDATE SET TGT.SOURCE = STAGE.SOURCE  , TGT.active = STAGE.JSON_DATA:active::VARIANT , TGT.user_fields_employee_status = STAGE.JSON_DATA:user_fields:employee_status::varchar , TGT.id = STAGE.JSON_DATA:id::number , TGT.user_fields_workday_id = (CASE TGT.SOURCE WHEN ''AMS'' THEN STAGE.JSON_DATA:user_fields:workday_ids::varchar WHEN ''Payroll'' THEN STAGE.JSON_DATA:user_fields:workday_id::varchar END), TGT.role = STAGE.JSON_DATA:role::varchar , TGT.name = STAGE.JSON_DATA:name::varchar , TGT.email = STAGE.JSON_DATA:email::varchar , TGT.user_fields_employee_id_text = STAGE.JSON_DATA:user_fields:employee_id_text::varchar , TGT.user_fields_employee_key = STAGE.JSON_DATA:user_fields:employee_key::varchar , TGT.created_at = STAGE.JSON_DATA:created_at::varchar , TGT.updated_at = STAGE.JSON_DATA:updated_at::varchar , TGT.time_zone = STAGE.JSON_DATA:time_zone::varchar , TGT.iana_time_zone = STAGE.JSON_DATA:iana_time_zone::varchar , TGT.phone = STAGE.JSON_DATA:phone::varchar , TGT.shared_phone_number = STAGE.JSON_DATA:shared_phone_number::varchar , TGT.photo = STAGE.JSON_DATA:photo::varchar , TGT.locale_id = STAGE.JSON_DATA:locale_id::VARIANT , TGT.locale = STAGE.JSON_DATA:locale::varchar , TGT.organization_id = STAGE.JSON_DATA:organization_id::varchar , TGT.verified = STAGE.JSON_DATA:verified::VARIANT , TGT.external_id = STAGE.JSON_DATA:external_id::varchar , TGT.tags = STAGE.JSON_DATA:tags::varchar , TGT.alias = STAGE.JSON_DATA:alias::varchar , TGT.shared = STAGE.JSON_DATA:shared::VARIANT , TGT.shared_agent = STAGE.JSON_DATA:shared_agent::VARIANT , TGT.last_login_at = STAGE.JSON_DATA:last_login_at::varchar , TGT.two_factor_auth_enabled = STAGE.JSON_DATA:two_factor_auth_enabled::VARIANT , TGT.signature = STAGE.JSON_DATA:signature::varchar , TGT.details = STAGE.JSON_DATA:details::varchar , TGT.notes = STAGE.JSON_DATA:notes::varchar , TGT.role_type = STAGE.JSON_DATA:role_type::varchar , TGT.custom_role_id = STAGE.JSON_DATA:custom_role_id::varchar , TGT.moderator = STAGE.JSON_DATA:moderator::VARIANT , TGT.ticket_restriction = STAGE.JSON_DATA:ticket_restriction::varchar , TGT.only_private_comments = STAGE.JSON_DATA:only_private_comments::VARIANT , TGT.restricted_agent = STAGE.JSON_DATA:restricted_agent::VARIANT , TGT.suspended = STAGE.JSON_DATA:suspended::VARIANT , TGT.default_group_id = STAGE.JSON_DATA:default_group_id::varchar , TGT.report_csv = STAGE.JSON_DATA:report_csv::VARIANT , TGT.user_fields_admin_or_caregiver = STAGE.JSON_DATA:user_fields:admin_or_caregiver::varchar , TGT.user_fields_ams_system = STAGE.JSON_DATA:user_fields:ams_system::varchar , TGT.user_fields_branch = STAGE.JSON_DATA:user_fields:branch::varchar , TGT.user_fields_cell_phone = STAGE.JSON_DATA:user_fields:cell_phone::varchar , TGT.user_fields_department = STAGE.JSON_DATA:user_fields:department::varchar , TGT.user_fields_direct_phone_number = STAGE.JSON_DATA:user_fields:direct_phone_number::varchar , TGT.user_fields_email = STAGE.JSON_DATA:user_fields:email::varchar , TGT.user_fields_extension = STAGE.JSON_DATA:user_fields:extension::varchar , TGT.user_fields_first_name = STAGE.JSON_DATA:user_fields:first_name::varchar , TGT.user_fields_hire_date = STAGE.JSON_DATA:user_fields:hire_date::varchar , TGT.user_fields_home_phone = STAGE.JSON_DATA:user_fields:home_phone::varchar , TGT.user_fields_job_title = STAGE.JSON_DATA:user_fields:job_title::varchar , TGT.user_fields_last_name = STAGE.JSON_DATA:user_fields:last_name::varchar , TGT.user_fields_payroll_id = STAGE.JSON_DATA:user_fields:payroll_id::varchar , TGT.user_fields_payroll_system = STAGE.JSON_DATA:user_fields:payroll_system::varchar , TGT.user_fields_personal_email = STAGE.JSON_DATA:user_fields:personal_email::varchar , TGT.user_fields_state = STAGE.JSON_DATA:user_fields:state::varchar , TGT.photo_content_type = STAGE.JSON_DATA:photo:content_type::varchar , TGT.photo_content_url = STAGE.JSON_DATA:photo:content_url::varchar , TGT.photo_deleted = STAGE.JSON_DATA:photo:deleted::VARIANT , TGT.photo_file_name = STAGE.JSON_DATA:photo:file_name::varchar , TGT.photo_height = STAGE.JSON_DATA:photo:height::number , TGT.photo_id = STAGE.JSON_DATA:photo:id::number , TGT.photo_inline = STAGE.JSON_DATA:photo:inline::VARIANT , TGT.photo_mapped_content_url = STAGE.JSON_DATA:photo:mapped_content_url::varchar , TGT.photo_size = STAGE.JSON_DATA:photo:size::number , TGT.photo_thumbnails = STAGE.JSON_DATA:photo:thumbnails::varchar , TGT.photo_url = STAGE.JSON_DATA:photo:url::varchar , TGT.photo_width = STAGE.JSON_DATA:photo:width::number , TGT.url = STAGE.JSON_DATA:url::varchar , TGT.ETL_TASK_KEY = STAGE.ETL_TASK_KEY ,   TGT.ETL_INSERTED_TASK_KEY = STAGE.ETL_INSERTED_TASK_KEY ,   TGT.ETL_INSERTED_DATE = STAGE.ETL_INSERTED_DATE ,   TGT.ETL_INSERTED_BY = STAGE.ETL_INSERTED_BY ,   TGT.ETL_LAST_UPDATED_DATE = STAGE.ETL_LAST_UPDATED_DATE ,   TGT.ETL_LAST_UPDATED_BY = STAGE.ETL_LAST_UPDATED_BY ,   TGT.ETL_DELETED_FLAG = STAGE.ETL_DELETED_FLAG WHEN NOT MATCHED THEN INSERT ( SOURCE , active , user_fields_employee_status , id , user_fields_workday_id , role , name , email , user_fields_employee_id_text , user_fields_employee_key , created_at , updated_at , time_zone , iana_time_zone , phone , shared_phone_number , photo , locale_id , locale , organization_id , verified , external_id , tags , alias , shared , shared_agent , last_login_at , two_factor_auth_enabled , signature , details , notes , role_type , custom_role_id , moderator , ticket_restriction , only_private_comments , restricted_agent , suspended , default_group_id , report_csv , user_fields_admin_or_caregiver , user_fields_ams_system , user_fields_branch , user_fields_cell_phone , user_fields_department , user_fields_direct_phone_number , user_fields_email , user_fields_extension , user_fields_first_name , user_fields_hire_date , user_fields_home_phone , user_fields_job_title , user_fields_last_name , user_fields_payroll_id , user_fields_payroll_system , user_fields_personal_email , user_fields_state , photo_content_type , photo_content_url , photo_deleted , photo_file_name , photo_height , photo_id , photo_inline , photo_mapped_content_url , photo_size , photo_thumbnails , photo_url , photo_width , url ,  ETL_TASK_KEY ,   ETL_INSERTED_TASK_KEY ,   ETL_INSERTED_DATE ,   ETL_INSERTED_BY ,   ETL_LAST_UPDATED_DATE ,   ETL_LAST_UPDATED_BY ,   ETL_DELETED_FLAG) VALUES ( STAGE.SOURCE , STAGE.JSON_DATA:active::VARIANT , STAGE.JSON_DATA:user_fields:employee_status::varchar , STAGE.JSON_DATA:id::number , CASE SOURCE WHEN ''AMS'' THEN STAGE.JSON_DATA:user_fields:workday_id::varchar WHEN ''Payroll'' THEN STAGE.JSON_DATA:user_fields:workday_ids::varchar END, STAGE.JSON_DATA:role::varchar , STAGE.JSON_DATA:name::varchar , STAGE.JSON_DATA:email::varchar , STAGE.JSON_DATA:user_fields:employee_id_text::varchar , STAGE.JSON_DATA:user_fields:employee_key::varchar , STAGE.JSON_DATA:created_at::varchar , STAGE.JSON_DATA:updated_at::varchar , STAGE.JSON_DATA:time_zone::varchar , STAGE.JSON_DATA:iana_time_zone::varchar , STAGE.JSON_DATA:phone::varchar , STAGE.JSON_DATA:shared_phone_number::varchar , STAGE.JSON_DATA:photo::varchar , STAGE.JSON_DATA:locale_id::VARIANT , STAGE.JSON_DATA:locale::varchar , STAGE.JSON_DATA:organization_id::varchar , STAGE.JSON_DATA:verified::VARIANT , STAGE.JSON_DATA:external_id::varchar , STAGE.JSON_DATA:tags::varchar , STAGE.JSON_DATA:alias::varchar , STAGE.JSON_DATA:shared::VARIANT , STAGE.JSON_DATA:shared_agent::VARIANT , STAGE.JSON_DATA:last_login_at::varchar , STAGE.JSON_DATA:two_factor_auth_enabled::VARIANT , STAGE.JSON_DATA:signature::varchar , STAGE.JSON_DATA:details::varchar , STAGE.JSON_DATA:notes::varchar , STAGE.JSON_DATA:role_type::varchar , STAGE.JSON_DATA:custom_role_id::varchar , STAGE.JSON_DATA:moderator::VARIANT , STAGE.JSON_DATA:ticket_restriction::varchar , STAGE.JSON_DATA:only_private_comments::VARIANT , STAGE.JSON_DATA:restricted_agent::VARIANT , STAGE.JSON_DATA:suspended::VARIANT , STAGE.JSON_DATA:default_group_id::varchar , STAGE.JSON_DATA:report_csv::VARIANT , STAGE.JSON_DATA:user_fields:admin_or_caregiver::varchar , STAGE.JSON_DATA:user_fields:ams_system::varchar , STAGE.JSON_DATA:user_fields:branch::varchar , STAGE.JSON_DATA:user_fields:cell_phone::varchar , STAGE.JSON_DATA:user_fields:department::varchar , STAGE.JSON_DATA:user_fields:direct_phone_number::varchar , STAGE.JSON_DATA:user_fields:email::varchar , STAGE.JSON_DATA:user_fields:extension::varchar , STAGE.JSON_DATA:user_fields:first_name::varchar , STAGE.JSON_DATA:user_fields:hire_date::varchar , STAGE.JSON_DATA:user_fields:home_phone::varchar , STAGE.JSON_DATA:user_fields:job_title::varchar , STAGE.JSON_DATA:user_fields:last_name::varchar , STAGE.JSON_DATA:user_fields:payroll_id::varchar , STAGE.JSON_DATA:user_fields:payroll_system::varchar , STAGE.JSON_DATA:user_fields:personal_email::varchar , STAGE.JSON_DATA:user_fields:state::varchar , STAGE.JSON_DATA:photo:content_type::varchar , STAGE.JSON_DATA:photo:content_url::varchar , STAGE.JSON_DATA:photo:deleted::VARIANT , STAGE.JSON_DATA:photo:file_name::varchar , STAGE.JSON_DATA:photo:height::number , STAGE.JSON_DATA:photo:id::number , STAGE.JSON_DATA:photo:inline::VARIANT , STAGE.JSON_DATA:photo:mapped_content_url::varchar , STAGE.JSON_DATA:photo:size::number , STAGE.JSON_DATA:photo:thumbnails::varchar , STAGE.JSON_DATA:photo:url::varchar , STAGE.JSON_DATA:photo:width::number , STAGE.JSON_DATA:url::varchar ,  STAGE.ETL_TASK_KEY ,   STAGE.ETL_INSERTED_TASK_KEY ,   STAGE.ETL_INSERTED_DATE ,   STAGE.ETL_INSERTED_BY ,   STAGE.ETL_LAST_UPDATED_DATE ,   STAGE.ETL_LAST_UPDATED_BY ,   STAGE.ETL_DELETED_FLAG);

    return ''Success'';
END;

 EOT
}

