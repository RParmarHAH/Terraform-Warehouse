resource "snowflake_view" "DISC_ZENDESK_VW_ORGANIZATION_BRANCH_MAPPING" {
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "ZENDESK"
	name = "VW_ORGANIZATION_BRANCH_MAPPING"
	statement = <<-SQL
	 WITH cte AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA, ZO.ORGANIZATION_FIELDS_STATE ,ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER,DBM.OFFICE_FAX AS off_fax,ZO.ORGANIZATION_FIELDS_FAX AS fax, OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH dbm
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS zo
    ON dbm.OFFICE_CODE = zo.ORGANIZATION_FIELDS_OFFICE_NUMBER  
    AND zo.SOURCE = dbm.SOURCE_SYSTEM_TYPE
    AND (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '') AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))  OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL)) AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '')) OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))AND REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '')) )
ORDER BY ZO.NAME ASC),
CTE2 AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA,ZO.ORGANIZATION_FIELDS_STATE , ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER, DBM.OFFICE_FAX AS off_fax ,ZO.ORGANIZATION_FIELDS_FAX AS fax,OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH dbm
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS zo
    ON dbm.OFFICE_CODE = zo.ORGANIZATION_FIELDS_OFFICE_NUMBER  
    AND zo.SOURCE = dbm.SOURCE_SYSTEM_TYPE AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '')
    AND (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP) --AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '') AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))  OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL)) AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '')) OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))AND REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '')) )
WHERE ZO."SOURCE" = 'AMS' AND ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte) ORDER BY ZO.NAME ASC)
,CTE3 AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA,ZO.ORGANIZATION_FIELDS_STATE , ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER, DBM.OFFICE_FAX AS off_fax ,ZO.ORGANIZATION_FIELDS_FAX AS fax,OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH dbm
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS zo
    ON dbm.OFFICE_CODE = zo.ORGANIZATION_FIELDS_OFFICE_NUMBER  
    AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '')
    AND DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '') AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))
    WHERE ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte UNION SELECT DISTINCT ORG_ID FROM cte2) ORDER BY ZO.NAME ASC) -- OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL)) AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '')) OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))AND REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '')) ) AND ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte UNION SELECT DISTINCT ORG_ID FROM cte2) ORDER BY ZO.NAME ASC)
,CTE4 AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA, ZO.ORGANIZATION_FIELDS_STATE ,ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER, DBM.OFFICE_FAX AS off_fax ,ZO.ORGANIZATION_FIELDS_FAX AS fax,OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH dbm
INNER JOIN DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS zo
    ON dbm.OFFICE_CODE = zo.ORGANIZATION_FIELDS_OFFICE_NUMBER  
    AND zo.SOURCE = dbm.SOURCE_SYSTEM_TYPE
    AND (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP) --AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '') AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))  OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL)) AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '')) OR (DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))AND REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '')) )
WHERE ZO."SOURCE" = 'AMS' AND ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte UNION SELECT DISTINCT ORG_ID FROM cte2 union SELECT DISTINCT ORG_ID FROM cte3) ORDER BY ZO.NAME ASC)
,CTE5 AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA,ZO.ORGANIZATION_FIELDS_STATE , ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER, DBM.OFFICE_FAX AS off_fax ,ZO.ORGANIZATION_FIELDS_FAX AS fax,OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS ZO JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH DBM
ON REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '') AND UPPER(TRIM(SUBSTR(ZO.NAME, LENGTH(SUBSTR(ZO.NAME, 1, POSITION(' ', ZO.NAME, POSITION(' ', ZO.NAME) + 1) - 1)) + 1))) = UPPER(TRIM(DBM.OFFICE_NAME)) AND 
zo.SOURCE = dbm.SOURCE_SYSTEM_TYPE AND REGEXP_REPLACE(DBM.OFFICE_FAX, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_FAX, '[^0-9]', '') AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '') AND DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP
WHERE ZO."SOURCE" = 'AMS' AND ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte UNION SELECT DISTINCT ORG_ID FROM cte2 union SELECT DISTINCT ORG_ID FROM cte3 union SELECT DISTINCT ORG_ID FROM cte4) ORDER BY ZO.NAME ASC)
,CTE6 AS (
SELECT ZO.ID AS ORG_ID,dbm."BRANCH_NAME" AS NM, dbm."OFFICE_NAME" AS ONA,ZO.ORGANIZATION_FIELDS_STATE , ZO.NAME AS NAME_, OFFICE_CODE, ZO.ORGANIZATION_FIELDS_OFFICE_NUMBER, DBM.OFFICE_FAX AS off_fax ,ZO.ORGANIZATION_FIELDS_FAX AS fax,OFFICE_ZIP, ORGANIZATION_FIELDS_ZIP,DBM.OFFICE_ADDRESS1,ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, OFFICE_PHONE, ORGANIZATION_FIELDS_PHONE, "PRIMARY_BRANCH_EMAIL", ORGANIZATION_FIELDS_EMAIL, zo.SOURCE, dbm.SOURCE_SYSTEM_TYPE, *
FROM DISC_${var.SF_ENVIRONMENT}.ZENDESK.ORGANIZATIONS ZO JOIN DW_${var.SF_ENVIRONMENT}.HAH.DIM_BRANCH DBM
ON REGEXP_REPLACE(DBM.OFFICE_ADDRESS1, '[^a-zA-Z0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_OFFICE_ADDRESS, '[^a-zA-Z0-9]', '') AND UPPER(TRIM(REGEXP_REPLACE(SUBSTR(ZO.NAME, LENGTH(SUBSTR(ZO.NAME, 1, POSITION(' ', ZO.NAME, POSITION(' ', ZO.NAME) + 1) - 1)) + 1), '[^A-Za-z]', '', 1, 0, 'c'))) = UPPER(TRIM(REGEXP_REPLACE(DBM.OFFICE_NAME, '[^A-Za-z]', '', 1, 0, 'c'))) AND 
zo.SOURCE = dbm.SOURCE_SYSTEM_TYPE AND REGEXP_REPLACE(DBM.OFFICE_PHONE, '[^0-9]', '') = REGEXP_REPLACE(ZO.ORGANIZATION_FIELDS_PHONE, '[^0-9]', '') AND DBM.OFFICE_ZIP = ZO.ORGANIZATION_FIELDS_ZIP AND trim(upper(dbm.PRIMARY_BRANCH_EMAIL)) = trim(upper(zo.ORGANIZATION_FIELDS_EMAIL))
WHERE ZO."SOURCE" = 'AMS' AND ZO.id NOT IN (SELECT DISTINCT ORG_ID FROM cte UNION SELECT DISTINCT ORG_ID FROM cte2 union SELECT DISTINCT ORG_ID FROM cte3 union SELECT DISTINCT ORG_ID FROM cte4 union SELECT DISTINCT ORG_ID FROM cte5) ORDER BY ZO.NAME ASC)
--SELECT * FROM cte3;
--,CTE7 AS (
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE
UNION 
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE2
UNION 
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE3
UNION 
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE4
UNION 
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE5
UNION 
SELECT ORG_ID,NAME_,"BRANCH_KEY" ,"OFFICE_STATE_CODE" FROM CTE6;
SQL
	or_replace = true 
	is_secure = false 
}

