resource "snowflake_view" "DISC_ASR_ASR_OLD_REVENUE" {
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "ASR"
	name = "ASR_OLD_REVENUE"
	statement = <<-SQL
	 
WITH RAW_DATA AS 
(
SELECT DISTINCT --CUSTOMER , -- POSITION (',', CUSTOMER) AS POSITON, LENGTH (CUSTOMER) AS LENTH,
TRIM(UPPER(SUBSTRING(CUSTOMER,0,POSITION (',', CUSTOMER)-1))) AS LAST_NAME,  
TRIM(UPPER(SUBSTRING(CUSTOMER,POSITION (',', CUSTOMER)+1, LENGTH(CUSTOMER)-POSITION (',', CUSTOMER)))) AS FIRST_NAME , *
FROM DISC_${var.SF_ENVIRONMENT}.ASR."ASR_P&R2022" MATT
)
SELECT M.MASTER_ID  AS MASTER_ID, R.* 
FROM RAW_DATA R 
LEFT JOIN DISC_DEDUPE_${var.SF_ENVIRONMENT}.ASR.CLIENT_MASTER_LIST  M ON  TRIM(UPPER(M.FIRSTNAME)) = TRIM(UPPER(R.FIRST_NAME)) 
AND TRIM(UPPER(M.LASTNAME)) = TRIM(UPPER(R.LAST_NAME))
WHERE M.CLIENTID IS  NULL;
SQL
	or_replace = true 
	is_secure = false 
}

