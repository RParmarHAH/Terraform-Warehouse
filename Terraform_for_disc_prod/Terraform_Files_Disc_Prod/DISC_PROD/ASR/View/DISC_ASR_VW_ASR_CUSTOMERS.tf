resource "snowflake_view" "DISC_ASR_VW_ASR_CUSTOMERS" {
	database = "DISC_${var.SF_ENVIRONMENT}"
	schema = "ASR"
	name = "VW_ASR_CUSTOMERS"
	statement = <<-SQL
	 WITH CUSTOMER_PIVOT AS (
	SELECT *
		FROM DISC_${var.SF_ENVIRONMENT}.ASR.ASR_CUSTOMER_DETAILS 
	PIVOT
	(
		MAX(PROPERTY_VALUE)
		FOR CUSTOMER_EXTENDED_PROPERTY IN ('SEX', 'DOB', 'AGE', 'COMMENTS', 'SSN', 'MEDICAID BILLING NUMBER', 'MEDICAID ELIGIBILITY UPTO DATE', 'MEDICARE ELIGIBILITY UPTO DATE',
		'PRIMARY CARE PHYSICIAN NAME', 'PRIMARY CARE PHYSICIAN PHONE NUMBER', 'PRIMARY CARE PHYSICIAN NPI', 'ALT PHONE 2', 'ALT PHONE 3', 'COPAY', 'PRIOR AUTHORIZATION NUMBER',
		'CLIENT FILE AUDIT DATE', 'AUDITED BY', 'RELEASE FORM', 'CLIENT FORM', 'ASSIGNMENT TASK SHEET UPDATED', 'ALL REVIEW FORMS IN PLACE',
		'PRIMARY CARE PHYSICIAN FAX', 'EMERGENCY CONTACT2 PHONE', 'EMERGENCY CONTACT RELATIONSHIP', 'IMPORTANT CLIENT NOTE',
		'NURSING ASSESSMENT', 'INTAKE DATE', 'EMERGENCY CONTACT EMAIL', 'PRIMARY CARE PHYSICIAN ADDRESS', 'MEDICARE BILLING NUMBER', 'NEXT AUDIT DATE',
		'ASSIGNMENT TASK SHEET INITIAL', 'EMERGENCY CONTACT2 NAME', 'EMERGENCY CONTACT2 RELATIONSHIP', 'PREFERRED HOSPITAL',
		'PHARMACY', 'ALT PHONE 1', 'CLIENTS RIGHTS AND RESPONSIBILITIES', 'COPAY DATE'
		)
	)
)
, CUSTOMER_DETAILS AS
(
	SELECT DISTINCT
		TRIM(CUSTOMERID) AS CUSTOMERID,
		CASE 
	     	WHEN UPPER(TRIM("'SEX'")) = '1' THEN 'MALE'
	     	WHEN UPPER(TRIM("'SEX'")) = '2' THEN 'FEMALE'
	     	ELSE NULL
		END AS CLIENT_GENDER,
		NULLIF(REGEXP_REPLACE(UPPER(TRIM("'SSN'")),'-|\\s|[A-Z]',''),'') AS SSN,
		TRY_TO_DATE(SPLIT_PART("'DOB'",' ',1),'MM/DD/YYYY')::VARCHAR AS CLIENT_DOB,
		UPPER(TRIM("'MEDICAID BILLING NUMBER'")) AS MEDICAID_BILLING_NUMBER,
		UPPER(TRIM("'MEDICARE BILLING NUMBER'")) AS MEDICARE_BILLING_NUMBER
	FROM CUSTOMER_PIVOT
) 
SELECT 
ROW_NUMBER() OVER (PARTITION BY C.CUSTOMERID ORDER BY CLIENT_DOB DESC NULLS LAST) AS RANK,
CD.CLIENT_GENDER,
CD.SSN,
CD.CLIENT_DOB::VARCHAR  AS CLIENT_DOB, 
CD.MEDICAID_BILLING_NUMBER, 
CD.MEDICARE_BILLING_NUMBER,
c.*
FROM 
DISC_${var.SF_ENVIRONMENT}.ASR.ASR_CUSTOMERS C
LEFT JOIN CUSTOMER_DETAILS CD ON TRIM(CD.CUSTOMERID)  = TRIM(C.CUSTOMERID)
QUALIFY RANK = 1;
SQL
	or_replace = true 
	is_secure = false 
}

